"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const element_listener_1 = require("./element-listener");
const tooltip_manager_1 = require("./tooltip-manager");
const marker_manager_1 = require("./marker-manager");
class EditorControl {
    constructor(editor, results) {
        this.editor = editor;
        this.disposables = new atom_1.CompositeDisposable();
        this.disposables.add(this.emitter = new atom_1.Emitter());
        this.tooltips = new tooltip_manager_1.TooltipManager(this.editor);
        this.disposables.add(this.tooltips);
        this.markers = new marker_manager_1.MarkerManager(this.editor, results);
        this.disposables.add(this.markers);
        this.editorElement = atom.views.getView(this.editor);
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.registerGutterEvents();
        }
        const buffer = this.editor.getBuffer();
        this.disposables.add(buffer.onWillSave(() => this.emitter.emit('will-save-buffer', buffer)));
        this.disposables.add(buffer.onDidSave(() => this.emitter.emit('did-save-buffer', buffer)));
        this.disposables.add(this.editor.onDidStopChanging(() => this.emitter.emit('did-stop-changing', this.editor)));
        this.disposables.add(this.editorElement.onDidChangeScrollLeft(() => this.tooltips.hide({ type: 'mouse' })));
        this.disposables.add(this.editorElement.onDidChangeScrollTop(() => this.tooltips.hide({ type: 'mouse' })));
        this.disposables.add(element_listener_1.listen(this.editorElement, 'mousemove', '.scroll-view', this.trackMouseBufferPosition.bind(this)));
        this.disposables.add(element_listener_1.listen(this.editorElement, 'mouseout', '.scroll-view', this.stopTrackingMouseBufferPosition.bind(this)));
        this.disposables.add(this.editor.onDidChangeSelectionRange(this.trackSelection.bind(this)));
    }
    deactivate() {
        if (this.exprTypeTimeout) {
            clearTimeout(this.exprTypeTimeout);
        }
        if (this.selTimeout) {
            clearTimeout(this.selTimeout);
        }
        this.disposables.dispose();
        this.lastMouseBufferPt = undefined;
    }
    onShouldShowTooltip(callback) {
        return this.emitter.on('should-show-tooltip', callback);
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    shouldShowTooltip(pos, type) {
        if (!type) {
            type = 'mouse';
        }
        if ((type === 'mouse' || type === 'keyboard') && this.showCheckResult(pos, type)) {
            return;
        }
        if ((pos.row < 0) ||
            (pos.row >= this.editor.getLineCount()) ||
            pos.isEqual(this.editor.bufferRangeForBufferRow(pos.row).end)) {
            this.tooltips.hide({ type, subtype: 'external' });
        }
        else if (this.rangeHasChanged(pos, type)) {
            this.emitter.emit('should-show-tooltip', {
                editor: this.editor,
                pos,
                type
            });
        }
    }
    rangeHasChanged(pos, eventType) {
        const newrange = this.getEventRange(pos, eventType).crange;
        const isFirstIteration = !(this.lastMouseBufferRangeTest && this.lastMouseBufferPtTest);
        const isSameToken = () => {
            if (!(this.lastMouseBufferRangeTest && this.lastMouseBufferPtTest)) {
                return false;
            }
            const rangesAreEmpty = this.lastMouseBufferRangeTest.isEmpty() && newrange.isEmpty();
            const isSameRow = this.lastMouseBufferPtTest.row === pos.row;
            if (!rangesAreEmpty || !isSameRow) {
                return false;
            }
            const tl = this.editor.tokenizedBuffer.tokenizedLineForRow(this.lastMouseBufferPtTest.row);
            const oldtokid = tl.tokenIndexAtBufferColumn(this.lastMouseBufferPtTest
                .column);
            const newtokid = tl.tokenIndexAtBufferColumn(pos.column);
            return oldtokid === newtokid;
        };
        const result = isFirstIteration || !(this.lastMouseBufferRangeTest.isEqual(newrange) || isSameToken());
        this.lastMouseBufferPtTest = pos;
        this.lastMouseBufferRangeTest = newrange;
        return result;
    }
    getEventRange(pos, eventType) {
        let crange;
        switch (eventType) {
            case 'mouse':
            case 'context':
                if (!pos) {
                    pos = this.lastMouseBufferPt;
                }
                const [selRange] = Array.from(this.editor.getSelections()
                    .map((sel) => sel.getBufferRange()).filter((sel) => sel.containsPoint(pos)));
                crange = selRange || new atom_1.Range(pos, pos);
                break;
            case 'keyboard':
            case 'selection':
                crange = this.editor.getLastSelection().getBufferRange();
                pos = crange.start;
                break;
            default:
                throw new Error(`unknown event type ${eventType}`);
        }
        const ppos = pos;
        return {
            crange, pos: ppos, eventType
        };
    }
    showCheckResult(pos, type) {
        const checkMessage = this.markers.getMessageAt(pos, type);
        let evt;
        if (type === 'gutter') {
            evt = 'mouse';
        }
        else {
            evt = type;
        }
        if (checkMessage.length > 0) {
            this.tooltips.show(new atom_1.Range(pos, pos), checkMessage, { type: evt, subtype: 'check-result' });
            return true;
        }
        else {
            this.tooltips.hide({ type: evt, subtype: 'check-result' });
            return false;
        }
    }
    registerGutterEvents() {
        const gutterElement = atom.views.getView(this.markers.gutter);
        this.disposables.add(element_listener_1.listen(gutterElement, 'mouseover', '.decoration', (e) => {
            const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
            if (bufferPt) {
                this.lastMouseBufferPt = bufferPt;
                this.showCheckResult(bufferPt, 'gutter');
            }
        }));
        this.disposables.add(element_listener_1.listen(gutterElement, 'mouseout', '.decoration', (e) => this.tooltips.hide({ type: 'mouse', subtype: 'check-result' })));
    }
    trackMouseBufferPosition(e) {
        const bufferPt = utils_1.bufferPositionFromMouseEvent(this.editor, e);
        if (!bufferPt) {
            return;
        }
        if (this.lastMouseBufferPt && this.lastMouseBufferPt.isEqual(bufferPt)) {
            return;
        }
        this.lastMouseBufferPt = bufferPt;
        if (this.exprTypeTimeout) {
            clearTimeout(this.exprTypeTimeout);
        }
        this.exprTypeTimeout = setTimeout(() => bufferPt && this.shouldShowTooltip(bufferPt), atom.config.get('ide-haskell.expressionTypeInterval'));
    }
    stopTrackingMouseBufferPosition(e) {
        if (this.exprTypeTimeout) {
            return clearTimeout(this.exprTypeTimeout);
        }
    }
    trackSelection({ newBufferRange }) {
        this.handleCursorUnderTooltip(newBufferRange);
        if (this.selTimeout) {
            clearTimeout(this.selTimeout);
        }
        if (newBufferRange.isEmpty()) {
            this.tooltips.hide({ type: 'selection' });
            switch (atom.config.get('ide-haskell.onCursorMove')) {
                case 'Show Tooltip':
                    if (this.exprTypeTimeout) {
                        clearTimeout(this.exprTypeTimeout);
                    }
                    if (!this.showCheckResult(newBufferRange.start, 'keyboard')) {
                        return this.tooltips.hide({ persistOnCursorMove: false });
                    }
                    break;
                case 'Hide Tooltip':
                    if (this.exprTypeTimeout) {
                        clearTimeout(this.exprTypeTimeout);
                    }
                    return this.tooltips.hide({ persistOnCursorMove: false });
                default:
            }
        }
        else {
            this.selTimeout = setTimeout(() => this.shouldShowTooltip(newBufferRange.start, 'selection'), atom.config.get('ide-haskell.expressionTypeInterval'));
        }
    }
    handleCursorUnderTooltip(currentRange) {
        const tooltipElement = document.querySelector('ide-haskell-tooltip');
        if (tooltipElement) {
            const slcl = this.editorElement.pixelRectForScreenRange(this.editor.screenRangeForBufferRange(currentRange));
            const eecl = this.editorElement.querySelector('.scroll-view').getBoundingClientRect();
            const ttcl = tooltipElement.getBoundingClientRect();
            const ttcld = tooltipElement.querySelector('div').getBoundingClientRect();
            const ttbox = {
                left: ttcl.left - eecl.left,
                top: ttcld.top - eecl.top,
                width: ttcl.width,
                height: ttcld.height
            };
            const xmax = Math.round(Math.max(ttbox.left, slcl.left));
            const xmin = Math.round(Math.min(ttbox.left + ttbox.width, slcl.left +
                slcl.width));
            const ymax = Math.round(Math.max(ttbox.top, slcl.top));
            const ymin = Math.round(Math.min(ttbox.top + ttbox.height, slcl.top +
                slcl.height));
            const tt = document.querySelector('ide-haskell-tooltip');
            if (tt) {
                if ((ymax <= ymin) && (xmax <= xmin)) {
                    tt.style.setProperty('opacity', '0.3');
                }
                else {
                    tt.style.removeProperty('opacity');
                }
            }
        }
    }
}
exports.EditorControl = EditorControl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yLWNvbnRyb2wvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFFYTtBQUViLG9DQUVpQjtBQUtqQix5REFBeUM7QUFDekMsdURBQWdEO0FBQ2hELHFEQUF5RDtBQVd6RDtJQVdFLFlBQXFCLE1BQWtCLEVBQUUsT0FBa0I7UUFBdEMsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUMsQ0FBQTtRQUNsRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDL0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ25DLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSw4QkFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDdEQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWxDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBRXBELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUN4RSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQTtRQUM3QixDQUFDO1FBR0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUs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QUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNQLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDckMsRUFBRSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQ2xCLFNBQVMsRUFBRSxLQUFLLENBQUMsQ0FBQTtnQkFDckIsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDTixFQUFFLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FDckIsU0FBUyxDQUFDLENBQUE7Z0JBQ2QsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBN1FELHNDQTZRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFJhbmdlLCBFbWl0dGVyLCBUZXh0RWRpdG9yLCBQb2ludCwgQ29tcG9zaXRlRGlzcG9zYWJsZSwgR3V0dGVyLCBEaXNwbGF5TWFya2VyLCBUZXh0QnVmZmVyXG59IGZyb20gJ2F0b20nXG5cbmltcG9ydCB7XG4gIGJ1ZmZlclBvc2l0aW9uRnJvbU1vdXNlRXZlbnRcbn0gZnJvbSAnLi4vdXRpbHMnXG5cbmltcG9ydCB7UmVzdWx0SXRlbSwgVFNldmVyaXR5fSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtUb29sdGlwTWVzc2FnZX0gZnJvbSAnLi90b29sdGlwLXZpZXcnXG5pbXBvcnQge1RNZXNzYWdlLCBNZXNzYWdlT2JqZWN0fSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7bGlzdGVufSBmcm9tICcuL2VsZW1lbnQtbGlzdGVuZXInXG5pbXBvcnQge1Rvb2x0aXBNYW5hZ2VyfSBmcm9tICcuL3Rvb2x0aXAtbWFuYWdlcidcbmltcG9ydCB7TWFya2VyTWFuYWdlciwgVEZpbmRUeXBlfSBmcm9tICcuL21hcmtlci1tYW5hZ2VyJ1xuaW1wb3J0IHtSZXN1bHRzREJ9IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5cbmV4cG9ydCB0eXBlIFRFdmVudFJhbmdlVHlwZSA9ICdrZXlib2FyZCcgfCAnY29udGV4dCcgfCAnbW91c2UnIHwgJ3NlbGVjdGlvbidcbmV4cG9ydCB0eXBlIFRUZXh0QnVmZmVyQ2FsbGJhY2sgPSAoYnVmZmVyOiBUZXh0QnVmZmVyKSA9PiB2b2lkXG5cbi8vIFRPRE86IHRoaXMgc2hvdWxkIGJlIGJvdW5kIHRvIG9uV2lsbFNhdmUgaW4gUGx1Z2luTWFuYWdlclxuLy8gaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwub25TYXZlUHJldHRpZnknKSkge1xuLy8gICByZXR1cm4gYXRvbS5jb21tYW5kcy5kaXNwYXRjaCh0aGlzLmVkaXRvckVsZW1lbnQsICdpZGUtaGFza2VsbDpwcmV0dGlmeS1maWxlJylcbi8vIH1cblxuZXhwb3J0IGNsYXNzIEVkaXRvckNvbnRyb2wge1xuICBwdWJsaWMgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUgLy8gVE9ETyBzaG91bGQgYmUgcHJpdmF0ZS4uLlxuICBwcml2YXRlIGVtaXR0ZXI6IEVtaXR0ZXJcbiAgcHJpdmF0ZSBsYXN0TW91c2VCdWZmZXJQdD86IFBvaW50XG4gIHByaXZhdGUgZXhwclR5cGVUaW1lb3V0PzogbnVtYmVyXG4gIHByaXZhdGUgc2VsVGltZW91dD86IG51bWJlclxuICBwcml2YXRlIGxhc3RNb3VzZUJ1ZmZlclB0VGVzdD86IFBvaW50XG4gIHByaXZhdGUgbGFzdE1vdXNlQnVmZmVyUmFuZ2VUZXN0PzogUmFuZ2VcbiAgcHJpdmF0ZSBlZGl0b3JFbGVtZW50OiBhbnlcbiAgcHVibGljIHRvb2x0aXBzOiBUb29sdGlwTWFuYWdlclxuICBwdWJsaWMgbWFya2VyczogTWFya2VyTWFuYWdlclxuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBlZGl0b3I6IFRleHRFZGl0b3IsIHJlc3VsdHM6IFJlc3VsdHNEQikge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKSlcbiAgICB0aGlzLnRvb2x0aXBzID0gbmV3IFRvb2x0aXBNYW5hZ2VyKHRoaXMuZWRpdG9yKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMudG9vbHRpcHMpXG4gICAgdGhpcy5tYXJrZXJzID0gbmV3IE1hcmtlck1hbmFnZXIodGhpcy5lZGl0b3IsIHJlc3VsdHMpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5tYXJrZXJzKVxuXG4gICAgdGhpcy5lZGl0b3JFbGVtZW50ID0gYXRvbS52aWV3cy5nZXRWaWV3KHRoaXMuZWRpdG9yKVxuXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpID09PSAnYnVpbHRpbicpIHtcbiAgICAgIHRoaXMucmVnaXN0ZXJHdXR0ZXJFdmVudHMoKVxuICAgIH1cblxuICAgIC8vIGJ1ZmZlciBldmVudHMgZm9yIGF1dG9tYXRpYyBjaGVja1xuICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChidWZmZXIub25XaWxsU2F2ZSgoKSA9PiB0aGlzLmVtaXR0ZXIuZW1pdCgnd2lsbC1zYXZlLWJ1ZmZlcicsIGJ1ZmZlcikpKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGJ1ZmZlci5vbkRpZFNhdmUoKCkgPT4gdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1zYXZlLWJ1ZmZlcicsIGJ1ZmZlcikpKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMuZWRpdG9yLm9uRGlkU3RvcENoYW5naW5nKCgpID0+IHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc3RvcC1jaGFuZ2luZycsIHRoaXMuZWRpdG9yKSkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lZGl0b3JFbGVtZW50Lm9uRGlkQ2hhbmdlU2Nyb2xsTGVmdCgoKSA9PiB0aGlzLnRvb2x0aXBzLmhpZGUoe3R5cGU6ICdtb3VzZSd9KSkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lZGl0b3JFbGVtZW50Lm9uRGlkQ2hhbmdlU2Nyb2xsVG9wKCgpID0+IHRoaXMudG9vbHRpcHMuaGlkZSh7dHlwZTogJ21vdXNlJ30pKSlcblxuICAgIC8vIHRvb2x0aXAgdHJhY2tpbmcgKG1vdXNlIGFuZCBzZWxlY3Rpb24pXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQobGlzdGVuKHRoaXMuZWRpdG9yRWxlbWVudCwgJ21vdXNlbW92ZScsICcuc2Nyb2xsLXZpZXcnLCB0aGlzLnRyYWNrTW91c2VCdWZmZXJQb3NpdGlvbi5iaW5kKHRoaXMpKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChsaXN0ZW4odGhpcy5lZGl0b3JFbGVtZW50LCAnbW91c2VvdXQnLCAnLnNjcm9sbC12aWV3JywgdGhpcy5zdG9wVHJhY2tpbmdNb3VzZUJ1ZmZlclBvc2l0aW9uLmJpbmQodGhpcykpKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lZGl0b3Iub25EaWRDaGFuZ2VTZWxlY3Rpb25SYW5nZSh0aGlzLnRyYWNrU2VsZWN0aW9uLmJpbmQodGhpcykpKVxuICB9XG5cbiAgcHVibGljIGRlYWN0aXZhdGUgKCkge1xuICAgIGlmICh0aGlzLmV4cHJUeXBlVGltZW91dCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwclR5cGVUaW1lb3V0KVxuICAgIH1cbiAgICBpZiAodGhpcy5zZWxUaW1lb3V0KSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5zZWxUaW1lb3V0KVxuICAgIH1cbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICAgIHRoaXMubGFzdE1vdXNlQnVmZmVyUHQgPSB1bmRlZmluZWRcbiAgfVxuXG4gIG9uU2hvdWxkU2hvd1Rvb2x0aXAgKGNhbGxiYWNrOiAoYXJnczoge2VkaXRvcjogVGV4dEVkaXRvciwgcG9zOiBQb2ludCwgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGV9KSA9PiB2b2lkKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignc2hvdWxkLXNob3ctdG9vbHRpcCcsIGNhbGxiYWNrKVxuICB9XG5cbiAgb25XaWxsU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCd3aWxsLXNhdmUtYnVmZmVyJywgY2FsbGJhY2spXG4gIH1cblxuICBvbkRpZFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXNhdmUtYnVmZmVyJywgY2FsbGJhY2spXG4gIH1cblxuICBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IChlZGl0b3I6IFRleHRFZGl0b3IpID0+IHZvaWQpIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc3RvcC1jaGFuZ2luZycsIGNhbGxiYWNrKVxuICB9XG5cbiAgc2hvdWxkU2hvd1Rvb2x0aXAgKHBvczogUG9pbnQsIHR5cGU/OiBURXZlbnRSYW5nZVR5cGUpIHtcbiAgICBpZiAoIXR5cGUpIHtcbiAgICAgIHR5cGUgPSAnbW91c2UnXG4gICAgfVxuICAgIGlmICgodHlwZSA9PT0gJ21vdXNlJyB8fCB0eXBlID09PSAna2V5Ym9hcmQnKSAmJiB0aGlzLnNob3dDaGVja1Jlc3VsdChwb3MsIHR5cGUpKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBpZiAoKHBvcy5yb3cgPCAwKSB8fFxuICAgICAgKHBvcy5yb3cgPj0gdGhpcy5lZGl0b3IuZ2V0TGluZUNvdW50KCkpIHx8XG4gICAgICBwb3MuaXNFcXVhbCh0aGlzLmVkaXRvci5idWZmZXJSYW5nZUZvckJ1ZmZlclJvdyhwb3Mucm93KS5lbmQpKSB7XG4gICAgICB0aGlzLnRvb2x0aXBzLmhpZGUoe3R5cGUsIHN1YnR5cGU6ICdleHRlcm5hbCd9KVxuICAgIH0gZWxzZSBpZiAodGhpcy5yYW5nZUhhc0NoYW5nZWQocG9zLCB0eXBlKSkge1xuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ3Nob3VsZC1zaG93LXRvb2x0aXAnLCB7XG4gICAgICAgIGVkaXRvcjogdGhpcy5lZGl0b3IsXG4gICAgICAgIHBvcyxcbiAgICAgICAgdHlwZVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICByYW5nZUhhc0NoYW5nZWQgKHBvczogUG9pbnQsIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlKSB7XG4gICAgY29uc3QgbmV3cmFuZ2UgPSB0aGlzLmdldEV2ZW50UmFuZ2UocG9zLCBldmVudFR5cGUpLmNyYW5nZVxuICAgIGNvbnN0IGlzRmlyc3RJdGVyYXRpb24gPSAhKHRoaXMubGFzdE1vdXNlQnVmZmVyUmFuZ2VUZXN0ICYmIHRoaXMubGFzdE1vdXNlQnVmZmVyUHRUZXN0KVxuICAgIGNvbnN0IGlzU2FtZVRva2VuID0gKCkgPT4ge1xuICAgICAgaWYgKCEodGhpcy5sYXN0TW91c2VCdWZmZXJSYW5nZVRlc3QgJiYgdGhpcy5sYXN0TW91c2VCdWZmZXJQdFRlc3QpKSB7IHJldHVybiBmYWxzZSB9XG4gICAgICBjb25zdCByYW5nZXNBcmVFbXB0eSA9IHRoaXMubGFzdE1vdXNlQnVmZmVyUmFuZ2VUZXN0LmlzRW1wdHkoKSAmJiBuZXdyYW5nZS5pc0VtcHR5KClcbiAgICAgIGNvbnN0IGlzU2FtZVJvdyA9IHRoaXMubGFzdE1vdXNlQnVmZmVyUHRUZXN0LnJvdyA9PT0gcG9zLnJvd1xuICAgICAgaWYgKCFyYW5nZXNBcmVFbXB0eSB8fCAhaXNTYW1lUm93KSB7XG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfVxuICAgICAgY29uc3QgdGwgPSAodGhpcy5lZGl0b3IgYXMgYW55KS50b2tlbml6ZWRCdWZmZXIudG9rZW5pemVkTGluZUZvclJvdyh0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0VGVzdC5yb3cpXG4gICAgICBjb25zdCBvbGR0b2tpZCA9IHRsLnRva2VuSW5kZXhBdEJ1ZmZlckNvbHVtbih0aGlzLmxhc3RNb3VzZUJ1ZmZlclB0VGVzdFxuICAgICAgICAuY29sdW1uKVxuICAgICAgY29uc3QgbmV3dG9raWQgPSB0bC50b2tlbkluZGV4QXRCdWZmZXJDb2x1bW4ocG9zLmNvbHVtbilcbiAgICAgIHJldHVybiBvbGR0b2tpZCA9PT0gbmV3dG9raWRcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0gaXNGaXJzdEl0ZXJhdGlvbiB8fCAhKHRoaXMubGFzdE1vdXNlQnVmZmVyUmFuZ2VUZXN0IS5pc0VxdWFsKG5ld3JhbmdlKSB8fCBpc1NhbWVUb2tlbigpKVxuICAgIHRoaXMubGFzdE1vdXNlQnVmZmVyUHRUZXN0ID0gcG9zXG4gICAgdGhpcy5sYXN0TW91c2VCdWZmZXJSYW5nZVRlc3QgPSBuZXdyYW5nZVxuICAgIHJldHVybiByZXN1bHRcbiAgfVxuXG4gIGdldEV2ZW50UmFuZ2UgKHBvczogUG9pbnQgfCB1bmRlZmluZWQsIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlKSB7XG4gICAgbGV0IGNyYW5nZTogUmFuZ2VcbiAgICBzd2l0Y2ggKGV2ZW50VHlwZSkge1xuICAgICAgY2FzZSAnbW91c2UnOlxuICAgICAgY2FzZSAnY29udGV4dCc6XG4gICAgICAgIGlmICghcG9zKSB7XG4gICAgICAgICAgcG9zID0gdGhpcy5sYXN0TW91c2VCdWZmZXJQdFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IFtzZWxSYW5nZV0gPSBBcnJheS5mcm9tKHRoaXMuZWRpdG9yLmdldFNlbGVjdGlvbnMoKVxuICAgICAgICAgIC5tYXAoKHNlbCkgPT4gc2VsLmdldEJ1ZmZlclJhbmdlKCkpLmZpbHRlcigoc2VsKSA9PiBzZWwuY29udGFpbnNQb2ludChcbiAgICAgICAgICAgIHBvcykpKVxuICAgICAgICBjcmFuZ2UgPSBzZWxSYW5nZSB8fCBuZXcgUmFuZ2UocG9zISwgcG9zISlcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ2tleWJvYXJkJzpcbiAgICAgIGNhc2UgJ3NlbGVjdGlvbic6XG4gICAgICAgIGNyYW5nZSA9IHRoaXMuZWRpdG9yLmdldExhc3RTZWxlY3Rpb24oKS5nZXRCdWZmZXJSYW5nZSgpXG4gICAgICAgIHBvcyA9IGNyYW5nZS5zdGFydFxuICAgICAgICBicmVha1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGV2ZW50IHR5cGUgJHtldmVudFR5cGV9YClcbiAgICB9XG5cbiAgICBjb25zdCBwcG9zID0gcG9zIVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNyYW5nZSwgcG9zOiBwcG9zLCBldmVudFR5cGVcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNob3dDaGVja1Jlc3VsdChwb3M6IFBvaW50LCB0eXBlOiBURmluZFR5cGUpIHtcbiAgICBjb25zdCBjaGVja01lc3NhZ2UgPSB0aGlzLm1hcmtlcnMuZ2V0TWVzc2FnZUF0KHBvcywgdHlwZSlcbiAgICBsZXQgZXZ0OiBURXZlbnRSYW5nZVR5cGVcbiAgICBpZiAodHlwZSA9PT0gJ2d1dHRlcicpIHtcbiAgICAgIGV2dCA9ICdtb3VzZSdcbiAgICB9IGVsc2Uge1xuICAgICAgZXZ0ID0gdHlwZVxuICAgIH1cbiAgICBpZiAoY2hlY2tNZXNzYWdlLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMudG9vbHRpcHMuc2hvdyhcbiAgICAgICAgbmV3IFJhbmdlKHBvcywgcG9zKSxcbiAgICAgICAgY2hlY2tNZXNzYWdlLFxuICAgICAgICB7dHlwZTogZXZ0LCBzdWJ0eXBlOiAnY2hlY2stcmVzdWx0J31cbiAgICAgIClcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudG9vbHRpcHMuaGlkZSh7dHlwZTogZXZ0LCBzdWJ0eXBlOiAnY2hlY2stcmVzdWx0J30pXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyR3V0dGVyRXZlbnRzICgpIHtcbiAgICBjb25zdCBndXR0ZXJFbGVtZW50ID0gYXRvbS52aWV3cy5nZXRWaWV3KHRoaXMubWFya2Vycy5ndXR0ZXIpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQobGlzdGVuKFxuICAgICAgZ3V0dGVyRWxlbWVudCwgJ21vdXNlb3ZlcicsICcuZGVjb3JhdGlvbicsXG4gICAgICAoZSkgPT4ge1xuICAgICAgICBjb25zdCBidWZmZXJQdCA9IGJ1ZmZlclBvc2l0aW9uRnJvbU1vdXNlRXZlbnQodGhpcy5lZGl0b3IsIGUgYXMgTW91c2VFdmVudClcbiAgICAgICAgaWYgKGJ1ZmZlclB0KSB7XG4gICAgICAgICAgdGhpcy5sYXN0TW91c2VCdWZmZXJQdCA9IGJ1ZmZlclB0XG4gICAgICAgICAgdGhpcy5zaG93Q2hlY2tSZXN1bHQoYnVmZmVyUHQsICdndXR0ZXInKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChsaXN0ZW4oXG4gICAgICBndXR0ZXJFbGVtZW50LCAnbW91c2VvdXQnLCAnLmRlY29yYXRpb24nLCAoZSkgPT4gdGhpcy50b29sdGlwcy5oaWRlKFxuICAgICAgICB7dHlwZTogJ21vdXNlJywgc3VidHlwZTogJ2NoZWNrLXJlc3VsdCd9KVxuICAgICkpXG4gIH1cblxuICBwcml2YXRlIHRyYWNrTW91c2VCdWZmZXJQb3NpdGlvbiAoZTogTW91c2VFdmVudCkge1xuICAgIGNvbnN0IGJ1ZmZlclB0ID0gYnVmZmVyUG9zaXRpb25Gcm9tTW91c2VFdmVudCh0aGlzLmVkaXRvciwgZSBhcyBNb3VzZUV2ZW50KVxuXG4gICAgaWYgKCFidWZmZXJQdCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKHRoaXMubGFzdE1vdXNlQnVmZmVyUHQgJiYgdGhpcy5sYXN0TW91c2VCdWZmZXJQdC5pc0VxdWFsKGJ1ZmZlclB0KSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHRoaXMubGFzdE1vdXNlQnVmZmVyUHQgPSBidWZmZXJQdFxuXG4gICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICAgIHRoaXMuZXhwclR5cGVUaW1lb3V0ID0gc2V0VGltZW91dChcbiAgICAgICgpID0+IGJ1ZmZlclB0ICYmIHRoaXMuc2hvdWxkU2hvd1Rvb2x0aXAoYnVmZmVyUHQpLFxuICAgICAgYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5leHByZXNzaW9uVHlwZUludGVydmFsJylcbiAgICApXG4gIH1cblxuICBwcml2YXRlIHN0b3BUcmFja2luZ01vdXNlQnVmZmVyUG9zaXRpb24gKGU6IE1vdXNlRXZlbnQpIHtcbiAgICBpZiAodGhpcy5leHByVHlwZVRpbWVvdXQpIHtcbiAgICAgIHJldHVybiBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0cmFja1NlbGVjdGlvbiAoe25ld0J1ZmZlclJhbmdlfToge25ld0J1ZmZlclJhbmdlOiBSYW5nZX0pIHtcbiAgICB0aGlzLmhhbmRsZUN1cnNvclVuZGVyVG9vbHRpcChuZXdCdWZmZXJSYW5nZSlcblxuICAgIGlmICh0aGlzLnNlbFRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnNlbFRpbWVvdXQpXG4gICAgfVxuICAgIGlmIChuZXdCdWZmZXJSYW5nZS5pc0VtcHR5KCkpIHtcbiAgICAgIHRoaXMudG9vbHRpcHMuaGlkZSh7dHlwZTogJ3NlbGVjdGlvbid9KVxuICAgICAgc3dpdGNoIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm9uQ3Vyc29yTW92ZScpKSB7XG4gICAgICAgIGNhc2UgJ1Nob3cgVG9vbHRpcCc6XG4gICAgICAgICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghdGhpcy5zaG93Q2hlY2tSZXN1bHQobmV3QnVmZmVyUmFuZ2Uuc3RhcnQsICdrZXlib2FyZCcpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy50b29sdGlwcy5oaWRlKHtwZXJzaXN0T25DdXJzb3JNb3ZlOiBmYWxzZX0pXG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgJ0hpZGUgVG9vbHRpcCc6XG4gICAgICAgICAgaWYgKHRoaXMuZXhwclR5cGVUaW1lb3V0KSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5leHByVHlwZVRpbWVvdXQpXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0aGlzLnRvb2x0aXBzLmhpZGUoe3BlcnNpc3RPbkN1cnNvck1vdmU6IGZhbHNlfSlcbiAgICAgICAgZGVmYXVsdDogLy8gaW1wb3NzaWJsZSwgYnV0IHRzbGludCBjb21wbGFpbnNcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZWxUaW1lb3V0ID0gc2V0VGltZW91dChcbiAgICAgICAgKCkgPT4gdGhpcy5zaG91bGRTaG93VG9vbHRpcChuZXdCdWZmZXJSYW5nZS5zdGFydCwgJ3NlbGVjdGlvbicpLFxuICAgICAgICBhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLmV4cHJlc3Npb25UeXBlSW50ZXJ2YWwnKVxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlQ3Vyc29yVW5kZXJUb29sdGlwIChjdXJyZW50UmFuZ2U6IFJhbmdlKSB7XG4gICAgY29uc3QgdG9vbHRpcEVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdpZGUtaGFza2VsbC10b29sdGlwJylcbiAgICBpZiAodG9vbHRpcEVsZW1lbnQpIHtcbiAgICAgIGNvbnN0IHNsY2wgPSB0aGlzLmVkaXRvckVsZW1lbnQucGl4ZWxSZWN0Rm9yU2NyZWVuUmFuZ2UodGhpcy5lZGl0b3Iuc2NyZWVuUmFuZ2VGb3JCdWZmZXJSYW5nZShjdXJyZW50UmFuZ2UpKVxuICAgICAgY29uc3QgZWVjbCA9IHRoaXMuZWRpdG9yRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuc2Nyb2xsLXZpZXcnKS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgICAgY29uc3QgdHRjbCA9IHRvb2x0aXBFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgICBjb25zdCB0dGNsZCA9IHRvb2x0aXBFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2RpdicpIS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgICAgY29uc3QgdHRib3ggPSB7XG4gICAgICAgIGxlZnQ6IHR0Y2wubGVmdCAtIGVlY2wubGVmdCxcbiAgICAgICAgdG9wOiB0dGNsZC50b3AgLSBlZWNsLnRvcCxcbiAgICAgICAgd2lkdGg6IHR0Y2wud2lkdGgsXG4gICAgICAgIGhlaWdodDogdHRjbGQuaGVpZ2h0XG4gICAgICB9XG4gICAgICBjb25zdCB4bWF4ID0gTWF0aC5yb3VuZChNYXRoLm1heCh0dGJveC5sZWZ0LCBzbGNsLmxlZnQpKVxuICAgICAgY29uc3QgeG1pbiA9IE1hdGgucm91bmQoTWF0aC5taW4odHRib3gubGVmdCArIHR0Ym94LndpZHRoLCBzbGNsLmxlZnQgK1xuICAgICAgICBzbGNsLndpZHRoKSlcbiAgICAgIGNvbnN0IHltYXggPSBNYXRoLnJvdW5kKE1hdGgubWF4KHR0Ym94LnRvcCwgc2xjbC50b3ApKVxuICAgICAgY29uc3QgeW1pbiA9IE1hdGgucm91bmQoTWF0aC5taW4odHRib3gudG9wICsgdHRib3guaGVpZ2h0LCBzbGNsLnRvcCArXG4gICAgICAgIHNsY2wuaGVpZ2h0KSlcbiAgICAgIGNvbnN0IHR0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaWRlLWhhc2tlbGwtdG9vbHRpcCcpIGFzIEhUTUxFbGVtZW50XG4gICAgICBpZiAodHQpIHtcbiAgICAgICAgaWYgKCh5bWF4IDw9IHltaW4pICYmICh4bWF4IDw9IHhtaW4pKSB7XG4gICAgICAgICAgdHQuc3R5bGUuc2V0UHJvcGVydHkoXG4gICAgICAgICAgICAnb3BhY2l0eScsICcwLjMnKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHR0LnN0eWxlLnJlbW92ZVByb3BlcnR5KFxuICAgICAgICAgICAgJ29wYWNpdHknKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=