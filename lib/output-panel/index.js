'use babel';
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const etch_1 = require("etch");
const atom_1 = require("atom");
const output_panel_buttons_1 = require("./views/output-panel-buttons");
const output_panel_checkbox_1 = require("./views/output-panel-checkbox");
const progress_bar_1 = require("./views/progress-bar");
const output_panel_items_1 = require("./views/output-panel-items");
const $ = etch_1.default.dom;
class OutputPanel {
    constructor(state, results) {
        this.state = state || {};
        this.results = results;
        this.hiddenOutput = true;
        this.elements = new Set();
        this.statusMap = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        etch_1.default.initialize(this);
        atom.config.observe('ide-haskell.panelPosition', (value) => {
            this.pos = value;
            this.panel = atom.workspace.addPanel(this.pos, {
                item: this,
                visible: this.state.visibility || true
            });
            if (this.element) {
                this.update();
            }
        });
        this.disposables.add(atom.tooltips.add(this.refs.status, {
            'class': 'ide-haskell-status-tooltip',
            title: () => {
                let res = [];
                for (let [plugin, { status, detail }] of this.statusMap.entries()) {
                    res.push(`
          <ide-haskell-status-item>
            <ide-haskell-status-icon data-status="${status}">${plugin}</ide-haskell-status-icon>
            <ide-haskell-status-detail>${detail || ''}</ide-haskell-status-detail>
          </ide-haskell-status-item>
          `);
                }
                return res.join('');
            }
        }));
        this.disposables.add(this.results.onDidUpdate(({ types }) => {
            this.currentResult = null;
            if (atom.config.get('ide-haskell.autoHideOutput') &&
                types.map((type) => this.results.filter({ severity: type }).length).every((l) => l === 0)) {
                this.buttons.disableAll();
            }
            else {
                if (atom.config.get('ide-haskell.switchTabOnCheck')) {
                    this.activateFirstNonEmptyTab(types);
                }
            }
            this.updateItems();
        }));
        this.setProgress(NaN);
        this.disposables.add(this.refs.buttons.onButtonClicked(() => this.updateItems()));
        this.disposables.add(this.refs.checkboxUriFilter.onCheckboxSwitched(() => this.updateItems()));
        this.disposables.add(atom.workspace.onDidChangeActivePaneItem(() => {
            if (this.refs.checkboxUriFilter.getFileFilter())
                this.updateItems();
        }));
    }
    render() {
        let orientMap = {
            'top': 'horizontal',
            'bottom': 'horizontal',
            'left': 'vertical',
            'right': 'vertical'
        };
        return (etch_1.default.dom("ide-haskell-panel", { style: { width: this.state.width, height: this.state.height }, dataset: { pos: this.pos }, class: this.hiddenOutput ? 'hidden-output' : '' },
            etch_1.default.dom("resize-handle", { on: { mousedown: this.resizeStart } }),
            etch_1.default.dom("ide-haskell-panel-heading", { ref: 'heading' },
                etch_1.default.dom("ide-haskell-status-icon", { ref: 'status', id: 'status', dataset: { status: 'ready' } }),
                etch_1.default.dom(output_panel_buttons_1.OutputPanelButtons, { ref: 'buttons', id: 'buttons' }),
                etch_1.default.dom(output_panel_checkbox_1.OutputPanelCheckbox, { ref: 'checkboxUriFilter', id: 'checkboxUriFilter', enabled: this.state.fileFilter }),
                Array.from(this.elements.values()),
                etch_1.default.dom(progress_bar_1.ProgressBar, { ref: 'progressBar', id: 'progressBar', orientation: orientMap[this.pos] })),
            etch_1.default.dom(output_panel_items_1.OutputPanelItems, { model: this.results, ref: 'items', id: 'items' })));
    }
    resizeStart(e) {
        let varsMap = {
            'top': { axis: 'Y', param: 'height', dir: 1 },
            'bottom': { axis: 'Y', param: 'height', dir: -1 },
            'left': { axis: 'X', param: 'width', dir: 1 },
            'right': { axis: 'X', param: 'width', dir: -1 }
        };
        let vars = varsMap[this.pos];
        vars.axis = `client${vars.axis}`;
        let startAxis = e[vars.axis];
        let startParam = parseInt(document.defaultView.getComputedStyle(this.element)[vars.param], 10);
        let doDrag = (e) => {
            this.state[vars.param] =
                (startParam + vars.dir * (e[vars.axis] - startAxis)) + 'px';
            this.update();
        };
        let stopDrag = () => {
            document.documentElement.removeEventListener('mousemove', doDrag);
            document.documentElement.removeEventListener('mouseup', stopDrag);
        };
        document.documentElement.addEventListener('mousemove', doDrag);
        document.documentElement.addEventListener('mouseup', stopDrag);
    }
    update() {
        return etch_1.default.update(this);
    }
    destroy() {
        return __awaiter(this, void 0, void 0, function* () {
            yield etch_1.default.destroy(this);
            this.disposables.dispose();
            this.panel.destroy();
            this.statusMap.clear();
            this.statusMap = null;
        });
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            let { events, classes, style, attrs } = opts;
            let props = {};
            if (classes)
                props.class = classes.join(' ');
            if (style)
                props.style = style;
            if (attrs)
                props.attributes = attrs;
            if (events)
                props.on = events;
            element = $(element, props);
        }
        else {
            element = $(element, opts);
        }
        this.elements.add(element);
        this.update();
        return new atom_1.Disposable(() => {
            this.elements.delete(element);
            this.update();
        });
    }
    updateItems() {
        let activeTab = this.getActiveTab();
        let uri;
        if (activeTab) {
            this.hiddenOutput = false;
            let filter = { severity: activeTab };
            if (this.refs.checkboxUriFilter.getFileFilter()) {
                uri = atom.workspace.getActiveTextEditor().getPath();
                if (uri && this.refs.buttons.options(activeTab).uriFilter) {
                    filter.uri = uri;
                }
            }
            let scroll = this.refs.buttons.options(activeTab).autoScroll && this.refs.items.atEnd();
            this.refs.items.filter(filter);
            if (scroll)
                this.refs.items.scrollToEnd();
        }
        else {
            this.hiddenOutput = true;
        }
        this.refs.buttons.buttonNames().forEach((btn) => {
            let f = { severity: btn };
            if (uri && this.refs.buttons.options(btn).uriFilter)
                f.uri = uri;
            this.refs.buttons.setCount(btn, this.results.filter(f).length);
        });
        this.update();
    }
    activateTab(tab) {
        this.refs.buttons.clickButton(tab, true);
    }
    activateFirstNonEmptyTab(types) {
        let names = this.refs.buttons.buttonNames();
        for (let i in names) {
            let name = names[i];
            if (!types || types.includes(name)) {
                if ((this.results.filter({ severity: name })).length > 0) {
                    this.activateTab(name);
                    break;
                }
            }
        }
    }
    showItem(item) {
        this.activateTab(item.severity);
        this.refs.items.showItem(item);
    }
    getActiveTab() {
        return this.refs.buttons.getActive();
    }
    createTab(name, opts) {
        if (!this.refs.buttons.buttonNames().includes(name)) {
            this.refs.buttons.createButton(name, opts);
            this.activateTab(this.state.activeTab);
        }
    }
    setProgress(progress) {
        this.refs.progressBar.setProgress(progress);
    }
    toggle() {
        if (this.panel.isVisible())
            this.panel.hide();
        else
            this.panel.show();
    }
    serialize() {
        return {
            visibility: this.panel.isVisible(),
            height: this.element.style.height,
            width: this.element.style.width,
            activeTab: this.getActiveTab(),
            fileFilter: this.refs.checkboxUriFilter.getFileFilter()
        };
    }
    backendStatus(pluginName, { status, progress, detail }) {
        let prio = {
            progress: 5,
            error: 20,
            warning: 10,
            ready: 0
        };
        this.statusMap.set(pluginName, { status, progress, detail });
        let stArr = Array.from(this.statusMap.values());
        let [consensus] = stArr.sort((a, b) => prio[b.status] - prio[a.status]);
        this.refs.status.setAttribute('data-status', consensus.status);
        let progressArr = stArr.filter(({ status, progress }) => status === 'progress' && progress !== undefined);
        let progressAve = progressArr.reduce((acc, { progress }) => acc + progress, 0) / progressArr.length;
        this.setProgress(progressAve);
    }
    showNextError() {
        let rs = this.results.resultsWithURI();
        if (rs.length === 0)
            return;
        if (this.currentResult !== null && this.currentResult !== undefined) {
            this.currentResult++;
        }
        else {
            this.currentResult = 0;
        }
        if (this.currentResult >= rs.length)
            this.currentResult = 0;
        this.showItem(rs[this.currentResult]);
    }
    showPrevError() {
        let rs = this.results.resultsWithURI();
        if (rs.length === 0)
            return;
        if (this.currentResult !== null && this.currentResult !== undefined) {
            this.currentResult--;
        }
        else {
            this.currentResult = rs.length - 1;
        }
        if (this.currentResult < 0)
            this.currentResult = rs.length - 1;
        this.showItem(rs[this.currentResult]);
    }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvb3V0cHV0LXBhbmVsL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQTs7Ozs7Ozs7OztBQUdYLCtCQUF1QjtBQUN2QiwrQkFBb0Q7QUFDcEQsdUVBQStEO0FBQy9ELHlFQUFpRTtBQUNqRSx1REFBZ0Q7QUFDaEQsbUVBQTJEO0FBQzNELE1BQU0sQ0FBQyxHQUFHLGNBQUksQ0FBQyxHQUFHLENBQUE7QUFFbEI7SUFDRSxZQUFhLEtBQUssRUFBRSxPQUFPO1FBQ3pCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQTtRQUN4QixJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQTtRQUV0QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQTtRQUV4QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFFekIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFBO1FBRTFCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBRTVDLGNBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFckIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsMkJBQTJCLEVBQUUsQ0FBQyxLQUFLO1lBQ3JELElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFBO1lBQ2hCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDN0MsSUFBSSxFQUFFLElBQUk7Z0JBQ1YsT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxJQUFJLElBQUk7YUFDdkMsQ0FBQyxDQUFBO1lBQ0YsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7Z0JB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c0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcbi8qKiBAanN4IGV0Y2guZG9tICovXG5cbmltcG9ydCBldGNoIGZyb20gJ2V0Y2gnXG5pbXBvcnQge0Rpc3Bvc2FibGUsIENvbXBvc2l0ZURpc3Bvc2FibGV9IGZyb20gJ2F0b20nXG5pbXBvcnQge091dHB1dFBhbmVsQnV0dG9uc30gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtYnV0dG9ucydcbmltcG9ydCB7T3V0cHV0UGFuZWxDaGVja2JveH0gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtY2hlY2tib3gnXG5pbXBvcnQge1Byb2dyZXNzQmFyfSBmcm9tICcuL3ZpZXdzL3Byb2dyZXNzLWJhcidcbmltcG9ydCB7T3V0cHV0UGFuZWxJdGVtc30gZnJvbSAnLi92aWV3cy9vdXRwdXQtcGFuZWwtaXRlbXMnXG5jb25zdCAkID0gZXRjaC5kb21cblxuZXhwb3J0IGNsYXNzIE91dHB1dFBhbmVsIHtcbiAgY29uc3RydWN0b3IgKHN0YXRlLCByZXN1bHRzKSB7XG4gICAgdGhpcy5zdGF0ZSA9IHN0YXRlIHx8IHt9XG4gICAgdGhpcy5yZXN1bHRzID0gcmVzdWx0c1xuXG4gICAgdGhpcy5oaWRkZW5PdXRwdXQgPSB0cnVlXG5cbiAgICB0aGlzLmVsZW1lbnRzID0gbmV3IFNldCgpXG5cbiAgICB0aGlzLnN0YXR1c01hcCA9IG5ldyBNYXAoKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcblxuICAgIGV0Y2guaW5pdGlhbGl6ZSh0aGlzKVxuXG4gICAgYXRvbS5jb25maWcub2JzZXJ2ZSgnaWRlLWhhc2tlbGwucGFuZWxQb3NpdGlvbicsICh2YWx1ZSkgPT4ge1xuICAgICAgdGhpcy5wb3MgPSB2YWx1ZVxuICAgICAgdGhpcy5wYW5lbCA9IGF0b20ud29ya3NwYWNlLmFkZFBhbmVsKHRoaXMucG9zLCB7XG4gICAgICAgIGl0ZW06IHRoaXMsXG4gICAgICAgIHZpc2libGU6IHRoaXMuc3RhdGUudmlzaWJpbGl0eSB8fCB0cnVlXG4gICAgICB9KVxuICAgICAgaWYgKHRoaXMuZWxlbWVudCkge1xuICAgICAgICB0aGlzLnVwZGF0ZSgpXG4gICAgICB9XG4gICAgfSlcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGF0b20udG9vbHRpcHMuYWRkKHRoaXMucmVmcy5zdGF0dXMsIHtcbiAgICAgICdjbGFzcyc6ICdpZGUtaGFza2VsbC1zdGF0dXMtdG9vbHRpcCcsXG4gICAgICB0aXRsZTogKCkgPT4ge1xuICAgICAgICBsZXQgcmVzID0gW11cbiAgICAgICAgZm9yIChsZXQgW3BsdWdpbiwge3N0YXR1cywgZGV0YWlsfV0gb2YgdGhpcy5zdGF0dXNNYXAuZW50cmllcygpKSB7XG4gICAgICAgICAgcmVzLnB1c2goYFxuICAgICAgICAgIDxpZGUtaGFza2VsbC1zdGF0dXMtaXRlbT5cbiAgICAgICAgICAgIDxpZGUtaGFza2VsbC1zdGF0dXMtaWNvbiBkYXRhLXN0YXR1cz1cIiR7c3RhdHVzfVwiPiR7cGx1Z2lufTwvaWRlLWhhc2tlbGwtc3RhdHVzLWljb24+XG4gICAgICAgICAgICA8aWRlLWhhc2tlbGwtc3RhdHVzLWRldGFpbD4ke2RldGFpbCB8fCAnJ308L2lkZS1oYXNrZWxsLXN0YXR1cy1kZXRhaWw+XG4gICAgICAgICAgPC9pZGUtaGFza2VsbC1zdGF0dXMtaXRlbT5cbiAgICAgICAgICBgKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXMuam9pbignJylcbiAgICAgIH1cbiAgICB9KSlcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVzdWx0cy5vbkRpZFVwZGF0ZSgoe3R5cGVzfSkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50UmVzdWx0ID0gbnVsbFxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwuYXV0b0hpZGVPdXRwdXQnKSAmJlxuICAgICAgICAgIHR5cGVzLm1hcCgodHlwZSkgPT4gdGhpcy5yZXN1bHRzLmZpbHRlcih7c2V2ZXJpdHk6IHR5cGV9KS5sZW5ndGgpLmV2ZXJ5KChsKSA9PiBsID09PSAwKSkge1xuICAgICAgICB0aGlzLmJ1dHRvbnMuZGlzYWJsZUFsbCgpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5zd2l0Y2hUYWJPbkNoZWNrJykpIHtcbiAgICAgICAgICB0aGlzLmFjdGl2YXRlRmlyc3ROb25FbXB0eVRhYih0eXBlcylcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy51cGRhdGVJdGVtcygpXG4gICAgfSkpXG5cbiAgICB0aGlzLnNldFByb2dyZXNzKE5hTilcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVmcy5idXR0b25zLm9uQnV0dG9uQ2xpY2tlZCgoKSA9PiB0aGlzLnVwZGF0ZUl0ZW1zKCkpKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucmVmcy5jaGVja2JveFVyaUZpbHRlci5vbkNoZWNrYm94U3dpdGNoZWQoKCkgPT4gdGhpcy51cGRhdGVJdGVtcygpKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChhdG9tLndvcmtzcGFjZS5vbkRpZENoYW5nZUFjdGl2ZVBhbmVJdGVtKCgpID0+IHtcbiAgICAgIGlmICh0aGlzLnJlZnMuY2hlY2tib3hVcmlGaWx0ZXIuZ2V0RmlsZUZpbHRlcigpKSB0aGlzLnVwZGF0ZUl0ZW1zKClcbiAgICB9KSlcbiAgfVxuXG4gIHJlbmRlciAoKSB7XG4gICAgbGV0IG9yaWVudE1hcCA9IHtcbiAgICAgICd0b3AnOiAnaG9yaXpvbnRhbCcsXG4gICAgICAnYm90dG9tJzogJ2hvcml6b250YWwnLFxuICAgICAgJ2xlZnQnOiAndmVydGljYWwnLFxuICAgICAgJ3JpZ2h0JzogJ3ZlcnRpY2FsJ1xuICAgIH1cbiAgICByZXR1cm4gKFxuICAgICAgPGlkZS1oYXNrZWxsLXBhbmVsIHN0eWxlPXt7d2lkdGg6IHRoaXMuc3RhdGUud2lkdGgsIGhlaWdodDogdGhpcy5zdGF0ZS5oZWlnaHR9fVxuICAgICAgICBkYXRhc2V0PXt7cG9zOiB0aGlzLnBvc319XG4gICAgICAgIGNsYXNzPXt0aGlzLmhpZGRlbk91dHB1dCA/ICdoaWRkZW4tb3V0cHV0JyA6ICcnfT5cbiAgICAgICAgPHJlc2l6ZS1oYW5kbGUgb249e3ttb3VzZWRvd246IHRoaXMucmVzaXplU3RhcnR9fSAvPlxuICAgICAgICA8aWRlLWhhc2tlbGwtcGFuZWwtaGVhZGluZyByZWY9J2hlYWRpbmcnPlxuICAgICAgICAgIDxpZGUtaGFza2VsbC1zdGF0dXMtaWNvbiByZWY9J3N0YXR1cycgaWQ9J3N0YXR1cycgZGF0YXNldD17e3N0YXR1czogJ3JlYWR5J319Lz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxCdXR0b25zIHJlZj0nYnV0dG9ucycgaWQ9J2J1dHRvbnMnLz5cbiAgICAgICAgICA8T3V0cHV0UGFuZWxDaGVja2JveCByZWY9J2NoZWNrYm94VXJpRmlsdGVyJyBpZD0nY2hlY2tib3hVcmlGaWx0ZXInXG4gICAgICAgICAgICBlbmFibGVkPXt0aGlzLnN0YXRlLmZpbGVGaWx0ZXJ9Lz5cbiAgICAgICAgICB7QXJyYXkuZnJvbSh0aGlzLmVsZW1lbnRzLnZhbHVlcygpKX1cbiAgICAgICAgICA8UHJvZ3Jlc3NCYXIgcmVmPSdwcm9ncmVzc0JhcicgaWQ9J3Byb2dyZXNzQmFyJ1xuICAgICAgICAgICAgb3JpZW50YXRpb249e29yaWVudE1hcFt0aGlzLnBvc119Lz5cbiAgICAgICAgPC9pZGUtaGFza2VsbC1wYW5lbC1oZWFkaW5nPlxuICAgICAgICA8T3V0cHV0UGFuZWxJdGVtcyBtb2RlbD17dGhpcy5yZXN1bHRzfSByZWY9J2l0ZW1zJyBpZD0naXRlbXMnLz5cbiAgICAgIDwvaWRlLWhhc2tlbGwtcGFuZWw+XG4gICAgKVxuICB9XG5cbiAgcmVzaXplU3RhcnQgKGUpIHtcbiAgICBsZXQgdmFyc01hcCA9IHtcbiAgICAgICd0b3AnOiB7YXhpczogJ1knLCBwYXJhbTogJ2hlaWdodCcsIGRpcjogMX0sXG4gICAgICAnYm90dG9tJzoge2F4aXM6ICdZJywgcGFyYW06ICdoZWlnaHQnLCBkaXI6IC0xfSxcbiAgICAgICdsZWZ0Jzoge2F4aXM6ICdYJywgcGFyYW06ICd3aWR0aCcsIGRpcjogMX0sXG4gICAgICAncmlnaHQnOiB7YXhpczogJ1gnLCBwYXJhbTogJ3dpZHRoJywgZGlyOiAtMX1cbiAgICB9XG5cbiAgICBsZXQgdmFycyA9IHZhcnNNYXBbdGhpcy5wb3NdXG5cbiAgICB2YXJzLmF4aXMgPSBgY2xpZW50JHt2YXJzLmF4aXN9YFxuICAgIGxldCBzdGFydEF4aXMgPSBlW3ZhcnMuYXhpc11cbiAgICBsZXQgc3RhcnRQYXJhbSA9IHBhcnNlSW50KGRvY3VtZW50LmRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUodGhpcy5lbGVtZW50KVt2YXJzLnBhcmFtXSwgMTApXG5cbiAgICBsZXQgZG9EcmFnID0gKGUpID0+IHtcbiAgICAgIHRoaXMuc3RhdGVbdmFycy5wYXJhbV0gPVxuICAgICAgICAoc3RhcnRQYXJhbSArIHZhcnMuZGlyICogKGVbdmFycy5heGlzXSAtIHN0YXJ0QXhpcykpICsgJ3B4J1xuICAgICAgdGhpcy51cGRhdGUoKVxuICAgIH1cbiAgICBsZXQgc3RvcERyYWcgPSAoKSA9PiB7XG4gICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgZG9EcmFnKVxuICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBzdG9wRHJhZylcbiAgICB9XG5cbiAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgZG9EcmFnKVxuICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgc3RvcERyYWcpXG4gIH1cblxuICB1cGRhdGUgKCkge1xuICAgIHJldHVybiBldGNoLnVwZGF0ZSh0aGlzKVxuICB9XG5cbiAgYXN5bmMgZGVzdHJveSAoKSB7XG4gICAgYXdhaXQgZXRjaC5kZXN0cm95KHRoaXMpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLnBhbmVsLmRlc3Ryb3koKVxuICAgIHRoaXMuc3RhdHVzTWFwLmNsZWFyKClcbiAgICB0aGlzLnN0YXR1c01hcCA9IG51bGxcbiAgfVxuXG4gIGFkZFBhbmVsQ29udHJvbCAoZWxlbWVudCwgb3B0cykge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGxldCB7ZXZlbnRzLCBjbGFzc2VzLCBzdHlsZSwgYXR0cnN9ID0gb3B0c1xuICAgICAgbGV0IHByb3BzID0ge31cbiAgICAgIGlmIChjbGFzc2VzKSBwcm9wcy5jbGFzcyA9IGNsYXNzZXMuam9pbignICcpXG4gICAgICBpZiAoc3R5bGUpIHByb3BzLnN0eWxlID0gc3R5bGVcbiAgICAgIGlmIChhdHRycykgcHJvcHMuYXR0cmlidXRlcyA9IGF0dHJzXG4gICAgICBpZiAoZXZlbnRzKSBwcm9wcy5vbiA9IGV2ZW50c1xuXG4gICAgICBlbGVtZW50ID0gJChlbGVtZW50LCBwcm9wcylcbiAgICB9IGVsc2Uge1xuICAgICAgZWxlbWVudCA9ICQoZWxlbWVudCwgb3B0cylcbiAgICB9XG4gICAgdGhpcy5lbGVtZW50cy5hZGQoZWxlbWVudClcbiAgICB0aGlzLnVwZGF0ZSgpXG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuZWxlbWVudHMuZGVsZXRlKGVsZW1lbnQpXG4gICAgICB0aGlzLnVwZGF0ZSgpXG4gICAgfSlcbiAgfVxuXG4gIHVwZGF0ZUl0ZW1zICgpIHtcbiAgICBsZXQgYWN0aXZlVGFiID0gdGhpcy5nZXRBY3RpdmVUYWIoKVxuICAgIGxldCB1cmlcbiAgICBpZiAoYWN0aXZlVGFiKSB7XG4gICAgICB0aGlzLmhpZGRlbk91dHB1dCA9IGZhbHNlXG4gICAgICBsZXQgZmlsdGVyID0ge3NldmVyaXR5OiBhY3RpdmVUYWJ9XG4gICAgICBpZiAodGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldEZpbGVGaWx0ZXIoKSkge1xuICAgICAgICB1cmkgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkuZ2V0UGF0aCgpXG4gICAgICAgIGlmICh1cmkgJiYgdGhpcy5yZWZzLmJ1dHRvbnMub3B0aW9ucyhhY3RpdmVUYWIpLnVyaUZpbHRlcikge1xuICAgICAgICAgIGZpbHRlci51cmkgPSB1cmlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbGV0IHNjcm9sbCA9IHRoaXMucmVmcy5idXR0b25zLm9wdGlvbnMoYWN0aXZlVGFiKS5hdXRvU2Nyb2xsICYmIHRoaXMucmVmcy5pdGVtcy5hdEVuZCgpXG4gICAgICB0aGlzLnJlZnMuaXRlbXMuZmlsdGVyKGZpbHRlcilcbiAgICAgIGlmIChzY3JvbGwpIHRoaXMucmVmcy5pdGVtcy5zY3JvbGxUb0VuZCgpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaGlkZGVuT3V0cHV0ID0gdHJ1ZVxuICAgIH1cblxuICAgIHRoaXMucmVmcy5idXR0b25zLmJ1dHRvbk5hbWVzKCkuZm9yRWFjaCgoYnRuKSA9PiB7XG4gICAgICBsZXQgZiA9IHtzZXZlcml0eTogYnRufVxuICAgICAgaWYgKHVyaSAmJiB0aGlzLnJlZnMuYnV0dG9ucy5vcHRpb25zKGJ0bikudXJpRmlsdGVyKSBmLnVyaSA9IHVyaVxuICAgICAgdGhpcy5yZWZzLmJ1dHRvbnMuc2V0Q291bnQoYnRuLCB0aGlzLnJlc3VsdHMuZmlsdGVyKGYpLmxlbmd0aClcbiAgICB9KVxuICAgIHRoaXMudXBkYXRlKClcbiAgfVxuXG4gIGFjdGl2YXRlVGFiICh0YWIpIHtcbiAgICB0aGlzLnJlZnMuYnV0dG9ucy5jbGlja0J1dHRvbih0YWIsIHRydWUpXG4gIH1cblxuICBhY3RpdmF0ZUZpcnN0Tm9uRW1wdHlUYWIgKHR5cGVzKSB7XG4gICAgbGV0IG5hbWVzID0gdGhpcy5yZWZzLmJ1dHRvbnMuYnV0dG9uTmFtZXMoKVxuICAgIGZvciAobGV0IGkgaW4gbmFtZXMpIHtcbiAgICAgIGxldCBuYW1lID0gbmFtZXNbaV1cbiAgICAgIGlmICghdHlwZXMgfHwgdHlwZXMuaW5jbHVkZXMobmFtZSkpIHtcbiAgICAgICAgaWYgKCh0aGlzLnJlc3VsdHMuZmlsdGVyKHtzZXZlcml0eTogbmFtZX0pKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhpcy5hY3RpdmF0ZVRhYihuYW1lKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzaG93SXRlbSAoaXRlbSkge1xuICAgIHRoaXMuYWN0aXZhdGVUYWIoaXRlbS5zZXZlcml0eSlcbiAgICB0aGlzLnJlZnMuaXRlbXMuc2hvd0l0ZW0oaXRlbSlcbiAgfVxuXG4gIGdldEFjdGl2ZVRhYiAoKSB7XG4gICAgcmV0dXJuIHRoaXMucmVmcy5idXR0b25zLmdldEFjdGl2ZSgpXG4gIH1cblxuICBjcmVhdGVUYWIgKG5hbWUsIG9wdHMpIHtcbiAgICBpZiAoIXRoaXMucmVmcy5idXR0b25zLmJ1dHRvbk5hbWVzKCkuaW5jbHVkZXMobmFtZSkpIHtcbiAgICAgIHRoaXMucmVmcy5idXR0b25zLmNyZWF0ZUJ1dHRvbihuYW1lLCBvcHRzKVxuICAgICAgdGhpcy5hY3RpdmF0ZVRhYih0aGlzLnN0YXRlLmFjdGl2ZVRhYilcbiAgICB9XG4gIH1cblxuICBzZXRQcm9ncmVzcyAocHJvZ3Jlc3MpIHtcbiAgICB0aGlzLnJlZnMucHJvZ3Jlc3NCYXIuc2V0UHJvZ3Jlc3MocHJvZ3Jlc3MpXG4gIH1cblxuICB0b2dnbGUgKCkge1xuICAgIGlmICh0aGlzLnBhbmVsLmlzVmlzaWJsZSgpKSB0aGlzLnBhbmVsLmhpZGUoKVxuICAgIGVsc2UgdGhpcy5wYW5lbC5zaG93KClcbiAgfVxuXG4gIHNlcmlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHZpc2liaWxpdHk6IHRoaXMucGFuZWwuaXNWaXNpYmxlKCksXG4gICAgICBoZWlnaHQ6IHRoaXMuZWxlbWVudC5zdHlsZS5oZWlnaHQsXG4gICAgICB3aWR0aDogdGhpcy5lbGVtZW50LnN0eWxlLndpZHRoLFxuICAgICAgYWN0aXZlVGFiOiB0aGlzLmdldEFjdGl2ZVRhYigpLFxuICAgICAgZmlsZUZpbHRlcjogdGhpcy5yZWZzLmNoZWNrYm94VXJpRmlsdGVyLmdldEZpbGVGaWx0ZXIoKVxuICAgIH1cbiAgfVxuXG4gIGJhY2tlbmRTdGF0dXMgKHBsdWdpbk5hbWUsIHtzdGF0dXMsIHByb2dyZXNzLCBkZXRhaWx9KSB7XG4gICAgbGV0IHByaW8gPSB7XG4gICAgICBwcm9ncmVzczogNSxcbiAgICAgIGVycm9yOiAyMCxcbiAgICAgIHdhcm5pbmc6IDEwLFxuICAgICAgcmVhZHk6IDBcbiAgICB9XG4gICAgdGhpcy5zdGF0dXNNYXAuc2V0KHBsdWdpbk5hbWUsIHtzdGF0dXMsIHByb2dyZXNzLCBkZXRhaWx9KVxuICAgIGxldCBzdEFyciA9IEFycmF5LmZyb20odGhpcy5zdGF0dXNNYXAudmFsdWVzKCkpXG4gICAgbGV0IFtjb25zZW5zdXNdID0gc3RBcnIuc29ydCgoYSwgYikgPT4gcHJpb1tiLnN0YXR1c10gLSBwcmlvW2Euc3RhdHVzXSlcbiAgICB0aGlzLnJlZnMuc3RhdHVzLnNldEF0dHJpYnV0ZSgnZGF0YS1zdGF0dXMnLCBjb25zZW5zdXMuc3RhdHVzKVxuICAgIGxldCBwcm9ncmVzc0FyciA9IHN0QXJyLmZpbHRlcihcbiAgICAgICh7c3RhdHVzLCBwcm9ncmVzc30pID0+IHN0YXR1cyA9PT0gJ3Byb2dyZXNzJyAmJiBwcm9ncmVzcyAhPT0gdW5kZWZpbmVkXG4gICAgKVxuICAgIGxldCBwcm9ncmVzc0F2ZSA9IHByb2dyZXNzQXJyLnJlZHVjZSgoYWNjLCB7cHJvZ3Jlc3N9KSA9PiBhY2MgKyBwcm9ncmVzcywgMCkgLyBwcm9ncmVzc0Fyci5sZW5ndGhcbiAgICB0aGlzLnNldFByb2dyZXNzKHByb2dyZXNzQXZlKVxuICB9XG5cbiAgc2hvd05leHRFcnJvciAoKSB7XG4gICAgbGV0IHJzID0gdGhpcy5yZXN1bHRzLnJlc3VsdHNXaXRoVVJJKClcbiAgICBpZiAocnMubGVuZ3RoID09PSAwKSByZXR1cm5cblxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgIT09IG51bGwgJiYgdGhpcy5jdXJyZW50UmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCsrXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcbiAgICB9XG4gICAgaWYgKHRoaXMuY3VycmVudFJlc3VsdCA+PSBycy5sZW5ndGgpIHRoaXMuY3VycmVudFJlc3VsdCA9IDBcblxuICAgIHRoaXMuc2hvd0l0ZW0ocnNbdGhpcy5jdXJyZW50UmVzdWx0XSlcbiAgfVxuXG4gIHNob3dQcmV2RXJyb3IgKCkge1xuICAgIGxldCBycyA9IHRoaXMucmVzdWx0cy5yZXN1bHRzV2l0aFVSSSgpXG4gICAgaWYgKHJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuXG5cbiAgICBpZiAodGhpcy5jdXJyZW50UmVzdWx0ICE9PSBudWxsICYmIHRoaXMuY3VycmVudFJlc3VsdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQtLVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxXG4gICAgfVxuICAgIGlmICh0aGlzLmN1cnJlbnRSZXN1bHQgPCAwKSB0aGlzLmN1cnJlbnRSZXN1bHQgPSBycy5sZW5ndGggLSAxXG5cbiAgICB0aGlzLnNob3dJdGVtKHJzW3RoaXMuY3VycmVudFJlc3VsdF0pXG4gIH1cbn1cbiJdfQ==