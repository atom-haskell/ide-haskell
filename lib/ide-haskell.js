"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const plugin_manager_1 = require("./plugin-manager");
const prettify_1 = require("./prettify");
const utils_1 = require("./utils");
const UPI3 = require("./upi-3");
const OutputPanel = require("./output-panel");
const AtomTypes = require("atom");
var CompositeDisposable = AtomTypes.CompositeDisposable;
var Disposable = AtomTypes.Disposable;
let upiProvided = false;
let disposables;
let pluginManager;
let outputPanel;
let menu;
function cleanConfig() {
}
function activate(state) {
    cleanConfig();
    atom.views.getView(atom.workspace).classList.add('ide-haskell');
    require('etch').setScheduler(atom.views);
    upiProvided = false;
    if (atom.config.get('ide-haskell.startupMessageIdeBackend')) {
        setTimeout(() => {
            if (!upiProvided) {
                atom.notifications.addWarning(`Ide-Haskell needs backends that provide most of functionality.
            Please refer to README for details`, { dismissable: true });
            }
        }, 5000);
    }
    disposables = new CompositeDisposable();
    pluginManager = new plugin_manager_1.PluginManager(state, deserializeOutputPanel());
    disposables.add(atom.commands.add('atom-workspace', {
        'ide-haskell:toggle-output': () => {
            if (pluginManager)
                pluginManager.togglePanel();
        },
        'ide-haskell:next-error': () => {
            if (pluginManager)
                pluginManager.nextError();
        },
        'ide-haskell:prev-error': () => {
            if (pluginManager)
                pluginManager.prevError();
        },
    }), atom.commands.add('atom-text-editor.ide-haskell', {
        'ide-haskell:prettify-file': ({ currentTarget }) => {
            prettify_1.prettifyFile(currentTarget.getModel());
        },
    }), atom.commands.add('atom-text-editor.ide-haskell--has-tooltips', {
        'ide-haskell:close-tooltip': ({ currentTarget, abortKeyBinding }) => {
            const controller = pluginManager && pluginManager.controller(currentTarget.getModel());
            if (controller && controller.tooltips.has()) {
                controller.tooltips.hide();
            }
            else {
                abortKeyBinding();
            }
        },
    }));
    menu = new CompositeDisposable();
    menu.add(atom.menu.add([
        {
            label: utils_1.MAIN_MENU_LABEL,
            submenu: [
                { label: 'Prettify', command: 'ide-haskell:prettify-file' },
                { label: 'Toggle Panel', command: 'ide-haskell:toggle-output' },
            ],
        },
    ]));
}
exports.activate = activate;
function deactivate() {
    if (pluginManager)
        pluginManager.deactivate();
    if (disposables)
        disposables.dispose();
    if (menu)
        menu.dispose();
    atom.menu.update();
    disposables = undefined;
    pluginManager = undefined;
    menu = undefined;
    outputPanel = undefined;
}
exports.deactivate = deactivate;
function serialize() {
    if (pluginManager) {
        return pluginManager.serialize();
    }
    return undefined;
}
exports.serialize = serialize;
function deserializeOutputPanel(state) {
    if (!outputPanel)
        outputPanel = new OutputPanel.OutputPanel(state);
    return outputPanel;
}
exports.deserializeOutputPanel = deserializeOutputPanel;
function provideUpi3() {
    upiProvided = true;
    return (options) => {
        if (!pluginManager) {
            throw new Error('IDE-Haskell failed to provide UPI instance: pluginManager is undefined');
        }
        return UPI3.instance(pluginManager, options, {
            eventsReturnResults: false,
        });
    };
}
exports.provideUpi3 = provideUpi3;
function consumeUpi3_0(registration) {
    upiProvided = true;
    if (pluginManager) {
        return UPI3.consume(pluginManager, registration, {
            eventsReturnResults: false,
        });
    }
    return undefined;
}
exports.consumeUpi3_0 = consumeUpi3_0;
function consumeUpi3(registration) {
    upiProvided = true;
    if (pluginManager) {
        return UPI3.consume(pluginManager, registration, {
            eventsReturnResults: true,
        });
    }
    return undefined;
}
exports.consumeUpi3 = consumeUpi3;
function consumeLinter(register) {
    if (!(disposables && pluginManager)) {
        return undefined;
    }
    const linter = register({ name: 'IDE-Haskell' });
    disposables.add(linter);
    pluginManager.setLinter(linter);
    return linter;
}
exports.consumeLinter = consumeLinter;
function consumeStatusBar(statusBar) {
    if (!pluginManager) {
        return undefined;
    }
    pluginManager.setStatusBar(statusBar);
    return new Disposable(() => {
        if (pluginManager) {
            pluginManager.removeStatusBar();
        }
    });
}
exports.consumeStatusBar = consumeStatusBar;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLWhhc2tlbGwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaWRlLWhhc2tlbGwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxREFBd0Q7QUFDeEQseUNBQXlDO0FBQ3pDLG1DQUF5QztBQUN6QyxnQ0FBK0I7QUFDL0IsOENBQTZDO0FBQzdDLGtDQUFpQztBQUlqQyxJQUFPLG1CQUFtQixHQUFHLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQTtBQUMxRCxJQUFPLFVBQVUsR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFBO0FBRXhDLElBQUksV0FBVyxHQUFHLEtBQUssQ0FBQTtBQUN2QixJQUFJLFdBQTRDLENBQUE7QUFDaEQsSUFBSSxhQUF3QyxDQUFBO0FBQzVDLElBQUksV0FBZ0QsQ0FBQTtBQUNwRCxJQUFJLElBQXFDLENBQUE7QUFFekM7QUFFQSxDQUFDO0FBRUQsa0JBQXlCLEtBQWE7SUFDcEMsV0FBVyxFQUFFLENBQUE7SUFFYixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQTtJQUUvRCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUV4QyxXQUFXLEdBQUcsS0FBSyxDQUFBO0lBRW5CLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHNDQUFzQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzVELFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pCLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUMzQjsrQ0FDcUMsRUFDckMsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQ3RCLENBQUE7WUFDSCxDQUFDO1FBQ0gsQ0FBQyxFQUFFLElB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RUFBRSxJQUFJO1NBQzFCLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFDRCxNQUFNLENBQUMsU0FBUyxDQUFBO0FBQ2xCLENBQUM7QUFWRCxrQ0FVQztBQUVELHVCQUNFLFFBQTRDO0lBRTVDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLElBQUksYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sQ0FBQyxTQUFTLENBQUE7SUFDbEIsQ0FBQztJQUNELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFBO0lBQ2hELFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDdkIsYUFBYSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUMvQixNQUFNLENBQUMsTUFBTSxDQUFBO0FBQ2YsQ0FBQztBQVZELHNDQVVDO0FBRUQsMEJBQ0UsU0FBOEI7SUFFOUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBQ25CLE1BQU0sQ0FBQyxTQUFTLENBQUE7SUFDbEIsQ0FBQztJQUNELGFBQWEsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDckMsTUFBTSxDQUFDLElBQUksVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUN6QixFQUFFLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLGFBQWEsQ0FBQyxlQUFlLEVBQUUsQ0FBQTtRQUNqQyxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDO0FBWkQsNENBWUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQbHVnaW5NYW5hZ2VyLCBJU3RhdGUgfSBmcm9tICcuL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHsgcHJldHRpZnlGaWxlIH0gZnJvbSAnLi9wcmV0dGlmeSdcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCB9IGZyb20gJy4vdXRpbHMnXG5pbXBvcnQgKiBhcyBVUEkzIGZyb20gJy4vdXBpLTMnXG5pbXBvcnQgKiBhcyBPdXRwdXRQYW5lbCBmcm9tICcuL291dHB1dC1wYW5lbCdcbmltcG9ydCAqIGFzIEF0b21UeXBlcyBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgVVBJIGZyb20gJ2F0b20taGFza2VsbC11cGknXG5pbXBvcnQgKiBhcyBMaW50ZXIgZnJvbSAnYXRvbS9saW50ZXInXG5pbXBvcnQgKiBhcyBTdGF0dXNCYXIgZnJvbSAnYXRvbS9zdGF0dXMtYmFyJ1xuaW1wb3J0IENvbXBvc2l0ZURpc3Bvc2FibGUgPSBBdG9tVHlwZXMuQ29tcG9zaXRlRGlzcG9zYWJsZVxuaW1wb3J0IERpc3Bvc2FibGUgPSBBdG9tVHlwZXMuRGlzcG9zYWJsZVxuXG5sZXQgdXBpUHJvdmlkZWQgPSBmYWxzZVxubGV0IGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlIHwgdW5kZWZpbmVkXG5sZXQgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlciB8IHVuZGVmaW5lZFxubGV0IG91dHB1dFBhbmVsOiBPdXRwdXRQYW5lbC5PdXRwdXRQYW5lbCB8IHVuZGVmaW5lZFxubGV0IG1lbnU6IENvbXBvc2l0ZURpc3Bvc2FibGUgfCB1bmRlZmluZWRcblxuZnVuY3Rpb24gY2xlYW5Db25maWcoKSB7XG4gIC8qbm9vcCovXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZShzdGF0ZTogSVN0YXRlKSB7XG4gIGNsZWFuQ29uZmlnKClcblxuICBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpLmNsYXNzTGlzdC5hZGQoJ2lkZS1oYXNrZWxsJylcblxuICByZXF1aXJlKCdldGNoJykuc2V0U2NoZWR1bGVyKGF0b20udmlld3MpXG5cbiAgdXBpUHJvdmlkZWQgPSBmYWxzZVxuXG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN0YXJ0dXBNZXNzYWdlSWRlQmFja2VuZCcpKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAoIXVwaVByb3ZpZGVkKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKFxuICAgICAgICAgIGBJZGUtSGFza2VsbCBuZWVkcyBiYWNrZW5kcyB0aGF0IHByb3ZpZGUgbW9zdCBvZiBmdW5jdGlvbmFsaXR5LlxuICAgICAgICAgICAgUGxlYXNlIHJlZmVyIHRvIFJFQURNRSBmb3IgZGV0YWlsc2AsXG4gICAgICAgICAgeyBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgICAgICApXG4gICAgICB9XG4gICAgfSwgNTAwMClcbiAgfVxuXG4gIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gIHBsdWdpbk1hbmFnZXIgPSBuZXcgUGx1Z2luTWFuYWdlcihzdGF0ZSwgZGVzZXJpYWxpemVPdXRwdXRQYW5lbCgpKVxuXG4gIC8vIGdsb2JhbCBjb21tYW5kc1xuICBkaXNwb3NhYmxlcy5hZGQoXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywge1xuICAgICAgJ2lkZS1oYXNrZWxsOnRvZ2dsZS1vdXRwdXQnOiAoKSA9PiB7XG4gICAgICAgIGlmIChwbHVnaW5NYW5hZ2VyKSBwbHVnaW5NYW5hZ2VyLnRvZ2dsZVBhbmVsKClcbiAgICAgIH0sXG4gICAgICAnaWRlLWhhc2tlbGw6bmV4dC1lcnJvcic6ICgpID0+IHtcbiAgICAgICAgaWYgKHBsdWdpbk1hbmFnZXIpIHBsdWdpbk1hbmFnZXIubmV4dEVycm9yKClcbiAgICAgIH0sXG4gICAgICAnaWRlLWhhc2tlbGw6cHJldi1lcnJvcic6ICgpID0+IHtcbiAgICAgICAgaWYgKHBsdWdpbk1hbmFnZXIpIHBsdWdpbk1hbmFnZXIucHJldkVycm9yKClcbiAgICAgIH0sXG4gICAgfSksXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3IuaWRlLWhhc2tlbGwnLCB7XG4gICAgICAnaWRlLWhhc2tlbGw6cHJldHRpZnktZmlsZSc6ICh7IGN1cnJlbnRUYXJnZXQgfSkgPT4ge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tZmxvYXRpbmctcHJvbWlzZXNcbiAgICAgICAgcHJldHRpZnlGaWxlKGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKSlcbiAgICAgIH0sXG4gICAgfSksXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3IuaWRlLWhhc2tlbGwtLWhhcy10b29sdGlwcycsIHtcbiAgICAgICdpZGUtaGFza2VsbDpjbG9zZS10b29sdGlwJzogKHsgY3VycmVudFRhcmdldCwgYWJvcnRLZXlCaW5kaW5nIH0pID0+IHtcbiAgICAgICAgY29uc3QgY29udHJvbGxlciA9XG4gICAgICAgICAgcGx1Z2luTWFuYWdlciAmJiBwbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoY3VycmVudFRhcmdldC5nZXRNb2RlbCgpKVxuICAgICAgICBpZiAoY29udHJvbGxlciAmJiBjb250cm9sbGVyLnRvb2x0aXBzLmhhcygpKSB7XG4gICAgICAgICAgY29udHJvbGxlci50b29sdGlwcy5oaWRlKClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhYm9ydEtleUJpbmRpbmcoKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIH0pLFxuICApXG5cbiAgbWVudSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgbWVudS5hZGQoXG4gICAgYXRvbS5tZW51LmFkZChbXG4gICAgICB7XG4gICAgICAgIGxhYmVsOiBNQUlOX01FTlVfTEFCRUwsXG4gICAgICAgIHN1Ym1lbnU6IFtcbiAgICAgICAgICB7IGxhYmVsOiAnUHJldHRpZnknLCBjb21tYW5kOiAnaWRlLWhhc2tlbGw6cHJldHRpZnktZmlsZScgfSxcbiAgICAgICAgICB7IGxhYmVsOiAnVG9nZ2xlIFBhbmVsJywgY29tbWFuZDogJ2lkZS1oYXNrZWxsOnRvZ2dsZS1vdXRwdXQnIH0sXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIF0pLFxuICApXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWFjdGl2YXRlKCkge1xuICBpZiAocGx1Z2luTWFuYWdlcikgcGx1Z2luTWFuYWdlci5kZWFjdGl2YXRlKClcblxuICAvLyBjbGVhciBjb21tYW5kc1xuICBpZiAoZGlzcG9zYWJsZXMpIGRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuXG4gIGlmIChtZW51KSBtZW51LmRpc3Bvc2UoKVxuICBhdG9tLm1lbnUudXBkYXRlKClcblxuICBkaXNwb3NhYmxlcyA9IHVuZGVmaW5lZFxuICBwbHVnaW5NYW5hZ2VyID0gdW5kZWZpbmVkXG4gIG1lbnUgPSB1bmRlZmluZWRcbiAgb3V0cHV0UGFuZWwgPSB1bmRlZmluZWRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNlcmlhbGl6ZSgpIHtcbiAgaWYgKHBsdWdpbk1hbmFnZXIpIHtcbiAgICByZXR1cm4gcGx1Z2luTWFuYWdlci5zZXJpYWxpemUoKVxuICB9XG4gIHJldHVybiB1bmRlZmluZWRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlc2VyaWFsaXplT3V0cHV0UGFuZWwoc3RhdGU/OiBPdXRwdXRQYW5lbC5JU3RhdGUpIHtcbiAgaWYgKCFvdXRwdXRQYW5lbCkgb3V0cHV0UGFuZWwgPSBuZXcgT3V0cHV0UGFuZWwuT3V0cHV0UGFuZWwoc3RhdGUpXG4gIHJldHVybiBvdXRwdXRQYW5lbFxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZVVwaTMoKTogVVBJLklVUElSZWdpc3RyYXRpb24ge1xuICB1cGlQcm92aWRlZCA9IHRydWVcbiAgcmV0dXJuIChvcHRpb25zOiBVUEkuSVJlZ2lzdHJhdGlvbk9wdGlvbnMpID0+IHtcbiAgICBpZiAoIXBsdWdpbk1hbmFnZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0lERS1IYXNrZWxsIGZhaWxlZCB0byBwcm92aWRlIFVQSSBpbnN0YW5jZTogcGx1Z2luTWFuYWdlciBpcyB1bmRlZmluZWQnLFxuICAgICAgKVxuICAgIH1cbiAgICByZXR1cm4gVVBJMy5pbnN0YW5jZShwbHVnaW5NYW5hZ2VyLCBvcHRpb25zLCB7XG4gICAgICBldmVudHNSZXR1cm5SZXN1bHRzOiBmYWxzZSxcbiAgICB9KVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lVXBpM18wKFxuICByZWdpc3RyYXRpb246IFVQSS5JUmVnaXN0cmF0aW9uT3B0aW9ucyxcbik6IERpc3Bvc2FibGUgfCB1bmRlZmluZWQge1xuICB1cGlQcm92aWRlZCA9IHRydWVcbiAgaWYgKHBsdWdpbk1hbmFnZXIpIHtcbiAgICByZXR1cm4gVVBJMy5jb25zdW1lKHBsdWdpbk1hbmFnZXIsIHJlZ2lzdHJhdGlvbiwge1xuICAgICAgZXZlbnRzUmV0dXJuUmVzdWx0czogZmFsc2UsXG4gICAgfSlcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lVXBpMyhcbiAgcmVnaXN0cmF0aW9uOiBVUEkuSVJlZ2lzdHJhdGlvbk9wdGlvbnMsXG4pOiBEaXNwb3NhYmxlIHwgdW5kZWZpbmVkIHtcbiAgdXBpUHJvdmlkZWQgPSB0cnVlXG4gIGlmIChwbHVnaW5NYW5hZ2VyKSB7XG4gICAgcmV0dXJuIFVQSTMuY29uc3VtZShwbHVnaW5NYW5hZ2VyLCByZWdpc3RyYXRpb24sIHtcbiAgICAgIGV2ZW50c1JldHVyblJlc3VsdHM6IHRydWUsXG4gICAgfSlcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lTGludGVyKFxuICByZWdpc3RlcjogKG9wdHM6IHt9KSA9PiBMaW50ZXIuSW5kaWVEZWxlZ2F0ZSxcbik6IERpc3Bvc2FibGUgfCB1bmRlZmluZWQge1xuICBpZiAoIShkaXNwb3NhYmxlcyAmJiBwbHVnaW5NYW5hZ2VyKSkge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuICBjb25zdCBsaW50ZXIgPSByZWdpc3Rlcih7IG5hbWU6ICdJREUtSGFza2VsbCcgfSlcbiAgZGlzcG9zYWJsZXMuYWRkKGxpbnRlcilcbiAgcGx1Z2luTWFuYWdlci5zZXRMaW50ZXIobGludGVyKVxuICByZXR1cm4gbGludGVyXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lU3RhdHVzQmFyKFxuICBzdGF0dXNCYXI6IFN0YXR1c0Jhci5TdGF0dXNCYXIsXG4pOiBEaXNwb3NhYmxlIHwgdW5kZWZpbmVkIHtcbiAgaWYgKCFwbHVnaW5NYW5hZ2VyKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZFxuICB9XG4gIHBsdWdpbk1hbmFnZXIuc2V0U3RhdHVzQmFyKHN0YXR1c0JhcilcbiAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICBpZiAocGx1Z2luTWFuYWdlcikge1xuICAgICAgcGx1Z2luTWFuYWdlci5yZW1vdmVTdGF0dXNCYXIoKVxuICAgIH1cbiAgfSlcbn1cbiJdfQ==