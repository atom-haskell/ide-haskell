"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const plugin_manager_1 = require("./plugin-manager");
const prettify_1 = require("./prettify");
const utils_1 = require("./utils");
const UPI = require("./upi");
const UPI3 = require("./upi-3");
let upiProvided = false;
let disposables;
let pluginManager;
let menu;
let upi3;
var config_1 = require("./config");
exports.config = config_1.config;
function cleanConfig() { }
function activate(state) {
    cleanConfig();
    atom.views.getView(atom.workspace).classList.add('ide-haskell');
    require('etch').setScheduler(atom.views);
    upiProvided = false;
    if (atom.config.get('ide-haskell.startupMessageIdeBackend')) {
        setTimeout(() => {
            if (!upiProvided) {
                atom.notifications.addWarning(`Ide-Haskell needs backends that provide most of functionality.
            Please refer to README for details`, { dismissable: true });
            }
        }, 5000);
    }
    disposables = new atom_1.CompositeDisposable();
    pluginManager = new plugin_manager_1.PluginManager(state);
    disposables.add(atom.commands.add('atom-workspace', {
        'ide-haskell:toggle-output': () => pluginManager && pluginManager.togglePanel()
    }));
    disposables.add(atom.commands.add('atom-text-editor[data-grammar~="haskell"]', {
        'ide-haskell:prettify-file': ({ currentTarget }) => {
            prettify_1.prettifyFile(currentTarget.getModel());
        },
        'ide-haskell:close-tooltip': ({ currentTarget, abortKeyBinding }) => {
            const controller = pluginManager && pluginManager.controller(currentTarget.getModel());
            if (!controller) {
                return;
            }
            if (controller.tooltips.has()) {
                controller.tooltips.hide();
            }
            else if (abortKeyBinding) {
                abortKeyBinding();
            }
        },
        'ide-haskell:next-error': () => pluginManager && pluginManager.nextError(),
        'ide-haskell:prev-error': () => pluginManager && pluginManager.prevError()
    }));
    disposables.add(atom.commands.add('atom-text-editor[data-grammar~="cabal"]', {
        'ide-haskell:prettify-file': ({ currentTarget }) => {
            prettify_1.prettifyFile(currentTarget.getModel(), 'cabal');
        }
    }));
    atom.keymaps.add('ide-haskell', {
        'atom-text-editor[data-grammar~="haskell"]': { escape: 'ide-haskell:close-tooltip' }
    });
    menu = new atom_1.CompositeDisposable();
    menu.add(atom.menu.add([{
            label: utils_1.MAIN_MENU_LABEL,
            submenu: [
                { label: 'Prettify', command: 'ide-haskell:prettify-file' },
                { label: 'Toggle Panel', command: 'ide-haskell:toggle-output' }
            ]
        }]));
    upi3 = new UPI3.UPI(pluginManager);
}
exports.activate = activate;
function deactivate() {
    pluginManager && pluginManager.deactivate();
    upi3 && upi3.dispose();
    atom.keymaps.removeBindingsFromSource('ide-haskell');
    disposables && disposables.dispose();
    menu && menu.dispose();
    atom.menu.update();
}
exports.deactivate = deactivate;
function serialize() {
    if (pluginManager) {
        return pluginManager.serialize();
    }
}
exports.serialize = serialize;
function provideUpi() {
    upiProvided = true;
    return new UPI.UPI(pluginManager);
}
exports.provideUpi = provideUpi;
function provideUpi3() {
    upiProvided = true;
    return upi3;
}
exports.provideUpi3 = provideUpi3;
function consumeLinter(indieRegistry) {
    if (!(disposables && pluginManager)) {
        return;
    }
    const linter = indieRegistry.register({ name: 'IDE-Haskell' });
    disposables.add(linter);
    pluginManager.setLinter(linter);
    return linter;
}
exports.consumeLinter = consumeLinter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRlLWhhc2tlbGwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaWRlLWhhc2tlbGwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBd0M7QUFDeEMscURBQXNEO0FBQ3RELHlDQUF1QztBQUN2QyxtQ0FBdUM7QUFDdkMsNkJBQTRCO0FBQzVCLGdDQUErQjtBQUUvQixJQUFJLFdBQVcsR0FBRyxLQUFLLENBQUE7QUFDdkIsSUFBSSxXQUE0QyxDQUFBO0FBQ2hELElBQUksYUFBd0MsQ0FBQTtBQUM1QyxJQUFJLElBQXFDLENBQUE7QUFDekMsSUFBSSxJQUEwQixDQUFBO0FBRTlCLG1DQUErQjtBQUF2QiwwQkFBQSxNQUFNLENBQUE7QUFFZCx5QkFBbUMsQ0FBQztBQU9wQyxrQkFBMEIsS0FBYTtJQUNyQyxXQUFXLEVBQUUsQ0FBQTtJQUViLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBRS9ELE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBRXhDLFdBQVcsR0FBRyxLQUFLLENBQUE7SUFFbkIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsc0NBQXNDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUQsVUFBVSxDQUNSO1lBQ0UsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNqQixJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FDM0I7K0NBQ21DLEVBQ25DLEVBQUMsV0FBVyxFQUFFLElBQUksRUFBQyxDQUFDLENBQUE7WUFDeEIsQ0FBQztRQUNILENBQUMsRUFDRCxJQUFJLENBQ0wsQ0FBQTtJQUNILENBQUM7SUFFRCxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO0lBRXZDLGFBQWEsR0FBRyxJQUFJLDhCQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7SUFHeEMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRTtRQUNsRCwyQkFBMkIsRUFBRSxNQUMzQixhQUFhLElBQUksYUFBYSxDQUFDLFdBQVcsRUFBRTtLQUMvQyxDQUFDLENBQUMsQ0FBQTtJQUVILFdBQVcsQ0FBQyxHQUFHLENBQ2IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsMkNBQTJDLEVBQUU7UUFDN0QsMkJBQTJCLEVBQUUsQ0FBQyxFQUFDLGFBQWEsRUFBYTtZQUN2RCx1QkFBWSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBQ3hDLENBQUM7UUFDRCwyQkFBMkIsRUFBRSxDQUFDLEVBQUMsYUFBYSxFQUFFLGVBQWUsRUFBYTtZQUN4RSxNQUFNLFVBQVUsR0FBRyxhQUFhLElBQUksYUFBYSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQTtZQUN0RixFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsTUFBTSxDQUFBO1lBQUMsQ0FBQztZQUMzQixFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDOUIsVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtZQUM1QixDQUFDO1lBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7Z0JBQzNCLGVBQWUsRUFBRSxDQUFBO1lBQ25CLENBQUM7UUFDSCxDQUFDO1FBQ0Qsd0JBQXdCLEVBQUUsTUFBTSxhQUFhLElBQUksYUFBYSxDQUFDLFNBQVMsRUFBRTtRQUMxRSx3QkFBd0IsRUFBRSxNQUFNLGFBQWEsSUFBSSxhQUFhLENBQUMsU0FBUyxFQUFFO0tBQzNFLENBQUMsQ0FBQyxDQUFBO0lBRUwsV0FBVyxDQUFDLEdBQUcsQ0FDYixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyx5Q0FBeUMsRUFBRTtRQUMzRCwyQkFBMkIsRUFBRSxDQUFDLEVBQUMsYUFBYSxFQUFhO1lBQ3ZELHVCQUFZLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxFQUFHLE9BQU8sQ0FBQyxDQUFBO1FBQ2xELENBQUM7S0FDRixDQUFDLENBQUMsQ0FBQTtJQUVMLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRTtRQUM5QiwyQ0FBMkMsRUFDekMsRUFBQyxNQUFNLEVBQUUsMkJBQTJCLEVBQUM7S0FDeEMsQ0FBQyxDQUFBO0lBRUYsSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsS0FBSyxFQUFFLHVCQUFlO1lBQ3RCLE9BQU8sRUFBRTtnQkFDUCxFQUFDLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLDJCQUEyQixFQUFDO2dCQUN6RCxFQUFDLEtBQUssRUFBRSxjQUFjLEVBQUUsT0FBTyxFQUFFLDJCQUEyQixFQUFDO2FBQzlEO1NBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUVQLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUE7QUFDcEMsQ0FBQztBQXhFRCw0QkF3RUM7QUFFRDtJQUNFLGFBQWEsSUFBSSxhQUFhLENBQUMsVUFBVSxFQUFFLENBQUE7SUFDM0MsSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUV0QixJQUFJLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBR3BELFdBQVcsSUFBSSxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7SUFFcEMsSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFBO0FBQ3BCLENBQUM7QUFYRCxnQ0FXQztBQUVEO0lBQ0UsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUNqQixNQUFNLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBQ25DLENBQUM7QUFDSCxDQUFDO0FBSkQsOEJBSUM7QUFFRDtJQUNFLFdBQVcsR0FBRyxJQUFJLENBQUE7SUFFbEIsTUFBTSxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFjLENBQUMsQ0FBQTtBQUNwQyxDQUFDO0FBSkQsZ0NBSUM7QUFFRDtJQUNFLFdBQVcsR0FBRyxJQUFJLENBQUE7SUFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQTtBQUNiLENBQUM7QUFIRCxrQ0FHQztBQU9ELHVCQUErQixhQUE4QjtJQUMzRCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUFDLE1BQU0sQ0FBQTtJQUFDLENBQUM7SUFDL0MsTUFBTSxNQUFNLEdBQUcsYUFBYSxDQUFDLFFBQVEsQ0FBQyxFQUFDLElBQUksRUFBRSxhQUFhLEVBQUMsQ0FBQyxDQUFBO0lBQzVELFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7SUFDdkIsYUFBYSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUMvQixNQUFNLENBQUMsTUFBTSxDQUFBO0FBQ2YsQ0FBQztBQU5ELHNDQU1DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyLCBJU3RhdGV9IGZyb20gJy4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQge3ByZXR0aWZ5RmlsZX0gZnJvbSAnLi9wcmV0dGlmeSdcbmltcG9ydCB7TUFJTl9NRU5VX0xBQkVMfSBmcm9tICcuL3V0aWxzJ1xuaW1wb3J0ICogYXMgVVBJIGZyb20gJy4vdXBpJ1xuaW1wb3J0ICogYXMgVVBJMyBmcm9tICcuL3VwaS0zJ1xuXG5sZXQgdXBpUHJvdmlkZWQgPSBmYWxzZVxubGV0IGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlIHwgdW5kZWZpbmVkXG5sZXQgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlciB8IHVuZGVmaW5lZFxubGV0IG1lbnU6IENvbXBvc2l0ZURpc3Bvc2FibGUgfCB1bmRlZmluZWRcbmxldCB1cGkzOiBVUEkzLlVQSSB8IHVuZGVmaW5lZFxuXG5leHBvcnQge2NvbmZpZ30gZnJvbSAnLi9jb25maWcnXG5cbmZ1bmN0aW9uIGNsZWFuQ29uZmlnICgpIHsgLypub29wKi8gfVxuXG5kZWNsYXJlIGludGVyZmFjZSBJRXZlbnREZXNjIHtcbiAgY3VycmVudFRhcmdldDogSFRNTEVsZW1lbnQgJiB7IGdldE1vZGVsICgpOiBBdG9tVHlwZXMuVGV4dEVkaXRvciB9XG4gIGFib3J0S2V5QmluZGluZz8gKCk6IHZvaWRcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFjdGl2YXRlIChzdGF0ZTogSVN0YXRlKSB7XG4gIGNsZWFuQ29uZmlnKClcblxuICBhdG9tLnZpZXdzLmdldFZpZXcoYXRvbS53b3Jrc3BhY2UpLmNsYXNzTGlzdC5hZGQoJ2lkZS1oYXNrZWxsJylcblxuICByZXF1aXJlKCdldGNoJykuc2V0U2NoZWR1bGVyKGF0b20udmlld3MpXG5cbiAgdXBpUHJvdmlkZWQgPSBmYWxzZVxuXG4gIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLnN0YXJ0dXBNZXNzYWdlSWRlQmFja2VuZCcpKSB7XG4gICAgc2V0VGltZW91dChcbiAgICAgICgpID0+IHtcbiAgICAgICAgaWYgKCF1cGlQcm92aWRlZCkge1xuICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKFxuICAgICAgICAgICAgYElkZS1IYXNrZWxsIG5lZWRzIGJhY2tlbmRzIHRoYXQgcHJvdmlkZSBtb3N0IG9mIGZ1bmN0aW9uYWxpdHkuXG4gICAgICAgICAgICBQbGVhc2UgcmVmZXIgdG8gUkVBRE1FIGZvciBkZXRhaWxzYCxcbiAgICAgICAgICAgIHtkaXNtaXNzYWJsZTogdHJ1ZX0pXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICA1MDAwXG4gICAgKVxuICB9XG5cbiAgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgcGx1Z2luTWFuYWdlciA9IG5ldyBQbHVnaW5NYW5hZ2VyKHN0YXRlKVxuXG4gIC8vIGdsb2JhbCBjb21tYW5kc1xuICBkaXNwb3NhYmxlcy5hZGQoYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywge1xuICAgICdpZGUtaGFza2VsbDp0b2dnbGUtb3V0cHV0JzogKCkgPT5cbiAgICAgIHBsdWdpbk1hbmFnZXIgJiYgcGx1Z2luTWFuYWdlci50b2dnbGVQYW5lbCgpXG4gIH0pKVxuXG4gIGRpc3Bvc2FibGVzLmFkZChcbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS10ZXh0LWVkaXRvcltkYXRhLWdyYW1tYXJ+PVwiaGFza2VsbFwiXScsIHtcbiAgICAgICdpZGUtaGFza2VsbDpwcmV0dGlmeS1maWxlJzogKHtjdXJyZW50VGFyZ2V0fTogSUV2ZW50RGVzYykgPT4ge1xuICAgICAgICBwcmV0dGlmeUZpbGUoY3VycmVudFRhcmdldC5nZXRNb2RlbCgpKVxuICAgICAgfSxcbiAgICAgICdpZGUtaGFza2VsbDpjbG9zZS10b29sdGlwJzogKHtjdXJyZW50VGFyZ2V0LCBhYm9ydEtleUJpbmRpbmd9OiBJRXZlbnREZXNjKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBwbHVnaW5NYW5hZ2VyICYmIHBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCkpXG4gICAgICAgIGlmICghY29udHJvbGxlcikgeyByZXR1cm4gfVxuICAgICAgICBpZiAoY29udHJvbGxlci50b29sdGlwcy5oYXMoKSkge1xuICAgICAgICAgIGNvbnRyb2xsZXIudG9vbHRpcHMuaGlkZSgpXG4gICAgICAgIH0gZWxzZSBpZiAoYWJvcnRLZXlCaW5kaW5nKSB7XG4gICAgICAgICAgYWJvcnRLZXlCaW5kaW5nKClcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgICdpZGUtaGFza2VsbDpuZXh0LWVycm9yJzogKCkgPT4gcGx1Z2luTWFuYWdlciAmJiBwbHVnaW5NYW5hZ2VyLm5leHRFcnJvcigpLFxuICAgICAgJ2lkZS1oYXNrZWxsOnByZXYtZXJyb3InOiAoKSA9PiBwbHVnaW5NYW5hZ2VyICYmIHBsdWdpbk1hbmFnZXIucHJldkVycm9yKClcbiAgICB9KSlcblxuICBkaXNwb3NhYmxlcy5hZGQoXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3JbZGF0YS1ncmFtbWFyfj1cImNhYmFsXCJdJywge1xuICAgICAgJ2lkZS1oYXNrZWxsOnByZXR0aWZ5LWZpbGUnOiAoe2N1cnJlbnRUYXJnZXR9OiBJRXZlbnREZXNjKSA9PiB7XG4gICAgICAgIHByZXR0aWZ5RmlsZShjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCkgLCAnY2FiYWwnKVxuICAgICAgfVxuICAgIH0pKVxuXG4gIGF0b20ua2V5bWFwcy5hZGQoJ2lkZS1oYXNrZWxsJywge1xuICAgICdhdG9tLXRleHQtZWRpdG9yW2RhdGEtZ3JhbW1hcn49XCJoYXNrZWxsXCJdJzpcbiAgICAgIHtlc2NhcGU6ICdpZGUtaGFza2VsbDpjbG9zZS10b29sdGlwJ31cbiAgfSlcblxuICBtZW51ID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBtZW51LmFkZChhdG9tLm1lbnUuYWRkKFt7XG4gICAgbGFiZWw6IE1BSU5fTUVOVV9MQUJFTCxcbiAgICBzdWJtZW51OiBbXG4gICAgICB7bGFiZWw6ICdQcmV0dGlmeScsIGNvbW1hbmQ6ICdpZGUtaGFza2VsbDpwcmV0dGlmeS1maWxlJ30sXG4gICAgICB7bGFiZWw6ICdUb2dnbGUgUGFuZWwnLCBjb21tYW5kOiAnaWRlLWhhc2tlbGw6dG9nZ2xlLW91dHB1dCd9XG4gICAgXX1dKSlcblxuICB1cGkzID0gbmV3IFVQSTMuVVBJKHBsdWdpbk1hbmFnZXIpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWFjdGl2YXRlICgpIHtcbiAgcGx1Z2luTWFuYWdlciAmJiBwbHVnaW5NYW5hZ2VyLmRlYWN0aXZhdGUoKVxuICB1cGkzICYmIHVwaTMuZGlzcG9zZSgpXG5cbiAgYXRvbS5rZXltYXBzLnJlbW92ZUJpbmRpbmdzRnJvbVNvdXJjZSgnaWRlLWhhc2tlbGwnKVxuXG4gIC8vIGNsZWFyIGNvbW1hbmRzXG4gIGRpc3Bvc2FibGVzICYmIGRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuXG4gIG1lbnUgJiYgbWVudS5kaXNwb3NlKClcbiAgYXRvbS5tZW51LnVwZGF0ZSgpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemUgKCkge1xuICBpZiAocGx1Z2luTWFuYWdlcikge1xuICAgICByZXR1cm4gcGx1Z2luTWFuYWdlci5zZXJpYWxpemUoKVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcm92aWRlVXBpICgpIHtcbiAgdXBpUHJvdmlkZWQgPSB0cnVlXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gIHJldHVybiBuZXcgVVBJLlVQSShwbHVnaW5NYW5hZ2VyISkgLy8gVE9ETzogbm90IGVudGlyZWx5IHN1cmUgaXQncyBPSy4uLlxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvdmlkZVVwaTMgKCkge1xuICB1cGlQcm92aWRlZCA9IHRydWVcbiAgcmV0dXJuIHVwaTNcbn1cblxuaW50ZXJmYWNlIElMaW50ZXJSZWdpc3RyeSB7XG4gIC8vIFRPRE86IHN0ZWFsIHRoaXMgZnJvbSBhdG9tLXR5cGVzY3JpcHRcbiAgcmVnaXN0ZXI6IEZ1bmN0aW9uXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdW1lTGludGVyIChpbmRpZVJlZ2lzdHJ5OiBJTGludGVyUmVnaXN0cnkpIHtcbiAgaWYgKCEoZGlzcG9zYWJsZXMgJiYgcGx1Z2luTWFuYWdlcikpIHsgcmV0dXJuIH1cbiAgY29uc3QgbGludGVyID0gaW5kaWVSZWdpc3RyeS5yZWdpc3Rlcih7bmFtZTogJ0lERS1IYXNrZWxsJ30pXG4gIGRpc3Bvc2FibGVzLmFkZChsaW50ZXIpXG4gIHBsdWdpbk1hbmFnZXIuc2V0TGludGVyKGxpbnRlcilcbiAgcmV0dXJuIGxpbnRlclxufVxuIl19