"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const output_panel_1 = require("./output-panel");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
class PluginManager {
    constructor(state) {
        this.checkResults = new results_db_1.ResultsDB();
        this.disposables = new atom_1.CompositeDisposable();
        this.controllers = new WeakMap();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.disposables.add(this.onResultsUpdated(({ types }) => this.updateEditorsWithResults(types)));
        }
        this.outputView = new output_panel_1.OutputPanel(state.outputView, this.checkResults);
        this.subscribeEditorController();
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputView, state.configParams);
        this.linterSupport = null;
    }
    deactivate() {
        this.checkResults.destroy();
        this.disposables.dispose();
        this.deleteEditorControllers();
        this.outputView.destroy();
        this.configParamManager.destroy();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = null;
        }
    }
    serialize() {
        return {
            outputView: this.outputView.serialize(),
            configParams: this.configParamManager.serialize()
        };
    }
    onShouldShowTooltip(callback) {
        return this.emitter.on('should-show-tooltip', callback);
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    togglePanel() {
        this.outputView.toggle();
    }
    onResultsUpdated(callback) {
        return this.checkResults.onDidUpdate(callback);
    }
    controller(editor) {
        return this.controllers.get(editor);
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.checkResults);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputView.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputView.showPrevError();
    }
    removeController(editor) {
        const controller = this.controllers.get(editor);
        if (controller) {
            controller.deactivate();
            this.controllers.delete(editor);
        }
    }
    controllerOnGrammar(editor, grammar) {
        if (grammar.scopeName.match(/haskell$/)) {
            this.addController(editor);
        }
        else {
            this.removeController(editor);
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            this.disposables.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }));
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
    deleteEditorControllers() {
        for (const editor of atom.workspace.getTextEditors()) {
            this.removeController(editor);
        }
    }
    updateEditorsWithResults(types) {
        for (const ed of atom.workspace.getTextEditors()) {
            const ctrl = this.controller(ed);
            const filtered = this.checkResults.filter(({ uri }) => uri === ed.getPath());
            if (ctrl) {
                ctrl.updateResults(filtered, types);
            }
        }
    }
    addController(editor) {
        if (!this.controllers.has(editor)) {
            const controller = new editor_control_1.EditorControl(editor);
            this.controllers.set(editor, controller);
            controller.disposables.add(editor.onDidDestroy(() => this.removeController(editor)), controller.onShouldShowTooltip(({ editor: ed, pos, eventType }) => this.emitter.emit('should-show-tooltip', { ed, pos, eventType })), controller.onWillSaveBuffer((buffer) => this.emitter.emit('will-save-buffer', buffer)), controller.onDidSaveBuffer((buffer) => this.emitter.emit('did-save-buffer', buffer)), controller.onDidStopChanging((ed) => this.emitter.emit('did-stop-changing', ed.getBuffer())));
            controller.updateResults(this.checkResults.filter(({ uri }) => uri === editor.getPath()));
        }
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBeUY7QUFDekYsNkNBQXVEO0FBQ3ZELGlEQUEwQztBQUMxQyxtREFBeUU7QUFDekUscURBQThDO0FBQzlDLHFEQUE4QztBQWU5QztJQVFFLFlBQWEsS0FBYTtRQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksc0JBQVMsRUFBRSxDQUFBO1FBRW5DLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQzVDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWxDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUN4RSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBQyxLQUFLLEVBQUMsS0FBSyxJQUFJLENBQUMsd0JBQXdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FDekUsQ0FBQTtRQUNILENBQUM7UUFFRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksMEJBQVcsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTtRQUV0RSxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQTtRQUVoQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxrQ0FBa0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxZQUFZLENBQUMs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cUIsRUFBRSxFQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFDLENBQUMsQ0FBQyxFQUNqRSxVQUFVLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxNQUFrQixLQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLE1BQU0sQ0FBQyxDQUFDLEVBQ2xHLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxNQUFrQixLQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxDQUFDLEVBQ2hHLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEVBQWMsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUN6RyxDQUFBO1lBQ0QsVUFBVSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUMsR0FBRyxFQUFDLEtBQUssR0FBRyxLQUFLLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDekYsQ0FBQztJQUNILENBQUM7Q0FDRjtBQXZKRCxzQ0F1SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIEVtaXR0ZXIsIFRleHRFZGl0b3IsIFBvaW50LCBUZXh0QnVmZmVyLCBHcmFtbWFyfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtSZXN1bHRzREIsIFRVcGRhdGVDYWxsYmFja30gZnJvbSAnLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbH0gZnJvbSAnLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge0NvbmZpZ1BhcmFtTWFuYWdlciwgSVN0YXRlIGFzIElQYXJhbVN0YXRlfSBmcm9tICcuL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQge0VkaXRvckNvbnRyb2x9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge0xpbnRlclN1cHBvcnR9IGZyb20gJy4vbGludGVyLXN1cHBvcnQnXG5cbnR5cGUgTGludGVyID0gYW55IC8vIFRPRE86IFN0ZWFsIHRoaXMgZnJvbSBhdG9tLXR5cGVzY3JpcHRcblxuZXhwb3J0IHR5cGUgVEV2ZW50VHlwZSA9ICdrZXlib2FyZCcgfCAnY29udGV4dCcgfCAnbW91c2UnIHwgJ3NlbGVjdGlvbidcbnR5cGUgVFNob3dUb29sdGlwQ2FsbGJhY2tQYXJhbXMgPSB7ZWRpdG9yOiBUZXh0RWRpdG9yLCBwb3M6IFBvaW50LCBldmVudFR5cGU6IFRFdmVudFR5cGV9XG50eXBlIFRTaG93VG9vbHRpcENhbGxiYWNrID0gKHBhcnM6IFRTaG93VG9vbHRpcENhbGxiYWNrUGFyYW1zKSA9PiB2b2lkXG5leHBvcnQgdHlwZSBUVGV4dEJ1ZmZlckNhbGxiYWNrID0gKGJ1ZmZlcjogVGV4dEJ1ZmZlcikgPT4gdm9pZFxuXG50eXBlIElPdXRwdXRWaWV3U3RhdGUgPSBhbnlcbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRlIHtcbiAgb3V0cHV0VmlldzogSU91dHB1dFZpZXdTdGF0ZVxuICBjb25maWdQYXJhbXM6IElQYXJhbVN0YXRlXG59XG5cbmV4cG9ydCBjbGFzcyBQbHVnaW5NYW5hZ2VyIHtcbiAgcHVibGljIGNoZWNrUmVzdWx0czogUmVzdWx0c0RCXG4gIHB1YmxpYyBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwdWJsaWMgY29udHJvbGxlcnM6IFdlYWtNYXA8VGV4dEVkaXRvciwgRWRpdG9yQ29udHJvbD5cbiAgcHVibGljIGVtaXR0ZXI6IEVtaXR0ZXJcbiAgcHVibGljIG91dHB1dFZpZXc6IE91dHB1dFBhbmVsXG4gIHB1YmxpYyBjb25maWdQYXJhbU1hbmFnZXI6IENvbmZpZ1BhcmFtTWFuYWdlclxuICBwdWJsaWMgbGludGVyU3VwcG9ydDogTGludGVyU3VwcG9ydCB8IG51bGxcbiAgY29uc3RydWN0b3IgKHN0YXRlOiBJU3RhdGUpIHtcbiAgICB0aGlzLmNoZWNrUmVzdWx0cyA9IG5ldyBSZXN1bHRzREIoKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmNvbnRyb2xsZXJzID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMuZW1pdHRlciA9IG5ldyBFbWl0dGVyKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLmVtaXR0ZXIpXG5cbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgPT09ICdidWlsdGluJykge1xuICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICAgIHRoaXMub25SZXN1bHRzVXBkYXRlZCgoe3R5cGVzfSkgPT4gdGhpcy51cGRhdGVFZGl0b3JzV2l0aFJlc3VsdHModHlwZXMpKVxuICAgICAgKVxuICAgIH1cblxuICAgIHRoaXMub3V0cHV0VmlldyA9IG5ldyBPdXRwdXRQYW5lbChzdGF0ZS5vdXRwdXRWaWV3LCB0aGlzLmNoZWNrUmVzdWx0cylcblxuICAgIHRoaXMuc3Vic2NyaWJlRWRpdG9yQ29udHJvbGxlcigpXG5cbiAgICB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlciA9IG5ldyBDb25maWdQYXJhbU1hbmFnZXIodGhpcy5vdXRwdXRWaWV3LCBzdGF0ZS5jb25maWdQYXJhbXMpXG5cbiAgICB0aGlzLmxpbnRlclN1cHBvcnQgPSBudWxsXG4gIH1cblxuICBwdWJsaWMgZGVhY3RpdmF0ZSAoKSB7XG4gICAgdGhpcy5jaGVja1Jlc3VsdHMuZGVzdHJveSgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcblxuICAgIHRoaXMuZGVsZXRlRWRpdG9yQ29udHJvbGxlcnMoKVxuICAgIHRoaXMub3V0cHV0Vmlldy5kZXN0cm95KClcbiAgICB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5kZXN0cm95KClcbiAgICBpZiAodGhpcy5saW50ZXJTdXBwb3J0KSB7XG4gICAgICB0aGlzLmxpbnRlclN1cHBvcnQuZGVzdHJveSgpXG4gICAgICB0aGlzLmxpbnRlclN1cHBvcnQgPSBudWxsXG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNlcmlhbGl6ZSAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG91dHB1dFZpZXc6IHRoaXMub3V0cHV0Vmlldy5zZXJpYWxpemUoKSxcbiAgICAgIGNvbmZpZ1BhcmFtczogdGhpcy5jb25maWdQYXJhbU1hbmFnZXIuc2VyaWFsaXplKClcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgb25TaG91bGRTaG93VG9vbHRpcCAoY2FsbGJhY2s6IFRTaG93VG9vbHRpcENhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignc2hvdWxkLXNob3ctdG9vbHRpcCcsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIG9uV2lsbFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignd2lsbC1zYXZlLWJ1ZmZlcicsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc3RvcC1jaGFuZ2luZycsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIHRvZ2dsZVBhbmVsICgpIHtcbiAgICB0aGlzLm91dHB1dFZpZXcudG9nZ2xlKClcbiAgfVxuXG4gIHB1YmxpYyBvblJlc3VsdHNVcGRhdGVkIChjYWxsYmFjazogVFVwZGF0ZUNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuY2hlY2tSZXN1bHRzLm9uRGlkVXBkYXRlKGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIGNvbnRyb2xsZXIgKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIHJldHVybiB0aGlzLmNvbnRyb2xsZXJzLmdldChlZGl0b3IpXG4gIH1cblxuICBwdWJsaWMgc2V0TGludGVyIChsaW50ZXI6IExpbnRlcikge1xuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSAhPT0gJ2xpbnRlcicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLmxpbnRlclN1cHBvcnQgPSBuZXcgTGludGVyU3VwcG9ydChsaW50ZXIsIHRoaXMuY2hlY2tSZXN1bHRzKVxuICB9XG5cbiAgcHVibGljIG5leHRFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLm91dHB1dFZpZXcuc2hvd05leHRFcnJvcigpXG4gIH1cblxuICBwdWJsaWMgcHJldkVycm9yICgpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdidWlsdGluJykgeyByZXR1cm4gfVxuICAgIHRoaXMub3V0cHV0Vmlldy5zaG93UHJldkVycm9yKClcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlQ29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgY29uc3QgY29udHJvbGxlciA9IHRoaXMuY29udHJvbGxlcnMuZ2V0KGVkaXRvcilcbiAgICBpZiAoY29udHJvbGxlcikge1xuICAgICAgY29udHJvbGxlci5kZWFjdGl2YXRlKClcbiAgICAgIHRoaXMuY29udHJvbGxlcnMuZGVsZXRlKGVkaXRvcilcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNvbnRyb2xsZXJPbkdyYW1tYXIgKGVkaXRvcjogVGV4dEVkaXRvciwgZ3JhbW1hcjogR3JhbW1hcikge1xuICAgIGlmIChncmFtbWFyLnNjb3BlTmFtZS5tYXRjaCgvaGFza2VsbCQvKSkge1xuICAgICAgdGhpcy5hZGRDb250cm9sbGVyKGVkaXRvcilcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZW1vdmVDb250cm9sbGVyKGVkaXRvcilcbiAgICB9XG4gIH1cblxuICAvLyBPYnNlcnZlIHRleHQgZWRpdG9ycyB0byBhdHRhY2ggY29udHJvbGxlclxuICBwcml2YXRlIHN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIgKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChlZGl0b3IpID0+IHtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICAgICAgZWRpdG9yLm9uRGlkQ2hhbmdlR3JhbW1hcigoZ3JhbW1hcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZ3JhbW1hcilcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICAgIHRoaXMuY29udHJvbGxlck9uR3JhbW1hcihlZGl0b3IsIGVkaXRvci5nZXRHcmFtbWFyKCkpXG4gICAgICB9KVxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgZGVsZXRlRWRpdG9yQ29udHJvbGxlcnMgKCkge1xuICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHsgdGhpcy5yZW1vdmVDb250cm9sbGVyKGVkaXRvcikgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVFZGl0b3JzV2l0aFJlc3VsdHMgKHR5cGVzOiBzdHJpbmdbXSkge1xuICAgIGZvciAoY29uc3QgZWQgb2YgYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKSkge1xuICAgICAgY29uc3QgY3RybCA9IHRoaXMuY29udHJvbGxlcihlZClcbiAgICAgIGNvbnN0IGZpbHRlcmVkID0gdGhpcy5jaGVja1Jlc3VsdHMuZmlsdGVyKCh7dXJpfSkgPT4gdXJpID09PSBlZC5nZXRQYXRoKCkpXG4gICAgICBpZiAoY3RybCkgeyBjdHJsLnVwZGF0ZVJlc3VsdHMoZmlsdGVyZWQsIHR5cGVzKSB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRDb250cm9sbGVyIChlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgICBpZiAoIXRoaXMuY29udHJvbGxlcnMuaGFzKGVkaXRvcikpIHtcbiAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgRWRpdG9yQ29udHJvbChlZGl0b3IpXG4gICAgICB0aGlzLmNvbnRyb2xsZXJzLnNldChlZGl0b3IsIGNvbnRyb2xsZXIpXG4gICAgICBjb250cm9sbGVyLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB0aGlzLnJlbW92ZUNvbnRyb2xsZXIoZWRpdG9yKSlcbiAgICAgICwgY29udHJvbGxlci5vblNob3VsZFNob3dUb29sdGlwKCh7ZWRpdG9yOiBlZCwgcG9zLCBldmVudFR5cGV9OiBUU2hvd1Rvb2x0aXBDYWxsYmFja1BhcmFtcykgPT5cbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnc2hvdWxkLXNob3ctdG9vbHRpcCcsIHtlZCwgcG9zLCBldmVudFR5cGV9KSlcbiAgICAgICwgY29udHJvbGxlci5vbldpbGxTYXZlQnVmZmVyKChidWZmZXI6IFRleHRCdWZmZXIpID0+IHRoaXMuZW1pdHRlci5lbWl0KCd3aWxsLXNhdmUtYnVmZmVyJywgYnVmZmVyKSlcbiAgICAgICwgY29udHJvbGxlci5vbkRpZFNhdmVCdWZmZXIoKGJ1ZmZlcjogVGV4dEJ1ZmZlcikgPT4gdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1zYXZlLWJ1ZmZlcicsIGJ1ZmZlcikpXG4gICAgICAsIGNvbnRyb2xsZXIub25EaWRTdG9wQ2hhbmdpbmcoKGVkOiBUZXh0RWRpdG9yKSA9PiB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLXN0b3AtY2hhbmdpbmcnLCBlZC5nZXRCdWZmZXIoKSkpXG4gICAgICApXG4gICAgICBjb250cm9sbGVyLnVwZGF0ZVJlc3VsdHModGhpcy5jaGVja1Jlc3VsdHMuZmlsdGVyKCh7dXJpfSkgPT4gdXJpID09PSBlZGl0b3IuZ2V0UGF0aCgpKSlcbiAgICB9XG4gIH1cbn1cbiJdfQ==