"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const output_panel_1 = require("./output-panel");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
class PluginManager {
    constructor(state) {
        this.checkResults = new results_db_1.ResultsDB();
        this.disposables = new atom_1.CompositeDisposable();
        this.controllers = new WeakMap();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.disposables.add(this.onResultsUpdated(({ types }) => this.updateEditorsWithResults(types)));
        }
        this.outputView = new output_panel_1.OutputPanel(state.outputView, this.checkResults);
        this.subscribeEditorController();
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputView, state.configParams);
        this.linterSupport = null;
    }
    deactivate() {
        this.checkResults.destroy();
        this.disposables.dispose();
        this.deleteEditorControllers();
        this.outputView.destroy();
        this.configParamManager.destroy();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = null;
        }
    }
    serialize() {
        return {
            outputView: this.outputView.serialize(),
            configParams: this.configParamManager.serialize()
        };
    }
    onShouldShowTooltip(callback) {
        return this.emitter.on('should-show-tooltip', callback);
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    togglePanel() {
        this.outputView.toggle();
    }
    onResultsUpdated(callback) {
        return this.checkResults.onDidUpdate(callback);
    }
    controller(editor) {
        return this.controllers.get(editor);
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.checkResults);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputView.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputView.showPrevError();
    }
    removeController(editor) {
        const controller = this.controllers.get(editor);
        if (controller) {
            controller.deactivate();
            this.controllers.delete(editor);
        }
    }
    controllerOnGrammar(editor, grammar) {
        if (grammar.scopeName.match(/haskell$/)) {
            this.addController(editor);
        }
        else {
            this.removeController(editor);
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            this.disposables.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }));
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
    deleteEditorControllers() {
        for (const editor of atom.workspace.getTextEditors()) {
            this.removeController(editor);
        }
    }
    updateEditorsWithResults(types) {
        for (const ed of atom.workspace.getTextEditors()) {
            const ctrl = this.controller(ed);
            const filtered = this.checkResults.filter(({ uri }) => uri === ed.getPath());
            if (ctrl) {
                ctrl.updateResults(filtered, types);
            }
        }
    }
    addController(editor) {
        if (!this.controllers.has(editor)) {
            const controller = new editor_control_1.EditorControl(editor);
            this.controllers.set(editor, controller);
            controller.disposables.add(editor.onDidDestroy(() => this.removeController(editor)), controller.onShouldShowTooltip((params) => this.emitter.emit('should-show-tooltip', params)), controller.onWillSaveBuffer((buffer) => this.emitter.emit('will-save-buffer', buffer)), controller.onDidSaveBuffer((buffer) => this.emitter.emit('did-save-buffer', buffer)), controller.onDidStopChanging((ed) => this.emitter.emit('did-stop-changing', ed.getBuffer())));
            controller.updateResults(this.checkResults.filter(({ uri }) => uri === editor.getPath()));
        }
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBeUY7QUFDekYsNkNBQXVEO0FBQ3ZELGlEQUEwQztBQUMxQyxtREFBeUU7QUFDekUscURBQW1FO0FBQ25FLHFEQUE4QztBQWM5QztJQVFFLFlBQWEsS0FBYTtRQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksc0JBQVMsRUFBRSxDQUFBO1FBRW5DLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQzVDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWxDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFDLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUN4RSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBQyxLQUFLLEVBQUMsS0FBSyxJQUFJLENBQUMsd0JBQXdCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FDekUsQ0FBQTtRQUNILENBQUM7UUFFRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksMEJBQVcsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTtRQUV0RSxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQTtRQUVoQyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxrQ0FBa0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxZQUFZLENBQUMs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QkFBZ0IsQ0FBQyxDQUFDLE1BQWtCLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsTUFBTSxDQUFDLENBQUMsRUFDbEcsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDLE1BQWtCLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxDQUFDLENBQUMsRUFDaEcsVUFBVSxDQUFDLGlCQUFpQixDQUFDLENBQUMsRUFBYyxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQ3pHLENBQUE7WUFDRCxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBQyxHQUFHLEVBQUMsS0FBSyxHQUFHLEtBQUssTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUN6RixDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBdkpELHNDQXVKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgRW1pdHRlciwgVGV4dEVkaXRvciwgUG9pbnQsIFRleHRCdWZmZXIsIEdyYW1tYXJ9IGZyb20gJ2F0b20nXG5pbXBvcnQge1Jlc3VsdHNEQiwgVFVwZGF0ZUNhbGxiYWNrfSBmcm9tICcuL3Jlc3VsdHMtZGInXG5pbXBvcnQge091dHB1dFBhbmVsfSBmcm9tICcuL291dHB1dC1wYW5lbCdcbmltcG9ydCB7Q29uZmlnUGFyYW1NYW5hZ2VyLCBJU3RhdGUgYXMgSVBhcmFtU3RhdGV9IGZyb20gJy4vY29uZmlnLXBhcmFtcydcbmltcG9ydCB7RWRpdG9yQ29udHJvbCwgVFRleHRCdWZmZXJDYWxsYmFja30gZnJvbSAnLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7TGludGVyU3VwcG9ydH0gZnJvbSAnLi9saW50ZXItc3VwcG9ydCdcblxudHlwZSBMaW50ZXIgPSBhbnkgLy8gVE9ETzogU3RlYWwgdGhpcyBmcm9tIGF0b20tdHlwZXNjcmlwdFxuXG5leHBvcnQgdHlwZSBURXZlbnRUeXBlID0gJ2tleWJvYXJkJyB8ICdjb250ZXh0JyB8ICdtb3VzZScgfCAnc2VsZWN0aW9uJ1xudHlwZSBUU2hvd1Rvb2x0aXBDYWxsYmFja1BhcmFtcyA9IHtlZGl0b3I6IFRleHRFZGl0b3IsIHBvczogUG9pbnQsIGV2ZW50VHlwZTogVEV2ZW50VHlwZX1cbnR5cGUgVFNob3dUb29sdGlwQ2FsbGJhY2sgPSAocGFyczogVFNob3dUb29sdGlwQ2FsbGJhY2tQYXJhbXMpID0+IHZvaWRcblxudHlwZSBJT3V0cHV0Vmlld1N0YXRlID0gYW55XG5leHBvcnQgaW50ZXJmYWNlIElTdGF0ZSB7XG4gIG91dHB1dFZpZXc6IElPdXRwdXRWaWV3U3RhdGVcbiAgY29uZmlnUGFyYW1zOiBJUGFyYW1TdGF0ZVxufVxuXG5leHBvcnQgY2xhc3MgUGx1Z2luTWFuYWdlciB7XG4gIHB1YmxpYyBjaGVja1Jlc3VsdHM6IFJlc3VsdHNEQlxuICBwdWJsaWMgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHVibGljIGNvbnRyb2xsZXJzOiBXZWFrTWFwPFRleHRFZGl0b3IsIEVkaXRvckNvbnRyb2w+XG4gIHB1YmxpYyBlbWl0dGVyOiBFbWl0dGVyXG4gIHB1YmxpYyBvdXRwdXRWaWV3OiBPdXRwdXRQYW5lbFxuICBwdWJsaWMgY29uZmlnUGFyYW1NYW5hZ2VyOiBDb25maWdQYXJhbU1hbmFnZXJcbiAgcHVibGljIGxpbnRlclN1cHBvcnQ6IExpbnRlclN1cHBvcnQgfCBudWxsXG4gIGNvbnN0cnVjdG9yIChzdGF0ZTogSVN0YXRlKSB7XG4gICAgdGhpcy5jaGVja1Jlc3VsdHMgPSBuZXcgUmVzdWx0c0RCKClcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5jb250cm9sbGVycyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQodGhpcy5lbWl0dGVyKVxuXG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpID09PSAnYnVpbHRpbicpIHtcbiAgICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgICB0aGlzLm9uUmVzdWx0c1VwZGF0ZWQoKHt0eXBlc30pID0+IHRoaXMudXBkYXRlRWRpdG9yc1dpdGhSZXN1bHRzKHR5cGVzKSlcbiAgICAgIClcbiAgICB9XG5cbiAgICB0aGlzLm91dHB1dFZpZXcgPSBuZXcgT3V0cHV0UGFuZWwoc3RhdGUub3V0cHV0VmlldywgdGhpcy5jaGVja1Jlc3VsdHMpXG5cbiAgICB0aGlzLnN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIoKVxuXG4gICAgdGhpcy5jb25maWdQYXJhbU1hbmFnZXIgPSBuZXcgQ29uZmlnUGFyYW1NYW5hZ2VyKHRoaXMub3V0cHV0Vmlldywgc3RhdGUuY29uZmlnUGFyYW1zKVxuXG4gICAgdGhpcy5saW50ZXJTdXBwb3J0ID0gbnVsbFxuICB9XG5cbiAgcHVibGljIGRlYWN0aXZhdGUgKCkge1xuICAgIHRoaXMuY2hlY2tSZXN1bHRzLmRlc3Ryb3koKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG5cbiAgICB0aGlzLmRlbGV0ZUVkaXRvckNvbnRyb2xsZXJzKClcbiAgICB0aGlzLm91dHB1dFZpZXcuZGVzdHJveSgpXG4gICAgdGhpcy5jb25maWdQYXJhbU1hbmFnZXIuZGVzdHJveSgpXG4gICAgaWYgKHRoaXMubGludGVyU3VwcG9ydCkge1xuICAgICAgdGhpcy5saW50ZXJTdXBwb3J0LmRlc3Ryb3koKVxuICAgICAgdGhpcy5saW50ZXJTdXBwb3J0ID0gbnVsbFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBvdXRwdXRWaWV3OiB0aGlzLm91dHB1dFZpZXcuc2VyaWFsaXplKCksXG4gICAgICBjb25maWdQYXJhbXM6IHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLnNlcmlhbGl6ZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIG9uU2hvdWxkU2hvd1Rvb2x0aXAgKGNhbGxiYWNrOiBUU2hvd1Rvb2x0aXBDYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ3Nob3VsZC1zaG93LXRvb2x0aXAnLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBvbldpbGxTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ3dpbGwtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXNhdmUtYnVmZmVyJywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgb25EaWRTdG9wQ2hhbmdpbmcgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignZGlkLXN0b3AtY2hhbmdpbmcnLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyB0b2dnbGVQYW5lbCAoKSB7XG4gICAgdGhpcy5vdXRwdXRWaWV3LnRvZ2dsZSgpXG4gIH1cblxuICBwdWJsaWMgb25SZXN1bHRzVXBkYXRlZCAoY2FsbGJhY2s6IFRVcGRhdGVDYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmNoZWNrUmVzdWx0cy5vbkRpZFVwZGF0ZShjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBjb250cm9sbGVyIChlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sbGVycy5nZXQoZWRpdG9yKVxuICB9XG5cbiAgcHVibGljIHNldExpbnRlciAobGludGVyOiBMaW50ZXIpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdsaW50ZXInKSB7IHJldHVybiB9XG4gICAgdGhpcy5saW50ZXJTdXBwb3J0ID0gbmV3IExpbnRlclN1cHBvcnQobGludGVyLCB0aGlzLmNoZWNrUmVzdWx0cylcbiAgfVxuXG4gIHB1YmxpYyBuZXh0RXJyb3IgKCkge1xuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSAhPT0gJ2J1aWx0aW4nKSB7IHJldHVybiB9XG4gICAgdGhpcy5vdXRwdXRWaWV3LnNob3dOZXh0RXJyb3IoKVxuICB9XG5cbiAgcHVibGljIHByZXZFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLm91dHB1dFZpZXcuc2hvd1ByZXZFcnJvcigpXG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUNvbnRyb2xsZXIgKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSB0aGlzLmNvbnRyb2xsZXJzLmdldChlZGl0b3IpXG4gICAgaWYgKGNvbnRyb2xsZXIpIHtcbiAgICAgIGNvbnRyb2xsZXIuZGVhY3RpdmF0ZSgpXG4gICAgICB0aGlzLmNvbnRyb2xsZXJzLmRlbGV0ZShlZGl0b3IpXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjb250cm9sbGVyT25HcmFtbWFyIChlZGl0b3I6IFRleHRFZGl0b3IsIGdyYW1tYXI6IEdyYW1tYXIpIHtcbiAgICBpZiAoZ3JhbW1hci5zY29wZU5hbWUubWF0Y2goL2hhc2tlbGwkLykpIHtcbiAgICAgIHRoaXMuYWRkQ29udHJvbGxlcihlZGl0b3IpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVtb3ZlQ29udHJvbGxlcihlZGl0b3IpXG4gICAgfVxuICB9XG5cbiAgLy8gT2JzZXJ2ZSB0ZXh0IGVkaXRvcnMgdG8gYXR0YWNoIGNvbnRyb2xsZXJcbiAgcHJpdmF0ZSBzdWJzY3JpYmVFZGl0b3JDb250cm9sbGVyICgpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgIGF0b20ud29ya3NwYWNlLm9ic2VydmVUZXh0RWRpdG9ycygoZWRpdG9yKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgICAgIGVkaXRvci5vbkRpZENoYW5nZUdyYW1tYXIoKGdyYW1tYXIpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY29udHJvbGxlck9uR3JhbW1hcihlZGl0b3IsIGdyYW1tYXIpXG4gICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgICB0aGlzLmNvbnRyb2xsZXJPbkdyYW1tYXIoZWRpdG9yLCBlZGl0b3IuZ2V0R3JhbW1hcigpKVxuICAgICAgfSlcbiAgICApXG4gIH1cblxuICBwcml2YXRlIGRlbGV0ZUVkaXRvckNvbnRyb2xsZXJzICgpIHtcbiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7IHRoaXMucmVtb3ZlQ29udHJvbGxlcihlZGl0b3IpIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlRWRpdG9yc1dpdGhSZXN1bHRzICh0eXBlczogc3RyaW5nW10pIHtcbiAgICBmb3IgKGNvbnN0IGVkIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHtcbiAgICAgIGNvbnN0IGN0cmwgPSB0aGlzLmNvbnRyb2xsZXIoZWQpXG4gICAgICBjb25zdCBmaWx0ZXJlZCA9IHRoaXMuY2hlY2tSZXN1bHRzLmZpbHRlcigoe3VyaX0pID0+IHVyaSA9PT0gZWQuZ2V0UGF0aCgpKVxuICAgICAgaWYgKGN0cmwpIHsgY3RybC51cGRhdGVSZXN1bHRzKGZpbHRlcmVkLCB0eXBlcykgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkQ29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgaWYgKCF0aGlzLmNvbnRyb2xsZXJzLmhhcyhlZGl0b3IpKSB7XG4gICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEVkaXRvckNvbnRyb2woZWRpdG9yKVxuICAgICAgdGhpcy5jb250cm9sbGVycy5zZXQoZWRpdG9yLCBjb250cm9sbGVyKVxuICAgICAgY29udHJvbGxlci5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICAgIGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4gdGhpcy5yZW1vdmVDb250cm9sbGVyKGVkaXRvcikpXG4gICAgICAsIGNvbnRyb2xsZXIub25TaG91bGRTaG93VG9vbHRpcCgocGFyYW1zOiBUU2hvd1Rvb2x0aXBDYWxsYmFja1BhcmFtcykgPT5cbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnc2hvdWxkLXNob3ctdG9vbHRpcCcsIHBhcmFtcykpXG4gICAgICAsIGNvbnRyb2xsZXIub25XaWxsU2F2ZUJ1ZmZlcigoYnVmZmVyOiBUZXh0QnVmZmVyKSA9PiB0aGlzLmVtaXR0ZXIuZW1pdCgnd2lsbC1zYXZlLWJ1ZmZlcicsIGJ1ZmZlcikpXG4gICAgICAsIGNvbnRyb2xsZXIub25EaWRTYXZlQnVmZmVyKChidWZmZXI6IFRleHRCdWZmZXIpID0+IHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc2F2ZS1idWZmZXInLCBidWZmZXIpKVxuICAgICAgLCBjb250cm9sbGVyLm9uRGlkU3RvcENoYW5naW5nKChlZDogVGV4dEVkaXRvcikgPT4gdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1zdG9wLWNoYW5naW5nJywgZWQuZ2V0QnVmZmVyKCkpKVxuICAgICAgKVxuICAgICAgY29udHJvbGxlci51cGRhdGVSZXN1bHRzKHRoaXMuY2hlY2tSZXN1bHRzLmZpbHRlcigoe3VyaX0pID0+IHVyaSA9PT0gZWRpdG9yLmdldFBhdGgoKSkpXG4gICAgfVxuICB9XG59XG4iXX0=