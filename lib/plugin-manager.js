"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const output_panel_1 = require("./output-panel");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
const tooltip_registry_1 = require("./tooltip-registry");
const check_results_provider_1 = require("./check-results-provider");
class PluginManager {
    constructor(state) {
        this.disposables = new atom_1.CompositeDisposable();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.controllers = new WeakMap();
        this.checkResultsControllers = new WeakMap();
        this.controllerClasses = new Set();
        this.editorDispMap = new WeakMap();
        this.checkResults = new results_db_1.ResultsDB();
        this.outputView = new output_panel_1.OutputPanel(state.outputView, this.checkResults);
        this.tooltipRegistry = new tooltip_registry_1.TooltipRegistry(this);
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputView, state.configParams);
        this.addEditorController(this.controllers, editor_control_1.EditorControl);
        this.addEditorController(this.checkResultsControllers, check_results_provider_1.CheckResultsProvider);
        this.subscribeEditorController();
    }
    deactivate() {
        this.checkResults.destroy();
        this.disposables.dispose();
        this.deleteEditorControllers();
        this.outputView.destroy();
        this.configParamManager.destroy();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = undefined;
        }
    }
    serialize() {
        return {
            outputView: this.outputView.serialize(),
            configParams: this.configParamManager.serialize()
        };
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    willSaveBuffer(buffer) {
        return this.emitter.emit('will-save-buffer', buffer);
    }
    didSaveBuffer(buffer) {
        return this.emitter.emit('did-save-buffer', buffer);
    }
    didStopChanging(buffer) {
        return this.emitter.emit('did-stop-changing', buffer);
    }
    togglePanel() {
        this.outputView.toggle();
    }
    controller(editor) {
        return this.controllers.get(editor);
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.checkResults);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputView.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputView.showPrevError();
    }
    removeController(editor) {
        const disp = this.editorDispMap.get(editor);
        if (disp) {
            disp.dispose();
            this.disposables.remove(disp);
            this.editorDispMap.delete(editor);
        }
        for (const { map } of this.controllerClasses) {
            const controller = map.get(editor);
            if (controller) {
                controller.destroy();
                map.delete(editor);
            }
        }
    }
    addEditorController(map, factory) {
        this.controllerClasses.add({ map, factory });
    }
    controllerOnGrammar(editor, grammar) {
        if (grammar.scopeName.match(/haskell$/)) {
            this.addController(editor);
        }
        else {
            this.removeController(editor);
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            this.disposables.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }));
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
    deleteEditorControllers() {
        for (const editor of atom.workspace.getTextEditors()) {
            this.removeController(editor);
        }
    }
    addController(editor) {
        if (!this.editorDispMap.has(editor)) {
            const disp = editor.onDidDestroy(() => this.removeController(editor));
            this.editorDispMap.set(editor, disp);
            this.disposables.add(disp);
        }
        for (const { map, factory } of this.controllerClasses) {
            if (!map.has(editor)) {
                const controller = new factory(editor, this);
                map.set(editor, controller);
            }
        }
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBcUc7QUFDckcsNkNBQXNDO0FBQ3RDLGlEQUEwQztBQUMxQyxtREFBeUU7QUFDekUscURBQW1FO0FBQ25FLHFEQUE4QztBQUM5Qyx5REFBa0Q7QUFDbEQscUVBQTZEO0FBd0I3RDtJQVlFLFlBQWEsS0FBYTtRQUN4QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWxDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUNsQyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUE7UUFFbEMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLHNCQUFTLEVBQUUsQ0FBQTtRQUNuQyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksMEJBQVcsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQTtRQUN0RSxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksa0NBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNoRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxrQ0FBa0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQTtRQUVyRixJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFB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WUFDckUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQ3BDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzVCLENBQUM7UUFDRCxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUMsR0FBRyxFQUFFLE9BQU8sRUFBQyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7WUFDcEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDckIsTUFBTSxVQUFVLEdBQUcsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFBO2dCQUM1QyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUMsQ0FBQTtZQUM3QixDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRjtBQS9KRCxzQ0ErSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIEVtaXR0ZXIsIFRleHRFZGl0b3IsIFBvaW50LCBUZXh0QnVmZmVyLCBHcmFtbWFyLCBEaXNwb3NhYmxlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtSZXN1bHRzREJ9IGZyb20gJy4vcmVzdWx0cy1kYidcbmltcG9ydCB7T3V0cHV0UGFuZWx9IGZyb20gJy4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHtDb25maWdQYXJhbU1hbmFnZXIsIElTdGF0ZSBhcyBJUGFyYW1TdGF0ZX0gZnJvbSAnLi9jb25maWctcGFyYW1zJ1xuaW1wb3J0IHtFZGl0b3JDb250cm9sLCBUVGV4dEJ1ZmZlckNhbGxiYWNrfSBmcm9tICcuL2VkaXRvci1jb250cm9sJ1xuaW1wb3J0IHtMaW50ZXJTdXBwb3J0fSBmcm9tICcuL2xpbnRlci1zdXBwb3J0J1xuaW1wb3J0IHtUb29sdGlwUmVnaXN0cnl9IGZyb20gJy4vdG9vbHRpcC1yZWdpc3RyeSdcbmltcG9ydCB7Q2hlY2tSZXN1bHRzUHJvdmlkZXJ9IGZyb20gJy4vY2hlY2stcmVzdWx0cy1wcm92aWRlcidcblxudHlwZSBMaW50ZXIgPSBhbnkgLy8gVE9ETzogU3RlYWwgdGhpcyBmcm9tIGF0b20tdHlwZXNjcmlwdFxuXG5leHBvcnQgdHlwZSBURXZlbnRUeXBlID0gJ2tleWJvYXJkJyB8ICdjb250ZXh0JyB8ICdtb3VzZScgfCAnc2VsZWN0aW9uJ1xudHlwZSBUU2hvd1Rvb2x0aXBDYWxsYmFja1BhcmFtcyA9IHtlZGl0b3I6IFRleHRFZGl0b3IsIHBvczogUG9pbnQsIGV2ZW50VHlwZTogVEV2ZW50VHlwZX1cbnR5cGUgVFNob3dUb29sdGlwQ2FsbGJhY2sgPSAocGFyczogVFNob3dUb29sdGlwQ2FsbGJhY2tQYXJhbXMpID0+IHZvaWRcblxudHlwZSBJT3V0cHV0Vmlld1N0YXRlID0gYW55XG5leHBvcnQgaW50ZXJmYWNlIElTdGF0ZSB7XG4gIG91dHB1dFZpZXc6IElPdXRwdXRWaWV3U3RhdGVcbiAgY29uZmlnUGFyYW1zOiBJUGFyYW1TdGF0ZVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElFZGl0b3JDb250cm9sbGVyIHtcbiAgZGVzdHJveSAoKTogdm9pZFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElFZGl0b3JDb250cm9sbGVyRmFjdG9yeSB7XG4gIG5ldyAoZWRpdG9yOiBUZXh0RWRpdG9yLCBtYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyKTogSUVkaXRvckNvbnRyb2xsZXJcbn1cblxudHlwZSBFQ01hcDxUIGV4dGVuZHMgSUVkaXRvckNvbnRyb2xsZXI+ID0gV2Vha01hcDxUZXh0RWRpdG9yLCBUPlxuXG5leHBvcnQgY2xhc3MgUGx1Z2luTWFuYWdlciB7XG4gIHB1YmxpYyBjaGVja1Jlc3VsdHM6IFJlc3VsdHNEQlxuICBwdWJsaWMgb3V0cHV0VmlldzogT3V0cHV0UGFuZWxcbiAgcHVibGljIGNvbmZpZ1BhcmFtTWFuYWdlcjogQ29uZmlnUGFyYW1NYW5hZ2VyXG4gIHB1YmxpYyBsaW50ZXJTdXBwb3J0PzogTGludGVyU3VwcG9ydFxuICBwdWJsaWMgdG9vbHRpcFJlZ2lzdHJ5OiBUb29sdGlwUmVnaXN0cnlcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIGVtaXR0ZXI6IEVtaXR0ZXJcbiAgcHJpdmF0ZSBjb250cm9sbGVyczogRUNNYXA8RWRpdG9yQ29udHJvbD5cbiAgcHJpdmF0ZSBjaGVja1Jlc3VsdHNDb250cm9sbGVyczogRUNNYXA8Q2hlY2tSZXN1bHRzUHJvdmlkZXI+XG4gIHByaXZhdGUgY29udHJvbGxlckNsYXNzZXM6IFNldDx7bWFwOiBFQ01hcDxJRWRpdG9yQ29udHJvbGxlcj4sIGZhY3Rvcnk6IElFZGl0b3JDb250cm9sbGVyRmFjdG9yeX0+XG4gIHByaXZhdGUgZWRpdG9yRGlzcE1hcDogV2Vha01hcDxUZXh0RWRpdG9yLCBEaXNwb3NhYmxlPlxuICBjb25zdHJ1Y3RvciAoc3RhdGU6IElTdGF0ZSkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMuZW1pdHRlcilcblxuICAgIHRoaXMuY29udHJvbGxlcnMgPSBuZXcgV2Vha01hcCgpXG4gICAgdGhpcy5jaGVja1Jlc3VsdHNDb250cm9sbGVycyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmNvbnRyb2xsZXJDbGFzc2VzID0gbmV3IFNldCgpXG4gICAgdGhpcy5lZGl0b3JEaXNwTWFwID0gbmV3IFdlYWtNYXAoKVxuXG4gICAgdGhpcy5jaGVja1Jlc3VsdHMgPSBuZXcgUmVzdWx0c0RCKClcbiAgICB0aGlzLm91dHB1dFZpZXcgPSBuZXcgT3V0cHV0UGFuZWwoc3RhdGUub3V0cHV0VmlldywgdGhpcy5jaGVja1Jlc3VsdHMpXG4gICAgdGhpcy50b29sdGlwUmVnaXN0cnkgPSBuZXcgVG9vbHRpcFJlZ2lzdHJ5KHRoaXMpXG4gICAgdGhpcy5jb25maWdQYXJhbU1hbmFnZXIgPSBuZXcgQ29uZmlnUGFyYW1NYW5hZ2VyKHRoaXMub3V0cHV0Vmlldywgc3RhdGUuY29uZmlnUGFyYW1zKVxuXG4gICAgdGhpcy5hZGRFZGl0b3JDb250cm9sbGVyKHRoaXMuY29udHJvbGxlcnMsIEVkaXRvckNvbnRyb2wpXG4gICAgdGhpcy5hZGRFZGl0b3JDb250cm9sbGVyKHRoaXMuY2hlY2tSZXN1bHRzQ29udHJvbGxlcnMsIENoZWNrUmVzdWx0c1Byb3ZpZGVyKVxuXG4gICAgdGhpcy5zdWJzY3JpYmVFZGl0b3JDb250cm9sbGVyKClcbiAgfVxuXG4gIHB1YmxpYyBkZWFjdGl2YXRlICgpIHtcbiAgICB0aGlzLmNoZWNrUmVzdWx0cy5kZXN0cm95KClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuXG4gICAgdGhpcy5kZWxldGVFZGl0b3JDb250cm9sbGVycygpXG4gICAgdGhpcy5vdXRwdXRWaWV3LmRlc3Ryb3koKVxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLmRlc3Ryb3koKVxuICAgIGlmICh0aGlzLmxpbnRlclN1cHBvcnQpIHtcbiAgICAgIHRoaXMubGludGVyU3VwcG9ydC5kZXN0cm95KClcbiAgICAgIHRoaXMubGludGVyU3VwcG9ydCA9IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXJpYWxpemUgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBvdXRwdXRWaWV3OiB0aGlzLm91dHB1dFZpZXcuc2VyaWFsaXplKCksXG4gICAgICBjb25maWdQYXJhbXM6IHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLnNlcmlhbGl6ZSgpXG4gICAgfVxuICB9XG5cbiAgcHVibGljIG9uV2lsbFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5vbignd2lsbC1zYXZlLWJ1ZmZlcicsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcbiAgfVxuXG4gIHB1YmxpYyBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc3RvcC1jaGFuZ2luZycsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIHdpbGxTYXZlQnVmZmVyIChidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLmVtaXQoJ3dpbGwtc2F2ZS1idWZmZXInLCBidWZmZXIpXG4gIH1cblxuICBwdWJsaWMgZGlkU2F2ZUJ1ZmZlciAoYnVmZmVyOiBUZXh0QnVmZmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc2F2ZS1idWZmZXInLCBidWZmZXIpXG4gIH1cblxuICBwdWJsaWMgZGlkU3RvcENoYW5naW5nIChidWZmZXI6IFRleHRCdWZmZXIpIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1zdG9wLWNoYW5naW5nJywgYnVmZmVyKVxuICB9XG5cbiAgcHVibGljIHRvZ2dsZVBhbmVsICgpIHtcbiAgICB0aGlzLm91dHB1dFZpZXcudG9nZ2xlKClcbiAgfVxuXG4gIHB1YmxpYyBjb250cm9sbGVyIChlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sbGVycy5nZXQoZWRpdG9yKVxuICB9XG5cbiAgcHVibGljIHNldExpbnRlciAobGludGVyOiBMaW50ZXIpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdsaW50ZXInKSB7IHJldHVybiB9XG4gICAgdGhpcy5saW50ZXJTdXBwb3J0ID0gbmV3IExpbnRlclN1cHBvcnQobGludGVyLCB0aGlzLmNoZWNrUmVzdWx0cylcbiAgfVxuXG4gIHB1YmxpYyBuZXh0RXJyb3IgKCkge1xuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSAhPT0gJ2J1aWx0aW4nKSB7IHJldHVybiB9XG4gICAgdGhpcy5vdXRwdXRWaWV3LnNob3dOZXh0RXJyb3IoKVxuICB9XG5cbiAgcHVibGljIHByZXZFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHsgcmV0dXJuIH1cbiAgICB0aGlzLm91dHB1dFZpZXcuc2hvd1ByZXZFcnJvcigpXG4gIH1cblxuICBwdWJsaWMgcmVtb3ZlQ29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMuZWRpdG9yRGlzcE1hcC5nZXQoZWRpdG9yKVxuICAgIGlmIChkaXNwKSB7XG4gICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgdGhpcy5kaXNwb3NhYmxlcy5yZW1vdmUoZGlzcClcbiAgICAgIHRoaXMuZWRpdG9yRGlzcE1hcC5kZWxldGUoZWRpdG9yKVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IHttYXB9IG9mIHRoaXMuY29udHJvbGxlckNsYXNzZXMpIHtcbiAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBtYXAuZ2V0KGVkaXRvcilcbiAgICAgIGlmIChjb250cm9sbGVyKSB7XG4gICAgICAgIGNvbnRyb2xsZXIuZGVzdHJveSgpXG4gICAgICAgIG1hcC5kZWxldGUoZWRpdG9yKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkRWRpdG9yQ29udHJvbGxlciAobWFwOiBXZWFrTWFwPFRleHRFZGl0b3IsIElFZGl0b3JDb250cm9sbGVyPiwgZmFjdG9yeTogSUVkaXRvckNvbnRyb2xsZXJGYWN0b3J5KSB7XG4gICAgdGhpcy5jb250cm9sbGVyQ2xhc3Nlcy5hZGQoe21hcCwgZmFjdG9yeX0pXG4gIH1cblxuICBwcml2YXRlIGNvbnRyb2xsZXJPbkdyYW1tYXIgKGVkaXRvcjogVGV4dEVkaXRvciwgZ3JhbW1hcjogR3JhbW1hcikge1xuICAgIGlmIChncmFtbWFyLnNjb3BlTmFtZS5tYXRjaCgvaGFza2VsbCQvKSkge1xuICAgICAgdGhpcy5hZGRDb250cm9sbGVyKGVkaXRvcilcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZW1vdmVDb250cm9sbGVyKGVkaXRvcilcbiAgICB9XG4gIH1cblxuICAvLyBPYnNlcnZlIHRleHQgZWRpdG9ycyB0byBhdHRhY2ggY29udHJvbGxlclxuICBwcml2YXRlIHN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIgKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChlZGl0b3IpID0+IHtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICAgICAgZWRpdG9yLm9uRGlkQ2hhbmdlR3JhbW1hcigoZ3JhbW1hcikgPT4ge1xuICAgICAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZ3JhbW1hcilcbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICAgIHRoaXMuY29udHJvbGxlck9uR3JhbW1hcihlZGl0b3IsIGVkaXRvci5nZXRHcmFtbWFyKCkpXG4gICAgICB9KVxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgZGVsZXRlRWRpdG9yQ29udHJvbGxlcnMgKCkge1xuICAgIGZvciAoY29uc3QgZWRpdG9yIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHsgdGhpcy5yZW1vdmVDb250cm9sbGVyKGVkaXRvcikgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRDb250cm9sbGVyIChlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgICBpZiAoIXRoaXMuZWRpdG9yRGlzcE1hcC5oYXMoZWRpdG9yKSkge1xuICAgICAgY29uc3QgZGlzcCA9IGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4gdGhpcy5yZW1vdmVDb250cm9sbGVyKGVkaXRvcikpXG4gICAgICB0aGlzLmVkaXRvckRpc3BNYXAuc2V0KGVkaXRvciwgZGlzcClcbiAgICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgfVxuICAgIGZvciAoY29uc3Qge21hcCwgZmFjdG9yeX0gb2YgdGhpcy5jb250cm9sbGVyQ2xhc3Nlcykge1xuICAgICAgaWYgKCFtYXAuaGFzKGVkaXRvcikpIHtcbiAgICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBmYWN0b3J5KGVkaXRvciwgdGhpcylcbiAgICAgICAgbWFwLnNldChlZGl0b3IsIGNvbnRyb2xsZXIpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=