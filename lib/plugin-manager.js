"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const output_panel_1 = require("./output-panel");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
class PluginManager {
    constructor(state) {
        this.checkResults = new results_db_1.ResultsDB();
        this.disposables = new atom_1.CompositeDisposable();
        this.controllers = new WeakMap();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        this.outputView = new output_panel_1.OutputPanel(state.outputView, this.checkResults);
        this.subscribeEditorController();
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputView, state.configParams);
        this.linterSupport = undefined;
    }
    deactivate() {
        this.checkResults.destroy();
        this.disposables.dispose();
        this.deleteEditorControllers();
        this.outputView.destroy();
        this.configParamManager.destroy();
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = undefined;
        }
    }
    serialize() {
        return {
            outputView: this.outputView.serialize(),
            configParams: this.configParamManager.serialize()
        };
    }
    onShouldShowTooltip(callback) {
        return this.emitter.on('should-show-tooltip', callback);
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    togglePanel() {
        this.outputView.toggle();
    }
    onResultsUpdated(callback) {
        return this.checkResults.onDidUpdate(callback);
    }
    controller(editor) {
        return this.controllers.get(editor);
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter') {
            return;
        }
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.checkResults);
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputView.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin') {
            return;
        }
        this.outputView.showPrevError();
    }
    removeController(editor) {
        const controller = this.controllers.get(editor);
        if (controller) {
            controller.deactivate();
            this.controllers.delete(editor);
        }
    }
    controllerOnGrammar(editor, grammar) {
        if (grammar.scopeName.match(/haskell$/)) {
            this.addController(editor);
        }
        else {
            this.removeController(editor);
        }
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            this.disposables.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }));
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
    deleteEditorControllers() {
        for (const editor of atom.workspace.getTextEditors()) {
            this.removeController(editor);
        }
    }
    addController(editor) {
        if (!this.controllers.has(editor)) {
            const controller = new editor_control_1.EditorControl(editor, this.checkResults);
            this.controllers.set(editor, controller);
            controller.disposables.add(editor.onDidDestroy(() => this.removeController(editor)), controller.onShouldShowTooltip((params) => this.emitter.emit('should-show-tooltip', params)), controller.onWillSaveBuffer((buffer) => this.emitter.emit('will-save-buffer', buffer)), controller.onDidSaveBuffer((buffer) => this.emitter.emit('did-save-buffer', buffer)), controller.onDidStopChanging((ed) => this.emitter.emit('did-stop-changing', ed.getBuffer())));
        }
    }
}
exports.PluginManager = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBeUY7QUFDekYsNkNBQXVEO0FBQ3ZELGlEQUEwQztBQUMxQyxtREFBeUU7QUFDekUscURBQW1FO0FBQ25FLHFEQUE4QztBQWM5QztJQVFFLFlBQWEsS0FBYTtRQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksc0JBQVMsRUFBRSxDQUFBO1FBRW5DLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQzVDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtRQUNoQyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksY0FBTyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRWxDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSwwQkFBVyxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBRXRFLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFBO1FBRWhDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLGtDQUFrQixDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBRXJGLElBQUksQ0FBQyxhQUFhLEdBQUcsU0FBUyxDQUFBO0lBQ2hDLENBQUM7SUFFTSxVQUFVO1FBQ2YsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtRQUMzQixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBRTFCLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFBO1FBQzlCLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDekIsSUFBSSxD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QUFZLENBQUMsQ0FBQTtZQUMvRCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUE7WUFDeEMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQ3hCLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsRUFDeEQsVUFBVSxDQUFDLG1CQUFtQixDQUFDLENBQUMsTUFBa0MsS0FDaEUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsTUFBTSxDQUFDLENBQUMsRUFDbkQsVUFBVSxDQUFDLGdCQUFnQixDQUFDLENBQUMsTUFBa0IsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxNQUFNLENBQUMsQ0FBQyxFQUNsRyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUMsTUFBa0IsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLENBQUMsQ0FBQyxFQUNoRyxVQUFVLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxFQUFjLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FDekcsQ0FBQTtRQUNILENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUF4SUQsc0NBd0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlLCBFbWl0dGVyLCBUZXh0RWRpdG9yLCBQb2ludCwgVGV4dEJ1ZmZlciwgR3JhbW1hcn0gZnJvbSAnYXRvbSdcbmltcG9ydCB7UmVzdWx0c0RCLCBUVXBkYXRlQ2FsbGJhY2t9IGZyb20gJy4vcmVzdWx0cy1kYidcbmltcG9ydCB7T3V0cHV0UGFuZWx9IGZyb20gJy4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHtDb25maWdQYXJhbU1hbmFnZXIsIElTdGF0ZSBhcyBJUGFyYW1TdGF0ZX0gZnJvbSAnLi9jb25maWctcGFyYW1zJ1xuaW1wb3J0IHtFZGl0b3JDb250cm9sLCBUVGV4dEJ1ZmZlckNhbGxiYWNrfSBmcm9tICcuL2VkaXRvci1jb250cm9sJ1xuaW1wb3J0IHtMaW50ZXJTdXBwb3J0fSBmcm9tICcuL2xpbnRlci1zdXBwb3J0J1xuXG50eXBlIExpbnRlciA9IGFueSAvLyBUT0RPOiBTdGVhbCB0aGlzIGZyb20gYXRvbS10eXBlc2NyaXB0XG5cbmV4cG9ydCB0eXBlIFRFdmVudFR5cGUgPSAna2V5Ym9hcmQnIHwgJ2NvbnRleHQnIHwgJ21vdXNlJyB8ICdzZWxlY3Rpb24nXG50eXBlIFRTaG93VG9vbHRpcENhbGxiYWNrUGFyYW1zID0ge2VkaXRvcjogVGV4dEVkaXRvciwgcG9zOiBQb2ludCwgZXZlbnRUeXBlOiBURXZlbnRUeXBlfVxudHlwZSBUU2hvd1Rvb2x0aXBDYWxsYmFjayA9IChwYXJzOiBUU2hvd1Rvb2x0aXBDYWxsYmFja1BhcmFtcykgPT4gdm9pZFxuXG50eXBlIElPdXRwdXRWaWV3U3RhdGUgPSBhbnlcbmV4cG9ydCBpbnRlcmZhY2UgSVN0YXRlIHtcbiAgb3V0cHV0VmlldzogSU91dHB1dFZpZXdTdGF0ZVxuICBjb25maWdQYXJhbXM6IElQYXJhbVN0YXRlXG59XG5cbmV4cG9ydCBjbGFzcyBQbHVnaW5NYW5hZ2VyIHtcbiAgcHVibGljIGNoZWNrUmVzdWx0czogUmVzdWx0c0RCXG4gIHB1YmxpYyBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwdWJsaWMgY29udHJvbGxlcnM6IFdlYWtNYXA8VGV4dEVkaXRvciwgRWRpdG9yQ29udHJvbD5cbiAgcHVibGljIGVtaXR0ZXI6IEVtaXR0ZXJcbiAgcHVibGljIG91dHB1dFZpZXc6IE91dHB1dFBhbmVsXG4gIHB1YmxpYyBjb25maWdQYXJhbU1hbmFnZXI6IENvbmZpZ1BhcmFtTWFuYWdlclxuICBwdWJsaWMgbGludGVyU3VwcG9ydD86IExpbnRlclN1cHBvcnRcbiAgY29uc3RydWN0b3IgKHN0YXRlOiBJU3RhdGUpIHtcbiAgICB0aGlzLmNoZWNrUmVzdWx0cyA9IG5ldyBSZXN1bHRzREIoKVxuXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmNvbnRyb2xsZXJzID0gbmV3IFdlYWtNYXAoKVxuICAgIHRoaXMuZW1pdHRlciA9IG5ldyBFbWl0dGVyKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLmVtaXR0ZXIpXG5cbiAgICB0aGlzLm91dHB1dFZpZXcgPSBuZXcgT3V0cHV0UGFuZWwoc3RhdGUub3V0cHV0VmlldywgdGhpcy5jaGVja1Jlc3VsdHMpXG5cbiAgICB0aGlzLnN1YnNjcmliZUVkaXRvckNvbnRyb2xsZXIoKVxuXG4gICAgdGhpcy5jb25maWdQYXJhbU1hbmFnZXIgPSBuZXcgQ29uZmlnUGFyYW1NYW5hZ2VyKHRoaXMub3V0cHV0Vmlldywgc3RhdGUuY29uZmlnUGFyYW1zKVxuXG4gICAgdGhpcy5saW50ZXJTdXBwb3J0ID0gdW5kZWZpbmVkXG4gIH1cblxuICBwdWJsaWMgZGVhY3RpdmF0ZSAoKSB7XG4gICAgdGhpcy5jaGVja1Jlc3VsdHMuZGVzdHJveSgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcblxuICAgIHRoaXMuZGVsZXRlRWRpdG9yQ29udHJvbGxlcnMoKVxuICAgIHRoaXMub3V0cHV0Vmlldy5kZXN0cm95KClcbiAgICB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5kZXN0cm95KClcbiAgICBpZiAodGhpcy5saW50ZXJTdXBwb3J0KSB7XG4gICAgICB0aGlzLmxpbnRlclN1cHBvcnQuZGVzdHJveSgpXG4gICAgICB0aGlzLmxpbnRlclN1cHBvcnQgPSB1bmRlZmluZWRcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2VyaWFsaXplICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgb3V0cHV0VmlldzogdGhpcy5vdXRwdXRWaWV3LnNlcmlhbGl6ZSgpLFxuICAgICAgY29uZmlnUGFyYW1zOiB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5zZXJpYWxpemUoKVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvblNob3VsZFNob3dUb29sdGlwIChjYWxsYmFjazogVFNob3dUb29sdGlwQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdzaG91bGQtc2hvdy10b29sdGlwJywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgb25XaWxsU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCd3aWxsLXNhdmUtYnVmZmVyJywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgb25EaWRTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1zYXZlLWJ1ZmZlcicsIGNhbGxiYWNrKVxuICB9XG5cbiAgcHVibGljIG9uRGlkU3RvcENoYW5naW5nIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1zdG9wLWNoYW5naW5nJywgY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgdG9nZ2xlUGFuZWwgKCkge1xuICAgIHRoaXMub3V0cHV0Vmlldy50b2dnbGUoKVxuICB9XG5cbiAgcHVibGljIG9uUmVzdWx0c1VwZGF0ZWQgKGNhbGxiYWNrOiBUVXBkYXRlQ2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5jaGVja1Jlc3VsdHMub25EaWRVcGRhdGUoY2FsbGJhY2spXG4gIH1cblxuICBwdWJsaWMgY29udHJvbGxlciAoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgcmV0dXJuIHRoaXMuY29udHJvbGxlcnMuZ2V0KGVkaXRvcilcbiAgfVxuXG4gIHB1YmxpYyBzZXRMaW50ZXIgKGxpbnRlcjogTGludGVyKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnbGludGVyJykgeyByZXR1cm4gfVxuICAgIHRoaXMubGludGVyU3VwcG9ydCA9IG5ldyBMaW50ZXJTdXBwb3J0KGxpbnRlciwgdGhpcy5jaGVja1Jlc3VsdHMpXG4gIH1cblxuICBwdWJsaWMgbmV4dEVycm9yICgpIHtcbiAgICBpZiAoYXRvbS5jb25maWcuZ2V0KCdpZGUtaGFza2VsbC5tZXNzYWdlRGlzcGxheUZyb250ZW5kJykgIT09ICdidWlsdGluJykgeyByZXR1cm4gfVxuICAgIHRoaXMub3V0cHV0Vmlldy5zaG93TmV4dEVycm9yKClcbiAgfVxuXG4gIHB1YmxpYyBwcmV2RXJyb3IgKCkge1xuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSAhPT0gJ2J1aWx0aW4nKSB7IHJldHVybiB9XG4gICAgdGhpcy5vdXRwdXRWaWV3LnNob3dQcmV2RXJyb3IoKVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVDb250cm9sbGVyIChlZGl0b3I6IFRleHRFZGl0b3IpIHtcbiAgICBjb25zdCBjb250cm9sbGVyID0gdGhpcy5jb250cm9sbGVycy5nZXQoZWRpdG9yKVxuICAgIGlmIChjb250cm9sbGVyKSB7XG4gICAgICBjb250cm9sbGVyLmRlYWN0aXZhdGUoKVxuICAgICAgdGhpcy5jb250cm9sbGVycy5kZWxldGUoZWRpdG9yKVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY29udHJvbGxlck9uR3JhbW1hciAoZWRpdG9yOiBUZXh0RWRpdG9yLCBncmFtbWFyOiBHcmFtbWFyKSB7XG4gICAgaWYgKGdyYW1tYXIuc2NvcGVOYW1lLm1hdGNoKC9oYXNrZWxsJC8pKSB7XG4gICAgICB0aGlzLmFkZENvbnRyb2xsZXIoZWRpdG9yKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbW92ZUNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIH1cbiAgfVxuXG4gIC8vIE9ic2VydmUgdGV4dCBlZGl0b3JzIHRvIGF0dGFjaCBjb250cm9sbGVyXG4gIHByaXZhdGUgc3Vic2NyaWJlRWRpdG9yQ29udHJvbGxlciAoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoKGVkaXRvcikgPT4ge1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgICAgICBlZGl0b3Iub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXJPbkdyYW1tYXIoZWRpdG9yLCBncmFtbWFyKVxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZWRpdG9yLmdldEdyYW1tYXIoKSlcbiAgICAgIH0pXG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBkZWxldGVFZGl0b3JDb250cm9sbGVycyAoKSB7XG4gICAgZm9yIChjb25zdCBlZGl0b3Igb2YgYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKSkgeyB0aGlzLnJlbW92ZUNvbnRyb2xsZXIoZWRpdG9yKSB9XG4gIH1cblxuICBwcml2YXRlIGFkZENvbnRyb2xsZXIgKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIGlmICghdGhpcy5jb250cm9sbGVycy5oYXMoZWRpdG9yKSkge1xuICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBFZGl0b3JDb250cm9sKGVkaXRvciwgdGhpcy5jaGVja1Jlc3VsdHMpXG4gICAgICB0aGlzLmNvbnRyb2xsZXJzLnNldChlZGl0b3IsIGNvbnRyb2xsZXIpXG4gICAgICBjb250cm9sbGVyLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB0aGlzLnJlbW92ZUNvbnRyb2xsZXIoZWRpdG9yKSlcbiAgICAgICwgY29udHJvbGxlci5vblNob3VsZFNob3dUb29sdGlwKChwYXJhbXM6IFRTaG93VG9vbHRpcENhbGxiYWNrUGFyYW1zKSA9PlxuICAgICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdzaG91bGQtc2hvdy10b29sdGlwJywgcGFyYW1zKSlcbiAgICAgICwgY29udHJvbGxlci5vbldpbGxTYXZlQnVmZmVyKChidWZmZXI6IFRleHRCdWZmZXIpID0+IHRoaXMuZW1pdHRlci5lbWl0KCd3aWxsLXNhdmUtYnVmZmVyJywgYnVmZmVyKSlcbiAgICAgICwgY29udHJvbGxlci5vbkRpZFNhdmVCdWZmZXIoKGJ1ZmZlcjogVGV4dEJ1ZmZlcikgPT4gdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1zYXZlLWJ1ZmZlcicsIGJ1ZmZlcikpXG4gICAgICAsIGNvbnRyb2xsZXIub25EaWRTdG9wQ2hhbmdpbmcoKGVkOiBUZXh0RWRpdG9yKSA9PiB0aGlzLmVtaXR0ZXIuZW1pdCgnZGlkLXN0b3AtY2hhbmdpbmcnLCBlZC5nZXRCdWZmZXIoKSkpXG4gICAgICApXG4gICAgfVxuICB9XG59XG4iXX0=