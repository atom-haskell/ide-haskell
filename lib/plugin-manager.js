'use babel';
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const results_db_1 = require("./results-db");
const output_panel_1 = require("./output-panel");
const config_params_1 = require("./config-params");
const editor_control_1 = require("./editor-control");
const linter_support_1 = require("./linter-support");
class PluginManager {
    constructor(state) {
        this.checkResults = new results_db_1.default();
        this.disposables = new atom_1.CompositeDisposable();
        this.controllers = new WeakMap();
        this.emitter = new atom_1.Emitter();
        this.disposables.add(this.emitter);
        if (atom.config.get('ide-haskell.messageDisplayFrontend') === 'builtin') {
            this.disposables.add(this.onResultsUpdated(({ types }) => this.updateEditorsWithResults(types)));
        }
        this.outputView = new output_panel_1.OutputPanel(state.outputView, this.checkResults);
        this.subscribeEditorController();
        this.configParamManager = new config_params_1.ConfigParamManager(this.outputView, state.configParams);
        this.linterSupport = null;
    }
    deactivate() {
        this.checkResults.destroy();
        this.checkResults = null;
        this.disposables.dispose();
        this.deleteEditorControllers();
        this.outputView.destroy();
        this.outputView = null;
        this.configParamManager.destroy();
        this.configParamManager = null;
        if (this.linterSupport) {
            this.linterSupport.destroy();
            this.linterSupport = null;
        }
    }
    serialize() {
        return {
            outputView: this.outputView.serialize(),
            configParams: this.configParamManager.serialize()
        };
    }
    onShouldShowTooltip(callback) {
        return this.emitter.on('should-show-tooltip', callback);
    }
    onWillSaveBuffer(callback) {
        return this.emitter.on('will-save-buffer', callback);
    }
    onDidSaveBuffer(callback) {
        return this.emitter.on('did-save-buffer', callback);
    }
    onDidStopChanging(callback) {
        return this.emitter.on('did-stop-changing', callback);
    }
    togglePanel() {
        this.outputView.toggle();
    }
    updateEditorsWithResults(types) {
        for (let ed of atom.workspace.getTextEditors()) {
            let ctrl = this.controller(ed);
            if (ctrl)
                ctrl.updateResults(this.checkResults.filter({ uri: ed.getPath() }), types);
        }
    }
    onResultsUpdated(callback) {
        return this.checkResults.onDidUpdate(callback);
    }
    controller(editor) {
        return this.controllers.get(editor);
    }
    addController(editor) {
        if (!this.controllers.has(editor)) {
            let controller = new editor_control_1.default(editor);
            this.controllers.set(editor, controller);
            controller.disposables.add(editor.onDidDestroy(() => this.removeController(editor)), controller.onShouldShowTooltip(({ editor, pos, eventType }) => this.emitter.emit('should-show-tooltip', { editor, pos, eventType })), controller.onWillSaveBuffer((buffer) => this.emitter.emit('will-save-buffer', buffer)), controller.onDidSaveBuffer((buffer) => this.emitter.emit('did-save-buffer', buffer)), controller.onDidStopChanging((editor) => this.emitter.emit('did-stop-changing', editor.getBuffer())));
            controller.updateResults(this.checkResults.filter({ uri: editor.getPath() }));
        }
    }
    setLinter(linter) {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'linter')
            return;
        this.linterSupport = new linter_support_1.LinterSupport(linter, this.checkResults);
    }
    removeController(editor) {
        if (this.controllers.has(editor))
            this.controllers.get(editor).deactivate();
        this.controllers.delete(editor);
    }
    controllerOnGrammar(editor, grammar) {
        if (grammar.scopeName.match(/haskell$/))
            this.addController(editor);
        else
            this.removeController(editor);
    }
    subscribeEditorController() {
        this.disposables.add(atom.workspace.observeTextEditors((editor) => {
            this.disposables.add(editor.onDidChangeGrammar((grammar) => {
                this.controllerOnGrammar(editor, grammar);
            }));
            this.controllerOnGrammar(editor, editor.getGrammar());
        }));
    }
    deleteEditorControllers() {
        for (let editor of atom.workspace.getTextEditors()) {
            this.removeController(editor);
        }
    }
    nextError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin')
            return;
        this.outputView.showNextError();
    }
    prevError() {
        if (atom.config.get('ide-haskell.messageDisplayFrontend') !== 'builtin')
            return;
        this.outputView.showPrevError();
    }
    addConfigParam(pluginName, specs) {
        return this.configParamManager.add(pluginName, specs);
    }
    getConfigParam(pluginName, name) {
        return this.configParamManager.get(pluginName, name);
    }
    setConfigParam(pluginName, name, value) {
        return this.configParamManager.set(pluginName, name, value);
    }
}
exports.default = PluginManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2luLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcGx1Z2luLW1hbmFnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFBOztBQUVYLCtCQUFpRDtBQUNqRCw2Q0FBb0M7QUFDcEMsaURBQTBDO0FBQzFDLG1EQUFrRDtBQUNsRCxxREFBNEM7QUFDNUMscURBQThDO0FBRTlDO0lBQ0UsWUFBYSxLQUFLO1FBQ2hCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxvQkFBUyxFQUFFLENBQUE7UUFFbkMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDNUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQ2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxjQUFPLEVBQUUsQ0FBQTtRQUM1QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFFbEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3hFLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUNsQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFDLEtBQUssRUFBQyxLQUFLLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUN6RSxDQUFBO1FBQ0gsQ0FBQztRQUVELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSwwQkFBVyxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBRXRFLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFBO1FBRWhDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLGtDQUFrQixDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxD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TUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQUMsQ0FBQztJQUN2RixDQUFDO0lBRUQsU0FBUztRQUNQLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFDLEtBQUssU0FBUyxDQUFDO1lBQUMsTUFBTSxDQUFBO1FBQy9FLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLENBQUE7SUFDakMsQ0FBQztJQUVELFNBQVM7UUFDUCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxvQ0FBb0MsQ0FBQyxLQUFLLFNBQVMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUMvRSxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxDQUFBO0lBQ2pDLENBQUM7SUFFRCxjQUFjLENBQUUsVUFBVSxFQUFFLEtBQUs7UUFDL0IsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFBO0lBQ3ZELENBQUM7SUFFRCxjQUFjLENBQUUsVUFBVSxFQUFFLElBQUk7UUFDOUIsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQ3RELENBQUM7SUFFRCxjQUFjLENBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxLQUFLO1FBQ3JDLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDN0QsQ0FBQztDQUNGO0FBeEpELGdDQXdKQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnXG5cbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgRW1pdHRlcn0gZnJvbSAnYXRvbSdcbmltcG9ydCBSZXN1bHRzREIgZnJvbSAnLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtPdXRwdXRQYW5lbH0gZnJvbSAnLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge0NvbmZpZ1BhcmFtTWFuYWdlcn0gZnJvbSAnLi9jb25maWctcGFyYW1zJ1xuaW1wb3J0IEVkaXRvckNvbnRyb2wgZnJvbSAnLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7TGludGVyU3VwcG9ydH0gZnJvbSAnLi9saW50ZXItc3VwcG9ydCdcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUGx1Z2luTWFuYWdlciB7XG4gIGNvbnN0cnVjdG9yIChzdGF0ZSkge1xuICAgIHRoaXMuY2hlY2tSZXN1bHRzID0gbmV3IFJlc3VsdHNEQigpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIHRoaXMuY29udHJvbGxlcnMgPSBuZXcgV2Vha01hcCgpXG4gICAgdGhpcy5lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMuZW1pdHRlcilcblxuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSA9PT0gJ2J1aWx0aW4nKSB7XG4gICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgICAgdGhpcy5vblJlc3VsdHNVcGRhdGVkKCh7dHlwZXN9KSA9PiB0aGlzLnVwZGF0ZUVkaXRvcnNXaXRoUmVzdWx0cyh0eXBlcykpXG4gICAgICApXG4gICAgfVxuXG4gICAgdGhpcy5vdXRwdXRWaWV3ID0gbmV3IE91dHB1dFBhbmVsKHN0YXRlLm91dHB1dFZpZXcsIHRoaXMuY2hlY2tSZXN1bHRzKVxuXG4gICAgdGhpcy5zdWJzY3JpYmVFZGl0b3JDb250cm9sbGVyKClcblxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyID0gbmV3IENvbmZpZ1BhcmFtTWFuYWdlcih0aGlzLm91dHB1dFZpZXcsIHN0YXRlLmNvbmZpZ1BhcmFtcylcblxuICAgIHRoaXMubGludGVyU3VwcG9ydCA9IG51bGxcbiAgfVxuXG4gIGRlYWN0aXZhdGUgKCkge1xuICAgIHRoaXMuY2hlY2tSZXN1bHRzLmRlc3Ryb3koKVxuICAgIHRoaXMuY2hlY2tSZXN1bHRzID0gbnVsbFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG5cbiAgICB0aGlzLmRlbGV0ZUVkaXRvckNvbnRyb2xsZXJzKClcbiAgICB0aGlzLm91dHB1dFZpZXcuZGVzdHJveSgpXG4gICAgdGhpcy5vdXRwdXRWaWV3ID0gbnVsbFxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLmRlc3Ryb3koKVxuICAgIHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyID0gbnVsbFxuICAgIGlmICh0aGlzLmxpbnRlclN1cHBvcnQpIHtcbiAgICAgIHRoaXMubGludGVyU3VwcG9ydC5kZXN0cm95KClcbiAgICAgIHRoaXMubGludGVyU3VwcG9ydCA9IG51bGxcbiAgICB9XG4gIH1cblxuICBzZXJpYWxpemUgKCkge1xuICAgIHJldHVybiB7XG4gICAgICBvdXRwdXRWaWV3OiB0aGlzLm91dHB1dFZpZXcuc2VyaWFsaXplKCksXG4gICAgICBjb25maWdQYXJhbXM6IHRoaXMuY29uZmlnUGFyYW1NYW5hZ2VyLnNlcmlhbGl6ZSgpXG4gICAgfVxuICB9XG5cbiAgb25TaG91bGRTaG93VG9vbHRpcCAoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdzaG91bGQtc2hvdy10b29sdGlwJywgY2FsbGJhY2spXG4gIH1cblxuICBvbldpbGxTYXZlQnVmZmVyIChjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ3dpbGwtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcbiAgfVxuXG4gIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5lbWl0dGVyLm9uKCdkaWQtc2F2ZS1idWZmZXInLCBjYWxsYmFjaylcbiAgfVxuXG4gIG9uRGlkU3RvcENoYW5naW5nIChjYWxsYmFjaykge1xuICAgIHJldHVybiB0aGlzLmVtaXR0ZXIub24oJ2RpZC1zdG9wLWNoYW5naW5nJywgY2FsbGJhY2spXG4gIH1cblxuICB0b2dnbGVQYW5lbCAoKSB7XG4gICAgdGhpcy5vdXRwdXRWaWV3LnRvZ2dsZSgpXG4gIH1cblxuICB1cGRhdGVFZGl0b3JzV2l0aFJlc3VsdHMgKHR5cGVzKSB7XG4gICAgZm9yIChsZXQgZWQgb2YgYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKSkge1xuICAgICAgbGV0IGN0cmwgPSB0aGlzLmNvbnRyb2xsZXIoZWQpXG4gICAgICBpZiAoY3RybCkgY3RybC51cGRhdGVSZXN1bHRzKHRoaXMuY2hlY2tSZXN1bHRzLmZpbHRlcih7dXJpOiBlZC5nZXRQYXRoKCl9KSwgdHlwZXMpXG4gICAgfVxuICB9XG5cbiAgb25SZXN1bHRzVXBkYXRlZCAoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5jaGVja1Jlc3VsdHMub25EaWRVcGRhdGUoY2FsbGJhY2spXG4gIH1cblxuICBjb250cm9sbGVyIChlZGl0b3IpIHtcbiAgICByZXR1cm4gdGhpcy5jb250cm9sbGVycy5nZXQoZWRpdG9yKVxuICB9XG5cbiAgYWRkQ29udHJvbGxlciAoZWRpdG9yKSB7XG4gICAgaWYgKCF0aGlzLmNvbnRyb2xsZXJzLmhhcyhlZGl0b3IpKSB7XG4gICAgICBsZXQgY29udHJvbGxlciA9IG5ldyBFZGl0b3JDb250cm9sKGVkaXRvcilcbiAgICAgIHRoaXMuY29udHJvbGxlcnMuc2V0KGVkaXRvciwgY29udHJvbGxlcilcbiAgICAgIGNvbnRyb2xsZXIuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgICBlZGl0b3Iub25EaWREZXN0cm95KCgpID0+IHRoaXMucmVtb3ZlQ29udHJvbGxlcihlZGl0b3IpKVxuICAgICAgLCBjb250cm9sbGVyLm9uU2hvdWxkU2hvd1Rvb2x0aXAoKHtlZGl0b3IsIHBvcywgZXZlbnRUeXBlfSkgPT5cbiAgICAgICAgICB0aGlzLmVtaXR0ZXIuZW1pdCgnc2hvdWxkLXNob3ctdG9vbHRpcCcsIHtlZGl0b3IsIHBvcywgZXZlbnRUeXBlfSkpXG4gICAgICAsIGNvbnRyb2xsZXIub25XaWxsU2F2ZUJ1ZmZlcigoYnVmZmVyKSA9PiB0aGlzLmVtaXR0ZXIuZW1pdCgnd2lsbC1zYXZlLWJ1ZmZlcicsIGJ1ZmZlcikpXG4gICAgICAsIGNvbnRyb2xsZXIub25EaWRTYXZlQnVmZmVyKChidWZmZXIpID0+IHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc2F2ZS1idWZmZXInLCBidWZmZXIpKVxuICAgICAgLCBjb250cm9sbGVyLm9uRGlkU3RvcENoYW5naW5nKChlZGl0b3IpID0+IHRoaXMuZW1pdHRlci5lbWl0KCdkaWQtc3RvcC1jaGFuZ2luZycsIGVkaXRvci5nZXRCdWZmZXIoKSkpXG4gICAgICApXG4gICAgICBjb250cm9sbGVyLnVwZGF0ZVJlc3VsdHModGhpcy5jaGVja1Jlc3VsdHMuZmlsdGVyKHt1cmk6IGVkaXRvci5nZXRQYXRoKCl9KSlcbiAgICB9XG4gIH1cblxuICBzZXRMaW50ZXIgKGxpbnRlcikge1xuICAgIGlmIChhdG9tLmNvbmZpZy5nZXQoJ2lkZS1oYXNrZWxsLm1lc3NhZ2VEaXNwbGF5RnJvbnRlbmQnKSAhPT0gJ2xpbnRlcicpIHJldHVyblxuICAgIHRoaXMubGludGVyU3VwcG9ydCA9IG5ldyBMaW50ZXJTdXBwb3J0KGxpbnRlciwgdGhpcy5jaGVja1Jlc3VsdHMpXG4gIH1cblxuICByZW1vdmVDb250cm9sbGVyIChlZGl0b3IpIHtcbiAgICBpZiAodGhpcy5jb250cm9sbGVycy5oYXMoZWRpdG9yKSkgdGhpcy5jb250cm9sbGVycy5nZXQoZWRpdG9yKS5kZWFjdGl2YXRlKClcbiAgICB0aGlzLmNvbnRyb2xsZXJzLmRlbGV0ZShlZGl0b3IpXG4gIH1cblxuICBjb250cm9sbGVyT25HcmFtbWFyIChlZGl0b3IsIGdyYW1tYXIpIHtcbiAgICBpZiAoZ3JhbW1hci5zY29wZU5hbWUubWF0Y2goL2hhc2tlbGwkLykpIHRoaXMuYWRkQ29udHJvbGxlcihlZGl0b3IpXG4gICAgZWxzZSB0aGlzLnJlbW92ZUNvbnRyb2xsZXIoZWRpdG9yKVxuICB9XG5cbiAgLy8gT2JzZXJ2ZSB0ZXh0IGVkaXRvcnMgdG8gYXR0YWNoIGNvbnRyb2xsZXJcbiAgc3Vic2NyaWJlRWRpdG9yQ29udHJvbGxlciAoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXG4gICAgICBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoKGVkaXRvcikgPT4ge1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChcbiAgICAgICAgICBlZGl0b3Iub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xsZXJPbkdyYW1tYXIoZWRpdG9yLCBncmFtbWFyKVxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgdGhpcy5jb250cm9sbGVyT25HcmFtbWFyKGVkaXRvciwgZWRpdG9yLmdldEdyYW1tYXIoKSlcbiAgICAgIH0pXG4gICAgKVxuICB9XG5cbiAgZGVsZXRlRWRpdG9yQ29udHJvbGxlcnMgKCkge1xuICAgIGZvciAobGV0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7IHRoaXMucmVtb3ZlQ29udHJvbGxlcihlZGl0b3IpIH1cbiAgfVxuXG4gIG5leHRFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHJldHVyblxuICAgIHRoaXMub3V0cHV0Vmlldy5zaG93TmV4dEVycm9yKClcbiAgfVxuXG4gIHByZXZFcnJvciAoKSB7XG4gICAgaWYgKGF0b20uY29uZmlnLmdldCgnaWRlLWhhc2tlbGwubWVzc2FnZURpc3BsYXlGcm9udGVuZCcpICE9PSAnYnVpbHRpbicpIHJldHVyblxuICAgIHRoaXMub3V0cHV0Vmlldy5zaG93UHJldkVycm9yKClcbiAgfVxuXG4gIGFkZENvbmZpZ1BhcmFtIChwbHVnaW5OYW1lLCBzcGVjcykge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5hZGQocGx1Z2luTmFtZSwgc3BlY3MpXG4gIH1cblxuICBnZXRDb25maWdQYXJhbSAocGx1Z2luTmFtZSwgbmFtZSkge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5nZXQocGx1Z2luTmFtZSwgbmFtZSlcbiAgfVxuXG4gIHNldENvbmZpZ1BhcmFtIChwbHVnaW5OYW1lLCBuYW1lLCB2YWx1ZSkge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZ1BhcmFtTWFuYWdlci5zZXQocGx1Z2luTmFtZSwgbmFtZSwgdmFsdWUpXG4gIH1cbn1cbiJdfQ==