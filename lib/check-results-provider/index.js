"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
class CheckResultsProvider {
    constructor(editor, pluginManager) {
        this.editor = editor;
        const results = pluginManager.resultsDB;
        const tooltipRegistry = pluginManager.tooltipRegistry;
        this.gutter = this.editor.gutterWithName('ide-haskell-check-results');
        this.disposables = new atom_1.CompositeDisposable();
        this.markers = editor.addMarkerLayer({
            maintainHistory: true,
            persistent: false
        });
        this.markerProps = new WeakMap();
        this.disposables.add(results.onDidUpdate(this.updateResults.bind(this)));
        this.disposables.add(tooltipRegistry.register('builtin:check-results', {
            priority: 200,
            handler: this.tooltipProvider.bind(this)
        }));
        this.updateResults(results);
    }
    destroy() {
        this.markers.destroy();
        this.disposables.dispose();
    }
    tooltipProvider(editor, crange, type) {
        if (this.editor !== editor) {
            return;
        }
        const msg = this.getMessageAt(crange.start, type);
        if (msg.length > 0) {
            return { range: crange, text: msg };
        }
    }
    getMessageAt(pos, type) {
        const markers = this.find(pos, type);
        const result = [];
        for (const marker of markers) {
            const res = this.markerProps.get(marker);
            if (!res) {
                continue;
            }
            result.push(res.message);
        }
        return result;
    }
    updateResults(res) {
        this.markers.clear();
        const path = this.editor.getPath();
        for (const r of res.filter(({ uri }) => uri === path)) {
            this.markerFromCheckResult(r);
        }
    }
    markerFromCheckResult(resItem) {
        const { position } = resItem;
        if (!position) {
            return;
        }
        const range = new atom_1.Range(position, atom_1.Point.fromObject([position.row, position.column + 1]));
        const marker = this.markers.markBufferRange(range, { invalidate: 'touch' });
        this.markerProps.set(marker, resItem);
        const disp = new atom_1.CompositeDisposable();
        disp.add(marker.onDidDestroy(() => {
            this.markerProps.delete(marker);
            disp.dispose();
        }), marker.onDidChange(({ isValid }) => {
            resItem.setValid(isValid);
        }));
        this.decorateMarker(marker, resItem);
    }
    decorateMarker(m, r) {
        if (!this.gutter) {
            return;
        }
        const cls = { class: `ide-haskell-${r.severity}` };
        this.gutter.decorateMarker(m, Object.assign({ type: 'line-number' }, cls));
        this.editor.decorateMarker(m, Object.assign({ type: 'highlight' }, cls));
        this.editor.decorateMarker(m, Object.assign({ type: 'line' }, cls));
    }
    find(pos, type) {
        switch (type) {
            case 'gutter':
            case 'selection':
                return this.markers.findMarkers({ startBufferRow: pos.row });
            case 'keyboard':
                return this.markers.findMarkers({ startBufferPosition: pos });
            case 'mouse':
            case 'context':
                return this.markers.findMarkers({ containsBufferPosition: pos });
            default: throw new TypeError('Switch assertion failed');
        }
    }
}
exports.CheckResultsProvider = CheckResultsProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY2hlY2stcmVzdWx0cy1wcm92aWRlci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUdhO0FBUWI7SUFLRSxZQUFxQixNQUFrQixFQUFFLGFBQTRCO1FBQWhELFdBQU0sR0FBTixNQUFNLENBQVk7UUFDckMsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQTtRQUN2QyxNQUFNLGVBQWUsR0FBRyxhQUFhLENBQUMsZUFBZSxDQUFBO1FBQ3JELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsMkJBQTJCLENBQUMsQ0FBQTtRQUVyRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUM7WUFDbkMsZUFBZSxFQUFFLElBQUk7WUFDckIsVUFBVSxFQUFFLEtBQUs7U0FDbEIsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFBO1FBQ2hDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3hFLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsdUJBQXVCLEVBQUU7WUFDckUsUUFBUSxFQUFFLEdBQUc7WUFDYixPQUFPLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1NBQ3pDLENBQUMsQ0FBQyxDQUFBO1FBQ0gsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUM3QixDQUFDO0lBRU0sT0FBTztRQUNaLElBQUksQ0FB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S0FBSyxTQUFTO2dCQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFLHNCQUFzQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUE7WUFDbEUsU0FBUyxNQUFNLElBQUksU0FBUyxDQUFDLHlCQUF5QixDQUFDLENBQUE7UUFDekQsQ0FBQztJQUNILENBQUM7Q0FDRjtBQW5HRCxvREFtR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBSYW5nZSwgVGV4dEVkaXRvciwgUG9pbnQsIENvbXBvc2l0ZURpc3Bvc2FibGUsIEd1dHRlciwgRGlzcGxheU1hcmtlcixcbiAgRGlzcGxheU1hcmtlckxheWVyXG59IGZyb20gJ2F0b20nXG5cbmltcG9ydCB7UmVzdWx0SXRlbX0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7TWVzc2FnZU9iamVjdH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1Jlc3VsdHNEQn0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7VEV2ZW50UmFuZ2VUeXBlfSBmcm9tICcuLi9lZGl0b3ItY29udHJvbC90b29sdGlwLW1hbmFnZXInXG5pbXBvcnQge1BsdWdpbk1hbmFnZXIsIElFZGl0b3JDb250cm9sbGVyfSBmcm9tICcuLi9wbHVnaW4tbWFuYWdlcidcblxuZXhwb3J0IGNsYXNzIENoZWNrUmVzdWx0c1Byb3ZpZGVyIGltcGxlbWVudHMgSUVkaXRvckNvbnRyb2xsZXIge1xuICBwdWJsaWMgZ3V0dGVyOiBHdXR0ZXJcbiAgcHJpdmF0ZSBtYXJrZXJzOiBEaXNwbGF5TWFya2VyTGF5ZXJcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIG1hcmtlclByb3BzOiBXZWFrTWFwPERpc3BsYXlNYXJrZXIsIFJlc3VsdEl0ZW0+XG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIGVkaXRvcjogVGV4dEVkaXRvciwgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIGNvbnN0IHJlc3VsdHMgPSBwbHVnaW5NYW5hZ2VyLnJlc3VsdHNEQlxuICAgIGNvbnN0IHRvb2x0aXBSZWdpc3RyeSA9IHBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5XG4gICAgdGhpcy5ndXR0ZXIgPSB0aGlzLmVkaXRvci5ndXR0ZXJXaXRoTmFtZSgnaWRlLWhhc2tlbGwtY2hlY2stcmVzdWx0cycpXG5cbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIHRoaXMubWFya2VycyA9IGVkaXRvci5hZGRNYXJrZXJMYXllcih7XG4gICAgICBtYWludGFpbkhpc3Rvcnk6IHRydWUsXG4gICAgICBwZXJzaXN0ZW50OiBmYWxzZVxuICAgIH0pXG4gICAgdGhpcy5tYXJrZXJQcm9wcyA9IG5ldyBXZWFrTWFwKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChyZXN1bHRzLm9uRGlkVXBkYXRlKHRoaXMudXBkYXRlUmVzdWx0cy5iaW5kKHRoaXMpKSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0b29sdGlwUmVnaXN0cnkucmVnaXN0ZXIoJ2J1aWx0aW46Y2hlY2stcmVzdWx0cycsIHtcbiAgICAgIHByaW9yaXR5OiAyMDAsXG4gICAgICBoYW5kbGVyOiB0aGlzLnRvb2x0aXBQcm92aWRlci5iaW5kKHRoaXMpXG4gICAgfSkpXG4gICAgdGhpcy51cGRhdGVSZXN1bHRzKHJlc3VsdHMpXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSAoKSB7XG4gICAgdGhpcy5tYXJrZXJzLmRlc3Ryb3koKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwcml2YXRlIHRvb2x0aXBQcm92aWRlciAoZWRpdG9yOiBUZXh0RWRpdG9yLCBjcmFuZ2U6IFJhbmdlLCB0eXBlOiBURXZlbnRSYW5nZVR5cGUpIHtcbiAgICBpZiAodGhpcy5lZGl0b3IgIT09IGVkaXRvcikgeyByZXR1cm4gfVxuICAgIGNvbnN0IG1zZyA9IHRoaXMuZ2V0TWVzc2FnZUF0KGNyYW5nZS5zdGFydCwgdHlwZSlcbiAgICBpZiAobXNnLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiB7IHJhbmdlOiBjcmFuZ2UsIHRleHQ6IG1zZyB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRNZXNzYWdlQXQgKHBvczogUG9pbnQsIHR5cGU6IFRFdmVudFJhbmdlVHlwZSkge1xuICAgIGNvbnN0IG1hcmtlcnMgPSB0aGlzLmZpbmQocG9zLCB0eXBlKVxuICAgIGNvbnN0IHJlc3VsdDogTWVzc2FnZU9iamVjdFtdID0gW11cbiAgICBmb3IgKGNvbnN0IG1hcmtlciBvZiBtYXJrZXJzKSB7XG4gICAgICBjb25zdCByZXMgPSB0aGlzLm1hcmtlclByb3BzLmdldChtYXJrZXIpXG4gICAgICBpZiAoIXJlcykgeyBjb250aW51ZSB9XG4gICAgICByZXN1bHQucHVzaChyZXMubWVzc2FnZSlcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVSZXN1bHRzIChyZXM6IFJlc3VsdHNEQikge1xuICAgIHRoaXMubWFya2Vycy5jbGVhcigpXG4gICAgY29uc3QgcGF0aCA9IHRoaXMuZWRpdG9yLmdldFBhdGgoKVxuICAgIGZvciAoY29uc3QgciBvZiByZXMuZmlsdGVyKCh7dXJpfSkgPT4gdXJpID09PSBwYXRoKSkge1xuICAgICAgdGhpcy5tYXJrZXJGcm9tQ2hlY2tSZXN1bHQocilcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1hcmtlckZyb21DaGVja1Jlc3VsdCAocmVzSXRlbTogUmVzdWx0SXRlbSkge1xuICAgIGNvbnN0IHtwb3NpdGlvbn0gPSByZXNJdGVtXG4gICAgaWYgKCFwb3NpdGlvbikgeyByZXR1cm4gfVxuXG4gICAgY29uc3QgcmFuZ2UgPSBuZXcgUmFuZ2UocG9zaXRpb24sIFBvaW50LmZyb21PYmplY3QoW3Bvc2l0aW9uLnJvdywgcG9zaXRpb24uY29sdW1uICsgMV0pKVxuICAgIGNvbnN0IG1hcmtlciA9IHRoaXMubWFya2Vycy5tYXJrQnVmZmVyUmFuZ2UocmFuZ2UsIHsgaW52YWxpZGF0ZTogJ3RvdWNoJyB9KVxuICAgIHRoaXMubWFya2VyUHJvcHMuc2V0KG1hcmtlciwgcmVzSXRlbSlcbiAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGRpc3AuYWRkKFxuICAgICAgbWFya2VyLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgIHRoaXMubWFya2VyUHJvcHMuZGVsZXRlKG1hcmtlcilcbiAgICAgICAgZGlzcC5kaXNwb3NlKClcbiAgICAgIH0pLFxuICAgICAgbWFya2VyLm9uRGlkQ2hhbmdlKCh7aXNWYWxpZH06IHtpc1ZhbGlkOiBib29sZWFufSkgPT4ge1xuICAgICAgICByZXNJdGVtLnNldFZhbGlkKGlzVmFsaWQpXG4gICAgICB9KVxuICAgIClcbiAgICB0aGlzLmRlY29yYXRlTWFya2VyKG1hcmtlciwgcmVzSXRlbSlcbiAgfVxuXG4gIHByaXZhdGUgZGVjb3JhdGVNYXJrZXIgKG06IERpc3BsYXlNYXJrZXIsIHI6IFJlc3VsdEl0ZW0pIHtcbiAgICBpZiAoIXRoaXMuZ3V0dGVyKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgY2xzID0ge2NsYXNzOiBgaWRlLWhhc2tlbGwtJHtyLnNldmVyaXR5fWB9XG4gICAgdGhpcy5ndXR0ZXIuZGVjb3JhdGVNYXJrZXIobSwgeyB0eXBlOiAnbGluZS1udW1iZXInLCAuLi5jbHMgfSlcbiAgICB0aGlzLmVkaXRvci5kZWNvcmF0ZU1hcmtlcihtLCB7IHR5cGU6ICdoaWdobGlnaHQnLCAuLi5jbHMgfSlcbiAgICB0aGlzLmVkaXRvci5kZWNvcmF0ZU1hcmtlcihtLCB7IHR5cGU6ICdsaW5lJywgLi4uY2xzIH0pXG4gIH1cblxuICBwcml2YXRlIGZpbmQgKHBvczogUG9pbnQsIHR5cGU6IFRFdmVudFJhbmdlVHlwZSkge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSAnZ3V0dGVyJzpcbiAgICAgIGNhc2UgJ3NlbGVjdGlvbic6IC8vIFRPRE86IHRoaXMgaXMgbm90IGdvb2RcbiAgICAgICAgcmV0dXJuIHRoaXMubWFya2Vycy5maW5kTWFya2Vycyh7IHN0YXJ0QnVmZmVyUm93OiBwb3Mucm93IH0pXG4gICAgICBjYXNlICdrZXlib2FyZCc6XG4gICAgICAgIHJldHVybiB0aGlzLm1hcmtlcnMuZmluZE1hcmtlcnMoeyBzdGFydEJ1ZmZlclBvc2l0aW9uOiBwb3MgfSlcbiAgICAgIGNhc2UgJ21vdXNlJzpcbiAgICAgIGNhc2UgJ2NvbnRleHQnOlxuICAgICAgICByZXR1cm4gdGhpcy5tYXJrZXJzLmZpbmRNYXJrZXJzKHsgY29udGFpbnNCdWZmZXJQb3NpdGlvbjogcG9zIH0pXG4gICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgVHlwZUVycm9yKCdTd2l0Y2ggYXNzZXJ0aW9uIGZhaWxlZCcpXG4gICAgfVxuICB9XG59XG4iXX0=