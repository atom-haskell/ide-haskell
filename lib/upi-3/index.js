"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const instance_1 = require("./instance");
exports.UPIInstance = instance_1.UPIInstance;
const error_1 = require("./error");
exports.UPIError = error_1.UPIError;
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
        this.instances = new Map();
        this.disposables = new atom_1.CompositeDisposable();
    }
    consume(options) {
        const { name, menu, messageTypes, events, controls, params, consumer, tooltipEvent } = options;
        if (!name) {
            throw new error_1.UPIError('name has to be specified for UPI');
        }
        if (this.instances.has(name)) {
            throw new error_1.UPIError(`Plugin ${name} already registered with UPI`);
        }
        const instance = new instance_1.UPIInstance(this.pluginManager, name);
        this.instances.set(name, instance);
        const disp = new atom_1.CompositeDisposable();
        if (menu) {
            disp.add(instance.menu.set(menu));
        }
        if (messageTypes) {
            instance.messages.setTypes(messageTypes);
        }
        if (events) {
            for (const k in events) {
                if (instance.events[k]) {
                    let v = events[k];
                    if (!Array.isArray(v)) {
                        v = [v];
                    }
                    for (const i of v) {
                        disp.add(instance.events[k](i));
                    }
                }
            }
        }
        if (tooltipEvent) {
            let handler, priority;
            if (typeof tooltipEvent === 'function') {
                handler = tooltipEvent;
                priority = 100;
            }
            else {
                ({ handler, priority } = tooltipEvent);
            }
            if (!priority) {
                priority = 100;
            }
            disp.add(instance.tooltips.onShouldShowTooltip(priority, handler));
        }
        if (controls) {
            for (const i of controls) {
                disp.add(instance.controls.add(i));
            }
        }
        if (params) {
            disp.add(instance.params.add(params));
        }
        if (consumer) {
            const d = consumer(instance);
            if (typeof d === 'object') {
                disp.add(d);
            }
        }
        disp.add(new atom_1.Disposable(() => {
            this.instances.delete(name);
            instance.destroy();
        }));
        this.disposables.add(disp);
        return disp;
    }
    dispose() {
        this.disposables.dispose();
    }
}
exports.UPI = UPI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBb0Q7QUFFcEQseUNBQXNDO0FBRXBCLDZDQUFXO0FBRDdCLG1DQUFnQztBQUN4QixvQ0FBUTtBQXdCaEI7SUFHRSxZQUFxQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUMvQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFDMUIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7SUFDOUMsQ0FBQztJQVNNLE9BQU8sQ0FBRSxPQUE2QjtRQUMzQyxNQUFNLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBQyxHQUFHLE9BQU8sQ0FBQTtRQUM1RixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDVixNQUFNLElBQUksZ0JBQVEsQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFBO1FBQ3hELENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0IsTUFBTSxJQUFJLGdCQUFRLENBQUMsVUFBVSxJQUFJLDhCQUE4QixDQUFDLENBQUE7UUFDbEUsQ0FBQztRQUNELE1BQU0sUUFBUSxHQUFHLElBQUksc0JBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQzFELElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQTtRQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFFdEMsRUFBRSxDQUFDLENBQUMsSUFB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USxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ3BCLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDSCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUMxQixNQUFNLENBQUMsSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVNLE9BQU87UUFDWixJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQzVCLENBQUM7Q0FDRjtBQWxGRCxrQkFrRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGV9IGZyb20gJ2F0b20nXG5pbXBvcnQge1BsdWdpbk1hbmFnZXJ9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtVUElJbnN0YW5jZX0gZnJvbSAnLi9pbnN0YW5jZSdcbmltcG9ydCB7VVBJRXJyb3J9IGZyb20gJy4vZXJyb3InXG5leHBvcnQge1VQSUVycm9yLCBVUElJbnN0YW5jZX1cblxuaW1wb3J0IHtJTWVudURlZmluaXRpb259IGZyb20gJy4vaW5zdGFuY2UvbWVudSdcbmltcG9ydCB7SVNldFR5cGVzUGFyYW1zfSBmcm9tICcuLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge1RleHRCdWZmZXJDYWxsYmFja30gZnJvbSAnLi9pbnN0YW5jZS9ldmVudHMnXG5pbXBvcnQge1RVUElDb250cm9sRGVmaW5pdGlvbn0gZnJvbSAnLi9pbnN0YW5jZS9jb250cm9scydcbmltcG9ydCB7SVBhcmFtU3BlY30gZnJvbSAnLi4vY29uZmlnLXBhcmFtcydcbmltcG9ydCB7VFRvb2x0aXBIYW5kbGVyfSBmcm9tICcuL2luc3RhbmNlL3Rvb2x0aXBzJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElSZWdpc3RyYXRpb25PcHRpb25zIHtcbiAgbmFtZTogc3RyaW5nXG4gIGNvbnN1bWVyPzogKGluc3RhbmNlOiBVUElJbnN0YW5jZSkgPT4gRGlzcG9zYWJsZSB8IHZvaWRcbiAgbWVudT86IElNZW51RGVmaW5pdGlvblxuICBtZXNzYWdlVHlwZXM/OiBJU2V0VHlwZXNQYXJhbXNcbiAgZXZlbnRzPzoge1xuICAgIG9uV2lsbFNhdmVCdWZmZXI/OiBUZXh0QnVmZmVyQ2FsbGJhY2sgfCBUZXh0QnVmZmVyQ2FsbGJhY2tbXVxuICAgIG9uRGlkU2F2ZUJ1ZmZlcj86IFRleHRCdWZmZXJDYWxsYmFjayB8IFRleHRCdWZmZXJDYWxsYmFja1tdXG4gICAgb25EaWRTdG9wQ2hhbmdpbmc/OiBUZXh0QnVmZmVyQ2FsbGJhY2sgfCBUZXh0QnVmZmVyQ2FsbGJhY2tbXVxuICB9XG4gIGNvbnRyb2xzPzogVFVQSUNvbnRyb2xEZWZpbml0aW9uW11cbiAgcGFyYW1zPzoge1twYXJhbU5hbWU6IHN0cmluZ106IElQYXJhbVNwZWM8YW55Pn1cbiAgdG9vbHRpcEV2ZW50PzogVFRvb2x0aXBIYW5kbGVyIHwge3ByaW9yaXR5PzogbnVtYmVyLCBoYW5kbGVyOiBUVG9vbHRpcEhhbmRsZXJ9XG59XG5cbmV4cG9ydCBjbGFzcyBVUEkge1xuICBwcml2YXRlIGluc3RhbmNlczogTWFwPHN0cmluZywgVVBJSW5zdGFuY2U+XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgY29uc3RydWN0b3IgKHByaXZhdGUgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuaW5zdGFuY2VzID0gbmV3IE1hcCgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgfVxuXG4gIC8qKlxuICBDYWxsIHRoaXMgZnVuY3Rpb24gaW4gY29uc3VtZXIgdG8gZ2V0IGFjdHVhbCBpbnRlcmZhY2VcblxuICBAcGFyYW0gbmFtZTogUGx1Z2luIHBhY2thZ2UgbmFtZVxuICBAcGFyYW0gY29uc3VtZXI6IGNhbGxiYWNrIDo6IFVQSUluc3RhbmNlIC0+ICgpXG4gIEByZXR1cm5zIHtEaXNwb3NhYmxlfVxuICAqL1xuICBwdWJsaWMgY29uc3VtZSAob3B0aW9uczogSVJlZ2lzdHJhdGlvbk9wdGlvbnMpOiBEaXNwb3NhYmxlIHtcbiAgICBjb25zdCB7bmFtZSwgbWVudSwgbWVzc2FnZVR5cGVzLCBldmVudHMsIGNvbnRyb2xzLCBwYXJhbXMsIGNvbnN1bWVyLCB0b29sdGlwRXZlbnR9ID0gb3B0aW9uc1xuICAgIGlmICghbmFtZSkge1xuICAgICAgdGhyb3cgbmV3IFVQSUVycm9yKCduYW1lIGhhcyB0byBiZSBzcGVjaWZpZWQgZm9yIFVQSScpXG4gICAgfVxuICAgIGlmICh0aGlzLmluc3RhbmNlcy5oYXMobmFtZSkpIHtcbiAgICAgIHRocm93IG5ldyBVUElFcnJvcihgUGx1Z2luICR7bmFtZX0gYWxyZWFkeSByZWdpc3RlcmVkIHdpdGggVVBJYClcbiAgICB9XG4gICAgY29uc3QgaW5zdGFuY2UgPSBuZXcgVVBJSW5zdGFuY2UodGhpcy5wbHVnaW5NYW5hZ2VyLCBuYW1lKVxuICAgIHRoaXMuaW5zdGFuY2VzLnNldChuYW1lLCBpbnN0YW5jZSlcbiAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuXG4gICAgaWYgKG1lbnUpIHtcbiAgICAgIGRpc3AuYWRkKGluc3RhbmNlLm1lbnUuc2V0KG1lbnUpKVxuICAgIH1cbiAgICBpZiAobWVzc2FnZVR5cGVzKSB7XG4gICAgICBpbnN0YW5jZS5tZXNzYWdlcy5zZXRUeXBlcyhtZXNzYWdlVHlwZXMpIC8vIFRPRE86IE1ha2UgZGlzcG9zYWJsZVxuICAgIH1cbiAgICBpZiAoZXZlbnRzKSB7XG4gICAgICBmb3IgKGNvbnN0IGsgaW4gZXZlbnRzKSB7XG4gICAgICAgIGlmIChpbnN0YW5jZS5ldmVudHNba10pIHtcbiAgICAgICAgICBsZXQgdjogVGV4dEJ1ZmZlckNhbGxiYWNrIHwgVGV4dEJ1ZmZlckNhbGxiYWNrW10gPSBldmVudHNba11cbiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkodikpIHsgdiA9IFt2XSB9XG4gICAgICAgICAgZm9yIChjb25zdCBpIG9mIHYpIHtcbiAgICAgICAgICAgIGRpc3AuYWRkKGluc3RhbmNlLmV2ZW50c1trXShpKSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHRvb2x0aXBFdmVudCkge1xuICAgICAgbGV0IGhhbmRsZXI6IFRUb29sdGlwSGFuZGxlciwgcHJpb3JpdHk6IG51bWJlciB8IHVuZGVmaW5lZFxuICAgICAgaWYgKHR5cGVvZiB0b29sdGlwRXZlbnQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgaGFuZGxlciA9IHRvb2x0aXBFdmVudFxuICAgICAgICBwcmlvcml0eSA9IDEwMFxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgKHtoYW5kbGVyLCBwcmlvcml0eX0gPSB0b29sdGlwRXZlbnQpXG4gICAgICB9XG4gICAgICBpZiAoIXByaW9yaXR5KSB7IHByaW9yaXR5ID0gMTAwIH1cbiAgICAgIGRpc3AuYWRkKGluc3RhbmNlLnRvb2x0aXBzLm9uU2hvdWxkU2hvd1Rvb2x0aXAocHJpb3JpdHksIGhhbmRsZXIpKVxuICAgIH1cbiAgICBpZiAoY29udHJvbHMpIHtcbiAgICAgIGZvciAoY29uc3QgaSBvZiBjb250cm9scykge1xuICAgICAgICBkaXNwLmFkZChpbnN0YW5jZS5jb250cm9scy5hZGQoaSkpXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChwYXJhbXMpIHtcbiAgICAgIGRpc3AuYWRkKGluc3RhbmNlLnBhcmFtcy5hZGQocGFyYW1zKSlcbiAgICB9XG5cbiAgICBpZiAoY29uc3VtZXIpIHtcbiAgICAgIGNvbnN0IGQgPSBjb25zdW1lcihpbnN0YW5jZSlcbiAgICAgIGlmICh0eXBlb2YgZCA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgZGlzcC5hZGQoZClcbiAgICAgIH1cbiAgICB9XG5cbiAgICBkaXNwLmFkZChuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICB0aGlzLmluc3RhbmNlcy5kZWxldGUobmFtZSlcbiAgICAgIGluc3RhbmNlLmRlc3Ryb3koKVxuICAgIH0pKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIHB1YmxpYyBkaXNwb3NlICgpIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG59XG4iXX0=