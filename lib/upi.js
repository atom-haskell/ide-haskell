"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("./utils");
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
    }
    registerPlugin(disposables, name) {
        return new UPIInstance(this.pluginManager, disposables, name);
    }
}
exports.UPI = UPI;
class UPIInstance {
    constructor(pluginManager, disposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        this.disposables = new atom_1.CompositeDisposable();
        disposables.add(this.disposables);
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputView.backendStatus(this.pluginName, status);
    }
    addMessages(messages, types) {
        return this.pluginManager.checkResults.appendResults(messages, types);
    }
    setMessages(messages, types) {
        messages = messages.map((m) => {
            if (m.position) {
                m.position = atom_1.Point.fromObject(m.position);
            }
            return m;
        });
        return this.pluginManager.checkResults.setResults(messages, types);
    }
    clearMessages(types) {
        return this.pluginManager.checkResults.setResults([], types);
    }
    setMessageTypes(types) {
        return (() => {
            const result = [];
            for (const type of Object.keys(types)) {
                const opts = types[type];
                result.push(this.pluginManager.outputView.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        const disp = this.pluginManager.tooltipRegistry.register(this.pluginName, { priority: 100, handler: callback });
        this.disposables.add(disp);
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        this.pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName: this.pluginName, tooltip });
    }
    onWillSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onWillSaveBuffer(callback));
        return disp;
    }
    onDidSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidSaveBuffer(callback));
        return disp;
    }
    onDidStopChanging(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidStopChanging(callback));
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            return this.pluginManager.outputView.addPanelControl(element, opts);
        }
        else {
            const newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputView.addPanelControl(DummyElement, newOpts);
        }
    }
    addConfigParam(spec) {
        return this.pluginManager.configParamManager.add(this.pluginName, spec);
    }
    getConfigParam(pluginName, name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!name) {
                name = pluginName;
                ({ pluginName } = this);
            }
            return this.pluginManager.configParamManager.get(pluginName, name);
        });
    }
    setConfigParam(pluginName, name, value) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!value) {
                value = name;
                name = pluginName;
                ({ pluginName } = this);
            }
            return this.pluginManager.configParamManager.set(pluginName, name, value);
        });
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        let ppos;
        if (pos) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        const res = controller.getEventRange(eventType);
        if (!res) {
            return;
        }
        return callback(res);
    }
}
class DummyElement {
    constructor(opts) {
        this.opts = opts;
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    update(opts) {
        this.opts = opts;
        this.element.remove();
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    init() {
        const { id, events, classes, style, attrs } = this.opts;
        if (id) {
            this.element.id = id;
        }
        if (events) {
            for (const ev of Object.keys(events)) {
                this.element.addEventListener(ev, events[ev]);
            }
        }
        if (classes) {
            for (const cls of classes) {
                this.element.classList.add(cls);
            }
        }
        if (style) {
            for (const st of Object.keys(style)) {
                this.element.style[st] = style[st];
            }
        }
        if (attrs) {
            for (const at of Object.keys(attrs)) {
                this.element.setAttribute(at, attrs[at]);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3VwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQ0EsK0JBQW9FO0FBQ3BFLG1DQUF1RDtBQWtCdkQ7SUFDRSxZQUFxQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUFJLENBQUM7SUFRL0MsY0FBYyxDQUFFLFdBQWdDLEVBQUUsSUFBWTtRQUNuRSxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDL0QsQ0FBQztDQUNGO0FBWkQsa0JBWUM7QUFFRDtJQUVFLFlBQ1UsYUFBNEIsRUFDcEMsV0FBZ0MsRUFDeEIsVUFBa0I7UUFGbEIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFFNUIsZUFBVSxHQUFWLFVBQVUsQ0FBUTtRQUUxQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUNuQyxDQUFDO0lBU0QsT0FBTyxDQUFFLElBQVksRUFBRSxJQUFXO1FBQ2hDLElBQUksUUFBUSxDQUFBO1FBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUUsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBRTthQUMxQztTQUNBLENBQUMsQ0FBQyxDQUFBO1FBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQTtJQUNqQixDQUFDO0lBU0QsU0FBUyxDQUFFLE1BQWU7UUFDeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxJ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SSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUE7WUFDL0MsQ0FBQztRQUNILENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ1osR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQ2pDLENBQUM7UUFDSCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNwQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDcEMsQ0FBQztRQUNILENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1YsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUMxQyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qIHRzbGludDpkaXNhYmxlOiBtYXgtY2xhc3Nlcy1wZXItZmlsZSBtZW1iZXItYWNjZXNzICovXG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBQb2ludCwgVGV4dEVkaXRvciwgUmFuZ2UgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgTUFJTl9NRU5VX0xBQkVMLCBnZXRFdmVudFR5cGUgfSBmcm9tICcuL3V0aWxzJ1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyfSBmcm9tICcuL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtJU3RhdHVzLCBJU2V2ZXJpdHlUYWJEZWZpbml0aW9uLCBJQ29udHJvbE9wdHN9IGZyb20gJy4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHtJUmVzdWx0SXRlbSwgVFNldmVyaXR5fSBmcm9tICcuL3Jlc3VsdHMtZGInXG5pbXBvcnQge1RFdmVudFJhbmdlVHlwZX0gZnJvbSAnLi9lZGl0b3ItY29udHJvbC90b29sdGlwLW1hbmFnZXInXG5pbXBvcnQge1RQb3NpdGlvbn0gZnJvbSAnLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtJUGFyYW1TcGVjfSBmcm9tICcuL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQge0VkaXRvckNvbnRyb2wsIFRUZXh0QnVmZmVyQ2FsbGJhY2t9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge1RUb29sdGlwSGFuZGxlciwgVFRvb2x0aXBGdW5jdGlvbn0gZnJvbSAnLi90b29sdGlwLXJlZ2lzdHJ5J1xuXG5pbnRlcmZhY2UgSVNob3dUb29sdGlwUGFyYW1zIHtcbiAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gIHBvczogVFBvc2l0aW9uXG4gIGV2ZW50VHlwZT86IFRFdmVudFJhbmdlVHlwZVxuICBkZXRhaWw/OiBFdmVudFxuICB0b29sdGlwOiBUVG9vbHRpcEZ1bmN0aW9uXG59XG5cbmV4cG9ydCBjbGFzcyBVUEkge1xuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyKSB7IH1cblxuICAvKlxuICBDYWxsIHRoaXMgZnVuY3Rpb24gaW4gY29uc3VtZXIgdG8gZ2V0IGFjdHVhbCBpbnRlcmZhY2VcblxuICBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgb25lIHlvdSB3aWxsIHJldHVybiBpbiBjb25zdW1lclxuICBuYW1lOiBQbHVnaW4gcGFja2FnZSBuYW1lXG4gICovXG4gIHB1YmxpYyByZWdpc3RlclBsdWdpbiAoZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGUsIG5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgVVBJSW5zdGFuY2UodGhpcy5wbHVnaW5NYW5hZ2VyLCBkaXNwb3NhYmxlcywgbmFtZSlcbiAgfVxufVxuXG5jbGFzcyBVUElJbnN0YW5jZSB7XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgY29uc3RydWN0b3IgKFxuICAgIHByaXZhdGUgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcixcbiAgICBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSxcbiAgICBwcml2YXRlIHBsdWdpbk5hbWU6IHN0cmluZ1xuICApIHtcbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGRpc3Bvc2FibGVzLmFkZCh0aGlzLmRpc3Bvc2FibGVzKVxuICB9XG5cbiAgLypcbiAgQWRkcyBuZXcgc3VtYmVudSB0byAnSGFza2VsbCBJREUnIG1lbnUgaXRlbVxuICBuYW1lIC0tIHN1Ym1lbnUgbGFiZWwsIHNob3VsZCBiZSBkZXNjcmlwdGl2ZSBvZiBhIHBhY2thZ2VcbiAgbWVudSAtLSBBdG9tIG1lbnUgb2JqZWN0XG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlLlxuICAqL1xuICBzZXRNZW51IChuYW1lOiBzdHJpbmcsIG1lbnU6IGFueVtdKSB7XG4gICAgbGV0IG1lbnVEaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQobWVudURpc3AgPSBhdG9tLm1lbnUuYWRkKFt7XG4gICAgICBsYWJlbDogTUFJTl9NRU5VX0xBQkVMLFxuICAgICAgc3VibWVudTogWyB7bGFiZWw6IG5hbWUsIHN1Ym1lbnU6IG1lbnV9IF1cbiAgICB9XG4gICAgXSkpXG4gICAgcmV0dXJuIG1lbnVEaXNwXG4gIH1cblxuICAvKlxuICBTZXRzIGJhY2tlbmQgc3RhdHVzXG4gIHN0YXR1cyAtLSBvYmplY3RcbiAgICBzdGF0dXM6IG9uZSBvZiAncHJvZ3Jlc3MnLCAncmVhZHknLCAnZXJyb3InLCAnd2FybmluZydcbiAgICBwcm9ncmVzczogZmxvYXQgYmV0d2VlbiAwIGFuZCAxLCBvbmx5IHJlbGV2YW50IHdoZW4gc3RhdHVzIGlzICdwcm9ncmVzcydcbiAgICAgICAgICAgICAgaWYgMCBvciB1bmRlZmluZWQsIHByb2dyZXNzIGJhciBpcyBub3Qgc2hvd25cbiAgKi9cbiAgc2V0U3RhdHVzIChzdGF0dXM6IElTdGF0dXMpIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFZpZXcuYmFja2VuZFN0YXR1cyh0aGlzLnBsdWdpbk5hbWUsIHN0YXR1cylcbiAgfVxuXG4gIC8qXG4gIEFkZCBtZXNzYWdlcyB0byBpZGUtaGFza2VsbCBvdXRwdXRcbiAgbWVzc2FnZXM6IEFycmF5IG9mIE9iamVjdFxuICAgIHVyaTogU3RyaW5nLCBGaWxlIFVSSSBtZXNzYWdlIHJlbGF0ZXMgdG9cbiAgICBwb3NpdGlvbjogUG9pbnQsIG9yIFBvaW50LWxpa2UgT2JqZWN0LCBwb3NpdGlvbiB0byB3aGljaCBtZXNzYWdlIHJlbGF0ZXNcbiAgICBtZXNzYWdlOiBTdHJpbmcgb3Igezx0ZXh0IHwgaHRtbD4sIGhpZ2hsaWdodGVyP30sIG1lc3NhZ2VcbiAgICBzZXZlcml0eTogU3RyaW5nLCBvbmUgb2YgJ2Vycm9yJywgJ3dhcm5pbmcnLCAnbGludCcsICdidWlsZCcsXG4gICAgICAgICAgICAgIG9yIHVzZXItZGVmaW5lZCwgc2VlIGBzZXRNZXNzYWdlVHlwZXNgXG4gIHR5cGVzOiBBcnJheSBvZiBTdHJpbmcsIGNvbnRhaW5pbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgLiBJZiB1bmRlZmluZWQsXG4gICAgICAgICB3aWxsIGJlIHRha2VuIGZyb20gYG1lc3NhZ2VzYFxuICAqL1xuICBhZGRNZXNzYWdlcyAobWVzc2FnZXM6IElSZXN1bHRJdGVtW10sIHR5cGVzPzogVFNldmVyaXR5W10pIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNoZWNrUmVzdWx0cy5hcHBlbmRSZXN1bHRzKG1lc3NhZ2VzLCB0eXBlcylcbiAgfVxuXG4gIC8qXG4gIFNldCBtZXNzYWdlcyBpbiBpZGUtaGFza2VsbCBvdXRwdXQuIENsZWFycyBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aFxuICBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgbWVzc2FnZXM6IEFycmF5IG9mIE9iamVjdFxuICAgIHVyaTogU3RyaW5nLCBGaWxlIFVSSSBtZXNzYWdlIHJlbGF0ZXMgdG9cbiAgICBwb3NpdGlvbjogUG9pbnQsIG9yIFBvaW50LWxpa2UgT2JqZWN0LCBwb3NpdGlvbiB0byB3aGljaCBtZXNzYWdlIHJlbGF0ZXNcbiAgICBtZXNzYWdlOiBTdHJpbmcsIG1lc3NhZ2VcbiAgICBzZXZlcml0eTogU3RyaW5nLCBvbmUgb2YgJ2Vycm9yJywgJ3dhcm5pbmcnLCAnbGludCcsICdidWlsZCcsXG4gICAgICAgICAgICAgIG9yIHVzZXItZGVmaW5lZCwgc2VlIGBzZXRNZXNzYWdlVHlwZXNgXG4gIHR5cGVzOiBBcnJheSBvZiBTdHJpbmcsIGNvbnRhaW5pbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgLiBJZiB1bmRlZmluZWQsXG4gICAgICAgICB3aWxsIGJlIHRha2VuIGZyb20gYG1lc3NhZ2VzYFxuICAqL1xuICBzZXRNZXNzYWdlcyAobWVzc2FnZXM6IElSZXN1bHRJdGVtW10sIHR5cGVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIG1lc3NhZ2VzID0gbWVzc2FnZXMubWFwKChtKSA9PiB7XG4gICAgICBpZiAobS5wb3NpdGlvbikgeyBtLnBvc2l0aW9uID0gUG9pbnQuZnJvbU9iamVjdChtLnBvc2l0aW9uKSB9XG4gICAgICByZXR1cm4gbVxuICAgIH0pXG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jaGVja1Jlc3VsdHMuc2V0UmVzdWx0cyhtZXNzYWdlcywgdHlwZXMpXG4gIH1cblxuICAvKlxuICBDbGVhciBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aCBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgVGhpcyBpcyBzaG9ydGhhbmQgZnJvbSBgc2V0TWVzc2FnZXMoW10sdHlwZXMpYFxuICAqL1xuICBjbGVhck1lc3NhZ2VzICh0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNoZWNrUmVzdWx0cy5zZXRSZXN1bHRzKFtdLCB0eXBlcylcbiAgfVxuXG4gIC8qXG4gIFNldCBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgdGhhdCB5b3VyIHBhY2thZ2Ugd2lsbCB1c2UuXG4gIHR5cGVzOiBPYmplY3Qgd2l0aCBrZXlzIHJlcHJlc2VudGluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgKGkuZS4gdGFiIG5hbWUpXG4gICAgICAgICBhbmQgdmFsdWVzIGJlaW5nIE9iamVjdHMgd2l0aCBrZXlzXG4gICAgdXJpRmlsdGVyOiBCb29sLCBzaG91bGQgdXJpIGZpbHRlciBhcHBseSB0byB0YWI/XG4gICAgYXV0b1Njcm9sbDogQm9vbCwgc2hvdWxkIHRhYiBhdXRvLXNjcm9sbD9cblxuICBUaGlzIGFsbG93cyB0byBkZWZpbmUgY3VzdG9tIG91dHB1dCBwYW5lbCB0YWJzLlxuICAqL1xuICBzZXRNZXNzYWdlVHlwZXMgKHR5cGVzOiB7IFtzZXZlcml0eTogc3RyaW5nXTogSVNldmVyaXR5VGFiRGVmaW5pdGlvbn0pIHtcbiAgICByZXR1cm4gKCgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdXG4gICAgICBmb3IgKGNvbnN0IHR5cGUgb2YgT2JqZWN0LmtleXModHlwZXMpKSB7XG4gICAgICAgIGNvbnN0IG9wdHMgPSB0eXBlc1t0eXBlXVxuICAgICAgICByZXN1bHQucHVzaCh0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0Vmlldy5jcmVhdGVUYWIodHlwZSwgb3B0cykpXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0XG4gICAgfSkoKVxuICB9XG5cbiAgLypcbiAgRWRpdG9yIGV2ZW50IHN1YnNjcmlwdGlvbi4gRmlyZXMgd2hlbiBtb3VzZSBjdXJzb3Igc3RvcHBlZCBvdmVyIGEgc3ltYm9sIGluXG4gIGVkaXRvci5cblxuICBjYWxsYmFjazogY2FsbGJhY2soZWRpdG9yLCBjcmFuZ2UsIHR5cGUpXG4gICAgZWRpdG9yOiBUZXh0RWRpdG9yLCBlZGl0b3IgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcbiAgICBjcmFuZ2U6IFJhbmdlLCBjdXJzb3IgcmFuZ2UgdGhhdCBnZW5lcmF0ZWQgZXZlbnQuXG4gICAgdHlwZTogT25lIG9mICdtb3VzZScsICdzZWxlY3Rpb24nIC0tIHR5cGUgb2YgZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhpc1xuXG4gICAgUmV0dXJucyB7cmFuZ2UsIHRleHR9IG9yIFByb21pc2UuXG4gICAgICByYW5nZTogUmFuZ2UsIHRvb2x0aXAgaGlnaGxpZ2h0aW5nIHJhbmdlXG4gICAgICB0ZXh0OiB0b29sdGlwIHRleHQuIFN0cmluZyBvciB7dGV4dCwgaGlnaGxpZ2h0ZXJ9IG9yIHtodG1sfVxuICAgICAgICB0ZXh0OiB0b29sdGlwIHRleHRcbiAgICAgICAgaGlnaGxpZ2h0ZXI6IGdyYW1tYXIgc2NvcGUgdGhhdCB3aWxsIGJlIHVzZWQgdG8gaGlnaGxpZ2h0IHRvb2x0aXAgdGV4dFxuICAgICAgICBodG1sOiBodG1sIHRvIGJlIGRpc3BsYXllZCBpbiB0b29sdGlwXG5cbiAgcmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uU2hvdWxkU2hvd1Rvb2x0aXAgKGNhbGxiYWNrOiBUVG9vbHRpcEhhbmRsZXIpIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5yZWdpc3RlcihcbiAgICAgIHRoaXMucGx1Z2luTmFtZSwge3ByaW9yaXR5OiAxMDAsIGhhbmRsZXI6IGNhbGxiYWNrfVxuICAgIClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKlxuICBTaG93IHRvb2x0aXAgaW4gZWRpdG9yLlxuXG4gIGVkaXRvcjogZWRpdG9yIHRoYXQgd2lsbCBzaG93IHRvb2x0aXBcbiAgcG9zOiB0b29sdGlwIHBvc2l0aW9uXG4gIGV2ZW50VHlwZTogb25lIG9mICdjb250ZXh0JywgJ2tleWJvYXJkJyBhbmQgJ21vdXNlJ1xuICBkZXRhaWw6IGZvciBhdXRvbWF0aWMgc2VsZWN0aW9uIGJldHdlZW4gJ2NvbnRleHQnIGFuZCAna2V5Ym9hcmQnLlxuICAgICAgICAgIElnbm9yZWQgaWYgJ2V2ZW50VHlwZScgaXMgc2V0LlxuICB0b29sdGlwOiBmdW5jdGlvbihjcmFuZ2UpXG4gICAgY3JhbmdlOiBSYW5nZSwgY3VycmVudGx5IHNlbGVjdGVkIHJhbmdlIGluIGVkaXRvciAocG9zc2libHkgZW1wdHkpXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZVxuICAgICAgcmFuZ2U6IFJhbmdlLCB0b29sdGlwIGhpZ2hsaWdodGluZyByYW5nZVxuICAgICAgcGVyc2lzdE9uQ3Vyc29yTW92ZTogQm9vbGVhbiwgb3B0aW9uYWwsIGRlZmF1bHQgZmFsc2UsIHBlcnNpc3Qgb24gY3Vyc29yIG1vdmUgcmVnYXJkbGVzcyBvZiBzZXR0aW5nc1xuICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0LiBTdHJpbmcgb3Ige3RleHQsIGhpZ2hsaWdodGVyfSBvciB7aHRtbH1cbiAgICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0XG4gICAgICAgIGhpZ2hsaWdodGVyOiBncmFtbWFyIHNjb3BlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGhpZ2hsaWdodCB0b29sdGlwIHRleHRcbiAgICAgICAgaHRtbDogaHRtbCB0byBiZSBkaXNwbGF5ZWQgaW4gdG9vbHRpcFxuICAqL1xuICBzaG93VG9vbHRpcCAoe2VkaXRvciwgcG9zLCBldmVudFR5cGUsIGRldGFpbCwgdG9vbHRpcH06IElTaG93VG9vbHRpcFBhcmFtcykge1xuICAgIGlmICghZXZlbnRUeXBlKSB7XG4gICAgICBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKVxuICAgIH1cbiAgICB0aGlzLnBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnNob3dUb29sdGlwKFxuICAgICAgZWRpdG9yLCBldmVudFR5cGUsIHtwbHVnaW5OYW1lOiB0aGlzLnBsdWdpbk5hbWUsIHRvb2x0aXB9XG4gICAgKVxuICB9XG5cbiAgLypcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBiZWZvcmUgSGFza2VsbCBidWZmZXIgaXMgc2F2ZWQuXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKGJ1ZmZlcilcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0aGF0IGdlbmVyYXRlZCBldmVudFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZVxuICAqL1xuICBvbldpbGxTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGxldCBkaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbldpbGxTYXZlQnVmZmVyKGNhbGxiYWNrKSlcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLypcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBhZnRlciBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cblxuICBjYWxsYmFjazogY2FsbGJhY2soYnVmZmVyKVxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBsZXQgZGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25EaWRTYXZlQnVmZmVyKGNhbGxiYWNrKSlcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgb25EaWRTdG9wQ2hhbmdpbmcgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgbGV0IGRpc3BcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uRGlkU3RvcENoYW5naW5nKGNhbGxiYWNrKSlcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLypcbiAgQWRkIGEgbmV3IGNvbnRyb2wgdG8gb3VwdHV0IHBhbmVsIGhlYWRpbmcuXG5cbiAgZWxlbWVudDogSFRNTEVsZW1lbnQgb2YgY29udHJvbCwgb3IgU3RyaW5nIHdpdGggdGFnIG5hbWVcbiAgb3B0czogdmFyaW91cyBvcHRpb25zXG4gICAgaWQ6IFN0cmluZywgaWRcbiAgICBldmVudHM6IE9iamVjdCwgZXZlbnQgY2FsbGJhY2tzLCBrZXkgaXMgZXZlbnQgbmFtZSwgZS5nLiBcImNsaWNrXCIsXG4gICAgICAgICAgICB2YWx1ZSBpcyBjYWxsYmFja1xuICAgIGNsYXNzZXM6IEFycmF5IG9mIFN0cmluZywgY2xhc3Nlc1xuICAgIHN0eWxlOiBPYmplY3QsIGNzcyBzdHlsZSwga2V5cyBhcmUgc3R5bGUgYXR0cmlidXRlcywgdmFsdWVzIGFyZSB2YWx1ZXNcbiAgICBhdHRyczogT2JqZWN0LCBvdGhlciBhdHRyaWJ1dGVzLCBrZXlzIGFyZSBhdHRyaWJ1dGUgbmFtZXMsIHZhbHVlcyBhcmUgdmFsdWVzXG4gICAgYmVmb3JlOiBTdHJpbmcsIENTUyBzZWxlY3RvciBvZiBlbGVtZW50LCB0aGF0IHRoaXMgb25lIHNob3VsZCBiZSBpbnNlcnRlZFxuICAgICAgICAgICAgYmVmb3JlLCBlLmcuICcjcHJvZ3Jlc3NCYXInXG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlLlxuICAqL1xuICBhZGRQYW5lbENvbnRyb2wgKGVsZW1lbnQ6IHN0cmluZyB8IEhUTUxFbGVtZW50LCBvcHRzOiBJQ29udHJvbE9wdHMpIHtcbiAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFZpZXcuYWRkUGFuZWxDb250cm9sKGVsZW1lbnQsIG9wdHMpXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5ld09wdHM6IElDb250cm9sT3B0cyAmIHtlbGVtZW50OiBIVE1MRWxlbWVudH0gPSB7Li4ub3B0cywgZWxlbWVudH1cbiAgICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0Vmlldy5hZGRQYW5lbENvbnRyb2woRHVtbXlFbGVtZW50LCBuZXdPcHRzKVxuICAgIH1cbiAgfVxuXG4gIC8qXG4gIGFkZENvbmZpZ1BhcmFtXG4gICAgcGFyYW1fbmFtZTpcbiAgICAgIG9uQ2hhbmdlZDogY2FsbGJhY2sgdm9pZCh2YWx1ZSlcbiAgICAgIGl0ZW1zOiBBcnJheSBvciBjYWxsYmFjayBBcnJheSh2b2lkKVxuICAgICAgaXRlbVRlbXBsYXRlOiBjYWxsYmFjaywgU3RyaW5nKGl0ZW0pLCBodG1sIHRlbXBsYXRlXG4gICAgICBpdGVtRmlsdGVyS2V5OiBTdHJpbmcsIGl0ZW0gZmlsdGVyIGtleVxuICAgICAgZGVzY3JpcHRpb246IFN0cmluZyBbb3B0aW9uYWxdXG4gICAgICBkaXNwbGF5TmFtZTogU3RyaW5nIFtvcHRpb25hbCwgY2FwaXRhbGl6ZWQgcGFyYW1fbmFtZSBkZWZhdWx0XVxuICAgICAgZGlzcGxheVRlbXBsYXRlOiBjYWxsYmFjaywgU3RyaW5nKGl0ZW0pLCBzdHJpbmcgdGVtcGxhdGVcbiAgICAgIGRlZmF1bHQ6IGl0ZW0sIGRlZmF1bHQgdmFsdWVcblxuICBSZXR1cm5zXG4gICAgZGlzcDogRGlzcG9zYWJsZVxuICAgIGNoYW5nZTogb2JqZWN0IG9mIGNoYW5nZSBmdW5jdGlvbnMsIGtleXMgYmVpbmcgcGFyYW1fbmFtZVxuICAqL1xuICBhZGRDb25maWdQYXJhbSAoc3BlYzogeyBbcGFyYW1OYW1lOiBzdHJpbmddOiBJUGFyYW1TcGVjPGFueT4gfSkge1xuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmFkZCh0aGlzLnBsdWdpbk5hbWUsIHNwZWMpXG4gIH1cblxuICAvKlxuICBnZXRDb25maWdQYXJhbShwYXJhbU5hbWUpIG9yIGdldENvbmZpZ1BhcmFtKHBsdWdpbk5hbWUsIHBhcmFtTmFtZSlcblxuICByZXR1cm5zIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlclxuICB2YWx1ZS5cblxuICBQcm9taXNlIGNhbiBiZSByZWplY3RlZCB3aXRoIGVpdGhlciBlcnJvciwgb3IgJ3VuZGVmaW5lZCcuIExhdHRlclxuICBpbiBjYXNlIHVzZXIgY2FuY2VscyBwYXJhbSBzZWxlY3Rpb24gZGlhbG9nLlxuICAqL1xuICBhc3luYyBnZXRDb25maWdQYXJhbSAocGx1Z2luTmFtZTogc3RyaW5nLCBuYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgIG5hbWUgPSBwbHVnaW5OYW1lO1xuICAgICAgKHsgcGx1Z2luTmFtZSB9ID0gdGhpcylcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuZ2V0KHBsdWdpbk5hbWUsIG5hbWUpXG4gIH1cblxuICAvKlxuICBzZXRDb25maWdQYXJhbShwYXJhbU5hbWUsIHZhbHVlKSBvciBzZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUsIHZhbHVlKVxuXG4gIHZhbHVlIGlzIG9wdGlvbmFsLiBJZiBvbWl0dGVkLCBhIHNlbGVjdGlvbiBkaWFsb2cgd2lsbCBiZSBwcmVzZW50ZWQgdG8gdXNlci5cblxuICByZXR1cm5zIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlciB2YWx1ZS5cblxuICBQcm9taXNlIGNhbiBiZSByZWplY3RlZCB3aXRoIGVpdGhlciBlcnJvciwgb3IgJ3VuZGVmaW5lZCcuIExhdHRlclxuICBpbiBjYXNlIHVzZXIgY2FuY2VscyBwYXJhbSBzZWxlY3Rpb24gZGlhbG9nLlxuICAqL1xuICBhc3luYyBzZXRDb25maWdQYXJhbSAocGx1Z2luTmFtZTogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICBpZiAoIXZhbHVlKSB7XG4gICAgICB2YWx1ZSA9IG5hbWVcbiAgICAgIG5hbWUgPSBwbHVnaW5OYW1lO1xuICAgICAgKHsgcGx1Z2luTmFtZSB9ID0gdGhpcylcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuc2V0KHBsdWdpbk5hbWUsIG5hbWUsIHZhbHVlKVxuICB9XG5cbiAgLypcbiAgVXRpbGl0eSBmdW5jdGlvbiB0byBleHRyYWN0IGV2ZW50IHJhbmdlL3R5cGUgZm9yIGEgZ2l2ZW4gZXZlbnRcblxuICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICBkZXRhaWw6IGV2ZW50IGRldGFpbCwgaWdub3JlZCBpZiBldmVudFR5cGUgaXMgc2V0XG4gIGV2ZW50VHlwZTogU3RyaW5nLCBldmVudCB0eXBlLCBvbmUgb2YgJ2tleWJvYXJkJywgJ2NvbnRleHQnLCAnbW91c2UnXG4gIHBvczogUG9pbnQsIG9yIFBvaW50LWxpa2UgT2JqZWN0LCBldmVudCBwb3NpdGlvbiwgY2FuIGJlIHVuZGVmaW5lZFxuICBjb250cm9sbGVyOiBsZWF2ZSB1bmRlZmluZWQsIHRoaXMgaXMgaW50ZXJuYWwgZmllbGRcblxuICBjYWxsYmFjazogY2FsbGJhY2soe3BvcywgY3JhbmdlLCBldmVudFR5cGV9KVxuICAgIHBvczogUG9pbnQsIGV2ZW50IHBvc2l0aW9uXG4gICAgY3JhbmdlOiBSYW5nZSwgZXZlbnQgcmFuZ2VcbiAgICBldmVudFR5cGU6IFN0cmluZywgZXZlbnQgdHlwZSwgb25lIG9mICdrZXlib2FyZCcsICdjb250ZXh0JywgJ21vdXNlJ1xuICAqL1xuICB3aXRoRXZlbnRSYW5nZSAoe2VkaXRvciwgZGV0YWlsLCBldmVudFR5cGUsIHBvcywgY29udHJvbGxlcn06IElFdmVudFJhbmdlUGFyYW1zLCBjYWxsYmFjazogVEV2ZW50UmFuZ2VDYWxsYmFjazxhbnk+KSB7XG4gICAgbGV0IHBwb3M6IFBvaW50IHwgdW5kZWZpbmVkXG4gICAgaWYgKHBvcykgeyBwcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpIH1cbiAgICBpZiAoIWV2ZW50VHlwZSkgeyBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKSB9XG4gICAgaWYgKCFjb250cm9sbGVyICYmIGVkaXRvcikgeyBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKSB9XG4gICAgaWYgKCFjb250cm9sbGVyKSB7IHJldHVybiB9XG4gICAgY29uc3QgcmVzID0gY29udHJvbGxlci5nZXRFdmVudFJhbmdlKGV2ZW50VHlwZSlcbiAgICBpZiAoIXJlcykgeyByZXR1cm4gfVxuICAgIHJldHVybiBjYWxsYmFjayhyZXMpXG4gIH1cbn1cblxuaW50ZXJmYWNlIElFdmVudFJhbmdlUGFyYW1zIHtcbiAgZWRpdG9yPzogVGV4dEVkaXRvclxuICBkZXRhaWw/OiBhbnlcbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIHBvczogVFBvc2l0aW9uXG4gIGNvbnRyb2xsZXI/OiBFZGl0b3JDb250cm9sXG59XG5leHBvcnQgdHlwZSBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+ID0gKHBhcnM6IHtwb3M6IFBvaW50LCBjcmFuZ2U6IFJhbmdlLCBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZX0pID0+IFRcblxuY2xhc3MgRHVtbXlFbGVtZW50IHtcbiAgcHJpdmF0ZSBlbGVtZW50OiBIVE1MRWxlbWVudFxuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBvcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9KSB7XG4gICAgdGhpcy5lbGVtZW50ID0gb3B0cy5lbGVtZW50LmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudFxuICAgIHRoaXMuaW5pdCgpXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlIChvcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9KSB7XG4gICAgdGhpcy5vcHRzID0gb3B0c1xuICAgIHRoaXMuZWxlbWVudC5yZW1vdmUoKVxuICAgIHRoaXMuZWxlbWVudCA9IG9wdHMuZWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnRcbiAgICB0aGlzLmluaXQoKVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0ICgpIHtcbiAgICBjb25zdCB7aWQsIGV2ZW50cywgY2xhc3Nlcywgc3R5bGUsIGF0dHJzfSA9IHRoaXMub3B0c1xuICAgIGlmIChpZCkgeyB0aGlzLmVsZW1lbnQuaWQgPSBpZCB9XG4gICAgaWYgKGV2ZW50cykge1xuICAgICAgZm9yIChjb25zdCBldiBvZiBPYmplY3Qua2V5cyhldmVudHMpKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2LCBldmVudHNbZXZdKVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoY2xhc3Nlcykge1xuICAgICAgZm9yIChjb25zdCBjbHMgb2YgY2xhc3Nlcykge1xuICAgICAgICB0aGlzLmVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbHMpXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzdHlsZSkge1xuICAgICAgZm9yIChjb25zdCBzdCBvZiBPYmplY3Qua2V5cyhzdHlsZSkpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LnN0eWxlW3N0XSA9IHN0eWxlW3N0XVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoYXR0cnMpIHtcbiAgICAgIGZvciAoY29uc3QgYXQgb2YgT2JqZWN0LmtleXMoYXR0cnMpKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUoYXQsIGF0dHJzW2F0XSlcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==