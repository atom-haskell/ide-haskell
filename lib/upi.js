"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("./utils");
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
    }
    registerPlugin(disposables, name) {
        return new UPIInstance(this.pluginManager, disposables, name);
    }
}
exports.UPI = UPI;
class UPIInstance {
    constructor(pluginManager, disposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        this.disposables = new atom_1.CompositeDisposable();
        disposables.add(this.disposables);
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputView.backendStatus(this.pluginName, status);
    }
    addMessages(messages, types) {
        return this.pluginManager.checkResults.appendResults(messages, types);
    }
    setMessages(messages, types) {
        messages = messages.map((m) => {
            if (m.position) {
                m.position = atom_1.Point.fromObject(m.position);
            }
            return m;
        });
        return this.pluginManager.checkResults.setResults(messages, types);
    }
    clearMessages(types) {
        return this.pluginManager.checkResults.setResults([], types);
    }
    setMessageTypes(types) {
        return (() => {
            const result = [];
            for (const type of Object.keys(types)) {
                const opts = types[type];
                result.push(this.pluginManager.outputView.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        const disp = this.pluginManager.tooltipRegistry.register(this.pluginName, { priority: 100, handler: callback });
        this.disposables.add(disp);
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        this.pluginManager.tooltipRegistry.showTooltip(editor, eventType, atom_1.Point.fromObject(pos), { pluginName: this.pluginName, tooltip });
    }
    onWillSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onWillSaveBuffer(callback));
        return disp;
    }
    onDidSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidSaveBuffer(callback));
        return disp;
    }
    onDidStopChanging(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidStopChanging(callback));
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            return this.pluginManager.outputView.addPanelControl(element, opts);
        }
        else {
            const newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputView.addPanelControl(DummyElement, newOpts);
        }
    }
    addConfigParam(spec) {
        return this.pluginManager.configParamManager.add(this.pluginName, spec);
    }
    getConfigParam(pluginName, name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!name) {
                name = pluginName;
                ({ pluginName } = this);
            }
            return this.pluginManager.configParamManager.get(pluginName, name);
        });
    }
    setConfigParam(pluginName, name, value) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!value) {
                value = name;
                name = pluginName;
                ({ pluginName } = this);
            }
            return this.pluginManager.configParamManager.set(pluginName, name, value);
        });
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        let ppos;
        if (pos) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        const res = controller.getEventRange(eventType);
        if (!res) {
            return;
        }
        return callback(res);
    }
}
class DummyElement {
    constructor(opts) {
        this.opts = opts;
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    update(opts) {
        this.opts = opts;
        this.element.remove();
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    init() {
        const { id, events, classes, style, attrs } = this.opts;
        if (id) {
            this.element.id = id;
        }
        if (events) {
            for (const ev of Object.keys(events)) {
                this.element.addEventListener(ev, events[ev]);
            }
        }
        if (classes) {
            for (const cls of classes) {
                this.element.classList.add(cls);
            }
        }
        if (style) {
            for (const st of Object.keys(style)) {
                this.element.style[st] = style[st];
            }
        }
        if (attrs) {
            for (const at of Object.keys(attrs)) {
                this.element.setAttribute(at, attrs[at]);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3VwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQ0EsK0JBQW9FO0FBQ3BFLG1DQUF1RDtBQWtCdkQ7SUFDRSxZQUFxQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUFJLENBQUM7SUFRL0MsY0FBYyxDQUFFLFdBQWdDLEVBQUUsSUFBWTtRQUNuRSxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDL0QsQ0FBQztDQUNGO0FBWkQsa0JBWUM7QUFFRDtJQUVFLFlBQ1UsYUFBNEIsRUFDcEMsV0FBZ0MsRUFDeEIsVUFBa0I7UUFGbEIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFFNUIsZUFBVSxHQUFWLFVBQVUsQ0FBUTtRQUUxQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUNuQyxDQUFDO0lBU0QsT0FBTyxDQUFFLElBQVksRUFBRSxJQUFXO1FBQ2hDLElBQUksUUFBUSxDQUFBO1FBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUUsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBRTthQUMxQztTQUNBLENBQUMsQ0FBQyxDQUFBO1FBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQTtJQUNqQixDQUFDO0lBU0QsU0FBUyxDQUFFLE1BQWU7UUFDeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxJ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TUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUMvQyxDQUFDO1FBQ0gsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDWixHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDakMsQ0FBQztRQUNILENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1YsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUNwQyxDQUFDO1FBQ0gsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDVixHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO1lBQzFDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGU6IG1heC1jbGFzc2VzLXBlci1maWxlIG1lbWJlci1hY2Nlc3MgKi9cbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFBvaW50LCBUZXh0RWRpdG9yLCBSYW5nZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBNQUlOX01FTlVfTEFCRUwsIGdldEV2ZW50VHlwZSB9IGZyb20gJy4vdXRpbHMnXG5pbXBvcnQge1BsdWdpbk1hbmFnZXJ9IGZyb20gJy4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQge0lTdGF0dXMsIElTZXZlcml0eVRhYkRlZmluaXRpb24sIElDb250cm9sT3B0c30gZnJvbSAnLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge0lSZXN1bHRJdGVtLCBUU2V2ZXJpdHl9IGZyb20gJy4vcmVzdWx0cy1kYidcbmltcG9ydCB7VEV2ZW50UmFuZ2VUeXBlfSBmcm9tICcuL2VkaXRvci1jb250cm9sL3Rvb2x0aXAtbWFuYWdlcidcbmltcG9ydCB7VFBvc2l0aW9ufSBmcm9tICcuL3Jlc3VsdHMtZGInXG5pbXBvcnQge0lQYXJhbVNwZWN9IGZyb20gJy4vY29uZmlnLXBhcmFtcydcbmltcG9ydCB7RWRpdG9yQ29udHJvbCwgVFRleHRCdWZmZXJDYWxsYmFja30gZnJvbSAnLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7VFRvb2x0aXBIYW5kbGVyLCBUVG9vbHRpcEZ1bmN0aW9ufSBmcm9tICcuL3Rvb2x0aXAtcmVnaXN0cnknXG5cbmludGVyZmFjZSBJU2hvd1Rvb2x0aXBQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgcG9zOiBUUG9zaXRpb25cbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIGRldGFpbD86IEV2ZW50XG4gIHRvb2x0aXA6IFRUb29sdGlwRnVuY3Rpb25cbn1cblxuZXhwb3J0IGNsYXNzIFVQSSB7XG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIHBsdWdpbk1hbmFnZXI6IFBsdWdpbk1hbmFnZXIpIHsgfVxuXG4gIC8qXG4gIENhbGwgdGhpcyBmdW5jdGlvbiBpbiBjb25zdW1lciB0byBnZXQgYWN0dWFsIGludGVyZmFjZVxuXG4gIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLCBvbmUgeW91IHdpbGwgcmV0dXJuIGluIGNvbnN1bWVyXG4gIG5hbWU6IFBsdWdpbiBwYWNrYWdlIG5hbWVcbiAgKi9cbiAgcHVibGljIHJlZ2lzdGVyUGx1Z2luIChkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgbmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBVUElJbnN0YW5jZSh0aGlzLnBsdWdpbk1hbmFnZXIsIGRpc3Bvc2FibGVzLCBuYW1lKVxuICB9XG59XG5cbmNsYXNzIFVQSUluc3RhbmNlIHtcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLFxuICAgIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLFxuICAgIHByaXZhdGUgcGx1Z2luTmFtZTogc3RyaW5nXG4gICkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZGlzcG9zYWJsZXMuYWRkKHRoaXMuZGlzcG9zYWJsZXMpXG4gIH1cblxuICAvKlxuICBBZGRzIG5ldyBzdW1iZW51IHRvICdIYXNrZWxsIElERScgbWVudSBpdGVtXG4gIG5hbWUgLS0gc3VibWVudSBsYWJlbCwgc2hvdWxkIGJlIGRlc2NyaXB0aXZlIG9mIGEgcGFja2FnZVxuICBtZW51IC0tIEF0b20gbWVudSBvYmplY3RcblxuICBSZXR1cm5zIERpc3Bvc2FibGUuXG4gICovXG4gIHNldE1lbnUgKG5hbWU6IHN0cmluZywgbWVudTogYW55W10pIHtcbiAgICBsZXQgbWVudURpc3BcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChtZW51RGlzcCA9IGF0b20ubWVudS5hZGQoW3tcbiAgICAgIGxhYmVsOiBNQUlOX01FTlVfTEFCRUwsXG4gICAgICBzdWJtZW51OiBbIHtsYWJlbDogbmFtZSwgc3VibWVudTogbWVudX0gXVxuICAgIH1cbiAgICBdKSlcbiAgICByZXR1cm4gbWVudURpc3BcbiAgfVxuXG4gIC8qXG4gIFNldHMgYmFja2VuZCBzdGF0dXNcbiAgc3RhdHVzIC0tIG9iamVjdFxuICAgIHN0YXR1czogb25lIG9mICdwcm9ncmVzcycsICdyZWFkeScsICdlcnJvcicsICd3YXJuaW5nJ1xuICAgIHByb2dyZXNzOiBmbG9hdCBiZXR3ZWVuIDAgYW5kIDEsIG9ubHkgcmVsZXZhbnQgd2hlbiBzdGF0dXMgaXMgJ3Byb2dyZXNzJ1xuICAgICAgICAgICAgICBpZiAwIG9yIHVuZGVmaW5lZCwgcHJvZ3Jlc3MgYmFyIGlzIG5vdCBzaG93blxuICAqL1xuICBzZXRTdGF0dXMgKHN0YXR1czogSVN0YXR1cykge1xuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0Vmlldy5iYWNrZW5kU3RhdHVzKHRoaXMucGx1Z2luTmFtZSwgc3RhdHVzKVxuICB9XG5cbiAgLypcbiAgQWRkIG1lc3NhZ2VzIHRvIGlkZS1oYXNrZWxsIG91dHB1dFxuICBtZXNzYWdlczogQXJyYXkgb2YgT2JqZWN0XG4gICAgdXJpOiBTdHJpbmcsIEZpbGUgVVJJIG1lc3NhZ2UgcmVsYXRlcyB0b1xuICAgIHBvc2l0aW9uOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIHBvc2l0aW9uIHRvIHdoaWNoIG1lc3NhZ2UgcmVsYXRlc1xuICAgIG1lc3NhZ2U6IFN0cmluZyBvciB7PHRleHQgfCBodG1sPiwgaGlnaGxpZ2h0ZXI/fSwgbWVzc2FnZVxuICAgIHNldmVyaXR5OiBTdHJpbmcsIG9uZSBvZiAnZXJyb3InLCAnd2FybmluZycsICdsaW50JywgJ2J1aWxkJyxcbiAgICAgICAgICAgICAgb3IgdXNlci1kZWZpbmVkLCBzZWUgYHNldE1lc3NhZ2VUeXBlc2BcbiAgdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIGFkZE1lc3NhZ2VzIChtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM/OiBUU2V2ZXJpdHlbXSkge1xuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY2hlY2tSZXN1bHRzLmFwcGVuZFJlc3VsdHMobWVzc2FnZXMsIHR5cGVzKVxuICB9XG5cbiAgLypcbiAgU2V0IG1lc3NhZ2VzIGluIGlkZS1oYXNrZWxsIG91dHB1dC4gQ2xlYXJzIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoXG4gIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuICBtZXNzYWdlczogQXJyYXkgb2YgT2JqZWN0XG4gICAgdXJpOiBTdHJpbmcsIEZpbGUgVVJJIG1lc3NhZ2UgcmVsYXRlcyB0b1xuICAgIHBvc2l0aW9uOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIHBvc2l0aW9uIHRvIHdoaWNoIG1lc3NhZ2UgcmVsYXRlc1xuICAgIG1lc3NhZ2U6IFN0cmluZywgbWVzc2FnZVxuICAgIHNldmVyaXR5OiBTdHJpbmcsIG9uZSBvZiAnZXJyb3InLCAnd2FybmluZycsICdsaW50JywgJ2J1aWxkJyxcbiAgICAgICAgICAgICAgb3IgdXNlci1kZWZpbmVkLCBzZWUgYHNldE1lc3NhZ2VUeXBlc2BcbiAgdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIHNldE1lc3NhZ2VzIChtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM6IFRTZXZlcml0eVtdKSB7XG4gICAgbWVzc2FnZXMgPSBtZXNzYWdlcy5tYXAoKG0pID0+IHtcbiAgICAgIGlmIChtLnBvc2l0aW9uKSB7IG0ucG9zaXRpb24gPSBQb2ludC5mcm9tT2JqZWN0KG0ucG9zaXRpb24pIH1cbiAgICAgIHJldHVybiBtXG4gICAgfSlcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNoZWNrUmVzdWx0cy5zZXRSZXN1bHRzKG1lc3NhZ2VzLCB0eXBlcylcbiAgfVxuXG4gIC8qXG4gIENsZWFyIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuICBUaGlzIGlzIHNob3J0aGFuZCBmcm9tIGBzZXRNZXNzYWdlcyhbXSx0eXBlcylgXG4gICovXG4gIGNsZWFyTWVzc2FnZXMgKHR5cGVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY2hlY2tSZXN1bHRzLnNldFJlc3VsdHMoW10sIHR5cGVzKVxuICB9XG5cbiAgLypcbiAgU2V0IHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YCB0aGF0IHlvdXIgcGFja2FnZSB3aWxsIHVzZS5cbiAgdHlwZXM6IE9iamVjdCB3aXRoIGtleXMgcmVwcmVzZW50aW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YCAoaS5lLiB0YWIgbmFtZSlcbiAgICAgICAgIGFuZCB2YWx1ZXMgYmVpbmcgT2JqZWN0cyB3aXRoIGtleXNcbiAgICB1cmlGaWx0ZXI6IEJvb2wsIHNob3VsZCB1cmkgZmlsdGVyIGFwcGx5IHRvIHRhYj9cbiAgICBhdXRvU2Nyb2xsOiBCb29sLCBzaG91bGQgdGFiIGF1dG8tc2Nyb2xsP1xuXG4gIFRoaXMgYWxsb3dzIHRvIGRlZmluZSBjdXN0b20gb3V0cHV0IHBhbmVsIHRhYnMuXG4gICovXG4gIHNldE1lc3NhZ2VUeXBlcyAodHlwZXM6IHsgW3NldmVyaXR5OiBzdHJpbmddOiBJU2V2ZXJpdHlUYWJEZWZpbml0aW9ufSkge1xuICAgIHJldHVybiAoKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gW11cbiAgICAgIGZvciAoY29uc3QgdHlwZSBvZiBPYmplY3Qua2V5cyh0eXBlcykpIHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IHR5cGVzW3R5cGVdXG4gICAgICAgIHJlc3VsdC5wdXNoKHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmNyZWF0ZVRhYih0eXBlLCBvcHRzKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRcbiAgICB9KSgpXG4gIH1cblxuICAvKlxuICBFZGl0b3IgZXZlbnQgc3Vic2NyaXB0aW9uLiBGaXJlcyB3aGVuIG1vdXNlIGN1cnNvciBzdG9wcGVkIG92ZXIgYSBzeW1ib2wgaW5cbiAgZWRpdG9yLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhlZGl0b3IsIGNyYW5nZSwgdHlwZSlcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnNvciByYW5nZSB0aGF0IGdlbmVyYXRlZCBldmVudC5cbiAgICB0eXBlOiBPbmUgb2YgJ21vdXNlJywgJ3NlbGVjdGlvbicgLS0gdHlwZSBvZiBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGlzXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZS5cbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcblxuICByZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25TaG91bGRTaG93VG9vbHRpcCAoY2FsbGJhY2s6IFRUb29sdGlwSGFuZGxlcikge1xuICAgIGNvbnN0IGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnJlZ2lzdGVyKFxuICAgICAgdGhpcy5wbHVnaW5OYW1lLCB7cHJpb3JpdHk6IDEwMCwgaGFuZGxlcjogY2FsbGJhY2t9XG4gICAgKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qXG4gIFNob3cgdG9vbHRpcCBpbiBlZGl0b3IuXG5cbiAgZWRpdG9yOiBlZGl0b3IgdGhhdCB3aWxsIHNob3cgdG9vbHRpcFxuICBwb3M6IHRvb2x0aXAgcG9zaXRpb25cbiAgZXZlbnRUeXBlOiBvbmUgb2YgJ2NvbnRleHQnLCAna2V5Ym9hcmQnIGFuZCAnbW91c2UnXG4gIGRldGFpbDogZm9yIGF1dG9tYXRpYyBzZWxlY3Rpb24gYmV0d2VlbiAnY29udGV4dCcgYW5kICdrZXlib2FyZCcuXG4gICAgICAgICAgSWdub3JlZCBpZiAnZXZlbnRUeXBlJyBpcyBzZXQuXG4gIHRvb2x0aXA6IGZ1bmN0aW9uKGNyYW5nZSlcbiAgICBjcmFuZ2U6IFJhbmdlLCBjdXJyZW50bHkgc2VsZWN0ZWQgcmFuZ2UgaW4gZWRpdG9yIChwb3NzaWJseSBlbXB0eSlcblxuICAgIFJldHVybnMge3JhbmdlLCB0ZXh0fSBvciBQcm9taXNlXG4gICAgICByYW5nZTogUmFuZ2UsIHRvb2x0aXAgaGlnaGxpZ2h0aW5nIHJhbmdlXG4gICAgICBwZXJzaXN0T25DdXJzb3JNb3ZlOiBCb29sZWFuLCBvcHRpb25hbCwgZGVmYXVsdCBmYWxzZSwgcGVyc2lzdCBvbiBjdXJzb3IgbW92ZSByZWdhcmRsZXNzIG9mIHNldHRpbmdzXG4gICAgICB0ZXh0OiB0b29sdGlwIHRleHQuIFN0cmluZyBvciB7dGV4dCwgaGlnaGxpZ2h0ZXJ9IG9yIHtodG1sfVxuICAgICAgICB0ZXh0OiB0b29sdGlwIHRleHRcbiAgICAgICAgaGlnaGxpZ2h0ZXI6IGdyYW1tYXIgc2NvcGUgdGhhdCB3aWxsIGJlIHVzZWQgdG8gaGlnaGxpZ2h0IHRvb2x0aXAgdGV4dFxuICAgICAgICBodG1sOiBodG1sIHRvIGJlIGRpc3BsYXllZCBpbiB0b29sdGlwXG4gICovXG4gIHNob3dUb29sdGlwICh7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZSwgZGV0YWlsLCB0b29sdGlwfTogSVNob3dUb29sdGlwUGFyYW1zKSB7XG4gICAgaWYgKCFldmVudFR5cGUpIHtcbiAgICAgIGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpXG4gICAgfVxuICAgIHRoaXMucGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnkuc2hvd1Rvb2x0aXAoXG4gICAgICBlZGl0b3IsIGV2ZW50VHlwZSwgUG9pbnQuZnJvbU9iamVjdChwb3MpLCB7cGx1Z2luTmFtZTogdGhpcy5wbHVnaW5OYW1lLCB0b29sdGlwfVxuICAgIClcbiAgfVxuXG4gIC8qXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYmVmb3JlIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhidWZmZXIpXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcblxuICBSZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25XaWxsU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBsZXQgZGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25XaWxsU2F2ZUJ1ZmZlcihjYWxsYmFjaykpXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYWZ0ZXIgSGFza2VsbCBidWZmZXIgaXMgc2F2ZWQuXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKGJ1ZmZlcilcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0aGF0IGdlbmVyYXRlZCBldmVudFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZVxuICAqL1xuICBvbkRpZFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgbGV0IGRpc3BcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uRGlkU2F2ZUJ1ZmZlcihjYWxsYmFjaykpXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIG9uRGlkU3RvcENoYW5naW5nIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGxldCBkaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbkRpZFN0b3BDaGFuZ2luZyhjYWxsYmFjaykpXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qXG4gIEFkZCBhIG5ldyBjb250cm9sIHRvIG91cHR1dCBwYW5lbCBoZWFkaW5nLlxuXG4gIGVsZW1lbnQ6IEhUTUxFbGVtZW50IG9mIGNvbnRyb2wsIG9yIFN0cmluZyB3aXRoIHRhZyBuYW1lXG4gIG9wdHM6IHZhcmlvdXMgb3B0aW9uc1xuICAgIGlkOiBTdHJpbmcsIGlkXG4gICAgZXZlbnRzOiBPYmplY3QsIGV2ZW50IGNhbGxiYWNrcywga2V5IGlzIGV2ZW50IG5hbWUsIGUuZy4gXCJjbGlja1wiLFxuICAgICAgICAgICAgdmFsdWUgaXMgY2FsbGJhY2tcbiAgICBjbGFzc2VzOiBBcnJheSBvZiBTdHJpbmcsIGNsYXNzZXNcbiAgICBzdHlsZTogT2JqZWN0LCBjc3Mgc3R5bGUsIGtleXMgYXJlIHN0eWxlIGF0dHJpYnV0ZXMsIHZhbHVlcyBhcmUgdmFsdWVzXG4gICAgYXR0cnM6IE9iamVjdCwgb3RoZXIgYXR0cmlidXRlcywga2V5cyBhcmUgYXR0cmlidXRlIG5hbWVzLCB2YWx1ZXMgYXJlIHZhbHVlc1xuICAgIGJlZm9yZTogU3RyaW5nLCBDU1Mgc2VsZWN0b3Igb2YgZWxlbWVudCwgdGhhdCB0aGlzIG9uZSBzaG91bGQgYmUgaW5zZXJ0ZWRcbiAgICAgICAgICAgIGJlZm9yZSwgZS5nLiAnI3Byb2dyZXNzQmFyJ1xuXG4gIFJldHVybnMgRGlzcG9zYWJsZS5cbiAgKi9cbiAgYWRkUGFuZWxDb250cm9sIChlbGVtZW50OiBzdHJpbmcgfCBIVE1MRWxlbWVudCwgb3B0czogSUNvbnRyb2xPcHRzKSB7XG4gICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmFkZFBhbmVsQ29udHJvbChlbGVtZW50LCBvcHRzKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBuZXdPcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9ID0gey4uLm9wdHMsIGVsZW1lbnR9XG4gICAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFZpZXcuYWRkUGFuZWxDb250cm9sKER1bW15RWxlbWVudCwgbmV3T3B0cylcbiAgICB9XG4gIH1cblxuICAvKlxuICBhZGRDb25maWdQYXJhbVxuICAgIHBhcmFtX25hbWU6XG4gICAgICBvbkNoYW5nZWQ6IGNhbGxiYWNrIHZvaWQodmFsdWUpXG4gICAgICBpdGVtczogQXJyYXkgb3IgY2FsbGJhY2sgQXJyYXkodm9pZClcbiAgICAgIGl0ZW1UZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgaHRtbCB0ZW1wbGF0ZVxuICAgICAgaXRlbUZpbHRlcktleTogU3RyaW5nLCBpdGVtIGZpbHRlciBrZXlcbiAgICAgIGRlc2NyaXB0aW9uOiBTdHJpbmcgW29wdGlvbmFsXVxuICAgICAgZGlzcGxheU5hbWU6IFN0cmluZyBbb3B0aW9uYWwsIGNhcGl0YWxpemVkIHBhcmFtX25hbWUgZGVmYXVsdF1cbiAgICAgIGRpc3BsYXlUZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgc3RyaW5nIHRlbXBsYXRlXG4gICAgICBkZWZhdWx0OiBpdGVtLCBkZWZhdWx0IHZhbHVlXG5cbiAgUmV0dXJuc1xuICAgIGRpc3A6IERpc3Bvc2FibGVcbiAgICBjaGFuZ2U6IG9iamVjdCBvZiBjaGFuZ2UgZnVuY3Rpb25zLCBrZXlzIGJlaW5nIHBhcmFtX25hbWVcbiAgKi9cbiAgYWRkQ29uZmlnUGFyYW0gKHNwZWM6IHsgW3BhcmFtTmFtZTogc3RyaW5nXTogSVBhcmFtU3BlYzxhbnk+IH0pIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5hZGQodGhpcy5wbHVnaW5OYW1lLCBzcGVjKVxuICB9XG5cbiAgLypcbiAgZ2V0Q29uZmlnUGFyYW0ocGFyYW1OYW1lKSBvciBnZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUpXG5cbiAgcmV0dXJucyBhIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXJcbiAgdmFsdWUuXG5cbiAgUHJvbWlzZSBjYW4gYmUgcmVqZWN0ZWQgd2l0aCBlaXRoZXIgZXJyb3IsIG9yICd1bmRlZmluZWQnLiBMYXR0ZXJcbiAgaW4gY2FzZSB1c2VyIGNhbmNlbHMgcGFyYW0gc2VsZWN0aW9uIGRpYWxvZy5cbiAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnUGFyYW0gKHBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKCFuYW1lKSB7XG4gICAgICBuYW1lID0gcGx1Z2luTmFtZTtcbiAgICAgICh7IHBsdWdpbk5hbWUgfSA9IHRoaXMpXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmdldChwbHVnaW5OYW1lLCBuYW1lKVxuICB9XG5cbiAgLypcbiAgc2V0Q29uZmlnUGFyYW0ocGFyYW1OYW1lLCB2YWx1ZSkgb3Igc2V0Q29uZmlnUGFyYW0ocGx1Z2luTmFtZSwgcGFyYW1OYW1lLCB2YWx1ZSlcblxuICB2YWx1ZSBpcyBvcHRpb25hbC4gSWYgb21pdHRlZCwgYSBzZWxlY3Rpb24gZGlhbG9nIHdpbGwgYmUgcHJlc2VudGVkIHRvIHVzZXIuXG5cbiAgcmV0dXJucyBhIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXIgdmFsdWUuXG5cbiAgUHJvbWlzZSBjYW4gYmUgcmVqZWN0ZWQgd2l0aCBlaXRoZXIgZXJyb3IsIG9yICd1bmRlZmluZWQnLiBMYXR0ZXJcbiAgaW4gY2FzZSB1c2VyIGNhbmNlbHMgcGFyYW0gc2VsZWN0aW9uIGRpYWxvZy5cbiAgKi9cbiAgYXN5bmMgc2V0Q29uZmlnUGFyYW0gKHBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgaWYgKCF2YWx1ZSkge1xuICAgICAgdmFsdWUgPSBuYW1lXG4gICAgICBuYW1lID0gcGx1Z2luTmFtZTtcbiAgICAgICh7IHBsdWdpbk5hbWUgfSA9IHRoaXMpXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLnNldChwbHVnaW5OYW1lLCBuYW1lLCB2YWx1ZSlcbiAgfVxuXG4gIC8qXG4gIFV0aWxpdHkgZnVuY3Rpb24gdG8gZXh0cmFjdCBldmVudCByYW5nZS90eXBlIGZvciBhIGdpdmVuIGV2ZW50XG5cbiAgZWRpdG9yOiBUZXh0RWRpdG9yLCBlZGl0b3IgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcbiAgZGV0YWlsOiBldmVudCBkZXRhaWwsIGlnbm9yZWQgaWYgZXZlbnRUeXBlIGlzIHNldFxuICBldmVudFR5cGU6IFN0cmluZywgZXZlbnQgdHlwZSwgb25lIG9mICdrZXlib2FyZCcsICdjb250ZXh0JywgJ21vdXNlJ1xuICBwb3M6IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgZXZlbnQgcG9zaXRpb24sIGNhbiBiZSB1bmRlZmluZWRcbiAgY29udHJvbGxlcjogbGVhdmUgdW5kZWZpbmVkLCB0aGlzIGlzIGludGVybmFsIGZpZWxkXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKHtwb3MsIGNyYW5nZSwgZXZlbnRUeXBlfSlcbiAgICBwb3M6IFBvaW50LCBldmVudCBwb3NpdGlvblxuICAgIGNyYW5nZTogUmFuZ2UsIGV2ZW50IHJhbmdlXG4gICAgZXZlbnRUeXBlOiBTdHJpbmcsIGV2ZW50IHR5cGUsIG9uZSBvZiAna2V5Ym9hcmQnLCAnY29udGV4dCcsICdtb3VzZSdcbiAgKi9cbiAgd2l0aEV2ZW50UmFuZ2UgKHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3MsIGNvbnRyb2xsZXJ9OiBJRXZlbnRSYW5nZVBhcmFtcywgY2FsbGJhY2s6IFRFdmVudFJhbmdlQ2FsbGJhY2s8YW55Pikge1xuICAgIGxldCBwcG9zOiBQb2ludCB8IHVuZGVmaW5lZFxuICAgIGlmIChwb3MpIHsgcHBvcyA9IFBvaW50LmZyb21PYmplY3QocG9zKSB9XG4gICAgaWYgKCFldmVudFR5cGUpIHsgZXZlbnRUeXBlID0gZ2V0RXZlbnRUeXBlKGRldGFpbCkgfVxuICAgIGlmICghY29udHJvbGxlciAmJiBlZGl0b3IpIHsgY29udHJvbGxlciA9IHRoaXMucGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcikgfVxuICAgIGlmICghY29udHJvbGxlcikgeyByZXR1cm4gfVxuICAgIGNvbnN0IHJlcyA9IGNvbnRyb2xsZXIuZ2V0RXZlbnRSYW5nZShldmVudFR5cGUpXG4gICAgaWYgKCFyZXMpIHsgcmV0dXJuIH1cbiAgICByZXR1cm4gY2FsbGJhY2socmVzKVxuICB9XG59XG5cbmludGVyZmFjZSBJRXZlbnRSYW5nZVBhcmFtcyB7XG4gIGVkaXRvcj86IFRleHRFZGl0b3JcbiAgZGV0YWlsPzogYW55XG4gIGV2ZW50VHlwZT86IFRFdmVudFJhbmdlVHlwZVxuICBwb3M6IFRQb3NpdGlvblxuICBjb250cm9sbGVyPzogRWRpdG9yQ29udHJvbFxufVxuZXhwb3J0IHR5cGUgVEV2ZW50UmFuZ2VDYWxsYmFjazxUPiA9IChwYXJzOiB7cG9zOiBQb2ludCwgY3JhbmdlOiBSYW5nZSwgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGV9KSA9PiBUXG5cbmNsYXNzIER1bW15RWxlbWVudCB7XG4gIHByaXZhdGUgZWxlbWVudDogSFRNTEVsZW1lbnRcbiAgY29uc3RydWN0b3IgKHByaXZhdGUgb3B0czogSUNvbnRyb2xPcHRzICYge2VsZW1lbnQ6IEhUTUxFbGVtZW50fSkge1xuICAgIHRoaXMuZWxlbWVudCA9IG9wdHMuZWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnRcbiAgICB0aGlzLmluaXQoKVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZSAob3B0czogSUNvbnRyb2xPcHRzICYge2VsZW1lbnQ6IEhUTUxFbGVtZW50fSkge1xuICAgIHRoaXMub3B0cyA9IG9wdHNcbiAgICB0aGlzLmVsZW1lbnQucmVtb3ZlKClcbiAgICB0aGlzLmVsZW1lbnQgPSBvcHRzLmVsZW1lbnQuY2xvbmVOb2RlKHRydWUpIGFzIEhUTUxFbGVtZW50XG4gICAgdGhpcy5pbml0KClcbiAgfVxuXG4gIHByaXZhdGUgaW5pdCAoKSB7XG4gICAgY29uc3Qge2lkLCBldmVudHMsIGNsYXNzZXMsIHN0eWxlLCBhdHRyc30gPSB0aGlzLm9wdHNcbiAgICBpZiAoaWQpIHsgdGhpcy5lbGVtZW50LmlkID0gaWQgfVxuICAgIGlmIChldmVudHMpIHtcbiAgICAgIGZvciAoY29uc3QgZXYgb2YgT2JqZWN0LmtleXMoZXZlbnRzKSkge1xuICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldiwgZXZlbnRzW2V2XSlcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGNsYXNzZXMpIHtcbiAgICAgIGZvciAoY29uc3QgY2xzIG9mIGNsYXNzZXMpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xzKVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc3R5bGUpIHtcbiAgICAgIGZvciAoY29uc3Qgc3Qgb2YgT2JqZWN0LmtleXMoc3R5bGUpKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudC5zdHlsZVtzdF0gPSBzdHlsZVtzdF1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGF0dHJzKSB7XG4gICAgICBmb3IgKGNvbnN0IGF0IG9mIE9iamVjdC5rZXlzKGF0dHJzKSkge1xuICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKGF0LCBhdHRyc1thdF0pXG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=