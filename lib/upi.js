"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("./utils");
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
    }
    registerPlugin(disposables, name) {
        return new UPIInstance(this.pluginManager, disposables, name);
    }
}
exports.UPI = UPI;
class UPIInstance {
    constructor(pluginManager, disposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        this.disposables = new atom_1.CompositeDisposable();
        disposables.add(this.disposables);
        this.messageProvider = this.pluginManager.resultsDB.registerProvider(pluginName);
        this.disposables.add(this.messageProvider);
        this.messages = [];
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputPanel.backendStatus(this.pluginName, status);
    }
    addMessages(messages, types) {
        this.messages.push(...messages);
        this.messageProvider.setMessages(this.messages);
    }
    setMessages(messages, types) {
        this.messages = [...messages];
        this.messageProvider.setMessages(this.messages);
    }
    clearMessages(types) {
        this.messages = this.messages.filter(({ severity }) => !types.includes(severity));
        this.messageProvider.setMessages(this.messages);
    }
    setMessageTypes(types) {
        return (() => {
            const result = [];
            for (const type of Object.keys(types)) {
                const opts = types[type];
                result.push(this.pluginManager.outputPanel.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        const disp = this.pluginManager.tooltipRegistry.register(this.pluginName, { priority: 100, handler: callback });
        this.disposables.add(disp);
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        this.pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName: this.pluginName, tooltip });
    }
    onWillSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onWillSaveBuffer(callback));
        return disp;
    }
    onDidSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidSaveBuffer(callback));
        return disp;
    }
    onDidStopChanging(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidStopChanging(callback));
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            return this.pluginManager.outputPanel.addPanelControl(element, opts);
        }
        else {
            const newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputPanel.addPanelControl(DummyElement, newOpts);
        }
    }
    addConfigParam(spec) {
        return this.pluginManager.configParamManager.add(this.pluginName, spec);
    }
    getConfigParam(pluginName, name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!name) {
                name = pluginName;
                ({ pluginName } = this);
            }
            return this.pluginManager.configParamManager.get(pluginName, name);
        });
    }
    setConfigParam(pluginName, name, value) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!value) {
                value = name;
                name = pluginName;
                ({ pluginName } = this);
            }
            return this.pluginManager.configParamManager.set(pluginName, name, value);
        });
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        let ppos;
        if (pos) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        const res = controller.getEventRange(eventType);
        if (!res) {
            return;
        }
        return callback(res);
    }
}
class DummyElement {
    constructor(opts) {
        this.opts = opts;
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    update(opts) {
        this.opts = opts;
        this.element.remove();
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    init() {
        const { id, events, classes, style, attrs } = this.opts;
        if (id) {
            this.element.id = id;
        }
        if (events) {
            for (const ev of Object.keys(events)) {
                this.element.addEventListener(ev, events[ev]);
            }
        }
        if (classes) {
            for (const cls of classes) {
                this.element.classList.add(cls);
            }
        }
        if (style) {
            for (const st of Object.keys(style)) {
                this.element.style[st] = style[st];
            }
        }
        if (attrs) {
            for (const at of Object.keys(attrs)) {
                this.element.setAttribute(at, attrs[at]);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3VwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQ0EsK0JBQW9FO0FBQ3BFLG1DQUF1RDtBQW1CdkQ7SUFDRSxZQUFxQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtJQUFJLENBQUM7SUFRL0MsY0FBYyxDQUFFLFdBQWdDLEVBQUUsSUFBWTtRQUNuRSxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDL0QsQ0FBQztDQUNGO0FBWkQsa0JBWUM7QUFFRDtJQUlFLFlBQ1UsYUFBNEIsRUFDcEMsV0FBZ0MsRUFDeEIsVUFBa0I7UUFGbEIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFFNUIsZUFBVSxHQUFWLFVBQVUsQ0FBUTtRQUUxQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUNqQyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ2hGLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQTtRQUMxQyxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQTtJQUNwQixDQUFDO0lBU0QsT0FBTyxDQUFFLElBQVksRUFBRSxJQUFXO1FBQ2hDLElBQUksUUFBUSxDQUFBO1FBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUUsRUFBQyxLQUFL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cGVyLWZpbGUgbWVtYmVyLWFjY2VzcyAqL1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUG9pbnQsIFRleHRFZGl0b3IsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCwgZ2V0RXZlbnRUeXBlIH0gZnJvbSAnLi91dGlscydcbmltcG9ydCB7UGx1Z2luTWFuYWdlcn0gZnJvbSAnLi9wbHVnaW4tbWFuYWdlcidcbmltcG9ydCB7SVN0YXR1cywgSVNldmVyaXR5VGFiRGVmaW5pdGlvbiwgSUNvbnRyb2xPcHRzfSBmcm9tICcuL291dHB1dC1wYW5lbCdcbmltcG9ydCB7SVJlc3VsdEl0ZW0sIFRTZXZlcml0eX0gZnJvbSAnLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtURXZlbnRSYW5nZVR5cGV9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wvdG9vbHRpcC1tYW5hZ2VyJ1xuaW1wb3J0IHtUUG9zaXRpb259IGZyb20gJy4vcmVzdWx0cy1kYidcbmltcG9ydCB7SVBhcmFtU3BlY30gZnJvbSAnLi9jb25maWctcGFyYW1zJ1xuaW1wb3J0IHtFZGl0b3JDb250cm9sLCBUVGV4dEJ1ZmZlckNhbGxiYWNrfSBmcm9tICcuL2VkaXRvci1jb250cm9sJ1xuaW1wb3J0IHtUVG9vbHRpcEhhbmRsZXIsIFRUb29sdGlwRnVuY3Rpb259IGZyb20gJy4vdG9vbHRpcC1yZWdpc3RyeSdcbmltcG9ydCB7UHJvdmlkZXJ9IGZyb20gJy4vcmVzdWx0cy1kYi9wcm92aWRlcidcblxuaW50ZXJmYWNlIElTaG93VG9vbHRpcFBhcmFtcyB7XG4gIGVkaXRvcjogVGV4dEVkaXRvclxuICBwb3M6IFRQb3NpdGlvblxuICBldmVudFR5cGU/OiBURXZlbnRSYW5nZVR5cGVcbiAgZGV0YWlsPzogYW55XG4gIHRvb2x0aXA6IFRUb29sdGlwRnVuY3Rpb25cbn1cblxuZXhwb3J0IGNsYXNzIFVQSSB7XG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIHBsdWdpbk1hbmFnZXI6IFBsdWdpbk1hbmFnZXIpIHsgfVxuXG4gIC8qXG4gIENhbGwgdGhpcyBmdW5jdGlvbiBpbiBjb25zdW1lciB0byBnZXQgYWN0dWFsIGludGVyZmFjZVxuXG4gIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLCBvbmUgeW91IHdpbGwgcmV0dXJuIGluIGNvbnN1bWVyXG4gIG5hbWU6IFBsdWdpbiBwYWNrYWdlIG5hbWVcbiAgKi9cbiAgcHVibGljIHJlZ2lzdGVyUGx1Z2luIChkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgbmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBVUElJbnN0YW5jZSh0aGlzLnBsdWdpbk1hbmFnZXIsIGRpc3Bvc2FibGVzLCBuYW1lKVxuICB9XG59XG5cbmNsYXNzIFVQSUluc3RhbmNlIHtcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBwcml2YXRlIG1lc3NhZ2VQcm92aWRlcjogUHJvdmlkZXJcbiAgcHJpdmF0ZSBtZXNzYWdlczogSVJlc3VsdEl0ZW1bXVxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLFxuICAgIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLFxuICAgIHByaXZhdGUgcGx1Z2luTmFtZTogc3RyaW5nXG4gICkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZGlzcG9zYWJsZXMuYWRkKHRoaXMuZGlzcG9zYWJsZXMpXG4gICAgdGhpcy5tZXNzYWdlUHJvdmlkZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIucmVzdWx0c0RCLnJlZ2lzdGVyUHJvdmlkZXIocGx1Z2luTmFtZSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLm1lc3NhZ2VQcm92aWRlcilcbiAgICB0aGlzLm1lc3NhZ2VzID0gW11cbiAgfVxuXG4gIC8qXG4gIEFkZHMgbmV3IHN1bWJlbnUgdG8gJ0hhc2tlbGwgSURFJyBtZW51IGl0ZW1cbiAgbmFtZSAtLSBzdWJtZW51IGxhYmVsLCBzaG91bGQgYmUgZGVzY3JpcHRpdmUgb2YgYSBwYWNrYWdlXG4gIG1lbnUgLS0gQXRvbSBtZW51IG9iamVjdFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZS5cbiAgKi9cbiAgc2V0TWVudSAobmFtZTogc3RyaW5nLCBtZW51OiBhbnlbXSkge1xuICAgIGxldCBtZW51RGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKG1lbnVEaXNwID0gYXRvbS5tZW51LmFkZChbe1xuICAgICAgbGFiZWw6IE1BSU5fTUVOVV9MQUJFTCxcbiAgICAgIHN1Ym1lbnU6IFsge2xhYmVsOiBuYW1lLCBzdWJtZW51OiBtZW51fSBdXG4gICAgfVxuICAgIF0pKVxuICAgIHJldHVybiBtZW51RGlzcFxuICB9XG5cbiAgLypcbiAgU2V0cyBiYWNrZW5kIHN0YXR1c1xuICBzdGF0dXMgLS0gb2JqZWN0XG4gICAgc3RhdHVzOiBvbmUgb2YgJ3Byb2dyZXNzJywgJ3JlYWR5JywgJ2Vycm9yJywgJ3dhcm5pbmcnXG4gICAgcHJvZ3Jlc3M6IGZsb2F0IGJldHdlZW4gMCBhbmQgMSwgb25seSByZWxldmFudCB3aGVuIHN0YXR1cyBpcyAncHJvZ3Jlc3MnXG4gICAgICAgICAgICAgIGlmIDAgb3IgdW5kZWZpbmVkLCBwcm9ncmVzcyBiYXIgaXMgbm90IHNob3duXG4gICovXG4gIHNldFN0YXR1cyAoc3RhdHVzOiBJU3RhdHVzKSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5iYWNrZW5kU3RhdHVzKHRoaXMucGx1Z2luTmFtZSwgc3RhdHVzKVxuICB9XG5cbiAgLypcbiAgQWRkIG1lc3NhZ2VzIHRvIGlkZS1oYXNrZWxsIG91dHB1dFxuICBtZXNzYWdlczogQXJyYXkgb2YgT2JqZWN0XG4gICAgdXJpOiBTdHJpbmcsIEZpbGUgVVJJIG1lc3NhZ2UgcmVsYXRlcyB0b1xuICAgIHBvc2l0aW9uOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIHBvc2l0aW9uIHRvIHdoaWNoIG1lc3NhZ2UgcmVsYXRlc1xuICAgIG1lc3NhZ2U6IFN0cmluZyBvciB7PHRleHQgfCBodG1sPiwgaGlnaGxpZ2h0ZXI/fSwgbWVzc2FnZVxuICAgIHNldmVyaXR5OiBTdHJpbmcsIG9uZSBvZiAnZXJyb3InLCAnd2FybmluZycsICdsaW50JywgJ2J1aWxkJyxcbiAgICAgICAgICAgICAgb3IgdXNlci1kZWZpbmVkLCBzZWUgYHNldE1lc3NhZ2VUeXBlc2BcbiAgdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIGFkZE1lc3NhZ2VzIChtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM/OiBUU2V2ZXJpdHlbXSkge1xuICAgIHRoaXMubWVzc2FnZXMucHVzaCguLi5tZXNzYWdlcylcbiAgICB0aGlzLm1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzKVxuICB9XG5cbiAgLypcbiAgU2V0IG1lc3NhZ2VzIGluIGlkZS1oYXNrZWxsIG91dHB1dC4gQ2xlYXJzIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoXG4gIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuICBtZXNzYWdlczogQXJyYXkgb2YgT2JqZWN0XG4gICAgdXJpOiBTdHJpbmcsIEZpbGUgVVJJIG1lc3NhZ2UgcmVsYXRlcyB0b1xuICAgIHBvc2l0aW9uOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIHBvc2l0aW9uIHRvIHdoaWNoIG1lc3NhZ2UgcmVsYXRlc1xuICAgIG1lc3NhZ2U6IFN0cmluZywgbWVzc2FnZVxuICAgIHNldmVyaXR5OiBTdHJpbmcsIG9uZSBvZiAnZXJyb3InLCAnd2FybmluZycsICdsaW50JywgJ2J1aWxkJyxcbiAgICAgICAgICAgICAgb3IgdXNlci1kZWZpbmVkLCBzZWUgYHNldE1lc3NhZ2VUeXBlc2BcbiAgdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIHNldE1lc3NhZ2VzIChtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM6IFRTZXZlcml0eVtdKSB7XG4gICAgdGhpcy5tZXNzYWdlcyA9IFsuLi5tZXNzYWdlc11cbiAgICB0aGlzLm1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzKVxuICB9XG5cbiAgLypcbiAgQ2xlYXIgYWxsIGV4aXN0aW5nIG1lc3NhZ2VzIHdpdGggYHNldmVyaXR5YCBpbiBgdHlwZXNgXG4gIFRoaXMgaXMgc2hvcnRoYW5kIGZyb20gYHNldE1lc3NhZ2VzKFtdLHR5cGVzKWBcbiAgKi9cbiAgY2xlYXJNZXNzYWdlcyAodHlwZXM6IFRTZXZlcml0eVtdKSB7XG4gICAgdGhpcy5tZXNzYWdlcyA9IHRoaXMubWVzc2FnZXMuZmlsdGVyKCh7c2V2ZXJpdHl9KSA9PiAhdHlwZXMuaW5jbHVkZXMoc2V2ZXJpdHkpKVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKHRoaXMubWVzc2FnZXMpXG4gIH1cblxuICAvKlxuICBTZXQgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgIHRoYXQgeW91ciBwYWNrYWdlIHdpbGwgdXNlLlxuICB0eXBlczogT2JqZWN0IHdpdGgga2V5cyByZXByZXNlbnRpbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgIChpLmUuIHRhYiBuYW1lKVxuICAgICAgICAgYW5kIHZhbHVlcyBiZWluZyBPYmplY3RzIHdpdGgga2V5c1xuICAgIHVyaUZpbHRlcjogQm9vbCwgc2hvdWxkIHVyaSBmaWx0ZXIgYXBwbHkgdG8gdGFiP1xuICAgIGF1dG9TY3JvbGw6IEJvb2wsIHNob3VsZCB0YWIgYXV0by1zY3JvbGw/XG5cbiAgVGhpcyBhbGxvd3MgdG8gZGVmaW5lIGN1c3RvbSBvdXRwdXQgcGFuZWwgdGFicy5cbiAgKi9cbiAgc2V0TWVzc2FnZVR5cGVzICh0eXBlczogeyBbc2V2ZXJpdHk6IHN0cmluZ106IElTZXZlcml0eVRhYkRlZmluaXRpb259KSB7XG4gICAgcmV0dXJuICgoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBbXVxuICAgICAgZm9yIChjb25zdCB0eXBlIG9mIE9iamVjdC5rZXlzKHR5cGVzKSkge1xuICAgICAgICBjb25zdCBvcHRzID0gdHlwZXNbdHlwZV1cbiAgICAgICAgcmVzdWx0LnB1c2godGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmNyZWF0ZVRhYih0eXBlLCBvcHRzKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRcbiAgICB9KSgpXG4gIH1cblxuICAvKlxuICBFZGl0b3IgZXZlbnQgc3Vic2NyaXB0aW9uLiBGaXJlcyB3aGVuIG1vdXNlIGN1cnNvciBzdG9wcGVkIG92ZXIgYSBzeW1ib2wgaW5cbiAgZWRpdG9yLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhlZGl0b3IsIGNyYW5nZSwgdHlwZSlcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnNvciByYW5nZSB0aGF0IGdlbmVyYXRlZCBldmVudC5cbiAgICB0eXBlOiBPbmUgb2YgJ21vdXNlJywgJ3NlbGVjdGlvbicgLS0gdHlwZSBvZiBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGlzXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZS5cbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcblxuICByZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25TaG91bGRTaG93VG9vbHRpcCAoY2FsbGJhY2s6IFRUb29sdGlwSGFuZGxlcikge1xuICAgIGNvbnN0IGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnJlZ2lzdGVyKFxuICAgICAgdGhpcy5wbHVnaW5OYW1lLCB7cHJpb3JpdHk6IDEwMCwgaGFuZGxlcjogY2FsbGJhY2t9XG4gICAgKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qXG4gIFNob3cgdG9vbHRpcCBpbiBlZGl0b3IuXG5cbiAgZWRpdG9yOiBlZGl0b3IgdGhhdCB3aWxsIHNob3cgdG9vbHRpcFxuICBwb3M6IHRvb2x0aXAgcG9zaXRpb25cbiAgZXZlbnRUeXBlOiBvbmUgb2YgJ2NvbnRleHQnLCAna2V5Ym9hcmQnIGFuZCAnbW91c2UnXG4gIGRldGFpbDogZm9yIGF1dG9tYXRpYyBzZWxlY3Rpb24gYmV0d2VlbiAnY29udGV4dCcgYW5kICdrZXlib2FyZCcuXG4gICAgICAgICAgSWdub3JlZCBpZiAnZXZlbnRUeXBlJyBpcyBzZXQuXG4gIHRvb2x0aXA6IGZ1bmN0aW9uKGNyYW5nZSlcbiAgICBjcmFuZ2U6IFJhbmdlLCBjdXJyZW50bHkgc2VsZWN0ZWQgcmFuZ2UgaW4gZWRpdG9yIChwb3NzaWJseSBlbXB0eSlcblxuICAgIFJldHVybnMge3JhbmdlLCB0ZXh0fSBvciBQcm9taXNlXG4gICAgICByYW5nZTogUmFuZ2UsIHRvb2x0aXAgaGlnaGxpZ2h0aW5nIHJhbmdlXG4gICAgICBwZXJzaXN0T25DdXJzb3JNb3ZlOiBCb29sZWFuLCBvcHRpb25hbCwgZGVmYXVsdCBmYWxzZSwgcGVyc2lzdCBvbiBjdXJzb3IgbW92ZSByZWdhcmRsZXNzIG9mIHNldHRpbmdzXG4gICAgICB0ZXh0OiB0b29sdGlwIHRleHQuIFN0cmluZyBvciB7dGV4dCwgaGlnaGxpZ2h0ZXJ9IG9yIHtodG1sfVxuICAgICAgICB0ZXh0OiB0b29sdGlwIHRleHRcbiAgICAgICAgaGlnaGxpZ2h0ZXI6IGdyYW1tYXIgc2NvcGUgdGhhdCB3aWxsIGJlIHVzZWQgdG8gaGlnaGxpZ2h0IHRvb2x0aXAgdGV4dFxuICAgICAgICBodG1sOiBodG1sIHRvIGJlIGRpc3BsYXllZCBpbiB0b29sdGlwXG4gICovXG4gIHNob3dUb29sdGlwICh7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZSwgZGV0YWlsLCB0b29sdGlwfTogSVNob3dUb29sdGlwUGFyYW1zKSB7XG4gICAgaWYgKCFldmVudFR5cGUpIHtcbiAgICAgIGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpXG4gICAgfVxuICAgIHRoaXMucGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnkuc2hvd1Rvb2x0aXAoXG4gICAgICBlZGl0b3IsIGV2ZW50VHlwZSwge3BsdWdpbk5hbWU6IHRoaXMucGx1Z2luTmFtZSwgdG9vbHRpcH1cbiAgICApXG4gIH1cblxuICAvKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGJlZm9yZSBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cblxuICBjYWxsYmFjazogY2FsbGJhY2soYnVmZmVyKVxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uV2lsbFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgbGV0IGRpc3BcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uV2lsbFNhdmVCdWZmZXIoY2FsbGJhY2spKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGFmdGVyIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhidWZmZXIpXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcblxuICBSZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25EaWRTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGxldCBkaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbkRpZFNhdmVCdWZmZXIoY2FsbGJhY2spKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBsZXQgZGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcoY2FsbGJhY2spKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKlxuICBBZGQgYSBuZXcgY29udHJvbCB0byBvdXB0dXQgcGFuZWwgaGVhZGluZy5cblxuICBlbGVtZW50OiBIVE1MRWxlbWVudCBvZiBjb250cm9sLCBvciBTdHJpbmcgd2l0aCB0YWcgbmFtZVxuICBvcHRzOiB2YXJpb3VzIG9wdGlvbnNcbiAgICBpZDogU3RyaW5nLCBpZFxuICAgIGV2ZW50czogT2JqZWN0LCBldmVudCBjYWxsYmFja3MsIGtleSBpcyBldmVudCBuYW1lLCBlLmcuIFwiY2xpY2tcIixcbiAgICAgICAgICAgIHZhbHVlIGlzIGNhbGxiYWNrXG4gICAgY2xhc3NlczogQXJyYXkgb2YgU3RyaW5nLCBjbGFzc2VzXG4gICAgc3R5bGU6IE9iamVjdCwgY3NzIHN0eWxlLCBrZXlzIGFyZSBzdHlsZSBhdHRyaWJ1dGVzLCB2YWx1ZXMgYXJlIHZhbHVlc1xuICAgIGF0dHJzOiBPYmplY3QsIG90aGVyIGF0dHJpYnV0ZXMsIGtleXMgYXJlIGF0dHJpYnV0ZSBuYW1lcywgdmFsdWVzIGFyZSB2YWx1ZXNcbiAgICBiZWZvcmU6IFN0cmluZywgQ1NTIHNlbGVjdG9yIG9mIGVsZW1lbnQsIHRoYXQgdGhpcyBvbmUgc2hvdWxkIGJlIGluc2VydGVkXG4gICAgICAgICAgICBiZWZvcmUsIGUuZy4gJyNwcm9ncmVzc0JhcidcblxuICBSZXR1cm5zIERpc3Bvc2FibGUuXG4gICovXG4gIGFkZFBhbmVsQ29udHJvbCAoZWxlbWVudDogc3RyaW5nIHwgSFRNTEVsZW1lbnQsIG9wdHM6IElDb250cm9sT3B0cykge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYWRkUGFuZWxDb250cm9sKGVsZW1lbnQsIG9wdHMpXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5ld09wdHM6IElDb250cm9sT3B0cyAmIHtlbGVtZW50OiBIVE1MRWxlbWVudH0gPSB7Li4ub3B0cywgZWxlbWVudH1cbiAgICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYWRkUGFuZWxDb250cm9sKER1bW15RWxlbWVudCwgbmV3T3B0cylcbiAgICB9XG4gIH1cblxuICAvKlxuICBhZGRDb25maWdQYXJhbVxuICAgIHBhcmFtX25hbWU6XG4gICAgICBvbkNoYW5nZWQ6IGNhbGxiYWNrIHZvaWQodmFsdWUpXG4gICAgICBpdGVtczogQXJyYXkgb3IgY2FsbGJhY2sgQXJyYXkodm9pZClcbiAgICAgIGl0ZW1UZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgaHRtbCB0ZW1wbGF0ZVxuICAgICAgaXRlbUZpbHRlcktleTogU3RyaW5nLCBpdGVtIGZpbHRlciBrZXlcbiAgICAgIGRlc2NyaXB0aW9uOiBTdHJpbmcgW29wdGlvbmFsXVxuICAgICAgZGlzcGxheU5hbWU6IFN0cmluZyBbb3B0aW9uYWwsIGNhcGl0YWxpemVkIHBhcmFtX25hbWUgZGVmYXVsdF1cbiAgICAgIGRpc3BsYXlUZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgc3RyaW5nIHRlbXBsYXRlXG4gICAgICBkZWZhdWx0OiBpdGVtLCBkZWZhdWx0IHZhbHVlXG5cbiAgUmV0dXJuc1xuICAgIGRpc3A6IERpc3Bvc2FibGVcbiAgICBjaGFuZ2U6IG9iamVjdCBvZiBjaGFuZ2UgZnVuY3Rpb25zLCBrZXlzIGJlaW5nIHBhcmFtX25hbWVcbiAgKi9cbiAgYWRkQ29uZmlnUGFyYW0gKHNwZWM6IHsgW3BhcmFtTmFtZTogc3RyaW5nXTogSVBhcmFtU3BlYzxhbnk+IH0pIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5hZGQodGhpcy5wbHVnaW5OYW1lLCBzcGVjKVxuICB9XG5cbiAgLypcbiAgZ2V0Q29uZmlnUGFyYW0ocGFyYW1OYW1lKSBvciBnZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUpXG5cbiAgcmV0dXJucyBhIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXJcbiAgdmFsdWUuXG5cbiAgUHJvbWlzZSBjYW4gYmUgcmVqZWN0ZWQgd2l0aCBlaXRoZXIgZXJyb3IsIG9yICd1bmRlZmluZWQnLiBMYXR0ZXJcbiAgaW4gY2FzZSB1c2VyIGNhbmNlbHMgcGFyYW0gc2VsZWN0aW9uIGRpYWxvZy5cbiAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnUGFyYW0gKHBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKCFuYW1lKSB7XG4gICAgICBuYW1lID0gcGx1Z2luTmFtZTtcbiAgICAgICh7IHBsdWdpbk5hbWUgfSA9IHRoaXMpXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmdldChwbHVnaW5OYW1lLCBuYW1lKVxuICB9XG5cbiAgLypcbiAgc2V0Q29uZmlnUGFyYW0ocGFyYW1OYW1lLCB2YWx1ZSkgb3Igc2V0Q29uZmlnUGFyYW0ocGx1Z2luTmFtZSwgcGFyYW1OYW1lLCB2YWx1ZSlcblxuICB2YWx1ZSBpcyBvcHRpb25hbC4gSWYgb21pdHRlZCwgYSBzZWxlY3Rpb24gZGlhbG9nIHdpbGwgYmUgcHJlc2VudGVkIHRvIHVzZXIuXG5cbiAgcmV0dXJucyBhIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXIgdmFsdWUuXG5cbiAgUHJvbWlzZSBjYW4gYmUgcmVqZWN0ZWQgd2l0aCBlaXRoZXIgZXJyb3IsIG9yICd1bmRlZmluZWQnLiBMYXR0ZXJcbiAgaW4gY2FzZSB1c2VyIGNhbmNlbHMgcGFyYW0gc2VsZWN0aW9uIGRpYWxvZy5cbiAgKi9cbiAgYXN5bmMgc2V0Q29uZmlnUGFyYW0gKHBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgaWYgKCF2YWx1ZSkge1xuICAgICAgdmFsdWUgPSBuYW1lXG4gICAgICBuYW1lID0gcGx1Z2luTmFtZTtcbiAgICAgICh7IHBsdWdpbk5hbWUgfSA9IHRoaXMpXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLnNldChwbHVnaW5OYW1lLCBuYW1lLCB2YWx1ZSlcbiAgfVxuXG4gIC8qXG4gIFV0aWxpdHkgZnVuY3Rpb24gdG8gZXh0cmFjdCBldmVudCByYW5nZS90eXBlIGZvciBhIGdpdmVuIGV2ZW50XG5cbiAgZWRpdG9yOiBUZXh0RWRpdG9yLCBlZGl0b3IgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcbiAgZGV0YWlsOiBldmVudCBkZXRhaWwsIGlnbm9yZWQgaWYgZXZlbnRUeXBlIGlzIHNldFxuICBldmVudFR5cGU6IFN0cmluZywgZXZlbnQgdHlwZSwgb25lIG9mICdrZXlib2FyZCcsICdjb250ZXh0JywgJ21vdXNlJ1xuICBwb3M6IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgZXZlbnQgcG9zaXRpb24sIGNhbiBiZSB1bmRlZmluZWRcbiAgY29udHJvbGxlcjogbGVhdmUgdW5kZWZpbmVkLCB0aGlzIGlzIGludGVybmFsIGZpZWxkXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKHtwb3MsIGNyYW5nZSwgZXZlbnRUeXBlfSlcbiAgICBwb3M6IFBvaW50LCBldmVudCBwb3NpdGlvblxuICAgIGNyYW5nZTogUmFuZ2UsIGV2ZW50IHJhbmdlXG4gICAgZXZlbnRUeXBlOiBTdHJpbmcsIGV2ZW50IHR5cGUsIG9uZSBvZiAna2V5Ym9hcmQnLCAnY29udGV4dCcsICdtb3VzZSdcbiAgKi9cbiAgd2l0aEV2ZW50UmFuZ2UgKHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3MsIGNvbnRyb2xsZXJ9OiBJRXZlbnRSYW5nZVBhcmFtcywgY2FsbGJhY2s6IFRFdmVudFJhbmdlQ2FsbGJhY2s8YW55Pikge1xuICAgIGxldCBwcG9zOiBQb2ludCB8IHVuZGVmaW5lZFxuICAgIGlmIChwb3MpIHsgcHBvcyA9IFBvaW50LmZyb21PYmplY3QocG9zKSB9XG4gICAgaWYgKCFldmVudFR5cGUpIHsgZXZlbnRUeXBlID0gZ2V0RXZlbnRUeXBlKGRldGFpbCkgfVxuICAgIGlmICghY29udHJvbGxlciAmJiBlZGl0b3IpIHsgY29udHJvbGxlciA9IHRoaXMucGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcikgfVxuICAgIGlmICghY29udHJvbGxlcikgeyByZXR1cm4gfVxuICAgIGNvbnN0IHJlcyA9IGNvbnRyb2xsZXIuZ2V0RXZlbnRSYW5nZShldmVudFR5cGUpXG4gICAgaWYgKCFyZXMpIHsgcmV0dXJuIH1cbiAgICByZXR1cm4gY2FsbGJhY2socmVzKVxuICB9XG59XG5cbmludGVyZmFjZSBJRXZlbnRSYW5nZVBhcmFtcyB7XG4gIGVkaXRvcj86IFRleHRFZGl0b3JcbiAgZGV0YWlsPzogYW55XG4gIGV2ZW50VHlwZT86IFRFdmVudFJhbmdlVHlwZVxuICBwb3M6IFRQb3NpdGlvblxuICBjb250cm9sbGVyPzogRWRpdG9yQ29udHJvbFxufVxuZXhwb3J0IHR5cGUgVEV2ZW50UmFuZ2VDYWxsYmFjazxUPiA9IChwYXJzOiB7cG9zOiBQb2ludCwgY3JhbmdlOiBSYW5nZSwgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGV9KSA9PiBUXG5cbmNsYXNzIER1bW15RWxlbWVudCB7XG4gIHByaXZhdGUgZWxlbWVudDogSFRNTEVsZW1lbnRcbiAgY29uc3RydWN0b3IgKHByaXZhdGUgb3B0czogSUNvbnRyb2xPcHRzICYge2VsZW1lbnQ6IEhUTUxFbGVtZW50fSkge1xuICAgIHRoaXMuZWxlbWVudCA9IG9wdHMuZWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnRcbiAgICB0aGlzLmluaXQoKVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZSAob3B0czogSUNvbnRyb2xPcHRzICYge2VsZW1lbnQ6IEhUTUxFbGVtZW50fSkge1xuICAgIHRoaXMub3B0cyA9IG9wdHNcbiAgICB0aGlzLmVsZW1lbnQucmVtb3ZlKClcbiAgICB0aGlzLmVsZW1lbnQgPSBvcHRzLmVsZW1lbnQuY2xvbmVOb2RlKHRydWUpIGFzIEhUTUxFbGVtZW50XG4gICAgdGhpcy5pbml0KClcbiAgfVxuXG4gIHByaXZhdGUgaW5pdCAoKSB7XG4gICAgY29uc3Qge2lkLCBldmVudHMsIGNsYXNzZXMsIHN0eWxlLCBhdHRyc30gPSB0aGlzLm9wdHNcbiAgICBpZiAoaWQpIHsgdGhpcy5lbGVtZW50LmlkID0gaWQgfVxuICAgIGlmIChldmVudHMpIHtcbiAgICAgIGZvciAoY29uc3QgZXYgb2YgT2JqZWN0LmtleXMoZXZlbnRzKSkge1xuICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldiwgZXZlbnRzW2V2XSlcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGNsYXNzZXMpIHtcbiAgICAgIGZvciAoY29uc3QgY2xzIG9mIGNsYXNzZXMpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xzKVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc3R5bGUpIHtcbiAgICAgIGZvciAoY29uc3Qgc3Qgb2YgT2JqZWN0LmtleXMoc3R5bGUpKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudC5zdHlsZVtzdF0gPSBzdHlsZVtzdF1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGF0dHJzKSB7XG4gICAgICBmb3IgKGNvbnN0IGF0IG9mIE9iamVjdC5rZXlzKGF0dHJzKSkge1xuICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKGF0LCBhdHRyc1thdF0pXG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=