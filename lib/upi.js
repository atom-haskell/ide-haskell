"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("./utils");
const utils_2 = require("./utils");
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
    }
    registerPlugin(disposables, name) {
        return new UPIInstance(this.pluginManager, disposables, name);
    }
}
exports.UPI = UPI;
class UPIInstance {
    constructor(pluginManager, disposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        disposables.add(this.disposables = new atom_1.CompositeDisposable());
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputView.backendStatus(this.pluginName, status);
    }
    addMessages(messages, types) {
        return this.pluginManager.checkResults.appendResults(messages, types);
    }
    setMessages(messages, types) {
        messages = messages.map(function (m) {
            if (m.position != null) {
                m.position = atom_1.Point.fromObject(m.position);
            }
            return m;
        });
        return this.pluginManager.checkResults.setResults(messages, types);
    }
    clearMessages(types) {
        return this.pluginManager.checkResults.setResults([], types);
    }
    setMessageTypes(types) {
        return (() => {
            let result = [];
            for (let type in types) {
                let opts = types[type];
                result.push(this.pluginManager.outputView.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onShouldShowTooltip(({ editor, pos, eventType }) => {
            return this.showTooltip({
                editor,
                pos,
                eventType,
                tooltip(crange) {
                    let res = callback(editor, crange, eventType);
                    if (res != null) {
                        return Promise.resolve(res);
                    }
                    else {
                        return Promise.reject({ ignore: true });
                    }
                }
            });
        }));
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        let controller = this.pluginManager.controller(editor);
        return this.withEventRange({ controller, pos, detail, eventType }, ({ crange, pos, eventType }) => {
            return Promise.resolve(tooltip(crange)).then(({ range, text, persistOnCursorMove }) => controller && controller.tooltips.show(range, utils_2.MessageObject.fromObject(text), { type: eventType, subtype: 'external', persistOnCursorMove }))
                .catch(status => {
                if (status == null) {
                    status = { status: 'warning' };
                }
                if (status instanceof Error) {
                    console.warn(status);
                    status = { status: 'warning' };
                }
                if (!status.ignore) {
                    controller && controller.tooltips.hide({ type: eventType });
                    return this.setStatus(status);
                }
            });
        });
    }
    onWillSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onWillSaveBuffer(callback));
        return disp;
    }
    onDidSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidSaveBuffer(callback));
        return disp;
    }
    onDidStopChanging(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidStopChanging(callback));
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element == 'string') {
            return this.pluginManager.outputView.addPanelControl(element, opts);
        }
        else {
            let newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputView.addPanelControl(DummyElement, opts);
        }
    }
    addConfigParam(spec) {
        return this.pluginManager.configParamManager.add(this.pluginName, spec);
    }
    getConfigParam(pluginName, name) {
        if (name == null) {
            name = pluginName;
            ({ pluginName } = this);
        }
        return this.pluginManager.configParamManager.get(pluginName, name);
    }
    setConfigParam(pluginName, name, value) {
        if (value == null) {
            value = name;
            name = pluginName;
            ({ pluginName } = this);
        }
        return this.pluginManager.configParamManager.set(pluginName, name, value);
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        let ppos;
        if (pos != null) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (eventType == null) {
            eventType = utils_1.getEventType(detail);
        }
        if (controller == null && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (controller == null) {
            return;
        }
        return callback(controller.getEventRange(ppos, eventType));
    }
}
class DummyElement {
    constructor(opts) {
        this.opts = opts;
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    update(opts) {
        this.opts = opts;
        this.element.remove();
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    init() {
        const { id, events, classes, style, attrs } = this.opts;
        if (id) {
            this.element.id = id;
        }
        if (events) {
            for (const ev of Object.keys(events)) {
                this.element.addEventListener(ev, events[ev]);
            }
        }
        if (classes) {
            for (const cls of classes) {
                this.element.classList.add(cls);
            }
        }
        if (style) {
            for (const st of Object.keys(style)) {
                this.element.style[st] = style[st];
            }
        }
        if (attrs) {
            for (const at of Object.keys(attrs)) {
                this.element.setAttribute(at, attrs[at]);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3VwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUFnRjtBQUNoRixtQ0FBdUQ7QUFJdkQsbUNBQStDO0FBd0IvQztJQUNFLFlBQXFCLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO0lBQUksQ0FBQztJQVF0RCxjQUFjLENBQUUsV0FBZ0MsRUFBRSxJQUFZO1FBQzVELE1BQU0sQ0FBQyxJQUFJLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUMvRCxDQUFDO0NBQ0Y7QUFaRCxrQkFZQztBQUVEO0lBRUUsWUFDVSxhQUE0QixFQUNwQyxXQUFnQyxFQUN4QixVQUFrQjtRQUZsQixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUU1QixlQUFVLEdBQVYsVUFBVSxDQUFRO1FBRTFCLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUMsQ0FBQTtJQUMvRCxDQUFDO0lBU0QsT0FBTyxDQUFFLElBQVksRUFBRSxJQUFXO1FBQ2hDLElBQUksUUFBUSxDQUFBO1FBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUUsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBRTthQUMxQztTQUNBLENBQUMsQ0FBQyxDQUFBO1FBQ0gsTUFBTSxDQUFDLFFBQVEsQ0FBQTtJQUNqQixDQUFDO0lBU0QsU0FBUyxDQUFFLE1BQWU7UUFDeEIsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE1B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RGlzcG9zYWJsZSwgUG9pbnQsIFRleHRFZGl0b3IsIFRleHRCdWZmZXIsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCwgZ2V0RXZlbnRUeXBlIH0gZnJvbSAnLi91dGlscydcbmltcG9ydCB7IFBsdWdpbk1hbmFnZXIgfSBmcm9tICcuL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtJU3RhdHVzLCBJU2V2ZXJpdHlUYWJEZWZpbml0aW9uLCBJQ29udHJvbE9wdHN9IGZyb20gJy4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHtJUmVzdWx0SXRlbSwgVFNldmVyaXR5fSBmcm9tICcuL3Jlc3VsdHMtZGInXG5pbXBvcnQge1RNZXNzYWdlLCBNZXNzYWdlT2JqZWN0fSBmcm9tICcuL3V0aWxzJ1xuaW1wb3J0IHtURXZlbnRSYW5nZVR5cGV9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge1RQb3NpdGlvbn0gZnJvbSAnLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtJUGFyYW1TcGVjfSBmcm9tICcuL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQge0VkaXRvckNvbnRyb2x9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wnXG5cbmludGVyZmFjZSBJVG9vbHRpcERhdGEge1xuICByYW5nZTogUmFuZ2VcbiAgdGV4dDogVE1lc3NhZ2VcbiAgcGVyc2lzdE9uQ3Vyc29yTW92ZT86IGJvb2xlYW5cbn1cbmV4cG9ydCB0eXBlIFRUb29sdGlwSGFuZGxlciA9XG4gIChlZGl0b3I6IFRleHRFZGl0b3IsIGNyYW5nZTogUmFuZ2UsIHR5cGU6IFRFdmVudFJhbmdlVHlwZSkgPT4gSVRvb2x0aXBEYXRhIHwgUHJvbWlzZTxJVG9vbHRpcERhdGE+XG5cbmludGVyZmFjZSBJU2hvd1Rvb2x0aXBQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgcG9zOiBUUG9zaXRpb25cbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIGRldGFpbD86IGFueVxuICB0b29sdGlwOiBUVG9vbHRpcEZ1bmN0aW9uXG59XG50eXBlIFRUb29sdGlwRnVuY3Rpb24gPSAoY3JhbmdlOiBSYW5nZSkgPT4gSVRvb2x0aXBEYXRhIHwgUHJvbWlzZTxJVG9vbHRpcERhdGE+XG5leHBvcnQgdHlwZSBUZXh0QnVmZmVyQ2FsbGJhY2sgPSAoYnVmZmVyOiBUZXh0QnVmZmVyKSA9PiB2b2lkXG5cbmV4cG9ydCBjbGFzcyBVUEkge1xuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyKSB7IH1cblxuICAvKlxuICBDYWxsIHRoaXMgZnVuY3Rpb24gaW4gY29uc3VtZXIgdG8gZ2V0IGFjdHVhbCBpbnRlcmZhY2VcblxuICBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgb25lIHlvdSB3aWxsIHJldHVybiBpbiBjb25zdW1lclxuICBuYW1lOiBQbHVnaW4gcGFja2FnZSBuYW1lXG4gICovXG4gIHJlZ2lzdGVyUGx1Z2luIChkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgbmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBVUElJbnN0YW5jZSh0aGlzLnBsdWdpbk1hbmFnZXIsIGRpc3Bvc2FibGVzLCBuYW1lKVxuICB9XG59XG5cbmNsYXNzIFVQSUluc3RhbmNlIHtcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLFxuICAgIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLFxuICAgIHByaXZhdGUgcGx1Z2luTmFtZTogc3RyaW5nXG4gICkge1xuICAgIGRpc3Bvc2FibGVzLmFkZCh0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKSlcbiAgfVxuXG4gIC8qXG4gIEFkZHMgbmV3IHN1bWJlbnUgdG8gJ0hhc2tlbGwgSURFJyBtZW51IGl0ZW1cbiAgbmFtZSAtLSBzdWJtZW51IGxhYmVsLCBzaG91bGQgYmUgZGVzY3JpcHRpdmUgb2YgYSBwYWNrYWdlXG4gIG1lbnUgLS0gQXRvbSBtZW51IG9iamVjdFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZS5cbiAgKi9cbiAgc2V0TWVudSAobmFtZTogc3RyaW5nLCBtZW51OiBhbnlbXSkge1xuICAgIGxldCBtZW51RGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKG1lbnVEaXNwID0gYXRvbS5tZW51LmFkZChbe1xuICAgICAgbGFiZWw6IE1BSU5fTUVOVV9MQUJFTCxcbiAgICAgIHN1Ym1lbnU6IFsge2xhYmVsOiBuYW1lLCBzdWJtZW51OiBtZW51fSBdXG4gICAgfVxuICAgIF0pKVxuICAgIHJldHVybiBtZW51RGlzcFxuICB9XG5cbiAgLypcbiAgU2V0cyBiYWNrZW5kIHN0YXR1c1xuICBzdGF0dXMgLS0gb2JqZWN0XG4gICAgc3RhdHVzOiBvbmUgb2YgJ3Byb2dyZXNzJywgJ3JlYWR5JywgJ2Vycm9yJywgJ3dhcm5pbmcnXG4gICAgcHJvZ3Jlc3M6IGZsb2F0IGJldHdlZW4gMCBhbmQgMSwgb25seSByZWxldmFudCB3aGVuIHN0YXR1cyBpcyAncHJvZ3Jlc3MnXG4gICAgICAgICAgICAgIGlmIDAgb3IgdW5kZWZpbmVkLCBwcm9ncmVzcyBiYXIgaXMgbm90IHNob3duXG4gICovXG4gIHNldFN0YXR1cyAoc3RhdHVzOiBJU3RhdHVzKSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmJhY2tlbmRTdGF0dXModGhpcy5wbHVnaW5OYW1lLCBzdGF0dXMpXG4gIH1cblxuICAvKlxuICBBZGQgbWVzc2FnZXMgdG8gaWRlLWhhc2tlbGwgb3V0cHV0XG4gIG1lc3NhZ2VzOiBBcnJheSBvZiBPYmplY3RcbiAgICB1cmk6IFN0cmluZywgRmlsZSBVUkkgbWVzc2FnZSByZWxhdGVzIHRvXG4gICAgcG9zaXRpb246IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgcG9zaXRpb24gdG8gd2hpY2ggbWVzc2FnZSByZWxhdGVzXG4gICAgbWVzc2FnZTogU3RyaW5nIG9yIHs8dGV4dCB8IGh0bWw+LCBoaWdobGlnaHRlcj99LCBtZXNzYWdlXG4gICAgc2V2ZXJpdHk6IFN0cmluZywgb25lIG9mICdlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnLCAnYnVpbGQnLFxuICAgICAgICAgICAgICBvciB1c2VyLWRlZmluZWQsIHNlZSBgc2V0TWVzc2FnZVR5cGVzYFxuICB0eXBlczogQXJyYXkgb2YgU3RyaW5nLCBjb250YWluaW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YC4gSWYgdW5kZWZpbmVkLFxuICAgICAgICAgd2lsbCBiZSB0YWtlbiBmcm9tIGBtZXNzYWdlc2BcbiAgKi9cbiAgYWRkTWVzc2FnZXMgKG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdLCB0eXBlcz86IFRTZXZlcml0eVtdKSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jaGVja1Jlc3VsdHMuYXBwZW5kUmVzdWx0cyhtZXNzYWdlcywgdHlwZXMpXG4gIH1cblxuICAvKlxuICBTZXQgbWVzc2FnZXMgaW4gaWRlLWhhc2tlbGwgb3V0cHV0LiBDbGVhcnMgYWxsIGV4aXN0aW5nIG1lc3NhZ2VzIHdpdGhcbiAgYHNldmVyaXR5YCBpbiBgdHlwZXNgXG4gIG1lc3NhZ2VzOiBBcnJheSBvZiBPYmplY3RcbiAgICB1cmk6IFN0cmluZywgRmlsZSBVUkkgbWVzc2FnZSByZWxhdGVzIHRvXG4gICAgcG9zaXRpb246IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgcG9zaXRpb24gdG8gd2hpY2ggbWVzc2FnZSByZWxhdGVzXG4gICAgbWVzc2FnZTogU3RyaW5nLCBtZXNzYWdlXG4gICAgc2V2ZXJpdHk6IFN0cmluZywgb25lIG9mICdlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnLCAnYnVpbGQnLFxuICAgICAgICAgICAgICBvciB1c2VyLWRlZmluZWQsIHNlZSBgc2V0TWVzc2FnZVR5cGVzYFxuICB0eXBlczogQXJyYXkgb2YgU3RyaW5nLCBjb250YWluaW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YC4gSWYgdW5kZWZpbmVkLFxuICAgICAgICAgd2lsbCBiZSB0YWtlbiBmcm9tIGBtZXNzYWdlc2BcbiAgKi9cbiAgc2V0TWVzc2FnZXMgKG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdLCB0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICBtZXNzYWdlcyA9IG1lc3NhZ2VzLm1hcChmdW5jdGlvbiAobSkge1xuICAgICAgaWYgKG0ucG9zaXRpb24gIT0gbnVsbCkgeyBtLnBvc2l0aW9uID0gUG9pbnQuZnJvbU9iamVjdChtLnBvc2l0aW9uKSB9XG4gICAgICByZXR1cm4gbVxuICAgIH0pXG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jaGVja1Jlc3VsdHMuc2V0UmVzdWx0cyhtZXNzYWdlcywgdHlwZXMpXG4gIH1cblxuICAvKlxuICBDbGVhciBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aCBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgVGhpcyBpcyBzaG9ydGhhbmQgZnJvbSBgc2V0TWVzc2FnZXMoW10sdHlwZXMpYFxuICAqL1xuICBjbGVhck1lc3NhZ2VzICh0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNoZWNrUmVzdWx0cy5zZXRSZXN1bHRzKFtdLCB0eXBlcylcbiAgfVxuXG4gIC8qXG4gIFNldCBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgdGhhdCB5b3VyIHBhY2thZ2Ugd2lsbCB1c2UuXG4gIHR5cGVzOiBPYmplY3Qgd2l0aCBrZXlzIHJlcHJlc2VudGluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgKGkuZS4gdGFiIG5hbWUpXG4gICAgICAgICBhbmQgdmFsdWVzIGJlaW5nIE9iamVjdHMgd2l0aCBrZXlzXG4gICAgdXJpRmlsdGVyOiBCb29sLCBzaG91bGQgdXJpIGZpbHRlciBhcHBseSB0byB0YWI/XG4gICAgYXV0b1Njcm9sbDogQm9vbCwgc2hvdWxkIHRhYiBhdXRvLXNjcm9sbD9cblxuICBUaGlzIGFsbG93cyB0byBkZWZpbmUgY3VzdG9tIG91dHB1dCBwYW5lbCB0YWJzLlxuICAqL1xuICBzZXRNZXNzYWdlVHlwZXMgKHR5cGVzOiB7IFtzZXZlcml0eTogc3RyaW5nXTogSVNldmVyaXR5VGFiRGVmaW5pdGlvbn0pIHtcbiAgICByZXR1cm4gKCgpID0+IHtcbiAgICAgIGxldCByZXN1bHQgPSBbXVxuICAgICAgZm9yIChsZXQgdHlwZSBpbiB0eXBlcykge1xuICAgICAgICBsZXQgb3B0cyA9IHR5cGVzW3R5cGVdXG4gICAgICAgIHJlc3VsdC5wdXNoKHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmNyZWF0ZVRhYih0eXBlLCBvcHRzKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRcbiAgICB9KSgpXG4gIH1cblxuICAvKlxuICBFZGl0b3IgZXZlbnQgc3Vic2NyaXB0aW9uLiBGaXJlcyB3aGVuIG1vdXNlIGN1cnNvciBzdG9wcGVkIG92ZXIgYSBzeW1ib2wgaW5cbiAgZWRpdG9yLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhlZGl0b3IsIGNyYW5nZSwgdHlwZSlcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnNvciByYW5nZSB0aGF0IGdlbmVyYXRlZCBldmVudC5cbiAgICB0eXBlOiBPbmUgb2YgJ21vdXNlJywgJ3NlbGVjdGlvbicgLS0gdHlwZSBvZiBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGlzXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZS5cbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcblxuICByZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25TaG91bGRTaG93VG9vbHRpcCAoY2FsbGJhY2s6IFRUb29sdGlwSGFuZGxlcikge1xuICAgIGxldCBkaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vblNob3VsZFNob3dUb29sdGlwKCh7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZX0pID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnNob3dUb29sdGlwKHtcbiAgICAgICAgZWRpdG9yLFxuICAgICAgICBwb3MsXG4gICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgdG9vbHRpcCAoY3JhbmdlKSB7XG4gICAgICAgICAgbGV0IHJlcyA9IGNhbGxiYWNrKGVkaXRvciwgY3JhbmdlLCBldmVudFR5cGUpXG4gICAgICAgICAgaWYgKHJlcyAhPSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlcylcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHtpZ25vcmU6IHRydWV9KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gICAgKVxuICAgIClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLypcbiAgU2hvdyB0b29sdGlwIGluIGVkaXRvci5cblxuICBlZGl0b3I6IGVkaXRvciB0aGF0IHdpbGwgc2hvdyB0b29sdGlwXG4gIHBvczogdG9vbHRpcCBwb3NpdGlvblxuICBldmVudFR5cGU6IG9uZSBvZiAnY29udGV4dCcsICdrZXlib2FyZCcgYW5kICdtb3VzZSdcbiAgZGV0YWlsOiBmb3IgYXV0b21hdGljIHNlbGVjdGlvbiBiZXR3ZWVuICdjb250ZXh0JyBhbmQgJ2tleWJvYXJkJy5cbiAgICAgICAgICBJZ25vcmVkIGlmICdldmVudFR5cGUnIGlzIHNldC5cbiAgdG9vbHRpcDogZnVuY3Rpb24oY3JhbmdlKVxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnJlbnRseSBzZWxlY3RlZCByYW5nZSBpbiBlZGl0b3IgKHBvc3NpYmx5IGVtcHR5KVxuXG4gICAgUmV0dXJucyB7cmFuZ2UsIHRleHR9IG9yIFByb21pc2VcbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHBlcnNpc3RPbkN1cnNvck1vdmU6IEJvb2xlYW4sIG9wdGlvbmFsLCBkZWZhdWx0IGZhbHNlLCBwZXJzaXN0IG9uIGN1cnNvciBtb3ZlIHJlZ2FyZGxlc3Mgb2Ygc2V0dGluZ3NcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcbiAgKi9cbiAgc2hvd1Rvb2x0aXAgKHtlZGl0b3IsIHBvcywgZXZlbnRUeXBlLCBkZXRhaWwsIHRvb2x0aXB9OiBJU2hvd1Rvb2x0aXBQYXJhbXMpIHtcbiAgICBsZXQgY29udHJvbGxlciA9IHRoaXMucGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcilcbiAgICByZXR1cm4gdGhpcy53aXRoRXZlbnRSYW5nZSh7Y29udHJvbGxlciwgcG9zLCBkZXRhaWwsIGV2ZW50VHlwZX0sICh7Y3JhbmdlLCBwb3MsIGV2ZW50VHlwZX0pID0+IHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodG9vbHRpcChjcmFuZ2UpKS50aGVuKFxuICAgICAgICAoe3JhbmdlLCB0ZXh0LCBwZXJzaXN0T25DdXJzb3JNb3ZlfSkgPT4gY29udHJvbGxlciAmJiBjb250cm9sbGVyLnRvb2x0aXBzLnNob3coXG4gICAgICAgICAgcmFuZ2UsIE1lc3NhZ2VPYmplY3QuZnJvbU9iamVjdCh0ZXh0KSwge3R5cGU6IGV2ZW50VHlwZSwgc3VidHlwZTogJ2V4dGVybmFsJywgcGVyc2lzdE9uQ3Vyc29yTW92ZX1cbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgLmNhdGNoKHN0YXR1cyA9PiB7XG4gICAgICAgIGlmIChzdGF0dXMgPT0gbnVsbCkgeyBzdGF0dXMgPSB7c3RhdHVzOiAnd2FybmluZyd9IH1cbiAgICAgICAgaWYgKHN0YXR1cyBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKHN0YXR1cylcbiAgICAgICAgICBzdGF0dXMgPSB7c3RhdHVzOiAnd2FybmluZyd9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFzdGF0dXMuaWdub3JlKSB7XG4gICAgICAgICAgY29udHJvbGxlciAmJiBjb250cm9sbGVyLnRvb2x0aXBzLmhpZGUoe3R5cGU6IGV2ZW50VHlwZX0pXG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2V0U3RhdHVzKHN0YXR1cylcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgKVxuICAgIH1cbiAgICApXG4gIH1cblxuICAvKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGJlZm9yZSBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cblxuICBjYWxsYmFjazogY2FsbGJhY2soYnVmZmVyKVxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uV2lsbFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBsZXQgZGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25XaWxsU2F2ZUJ1ZmZlcihjYWxsYmFjaykpXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYWZ0ZXIgSGFza2VsbCBidWZmZXIgaXMgc2F2ZWQuXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKGJ1ZmZlcilcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0aGF0IGdlbmVyYXRlZCBldmVudFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZVxuICAqL1xuICBvbkRpZFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBsZXQgZGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25EaWRTYXZlQnVmZmVyKGNhbGxiYWNrKSlcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgb25EaWRTdG9wQ2hhbmdpbmcgKGNhbGxiYWNrOiBUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBsZXQgZGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcoY2FsbGJhY2spKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKlxuICBBZGQgYSBuZXcgY29udHJvbCB0byBvdXB0dXQgcGFuZWwgaGVhZGluZy5cblxuICBlbGVtZW50OiBIVE1MRWxlbWVudCBvZiBjb250cm9sLCBvciBTdHJpbmcgd2l0aCB0YWcgbmFtZVxuICBvcHRzOiB2YXJpb3VzIG9wdGlvbnNcbiAgICBpZDogU3RyaW5nLCBpZFxuICAgIGV2ZW50czogT2JqZWN0LCBldmVudCBjYWxsYmFja3MsIGtleSBpcyBldmVudCBuYW1lLCBlLmcuIFwiY2xpY2tcIixcbiAgICAgICAgICAgIHZhbHVlIGlzIGNhbGxiYWNrXG4gICAgY2xhc3NlczogQXJyYXkgb2YgU3RyaW5nLCBjbGFzc2VzXG4gICAgc3R5bGU6IE9iamVjdCwgY3NzIHN0eWxlLCBrZXlzIGFyZSBzdHlsZSBhdHRyaWJ1dGVzLCB2YWx1ZXMgYXJlIHZhbHVlc1xuICAgIGF0dHJzOiBPYmplY3QsIG90aGVyIGF0dHJpYnV0ZXMsIGtleXMgYXJlIGF0dHJpYnV0ZSBuYW1lcywgdmFsdWVzIGFyZSB2YWx1ZXNcbiAgICBiZWZvcmU6IFN0cmluZywgQ1NTIHNlbGVjdG9yIG9mIGVsZW1lbnQsIHRoYXQgdGhpcyBvbmUgc2hvdWxkIGJlIGluc2VydGVkXG4gICAgICAgICAgICBiZWZvcmUsIGUuZy4gJyNwcm9ncmVzc0JhcidcblxuICBSZXR1cm5zIERpc3Bvc2FibGUuXG4gICovXG4gIGFkZFBhbmVsQ29udHJvbCAoZWxlbWVudDogc3RyaW5nIHwgSFRNTEVsZW1lbnQsIG9wdHM6IElDb250cm9sT3B0cykge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmFkZFBhbmVsQ29udHJvbChlbGVtZW50LCBvcHRzKVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgbmV3T3B0czogSUNvbnRyb2xPcHRzICYge2VsZW1lbnQ6IEhUTUxFbGVtZW50fSA9IHsuLi5vcHRzLCBlbGVtZW50fVxuICAgICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmFkZFBhbmVsQ29udHJvbChEdW1teUVsZW1lbnQsIG9wdHMpXG4gICAgfVxuICB9XG5cbiAgLypcbiAgYWRkQ29uZmlnUGFyYW1cbiAgICBwYXJhbV9uYW1lOlxuICAgICAgb25DaGFuZ2VkOiBjYWxsYmFjayB2b2lkKHZhbHVlKVxuICAgICAgaXRlbXM6IEFycmF5IG9yIGNhbGxiYWNrIEFycmF5KHZvaWQpXG4gICAgICBpdGVtVGVtcGxhdGU6IGNhbGxiYWNrLCBTdHJpbmcoaXRlbSksIGh0bWwgdGVtcGxhdGVcbiAgICAgIGl0ZW1GaWx0ZXJLZXk6IFN0cmluZywgaXRlbSBmaWx0ZXIga2V5XG4gICAgICBkZXNjcmlwdGlvbjogU3RyaW5nIFtvcHRpb25hbF1cbiAgICAgIGRpc3BsYXlOYW1lOiBTdHJpbmcgW29wdGlvbmFsLCBjYXBpdGFsaXplZCBwYXJhbV9uYW1lIGRlZmF1bHRdXG4gICAgICBkaXNwbGF5VGVtcGxhdGU6IGNhbGxiYWNrLCBTdHJpbmcoaXRlbSksIHN0cmluZyB0ZW1wbGF0ZVxuICAgICAgZGVmYXVsdDogaXRlbSwgZGVmYXVsdCB2YWx1ZVxuXG4gIFJldHVybnNcbiAgICBkaXNwOiBEaXNwb3NhYmxlXG4gICAgY2hhbmdlOiBvYmplY3Qgb2YgY2hhbmdlIGZ1bmN0aW9ucywga2V5cyBiZWluZyBwYXJhbV9uYW1lXG4gICovXG4gIGFkZENvbmZpZ1BhcmFtIChzcGVjOiB7IFtwYXJhbU5hbWU6IHN0cmluZ106IElQYXJhbVNwZWM8YW55PiB9KSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuYWRkKHRoaXMucGx1Z2luTmFtZSwgc3BlYylcbiAgfVxuXG4gIC8qXG4gIGdldENvbmZpZ1BhcmFtKHBhcmFtTmFtZSkgb3IgZ2V0Q29uZmlnUGFyYW0ocGx1Z2luTmFtZSwgcGFyYW1OYW1lKVxuXG4gIHJldHVybnMgYSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gcGFyYW1ldGVyXG4gIHZhbHVlLlxuXG4gIFByb21pc2UgY2FuIGJlIHJlamVjdGVkIHdpdGggZWl0aGVyIGVycm9yLCBvciAndW5kZWZpbmVkJy4gTGF0dGVyXG4gIGluIGNhc2UgdXNlciBjYW5jZWxzIHBhcmFtIHNlbGVjdGlvbiBkaWFsb2cuXG4gICovXG4gIGdldENvbmZpZ1BhcmFtIChwbHVnaW5OYW1lOiBzdHJpbmcsIG5hbWU6IHN0cmluZykge1xuICAgIGlmIChuYW1lID09IG51bGwpIHtcbiAgICAgIG5hbWUgPSBwbHVnaW5OYW1lO1xuICAgICAgKHsgcGx1Z2luTmFtZSB9ID0gdGhpcylcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuZ2V0KHBsdWdpbk5hbWUsIG5hbWUpXG4gIH1cblxuICAvKlxuICBzZXRDb25maWdQYXJhbShwYXJhbU5hbWUsIHZhbHVlKSBvciBzZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUsIHZhbHVlKVxuXG4gIHZhbHVlIGlzIG9wdGlvbmFsLiBJZiBvbWl0dGVkLCBhIHNlbGVjdGlvbiBkaWFsb2cgd2lsbCBiZSBwcmVzZW50ZWQgdG8gdXNlci5cblxuICByZXR1cm5zIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlciB2YWx1ZS5cblxuICBQcm9taXNlIGNhbiBiZSByZWplY3RlZCB3aXRoIGVpdGhlciBlcnJvciwgb3IgJ3VuZGVmaW5lZCcuIExhdHRlclxuICBpbiBjYXNlIHVzZXIgY2FuY2VscyBwYXJhbSBzZWxlY3Rpb24gZGlhbG9nLlxuICAqL1xuICBzZXRDb25maWdQYXJhbSAocGx1Z2luTmFtZTogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICBpZiAodmFsdWUgPT0gbnVsbCkge1xuICAgICAgdmFsdWUgPSBuYW1lXG4gICAgICBuYW1lID0gcGx1Z2luTmFtZTtcbiAgICAgICh7IHBsdWdpbk5hbWUgfSA9IHRoaXMpXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLnNldChwbHVnaW5OYW1lLCBuYW1lLCB2YWx1ZSlcbiAgfVxuXG4gIC8qXG4gIFV0aWxpdHkgZnVuY3Rpb24gdG8gZXh0cmFjdCBldmVudCByYW5nZS90eXBlIGZvciBhIGdpdmVuIGV2ZW50XG5cbiAgZWRpdG9yOiBUZXh0RWRpdG9yLCBlZGl0b3IgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcbiAgZGV0YWlsOiBldmVudCBkZXRhaWwsIGlnbm9yZWQgaWYgZXZlbnRUeXBlIGlzIHNldFxuICBldmVudFR5cGU6IFN0cmluZywgZXZlbnQgdHlwZSwgb25lIG9mICdrZXlib2FyZCcsICdjb250ZXh0JywgJ21vdXNlJ1xuICBwb3M6IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgZXZlbnQgcG9zaXRpb24sIGNhbiBiZSB1bmRlZmluZWRcbiAgY29udHJvbGxlcjogbGVhdmUgdW5kZWZpbmVkLCB0aGlzIGlzIGludGVybmFsIGZpZWxkXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKHtwb3MsIGNyYW5nZSwgZXZlbnRUeXBlfSlcbiAgICBwb3M6IFBvaW50LCBldmVudCBwb3NpdGlvblxuICAgIGNyYW5nZTogUmFuZ2UsIGV2ZW50IHJhbmdlXG4gICAgZXZlbnRUeXBlOiBTdHJpbmcsIGV2ZW50IHR5cGUsIG9uZSBvZiAna2V5Ym9hcmQnLCAnY29udGV4dCcsICdtb3VzZSdcbiAgKi9cbiAgd2l0aEV2ZW50UmFuZ2UgKHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3MsIGNvbnRyb2xsZXJ9OiBJRXZlbnRSYW5nZVBhcmFtcywgY2FsbGJhY2s6IFRFdmVudFJhbmdlQ2FsbGJhY2s8YW55Pikge1xuICAgIGxldCBwcG9zOiBQb2ludCB8IHVuZGVmaW5lZFxuICAgIGlmIChwb3MgIT0gbnVsbCkgeyBwcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpIH1cbiAgICBpZiAoZXZlbnRUeXBlID09IG51bGwpIHsgZXZlbnRUeXBlID0gZ2V0RXZlbnRUeXBlKGRldGFpbCkgfVxuICAgIGlmIChjb250cm9sbGVyID09IG51bGwgJiYgZWRpdG9yKSB7IGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpIH1cbiAgICBpZiAoY29udHJvbGxlciA9PSBudWxsKSB7IHJldHVybiB9XG5cbiAgICByZXR1cm4gY2FsbGJhY2soY29udHJvbGxlci5nZXRFdmVudFJhbmdlKHBwb3MsIGV2ZW50VHlwZSkpXG4gIH1cbn1cblxuaW50ZXJmYWNlIElFdmVudFJhbmdlUGFyYW1zIHtcbiAgZWRpdG9yPzogVGV4dEVkaXRvclxuICBkZXRhaWw/OiBhbnlcbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIHBvczogVFBvc2l0aW9uXG4gIGNvbnRyb2xsZXI/OiBFZGl0b3JDb250cm9sXG59XG5leHBvcnQgdHlwZSBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+ID0gKHBhcnM6IHtwb3M6IFBvaW50LCBjcmFuZ2U6IFJhbmdlLCBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZX0pID0+IFRcblxuY2xhc3MgRHVtbXlFbGVtZW50IHtcbiAgcHJpdmF0ZSBlbGVtZW50OiBIVE1MRWxlbWVudFxuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBvcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9KSB7XG4gICAgdGhpcy5lbGVtZW50ID0gb3B0cy5lbGVtZW50LmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudFxuICAgIHRoaXMuaW5pdCgpXG4gIH1cblxuICBwdWJsaWMgdXBkYXRlIChvcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9KSB7XG4gICAgdGhpcy5vcHRzID0gb3B0c1xuICAgIHRoaXMuZWxlbWVudC5yZW1vdmUoKVxuICAgIHRoaXMuZWxlbWVudCA9IG9wdHMuZWxlbWVudC5jbG9uZU5vZGUodHJ1ZSkgYXMgSFRNTEVsZW1lbnRcbiAgICB0aGlzLmluaXQoKVxuICB9XG5cbiAgcHJpdmF0ZSBpbml0KCkge1xuICAgIGNvbnN0IHtpZCwgZXZlbnRzLCBjbGFzc2VzLCBzdHlsZSwgYXR0cnN9ID0gdGhpcy5vcHRzXG4gICAgaWYgKGlkKSB7IHRoaXMuZWxlbWVudC5pZCA9IGlkIH1cbiAgICBpZiAoZXZlbnRzKSB7XG4gICAgICBmb3IgKGNvbnN0IGV2IG9mIE9iamVjdC5rZXlzKGV2ZW50cykpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXYsIGV2ZW50c1tldl0pXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjbGFzc2VzKSB7XG4gICAgICBmb3IgKGNvbnN0IGNscyBvZiBjbGFzc2VzKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudC5jbGFzc0xpc3QuYWRkKGNscylcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHN0eWxlKSB7XG4gICAgICBmb3IgKGNvbnN0IHN0IG9mIE9iamVjdC5rZXlzKHN0eWxlKSkge1xuICAgICAgICB0aGlzLmVsZW1lbnQuc3R5bGVbc3RdID0gc3R5bGVbc3RdXG4gICAgICB9XG4gICAgfVxuICAgIGlmIChhdHRycykge1xuICAgICAgZm9yIChjb25zdCBhdCBvZiBPYmplY3Qua2V5cyhhdHRycykpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZShhdCwgYXR0cnNbYXRdKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19