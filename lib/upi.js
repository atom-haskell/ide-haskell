"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("./utils");
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
    }
    registerPlugin(disposables, name) {
        return new UPIInstance(this.pluginManager, disposables, name);
    }
}
exports.UPI = UPI;
class UPIInstance {
    constructor(pluginManager, disposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        disposables.add(this.disposables = new atom_1.CompositeDisposable());
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputView.backendStatus(this.pluginName, status);
    }
    addMessages(messages, types) {
        return this.pluginManager.checkResults.appendResults(messages, types);
    }
    setMessages(messages, types) {
        messages = messages.map(function (m) {
            if (m.position != null) {
                m.position = atom_1.Point.fromObject(m.position);
            }
            return m;
        });
        return this.pluginManager.checkResults.setResults(messages, types);
    }
    clearMessages(types) {
        return this.pluginManager.checkResults.setResults([], types);
    }
    setMessageTypes(types) {
        return (() => {
            let result = [];
            for (let type in types) {
                let opts = types[type];
                result.push(this.pluginManager.outputView.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onShouldShowTooltip(({ editor, pos, eventType }) => {
            return this.showTooltip({
                editor,
                pos,
                eventType,
                tooltip(crange) {
                    let res = callback(editor, crange, eventType);
                    if (res != null) {
                        return Promise.resolve(res);
                    }
                    else {
                        return Promise.reject({ ignore: true });
                    }
                }
            });
        }));
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        let controller = this.pluginManager.controller(editor);
        return this.withEventRange({ controller, pos, detail, eventType }, ({ crange, pos, eventType }) => {
            return Promise.resolve(tooltip(crange)).then(({ range, text, persistOnCursorMove }) => controller && controller.showTooltip(pos, range, text, { eventType, subtype: 'external', persistOnCursorMove }))
                .catch(status => {
                if (status == null) {
                    status = { status: 'warning' };
                }
                if (status instanceof Error) {
                    console.warn(status);
                    status = { status: 'warning' };
                }
                if (!status.ignore) {
                    controller && controller.hideTooltip({ eventType });
                    return this.setStatus(status);
                }
            });
        });
    }
    onWillSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onWillSaveBuffer(callback));
        return disp;
    }
    onDidSaveBuffer(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidSaveBuffer(callback));
        return disp;
    }
    onDidStopChanging(callback) {
        let disp;
        this.disposables.add(disp = this.pluginManager.onDidStopChanging(callback));
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element == 'string') {
            return this.pluginManager.outputView.addPanelControl(element, opts);
        }
        else {
            let newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputView.addPanelControl(DummyElement, opts);
        }
    }
    addConfigParam(spec) {
        return this.pluginManager.configParamManager.add(this.pluginName, spec);
    }
    getConfigParam(pluginName, name) {
        if (name == null) {
            name = pluginName;
            ({ pluginName } = this);
        }
        return this.pluginManager.configParamManager.get(pluginName, name);
    }
    setConfigParam(pluginName, name, value) {
        if (value == null) {
            value = name;
            name = pluginName;
            ({ pluginName } = this);
        }
        return this.pluginManager.configParamManager.set(pluginName, name, value);
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        let ppos;
        if (pos != null) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (eventType == null) {
            eventType = utils_1.getEventType(detail);
        }
        if (controller == null && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (controller == null) {
            return;
        }
        return callback(controller.getEventRange(ppos, eventType));
    }
}
class DummyElement {
    constructor(opts) {
        this.opts = opts;
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    update(opts) {
        this.opts = opts;
        this.element.remove();
        this.element = opts.element.cloneNode(true);
        this.init();
    }
    init() {
        const { id, events, classes, style, attrs } = this.opts;
        if (id) {
            this.element.id = id;
        }
        if (events) {
            for (const ev of Object.keys(events)) {
                this.element.addEventListener(ev, events[ev]);
            }
        }
        if (classes) {
            for (const cls of classes) {
                this.element.classList.add(cls);
            }
        }
        if (style) {
            for (const st of Object.keys(style)) {
                this.element.style[st] = style[st];
            }
        }
        if (attrs) {
            for (const at of Object.keys(attrs)) {
                this.element.setAttribute(at, attrs[at]);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3VwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUFnRjtBQUNoRixtQ0FBdUQ7QUE0QnZEO0lBQ0UsWUFBcUIsYUFBNEI7UUFBNUIsa0JBQWEsR0FBYixhQUFhLENBQWU7SUFBSSxDQUFDO0lBUXRELGNBQWMsQ0FBRSxXQUFnQyxFQUFFLElBQVk7UUFDNUQsTUFBTSxDQUFDLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQy9ELENBQUM7Q0FDRjtBQVpELGtCQVlDO0FBRUQ7SUFFRSxZQUNVLGFBQTRCLEVBQ3BDLFdBQWdDLEVBQ3hCLFVBQWtCO1FBRmxCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBRTVCLGVBQVUsR0FBVixVQUFVLENBQVE7UUFFMUIsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQyxDQUFBO0lBQy9ELENBQUM7SUFTRCxPQUFPLENBQUUsSUFBWSxFQUFFLElBQVc7UUFDaEMsSUFBSSxRQUFRLENBQUE7UUFDWixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDN0MsS0FBSyxFQUFFLHVCQUFlO2dCQUN0QixPQUFPLEVBQUUsQ0FBRSxFQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBQyxDQUFFO2FBQzFDO1NBQ0EsQ0FBQyxDQUFDLENBQUE7UUFDSCxNQUFNLENBQUMsUUFBUSxDQUFBO0lBQ2pCLENBQUM7SUFTRCxTQUFTLENBQUUsTUFBZTtRQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUE7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QUFDLE1BQU0sRUFBRSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQTtZQUMvQyxDQUFDO1FBQ0gsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDWixHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDakMsQ0FBQztRQUNILENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ1YsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUNwQyxDQUFDO1FBQ0gsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDVixHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO1lBQzFDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUG9pbnQsIFRleHRFZGl0b3IsIFRleHRCdWZmZXIsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCwgZ2V0RXZlbnRUeXBlIH0gZnJvbSAnLi91dGlscydcbmltcG9ydCB7IFBsdWdpbk1hbmFnZXIgfSBmcm9tICcuL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtJU3RhdHVzLCBJU2V2ZXJpdHlUYWJEZWZpbml0aW9uLCBJQ29udHJvbE9wdHN9IGZyb20gJy4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHtJUmVzdWx0SXRlbSwgVFNldmVyaXR5fSBmcm9tICcuL3Jlc3VsdHMtZGInXG5pbXBvcnQge1RNZXNzYWdlfSBmcm9tICcuL3V0aWxzJ1xuaW1wb3J0IHtURXZlbnRSYW5nZVR5cGV9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge1RQb3NpdGlvbn0gZnJvbSAnLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtJUGFyYW1TcGVjfSBmcm9tICcuL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQge0VkaXRvckNvbnRyb2x9IGZyb20gJy4vZWRpdG9yLWNvbnRyb2wnXG5cbmludGVyZmFjZSBJVG9vbHRpcERhdGEge1xuICByYW5nZTogUmFuZ2VcbiAgdGV4dDogVE1lc3NhZ2VcbiAgcGVyc2lzdE9uQ3Vyc29yTW92ZT86IGJvb2xlYW5cbn1cbmV4cG9ydCB0eXBlIFRUb29sdGlwSGFuZGxlciA9XG4gIChlZGl0b3I6IFRleHRFZGl0b3IsIGNyYW5nZTogUmFuZ2UsIHR5cGU6IFRFdmVudFJhbmdlVHlwZSkgPT4gSVRvb2x0aXBEYXRhIHwgUHJvbWlzZTxJVG9vbHRpcERhdGE+XG5cbmludGVyZmFjZSBJU2hvd1Rvb2x0aXBQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgcG9zOiBUUG9zaXRpb25cbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIGRldGFpbD86IGFueVxuICB0b29sdGlwOiBUVG9vbHRpcEZ1bmN0aW9uXG59XG50eXBlIFRUb29sdGlwRnVuY3Rpb24gPSAoY3JhbmdlOiBSYW5nZSkgPT4gSVRvb2x0aXBEYXRhIHwgUHJvbWlzZTxJVG9vbHRpcERhdGE+XG5leHBvcnQgdHlwZSBUZXh0QnVmZmVyQ2FsbGJhY2sgPSAoYnVmZmVyOiBUZXh0QnVmZmVyKSA9PiB2b2lkXG5cbmV4cG9ydCBjbGFzcyBVUEkge1xuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyKSB7IH1cblxuICAvKlxuICBDYWxsIHRoaXMgZnVuY3Rpb24gaW4gY29uc3VtZXIgdG8gZ2V0IGFjdHVhbCBpbnRlcmZhY2VcblxuICBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgb25lIHlvdSB3aWxsIHJldHVybiBpbiBjb25zdW1lclxuICBuYW1lOiBQbHVnaW4gcGFja2FnZSBuYW1lXG4gICovXG4gIHJlZ2lzdGVyUGx1Z2luIChkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgbmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBVUElJbnN0YW5jZSh0aGlzLnBsdWdpbk1hbmFnZXIsIGRpc3Bvc2FibGVzLCBuYW1lKVxuICB9XG59XG5cbmNsYXNzIFVQSUluc3RhbmNlIHtcbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLFxuICAgIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLFxuICAgIHByaXZhdGUgcGx1Z2luTmFtZTogc3RyaW5nXG4gICkge1xuICAgIGRpc3Bvc2FibGVzLmFkZCh0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKSlcbiAgfVxuXG4gIC8qXG4gIEFkZHMgbmV3IHN1bWJlbnUgdG8gJ0hhc2tlbGwgSURFJyBtZW51IGl0ZW1cbiAgbmFtZSAtLSBzdWJtZW51IGxhYmVsLCBzaG91bGQgYmUgZGVzY3JpcHRpdmUgb2YgYSBwYWNrYWdlXG4gIG1lbnUgLS0gQXRvbSBtZW51IG9iamVjdFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZS5cbiAgKi9cbiAgc2V0TWVudSAobmFtZTogc3RyaW5nLCBtZW51OiBhbnlbXSkge1xuICAgIGxldCBtZW51RGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKG1lbnVEaXNwID0gYXRvbS5tZW51LmFkZChbe1xuICAgICAgbGFiZWw6IE1BSU5fTUVOVV9MQUJFTCxcbiAgICAgIHN1Ym1lbnU6IFsge2xhYmVsOiBuYW1lLCBzdWJtZW51OiBtZW51fSBdXG4gICAgfVxuICAgIF0pKVxuICAgIHJldHVybiBtZW51RGlzcFxuICB9XG5cbiAgLypcbiAgU2V0cyBiYWNrZW5kIHN0YXR1c1xuICBzdGF0dXMgLS0gb2JqZWN0XG4gICAgc3RhdHVzOiBvbmUgb2YgJ3Byb2dyZXNzJywgJ3JlYWR5JywgJ2Vycm9yJywgJ3dhcm5pbmcnXG4gICAgcHJvZ3Jlc3M6IGZsb2F0IGJldHdlZW4gMCBhbmQgMSwgb25seSByZWxldmFudCB3aGVuIHN0YXR1cyBpcyAncHJvZ3Jlc3MnXG4gICAgICAgICAgICAgIGlmIDAgb3IgdW5kZWZpbmVkLCBwcm9ncmVzcyBiYXIgaXMgbm90IHNob3duXG4gICovXG4gIHNldFN0YXR1cyAoc3RhdHVzOiBJU3RhdHVzKSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmJhY2tlbmRTdGF0dXModGhpcy5wbHVnaW5OYW1lLCBzdGF0dXMpXG4gIH1cblxuICAvKlxuICBBZGQgbWVzc2FnZXMgdG8gaWRlLWhhc2tlbGwgb3V0cHV0XG4gIG1lc3NhZ2VzOiBBcnJheSBvZiBPYmplY3RcbiAgICB1cmk6IFN0cmluZywgRmlsZSBVUkkgbWVzc2FnZSByZWxhdGVzIHRvXG4gICAgcG9zaXRpb246IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgcG9zaXRpb24gdG8gd2hpY2ggbWVzc2FnZSByZWxhdGVzXG4gICAgbWVzc2FnZTogU3RyaW5nIG9yIHs8dGV4dCB8IGh0bWw+LCBoaWdobGlnaHRlcj99LCBtZXNzYWdlXG4gICAgc2V2ZXJpdHk6IFN0cmluZywgb25lIG9mICdlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnLCAnYnVpbGQnLFxuICAgICAgICAgICAgICBvciB1c2VyLWRlZmluZWQsIHNlZSBgc2V0TWVzc2FnZVR5cGVzYFxuICB0eXBlczogQXJyYXkgb2YgU3RyaW5nLCBjb250YWluaW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YC4gSWYgdW5kZWZpbmVkLFxuICAgICAgICAgd2lsbCBiZSB0YWtlbiBmcm9tIGBtZXNzYWdlc2BcbiAgKi9cbiAgYWRkTWVzc2FnZXMgKG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdLCB0eXBlcz86IFRTZXZlcml0eVtdKSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jaGVja1Jlc3VsdHMuYXBwZW5kUmVzdWx0cyhtZXNzYWdlcywgdHlwZXMpXG4gIH1cblxuICAvKlxuICBTZXQgbWVzc2FnZXMgaW4gaWRlLWhhc2tlbGwgb3V0cHV0LiBDbGVhcnMgYWxsIGV4aXN0aW5nIG1lc3NhZ2VzIHdpdGhcbiAgYHNldmVyaXR5YCBpbiBgdHlwZXNgXG4gIG1lc3NhZ2VzOiBBcnJheSBvZiBPYmplY3RcbiAgICB1cmk6IFN0cmluZywgRmlsZSBVUkkgbWVzc2FnZSByZWxhdGVzIHRvXG4gICAgcG9zaXRpb246IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgcG9zaXRpb24gdG8gd2hpY2ggbWVzc2FnZSByZWxhdGVzXG4gICAgbWVzc2FnZTogU3RyaW5nLCBtZXNzYWdlXG4gICAgc2V2ZXJpdHk6IFN0cmluZywgb25lIG9mICdlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnLCAnYnVpbGQnLFxuICAgICAgICAgICAgICBvciB1c2VyLWRlZmluZWQsIHNlZSBgc2V0TWVzc2FnZVR5cGVzYFxuICB0eXBlczogQXJyYXkgb2YgU3RyaW5nLCBjb250YWluaW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YC4gSWYgdW5kZWZpbmVkLFxuICAgICAgICAgd2lsbCBiZSB0YWtlbiBmcm9tIGBtZXNzYWdlc2BcbiAgKi9cbiAgc2V0TWVzc2FnZXMgKG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdLCB0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICBtZXNzYWdlcyA9IG1lc3NhZ2VzLm1hcChmdW5jdGlvbiAobSkge1xuICAgICAgaWYgKG0ucG9zaXRpb24gIT0gbnVsbCkgeyBtLnBvc2l0aW9uID0gUG9pbnQuZnJvbU9iamVjdChtLnBvc2l0aW9uKSB9XG4gICAgICByZXR1cm4gbVxuICAgIH0pXG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jaGVja1Jlc3VsdHMuc2V0UmVzdWx0cyhtZXNzYWdlcywgdHlwZXMpXG4gIH1cblxuICAvKlxuICBDbGVhciBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aCBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgVGhpcyBpcyBzaG9ydGhhbmQgZnJvbSBgc2V0TWVzc2FnZXMoW10sdHlwZXMpYFxuICAqL1xuICBjbGVhck1lc3NhZ2VzICh0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNoZWNrUmVzdWx0cy5zZXRSZXN1bHRzKFtdLCB0eXBlcylcbiAgfVxuXG4gIC8qXG4gIFNldCBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgdGhhdCB5b3VyIHBhY2thZ2Ugd2lsbCB1c2UuXG4gIHR5cGVzOiBPYmplY3Qgd2l0aCBrZXlzIHJlcHJlc2VudGluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgKGkuZS4gdGFiIG5hbWUpXG4gICAgICAgICBhbmQgdmFsdWVzIGJlaW5nIE9iamVjdHMgd2l0aCBrZXlzXG4gICAgdXJpRmlsdGVyOiBCb29sLCBzaG91bGQgdXJpIGZpbHRlciBhcHBseSB0byB0YWI/XG4gICAgYXV0b1Njcm9sbDogQm9vbCwgc2hvdWxkIHRhYiBhdXRvLXNjcm9sbD9cblxuICBUaGlzIGFsbG93cyB0byBkZWZpbmUgY3VzdG9tIG91dHB1dCBwYW5lbCB0YWJzLlxuICAqL1xuICBzZXRNZXNzYWdlVHlwZXMgKHR5cGVzOiB7IFtzZXZlcml0eTogc3RyaW5nXTogSVNldmVyaXR5VGFiRGVmaW5pdGlvbn0pIHtcbiAgICByZXR1cm4gKCgpID0+IHtcbiAgICAgIGxldCByZXN1bHQgPSBbXVxuICAgICAgZm9yIChsZXQgdHlwZSBpbiB0eXBlcykge1xuICAgICAgICBsZXQgb3B0cyA9IHR5cGVzW3R5cGVdXG4gICAgICAgIHJlc3VsdC5wdXNoKHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmNyZWF0ZVRhYih0eXBlLCBvcHRzKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiByZXN1bHRcbiAgICB9KSgpXG4gIH1cblxuICAvKlxuICBFZGl0b3IgZXZlbnQgc3Vic2NyaXB0aW9uLiBGaXJlcyB3aGVuIG1vdXNlIGN1cnNvciBzdG9wcGVkIG92ZXIgYSBzeW1ib2wgaW5cbiAgZWRpdG9yLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhlZGl0b3IsIGNyYW5nZSwgdHlwZSlcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnNvciByYW5nZSB0aGF0IGdlbmVyYXRlZCBldmVudC5cbiAgICB0eXBlOiBPbmUgb2YgJ21vdXNlJywgJ3NlbGVjdGlvbicgLS0gdHlwZSBvZiBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGlzXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZS5cbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcblxuICByZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25TaG91bGRTaG93VG9vbHRpcCAoY2FsbGJhY2s6IFRUb29sdGlwSGFuZGxlcikge1xuICAgIGxldCBkaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vblNob3VsZFNob3dUb29sdGlwKCh7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZX0pID0+IHtcbiAgICAgIHJldHVybiB0aGlzLnNob3dUb29sdGlwKHtcbiAgICAgICAgZWRpdG9yLFxuICAgICAgICBwb3MsXG4gICAgICAgIGV2ZW50VHlwZSxcbiAgICAgICAgdG9vbHRpcCAoY3JhbmdlKSB7XG4gICAgICAgICAgbGV0IHJlcyA9IGNhbGxiYWNrKGVkaXRvciwgY3JhbmdlLCBldmVudFR5cGUpXG4gICAgICAgICAgaWYgKHJlcyAhPSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlcylcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHtpZ25vcmU6IHRydWV9KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gICAgKVxuICAgIClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLypcbiAgU2hvdyB0b29sdGlwIGluIGVkaXRvci5cblxuICBlZGl0b3I6IGVkaXRvciB0aGF0IHdpbGwgc2hvdyB0b29sdGlwXG4gIHBvczogdG9vbHRpcCBwb3NpdGlvblxuICBldmVudFR5cGU6IG9uZSBvZiAnY29udGV4dCcsICdrZXlib2FyZCcgYW5kICdtb3VzZSdcbiAgZGV0YWlsOiBmb3IgYXV0b21hdGljIHNlbGVjdGlvbiBiZXR3ZWVuICdjb250ZXh0JyBhbmQgJ2tleWJvYXJkJy5cbiAgICAgICAgICBJZ25vcmVkIGlmICdldmVudFR5cGUnIGlzIHNldC5cbiAgdG9vbHRpcDogZnVuY3Rpb24oY3JhbmdlKVxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnJlbnRseSBzZWxlY3RlZCByYW5nZSBpbiBlZGl0b3IgKHBvc3NpYmx5IGVtcHR5KVxuXG4gICAgUmV0dXJucyB7cmFuZ2UsIHRleHR9IG9yIFByb21pc2VcbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHBlcnNpc3RPbkN1cnNvck1vdmU6IEJvb2xlYW4sIG9wdGlvbmFsLCBkZWZhdWx0IGZhbHNlLCBwZXJzaXN0IG9uIGN1cnNvciBtb3ZlIHJlZ2FyZGxlc3Mgb2Ygc2V0dGluZ3NcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcbiAgKi9cbiAgc2hvd1Rvb2x0aXAgKHtlZGl0b3IsIHBvcywgZXZlbnRUeXBlLCBkZXRhaWwsIHRvb2x0aXB9OiBJU2hvd1Rvb2x0aXBQYXJhbXMpIHtcbiAgICBsZXQgY29udHJvbGxlciA9IHRoaXMucGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcilcbiAgICByZXR1cm4gdGhpcy53aXRoRXZlbnRSYW5nZSh7Y29udHJvbGxlciwgcG9zLCBkZXRhaWwsIGV2ZW50VHlwZX0sICh7Y3JhbmdlLCBwb3MsIGV2ZW50VHlwZX0pID0+IHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodG9vbHRpcChjcmFuZ2UpKS50aGVuKFxuICAgICAgICAoe3JhbmdlLCB0ZXh0LCBwZXJzaXN0T25DdXJzb3JNb3ZlfSkgPT4gY29udHJvbGxlciAmJiBjb250cm9sbGVyLnNob3dUb29sdGlwKFxuICAgICAgICAgIHBvcywgcmFuZ2UsIHRleHQsIHtldmVudFR5cGUsIHN1YnR5cGU6ICdleHRlcm5hbCcsIHBlcnNpc3RPbkN1cnNvck1vdmV9XG4gICAgICAgIClcbiAgICAgIClcbiAgICAgIC5jYXRjaChzdGF0dXMgPT4ge1xuICAgICAgICBpZiAoc3RhdHVzID09IG51bGwpIHsgc3RhdHVzID0ge3N0YXR1czogJ3dhcm5pbmcnfSB9XG4gICAgICAgIGlmIChzdGF0dXMgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUud2FybihzdGF0dXMpXG4gICAgICAgICAgc3RhdHVzID0ge3N0YXR1czogJ3dhcm5pbmcnfVxuICAgICAgICB9XG4gICAgICAgIGlmICghc3RhdHVzLmlnbm9yZSkge1xuICAgICAgICAgIGNvbnRyb2xsZXIgJiYgY29udHJvbGxlci5oaWRlVG9vbHRpcCh7ZXZlbnRUeXBlfSlcbiAgICAgICAgICByZXR1cm4gdGhpcy5zZXRTdGF0dXMoc3RhdHVzKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICApXG4gICAgfVxuICAgIClcbiAgfVxuXG4gIC8qXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYmVmb3JlIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhidWZmZXIpXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcblxuICBSZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25XaWxsU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGxldCBkaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbldpbGxTYXZlQnVmZmVyKGNhbGxiYWNrKSlcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLypcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBhZnRlciBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cblxuICBjYWxsYmFjazogY2FsbGJhY2soYnVmZmVyKVxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGxldCBkaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbkRpZFNhdmVCdWZmZXIoY2FsbGJhY2spKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGxldCBkaXNwXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci5vbkRpZFN0b3BDaGFuZ2luZyhjYWxsYmFjaykpXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qXG4gIEFkZCBhIG5ldyBjb250cm9sIHRvIG91cHR1dCBwYW5lbCBoZWFkaW5nLlxuXG4gIGVsZW1lbnQ6IEhUTUxFbGVtZW50IG9mIGNvbnRyb2wsIG9yIFN0cmluZyB3aXRoIHRhZyBuYW1lXG4gIG9wdHM6IHZhcmlvdXMgb3B0aW9uc1xuICAgIGlkOiBTdHJpbmcsIGlkXG4gICAgZXZlbnRzOiBPYmplY3QsIGV2ZW50IGNhbGxiYWNrcywga2V5IGlzIGV2ZW50IG5hbWUsIGUuZy4gXCJjbGlja1wiLFxuICAgICAgICAgICAgdmFsdWUgaXMgY2FsbGJhY2tcbiAgICBjbGFzc2VzOiBBcnJheSBvZiBTdHJpbmcsIGNsYXNzZXNcbiAgICBzdHlsZTogT2JqZWN0LCBjc3Mgc3R5bGUsIGtleXMgYXJlIHN0eWxlIGF0dHJpYnV0ZXMsIHZhbHVlcyBhcmUgdmFsdWVzXG4gICAgYXR0cnM6IE9iamVjdCwgb3RoZXIgYXR0cmlidXRlcywga2V5cyBhcmUgYXR0cmlidXRlIG5hbWVzLCB2YWx1ZXMgYXJlIHZhbHVlc1xuICAgIGJlZm9yZTogU3RyaW5nLCBDU1Mgc2VsZWN0b3Igb2YgZWxlbWVudCwgdGhhdCB0aGlzIG9uZSBzaG91bGQgYmUgaW5zZXJ0ZWRcbiAgICAgICAgICAgIGJlZm9yZSwgZS5nLiAnI3Byb2dyZXNzQmFyJ1xuXG4gIFJldHVybnMgRGlzcG9zYWJsZS5cbiAgKi9cbiAgYWRkUGFuZWxDb250cm9sIChlbGVtZW50OiBzdHJpbmcgfCBIVE1MRWxlbWVudCwgb3B0czogSUNvbnRyb2xPcHRzKSB7XG4gICAgaWYgKHR5cGVvZiBlbGVtZW50ID09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFZpZXcuYWRkUGFuZWxDb250cm9sKGVsZW1lbnQsIG9wdHMpXG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBuZXdPcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9ID0gey4uLm9wdHMsIGVsZW1lbnR9XG4gICAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFZpZXcuYWRkUGFuZWxDb250cm9sKER1bW15RWxlbWVudCwgb3B0cylcbiAgICB9XG4gIH1cblxuICAvKlxuICBhZGRDb25maWdQYXJhbVxuICAgIHBhcmFtX25hbWU6XG4gICAgICBvbkNoYW5nZWQ6IGNhbGxiYWNrIHZvaWQodmFsdWUpXG4gICAgICBpdGVtczogQXJyYXkgb3IgY2FsbGJhY2sgQXJyYXkodm9pZClcbiAgICAgIGl0ZW1UZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgaHRtbCB0ZW1wbGF0ZVxuICAgICAgaXRlbUZpbHRlcktleTogU3RyaW5nLCBpdGVtIGZpbHRlciBrZXlcbiAgICAgIGRlc2NyaXB0aW9uOiBTdHJpbmcgW29wdGlvbmFsXVxuICAgICAgZGlzcGxheU5hbWU6IFN0cmluZyBbb3B0aW9uYWwsIGNhcGl0YWxpemVkIHBhcmFtX25hbWUgZGVmYXVsdF1cbiAgICAgIGRpc3BsYXlUZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgc3RyaW5nIHRlbXBsYXRlXG4gICAgICBkZWZhdWx0OiBpdGVtLCBkZWZhdWx0IHZhbHVlXG5cbiAgUmV0dXJuc1xuICAgIGRpc3A6IERpc3Bvc2FibGVcbiAgICBjaGFuZ2U6IG9iamVjdCBvZiBjaGFuZ2UgZnVuY3Rpb25zLCBrZXlzIGJlaW5nIHBhcmFtX25hbWVcbiAgKi9cbiAgYWRkQ29uZmlnUGFyYW0gKHNwZWM6IHsgW3BhcmFtTmFtZTogc3RyaW5nXTogSVBhcmFtU3BlYzxhbnk+IH0pIHtcbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5hZGQodGhpcy5wbHVnaW5OYW1lLCBzcGVjKVxuICB9XG5cbiAgLypcbiAgZ2V0Q29uZmlnUGFyYW0ocGFyYW1OYW1lKSBvciBnZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUpXG5cbiAgcmV0dXJucyBhIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXJcbiAgdmFsdWUuXG5cbiAgUHJvbWlzZSBjYW4gYmUgcmVqZWN0ZWQgd2l0aCBlaXRoZXIgZXJyb3IsIG9yICd1bmRlZmluZWQnLiBMYXR0ZXJcbiAgaW4gY2FzZSB1c2VyIGNhbmNlbHMgcGFyYW0gc2VsZWN0aW9uIGRpYWxvZy5cbiAgKi9cbiAgZ2V0Q29uZmlnUGFyYW0gKHBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKG5hbWUgPT0gbnVsbCkge1xuICAgICAgbmFtZSA9IHBsdWdpbk5hbWU7XG4gICAgICAoeyBwbHVnaW5OYW1lIH0gPSB0aGlzKVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5nZXQocGx1Z2luTmFtZSwgbmFtZSlcbiAgfVxuXG4gIC8qXG4gIHNldENvbmZpZ1BhcmFtKHBhcmFtTmFtZSwgdmFsdWUpIG9yIHNldENvbmZpZ1BhcmFtKHBsdWdpbk5hbWUsIHBhcmFtTmFtZSwgdmFsdWUpXG5cbiAgdmFsdWUgaXMgb3B0aW9uYWwuIElmIG9taXR0ZWQsIGEgc2VsZWN0aW9uIGRpYWxvZyB3aWxsIGJlIHByZXNlbnRlZCB0byB1c2VyLlxuXG4gIHJldHVybnMgYSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gcGFyYW1ldGVyIHZhbHVlLlxuXG4gIFByb21pc2UgY2FuIGJlIHJlamVjdGVkIHdpdGggZWl0aGVyIGVycm9yLCBvciAndW5kZWZpbmVkJy4gTGF0dGVyXG4gIGluIGNhc2UgdXNlciBjYW5jZWxzIHBhcmFtIHNlbGVjdGlvbiBkaWFsb2cuXG4gICovXG4gIHNldENvbmZpZ1BhcmFtIChwbHVnaW5OYW1lOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7XG4gICAgICB2YWx1ZSA9IG5hbWVcbiAgICAgIG5hbWUgPSBwbHVnaW5OYW1lO1xuICAgICAgKHsgcGx1Z2luTmFtZSB9ID0gdGhpcylcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuc2V0KHBsdWdpbk5hbWUsIG5hbWUsIHZhbHVlKVxuICB9XG5cbiAgLypcbiAgVXRpbGl0eSBmdW5jdGlvbiB0byBleHRyYWN0IGV2ZW50IHJhbmdlL3R5cGUgZm9yIGEgZ2l2ZW4gZXZlbnRcblxuICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICBkZXRhaWw6IGV2ZW50IGRldGFpbCwgaWdub3JlZCBpZiBldmVudFR5cGUgaXMgc2V0XG4gIGV2ZW50VHlwZTogU3RyaW5nLCBldmVudCB0eXBlLCBvbmUgb2YgJ2tleWJvYXJkJywgJ2NvbnRleHQnLCAnbW91c2UnXG4gIHBvczogUG9pbnQsIG9yIFBvaW50LWxpa2UgT2JqZWN0LCBldmVudCBwb3NpdGlvbiwgY2FuIGJlIHVuZGVmaW5lZFxuICBjb250cm9sbGVyOiBsZWF2ZSB1bmRlZmluZWQsIHRoaXMgaXMgaW50ZXJuYWwgZmllbGRcblxuICBjYWxsYmFjazogY2FsbGJhY2soe3BvcywgY3JhbmdlLCBldmVudFR5cGV9KVxuICAgIHBvczogUG9pbnQsIGV2ZW50IHBvc2l0aW9uXG4gICAgY3JhbmdlOiBSYW5nZSwgZXZlbnQgcmFuZ2VcbiAgICBldmVudFR5cGU6IFN0cmluZywgZXZlbnQgdHlwZSwgb25lIG9mICdrZXlib2FyZCcsICdjb250ZXh0JywgJ21vdXNlJ1xuICAqL1xuICB3aXRoRXZlbnRSYW5nZSAoe2VkaXRvciwgZGV0YWlsLCBldmVudFR5cGUsIHBvcywgY29udHJvbGxlcn06IElFdmVudFJhbmdlUGFyYW1zLCBjYWxsYmFjazogVEV2ZW50UmFuZ2VDYWxsYmFjazxhbnk+KSB7XG4gICAgbGV0IHBwb3M6IFBvaW50IHwgdW5kZWZpbmVkXG4gICAgaWYgKHBvcyAhPSBudWxsKSB7IHBwb3MgPSBQb2ludC5mcm9tT2JqZWN0KHBvcykgfVxuICAgIGlmIChldmVudFR5cGUgPT0gbnVsbCkgeyBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKSB9XG4gICAgaWYgKGNvbnRyb2xsZXIgPT0gbnVsbCAmJiBlZGl0b3IpIHsgY29udHJvbGxlciA9IHRoaXMucGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcikgfVxuICAgIGlmIChjb250cm9sbGVyID09IG51bGwpIHsgcmV0dXJuIH1cblxuICAgIHJldHVybiBjYWxsYmFjayhjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UocHBvcywgZXZlbnRUeXBlKSlcbiAgfVxufVxuXG5pbnRlcmZhY2UgSUV2ZW50UmFuZ2VQYXJhbXMge1xuICBlZGl0b3I/OiBUZXh0RWRpdG9yXG4gIGRldGFpbD86IGFueVxuICBldmVudFR5cGU/OiBURXZlbnRSYW5nZVR5cGVcbiAgcG9zOiBUUG9zaXRpb25cbiAgY29udHJvbGxlcj86IEVkaXRvckNvbnRyb2xcbn1cbmV4cG9ydCB0eXBlIFRFdmVudFJhbmdlQ2FsbGJhY2s8VD4gPSAocGFyczoge3BvczogUG9pbnQsIGNyYW5nZTogUmFuZ2UsIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlfSkgPT4gVFxuXG5jbGFzcyBEdW1teUVsZW1lbnQge1xuICBwcml2YXRlIGVsZW1lbnQ6IEhUTUxFbGVtZW50XG4gIGNvbnN0cnVjdG9yIChwcml2YXRlIG9wdHM6IElDb250cm9sT3B0cyAmIHtlbGVtZW50OiBIVE1MRWxlbWVudH0pIHtcbiAgICB0aGlzLmVsZW1lbnQgPSBvcHRzLmVsZW1lbnQuY2xvbmVOb2RlKHRydWUpIGFzIEhUTUxFbGVtZW50XG4gICAgdGhpcy5pbml0KClcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUgKG9wdHM6IElDb250cm9sT3B0cyAmIHtlbGVtZW50OiBIVE1MRWxlbWVudH0pIHtcbiAgICB0aGlzLm9wdHMgPSBvcHRzXG4gICAgdGhpcy5lbGVtZW50LnJlbW92ZSgpXG4gICAgdGhpcy5lbGVtZW50ID0gb3B0cy5lbGVtZW50LmNsb25lTm9kZSh0cnVlKSBhcyBIVE1MRWxlbWVudFxuICAgIHRoaXMuaW5pdCgpXG4gIH1cblxuICBwcml2YXRlIGluaXQoKSB7XG4gICAgY29uc3Qge2lkLCBldmVudHMsIGNsYXNzZXMsIHN0eWxlLCBhdHRyc30gPSB0aGlzLm9wdHNcbiAgICBpZiAoaWQpIHsgdGhpcy5lbGVtZW50LmlkID0gaWQgfVxuICAgIGlmIChldmVudHMpIHtcbiAgICAgIGZvciAoY29uc3QgZXYgb2YgT2JqZWN0LmtleXMoZXZlbnRzKSkge1xuICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldiwgZXZlbnRzW2V2XSlcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGNsYXNzZXMpIHtcbiAgICAgIGZvciAoY29uc3QgY2xzIG9mIGNsYXNzZXMpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5hZGQoY2xzKVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc3R5bGUpIHtcbiAgICAgIGZvciAoY29uc3Qgc3Qgb2YgT2JqZWN0LmtleXMoc3R5bGUpKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudC5zdHlsZVtzdF0gPSBzdHlsZVtzdF1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGF0dHJzKSB7XG4gICAgICBmb3IgKGNvbnN0IGF0IG9mIE9iamVjdC5rZXlzKGF0dHJzKSkge1xuICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKGF0LCBhdHRyc1thdF0pXG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=