"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const instance_1 = require("./instance");
const error_1 = require("./error");
exports.UPIError = error_1.UPIError;
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
        this.instances = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.disposables.add(this.pluginManager.onShouldShowTooltip(this.shouldShowTooltip.bind(this)));
    }
    consume(options) {
        const { name, menu, messageTypes, events, controls, params, consumer, tooltipEvent } = options;
        if (!name) {
            throw new error_1.UPIError('name has to be specified for UPI');
        }
        if (this.instances.has(name)) {
            throw new error_1.UPIError(`Plugin ${name} already registered with UPI`);
        }
        const instance = new instance_1.UPIInstance(this.pluginManager, name, this);
        this.instances.set(name, instance);
        const disp = new atom_1.CompositeDisposable();
        if (menu) {
            disp.add(instance.menu.set(menu));
        }
        if (messageTypes) {
            instance.messages.setTypes(messageTypes);
        }
        if (events) {
            for (const k in events) {
                if (instance.events[k]) {
                    let v = events[k];
                    if (!Array.isArray(v)) {
                        v = [v];
                    }
                    for (const i of v) {
                        disp.add(instance.events[k](i));
                    }
                }
            }
        }
        if (tooltipEvent) {
            let handler, priority;
            if (typeof tooltipEvent === 'function') {
                handler = tooltipEvent;
                priority = 100;
            }
            else {
                ({ handler, priority } = tooltipEvent);
            }
            if (!priority) {
                priority = 100;
            }
            disp.add(instance.tooltips.onShouldShowTooltip(priority, handler));
        }
        if (controls) {
            for (const i of controls) {
                disp.add(instance.controls.add(i));
            }
        }
        if (params) {
            disp.add(instance.params.add(params));
        }
        if (consumer) {
            const d = consumer(instance);
            if (typeof d === 'object') {
                disp.add(d);
            }
        }
        disp.add(new atom_1.Disposable(() => {
            this.instances.delete(name);
            instance.destroy();
        }));
        this.disposables.add(disp);
        return disp;
    }
    dispose() {
        this.disposables.dispose();
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        if (pos) {
            pos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        return callback(controller.getEventRange(pos, eventType), eventType);
    }
    getEventRange({ editor, detail, eventType, pos, controller }) {
        if (pos) {
            pos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        return controller.getEventRange(pos, eventType);
    }
    shouldShowTooltip({ editor, pos, eventType }) {
        return __awaiter(this, void 0, void 0, function* () {
            const subs = [];
            for (const [pluginName, inst] of this.instances.entries()) {
                for (const vs of inst.tooltipEvents.values()) {
                    subs.push(Object.assign({ pluginName }, vs));
                }
            }
            subs.sort((a, b) => b.priority - a.priority);
            const controller = this.pluginManager.controller(editor);
            if (!controller) {
                return;
            }
            for (const { pluginName, handler } of subs) {
                try {
                    const eventRange = this.getEventRange({ controller, pos, eventType });
                    if (!eventRange) {
                        continue;
                    }
                    const { crange, pos: newPos } = eventRange;
                    const tt = yield Promise.resolve(handler(editor, crange, eventType));
                    if (tt) {
                        const { range, text } = tt;
                        controller.showTooltip(newPos, range, text, { eventType, subtype: 'external' });
                        break;
                    }
                    else {
                        continue;
                    }
                }
                catch (e) {
                    if (e.message) {
                        console.warn(e);
                        e = {
                            status: 'warning',
                            detail: e.message
                        };
                    }
                    if (!e.ignore) {
                        controller.hideTooltip({ eventType });
                        this.pluginManager.outputView.backendStatus(pluginName, e);
                    }
                }
            }
        });
    }
}
exports.UPI = UPI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTAuMy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQXVFO0FBQ3ZFLG9DQUFxQztBQUVyQyx5Q0FBc0M7QUFDdEMsbUNBQWdDO0FBQ3hCLG9DQUFRO0FBb0NoQjtJQUdFLFlBQXFCLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQy9DLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUMxQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2pHLENBQUM7SUFTTSxPQUFPLENBQUUsT0FBNkI7UUFDM0MsTUFBTSxFQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUMsR0FBRyxPQUFPLENBQUE7UUFDNUYsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ1YsTUFBTSxJQUFJLGdCQUFRLENBQUMsa0NBQWtDLENBQUMsQ0FBQTtRQUN4RCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLE1BQU0sSUFBSSxnQkFBUSxDQUFDLFVBQVUsSUFBSSw4QkFBOEIsQ0FBQyxDQUFBO1FBQ2xFLENBQUM7UUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFJLHNCQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDaEUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUV0QyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ1QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO1FBQ25DLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLFFBQVEsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFBO1FBQzFDLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ1gsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDdkIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZCLElBQUksQ0FBQyxHQUE4QyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQzVELEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQUMsQ0FBQztvQkFDbEMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7b0JBQ2pDLENBQUM7Z0JBQ0gsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNqQixJQUFJLE9BQXdCLEVBQUUsUUFBNEIsQ0FBQTtZQUMxRCxFQUFFLENBQUMsQ0FBQyxPQUFPLFlBQVksS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUN2QyxPQUFPLEdBQUcsWUFBWSxDQUFBO2dCQUN0QixRQUFRLEdBQUcsR0FBRyxDQUFBO1lBQ2hCLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixDQUFDLEVBQUMsT0FBTyxFQUFFLFFBQVEsRUFBQyxHQUFHLFlBQVksQ0FBQyxDQUFBO1lBQ3RDLENBQUM7WUFDRCxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQTtZQUFDLENBQUM7WUFDakMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFBO1FBQ3BFLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2IsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDekIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ3BDLENBQUM7UUFDSCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNYLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUN2QyxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNiLE1BQU0sQ0FBQyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQTtZQUM1QixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQ2IsQ0FBQztRQUNILENBQUM7UUFFRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksaUJBQVUsQ0FBQztZQUN0QixJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUMzQixRQUFRLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDcEIsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNILElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUE7SUFDYixDQUFDO0lBRU0sT0FBTztRQUNaLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDNUIsQ0FBQztJQUVNLGNBQWMsQ0FDbkIsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUE0QixFQUN2RSxRQUFnQztRQUVoQyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQUMsR0FBRyxHQUFHLFlBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUE7UUFBQyxDQUFDO1FBQ3hDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUFDLFNBQVMsR0FBRyxvQkFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUNwRCxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUNqRixFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBRTNCLE1BQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUE7SUFDdEUsQ0FBQztJQUVNLGFBQWEsQ0FDbEIsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUE0QjtRQUV2RSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQUMsR0FBRyxHQUFHLFlBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUE7UUFBQyxDQUFDO1FBQ3hDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUFDLFNBQVMsR0FBRyxvQkFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUNwRCxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUNqRixFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBRTNCLE1BQU0sQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQTtJQUNqRCxDQUFDO0lBRWEsaUJBQWlCLENBQzdCLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQStEOztZQUV0RixNQUFNLElBQUksR0FBc0QsRUFBRSxDQUFBO1lBQ2xFLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQzFELEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUM3QyxJQUFJLENBQUMsSUFBSSxpQkFBRSxVQUFVLElBQUssRUFBRSxFQUFFLENBQUE7Z0JBQ2hDLENBQUM7WUFDSCxDQUFDO1lBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUE7WUFDNUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDeEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUFDLE1BQU0sQ0FBQTtZQUFDLENBQUM7WUFDM0IsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUN6QyxJQUFJLENBQUM7b0JBQ0gsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFDLENBQUMsQ0FBQTtvQkFDbkUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO3dCQUFDLFFBQVEsQ0FBQTtvQkFBQyxDQUFDO29CQUM3QixNQUFNLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUMsR0FBRyxVQUFVLENBQUE7b0JBQ3hDLE1BQU0sRUFBRSxHQUFHLE1BQU0sT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFBO29CQUNwRSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO3dCQUNQLE1BQU0sRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFDLEdBQUcsRUFBRSxDQUFBO3dCQUN4QixVQUFVLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUMsQ0FBQyxDQUFBO3dCQUM3RSxLQUFLLENBQUE7b0JBQ1AsQ0FBQztvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDTixRQUFRLENBQUE7b0JBQ1YsQ0FBQztnQkFDSCxDQUFDO2dCQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ1gsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7d0JBQ2QsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTt3QkFDZixDQUFDLEdBQUc7NEJBQ0YsTUFBTSxFQUFFLFNBQVM7NEJBQ2pCLE1BQU0sRUFBRSxDQUFDLENBQUMsT0FBTzt5QkFDbEIsQ0FBQTtvQkFDSCxDQUFDO29CQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7d0JBQ2QsVUFBVSxDQUFDLFdBQVcsQ0FBQyxFQUFDLFNBQVMsRUFBQyxDQUFDLENBQUE7d0JBQ25DLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUE7b0JBQzVELENBQUM7Z0JBQ0gsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO0tBQUE7Q0FDRjtBQW5KRCxrQkFtSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGUsIFBvaW50LCBEaXNwb3NhYmxlLCBUZXh0RWRpdG9yfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtnZXRFdmVudFR5cGV9IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyfSBmcm9tICcuLi9wbHVnaW4tbWFuYWdlcidcbmltcG9ydCB7VVBJSW5zdGFuY2V9IGZyb20gJy4vaW5zdGFuY2UnXG5pbXBvcnQge1VQSUVycm9yfSBmcm9tICcuL2Vycm9yJ1xuZXhwb3J0IHtVUElFcnJvcn1cblxuaW1wb3J0IHtUUG9zaXRpb259IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQge1RFdmVudFJhbmdlVHlwZX0gZnJvbSAnLi9pbnN0YW5jZS9nZW5lcmFsJ1xuaW1wb3J0IHtJTWVudURlZmluaXRpb259IGZyb20gJy4vaW5zdGFuY2UvbWVudSdcbmltcG9ydCB7SVNldFR5cGVzUGFyYW1zfSBmcm9tICcuLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge1RleHRCdWZmZXJDYWxsYmFja30gZnJvbSAnLi9pbnN0YW5jZS9ldmVudHMnXG5pbXBvcnQge1RVUElDb250cm9sRGVmaW5pdGlvbn0gZnJvbSAnLi9pbnN0YW5jZS9jb250cm9scydcbmltcG9ydCB7SVBhcmFtU3BlY30gZnJvbSAnLi4vY29uZmlnLXBhcmFtcydcbmltcG9ydCB7VFRvb2x0aXBIYW5kbGVyfSBmcm9tICcuL2luc3RhbmNlL3Rvb2x0aXBzJ1xuaW1wb3J0IHtURXZlbnRSYW5nZUNhbGxiYWNrfSBmcm9tICcuL2luc3RhbmNlL3V0aWxzJ1xuaW1wb3J0IHtUVG9vbHRpcEhhbmRsZXJTcGVjfSBmcm9tICcuL2luc3RhbmNlJ1xuXG5leHBvcnQgaW50ZXJmYWNlIElSZWdpc3RyYXRpb25PcHRpb25zIHtcbiAgbmFtZTogc3RyaW5nXG4gIGNvbnN1bWVyPzogKGluc3RhbmNlOiBVUElJbnN0YW5jZSkgPT4gRGlzcG9zYWJsZSB8IHZvaWRcbiAgbWVudT86IElNZW51RGVmaW5pdGlvblxuICBtZXNzYWdlVHlwZXM/OiBJU2V0VHlwZXNQYXJhbXNcbiAgZXZlbnRzPzoge1xuICAgIG9uV2lsbFNhdmVCdWZmZXI/OiBUZXh0QnVmZmVyQ2FsbGJhY2sgfCBUZXh0QnVmZmVyQ2FsbGJhY2tbXVxuICAgIG9uRGlkU2F2ZUJ1ZmZlcj86IFRleHRCdWZmZXJDYWxsYmFjayB8IFRleHRCdWZmZXJDYWxsYmFja1tdXG4gICAgb25EaWRTdG9wQ2hhbmdpbmc/OiBUZXh0QnVmZmVyQ2FsbGJhY2sgfCBUZXh0QnVmZmVyQ2FsbGJhY2tbXVxuICB9XG4gIGNvbnRyb2xzPzogVFVQSUNvbnRyb2xEZWZpbml0aW9uW11cbiAgcGFyYW1zPzoge1twYXJhbU5hbWU6IHN0cmluZ106IElQYXJhbVNwZWM8YW55Pn1cbiAgdG9vbHRpcEV2ZW50PzogVFRvb2x0aXBIYW5kbGVyIHwge3ByaW9yaXR5PzogbnVtYmVyLCBoYW5kbGVyOiBUVG9vbHRpcEhhbmRsZXJ9XG59XG5cbmludGVyZmFjZSBJRXZlbnRSYW5nZVBhcmFtc0ludGVybmFsIHtcbiAgZWRpdG9yPzogVGV4dEVkaXRvclxuICBjb250cm9sbGVyOiBhbnlcbiAgZGV0YWlsPzogYW55XG4gIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlXG4gIHBvczogVFBvc2l0aW9uXG59XG5cbmV4cG9ydCBjbGFzcyBVUEkge1xuICBwcml2YXRlIGluc3RhbmNlczogTWFwPHN0cmluZywgVVBJSW5zdGFuY2U+XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgY29uc3RydWN0b3IgKHByaXZhdGUgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuaW5zdGFuY2VzID0gbmV3IE1hcCgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnBsdWdpbk1hbmFnZXIub25TaG91bGRTaG93VG9vbHRpcCh0aGlzLnNob3VsZFNob3dUb29sdGlwLmJpbmQodGhpcykpKVxuICB9XG5cbiAgLyoqXG4gIENhbGwgdGhpcyBmdW5jdGlvbiBpbiBjb25zdW1lciB0byBnZXQgYWN0dWFsIGludGVyZmFjZVxuXG4gIEBwYXJhbSBuYW1lOiBQbHVnaW4gcGFja2FnZSBuYW1lXG4gIEBwYXJhbSBjb25zdW1lcjogY2FsbGJhY2sgOjogVVBJSW5zdGFuY2UgLT4gKClcbiAgQHJldHVybnMge0Rpc3Bvc2FibGV9XG4gICovXG4gIHB1YmxpYyBjb25zdW1lIChvcHRpb25zOiBJUmVnaXN0cmF0aW9uT3B0aW9ucyk6IERpc3Bvc2FibGUge1xuICAgIGNvbnN0IHtuYW1lLCBtZW51LCBtZXNzYWdlVHlwZXMsIGV2ZW50cywgY29udHJvbHMsIHBhcmFtcywgY29uc3VtZXIsIHRvb2x0aXBFdmVudH0gPSBvcHRpb25zXG4gICAgaWYgKCFuYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgVVBJRXJyb3IoJ25hbWUgaGFzIHRvIGJlIHNwZWNpZmllZCBmb3IgVVBJJylcbiAgICB9XG4gICAgaWYgKHRoaXMuaW5zdGFuY2VzLmhhcyhuYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IFVQSUVycm9yKGBQbHVnaW4gJHtuYW1lfSBhbHJlYWR5IHJlZ2lzdGVyZWQgd2l0aCBVUElgKVxuICAgIH1cbiAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBVUElJbnN0YW5jZSh0aGlzLnBsdWdpbk1hbmFnZXIsIG5hbWUsIHRoaXMpXG4gICAgdGhpcy5pbnN0YW5jZXMuc2V0KG5hbWUsIGluc3RhbmNlKVxuICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgICBpZiAobWVudSkge1xuICAgICAgZGlzcC5hZGQoaW5zdGFuY2UubWVudS5zZXQobWVudSkpXG4gICAgfVxuICAgIGlmIChtZXNzYWdlVHlwZXMpIHtcbiAgICAgIGluc3RhbmNlLm1lc3NhZ2VzLnNldFR5cGVzKG1lc3NhZ2VUeXBlcykgLy8gVE9ETzogTWFrZSBkaXNwb3NhYmxlXG4gICAgfVxuICAgIGlmIChldmVudHMpIHtcbiAgICAgIGZvciAoY29uc3QgayBpbiBldmVudHMpIHtcbiAgICAgICAgaWYgKGluc3RhbmNlLmV2ZW50c1trXSkge1xuICAgICAgICAgIGxldCB2OiBUZXh0QnVmZmVyQ2FsbGJhY2sgfCBUZXh0QnVmZmVyQ2FsbGJhY2tbXSA9IGV2ZW50c1trXVxuICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2KSkgeyB2ID0gW3ZdIH1cbiAgICAgICAgICBmb3IgKGNvbnN0IGkgb2Ygdikge1xuICAgICAgICAgICAgZGlzcC5hZGQoaW5zdGFuY2UuZXZlbnRzW2tdKGkpKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodG9vbHRpcEV2ZW50KSB7XG4gICAgICBsZXQgaGFuZGxlcjogVFRvb2x0aXBIYW5kbGVyLCBwcmlvcml0eTogbnVtYmVyIHwgdW5kZWZpbmVkXG4gICAgICBpZiAodHlwZW9mIHRvb2x0aXBFdmVudCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBoYW5kbGVyID0gdG9vbHRpcEV2ZW50XG4gICAgICAgIHByaW9yaXR5ID0gMTAwXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAoe2hhbmRsZXIsIHByaW9yaXR5fSA9IHRvb2x0aXBFdmVudClcbiAgICAgIH1cbiAgICAgIGlmICghcHJpb3JpdHkpIHsgcHJpb3JpdHkgPSAxMDAgfVxuICAgICAgZGlzcC5hZGQoaW5zdGFuY2UudG9vbHRpcHMub25TaG91bGRTaG93VG9vbHRpcChwcmlvcml0eSwgaGFuZGxlcikpXG4gICAgfVxuICAgIGlmIChjb250cm9scykge1xuICAgICAgZm9yIChjb25zdCBpIG9mIGNvbnRyb2xzKSB7XG4gICAgICAgIGRpc3AuYWRkKGluc3RhbmNlLmNvbnRyb2xzLmFkZChpKSlcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHBhcmFtcykge1xuICAgICAgZGlzcC5hZGQoaW5zdGFuY2UucGFyYW1zLmFkZChwYXJhbXMpKVxuICAgIH1cblxuICAgIGlmIChjb25zdW1lcikge1xuICAgICAgY29uc3QgZCA9IGNvbnN1bWVyKGluc3RhbmNlKVxuICAgICAgaWYgKHR5cGVvZiBkID09PSAnb2JqZWN0Jykge1xuICAgICAgICBkaXNwLmFkZChkKVxuICAgICAgfVxuICAgIH1cblxuICAgIGRpc3AuYWRkKG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuaW5zdGFuY2VzLmRlbGV0ZShuYW1lKVxuICAgICAgaW5zdGFuY2UuZGVzdHJveSgpXG4gICAgfSkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgcHVibGljIGRpc3Bvc2UgKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwdWJsaWMgd2l0aEV2ZW50UmFuZ2U8VD4gKFxuICAgIHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3MsIGNvbnRyb2xsZXJ9OiBJRXZlbnRSYW5nZVBhcmFtc0ludGVybmFsLFxuICAgIGNhbGxiYWNrOiBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+XG4gICkge1xuICAgIGlmIChwb3MpIHsgcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpIH1cbiAgICBpZiAoIWV2ZW50VHlwZSkgeyBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKSB9XG4gICAgaWYgKCFjb250cm9sbGVyICYmIGVkaXRvcikgeyBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKSB9XG4gICAgaWYgKCFjb250cm9sbGVyKSB7IHJldHVybiB9XG5cbiAgICByZXR1cm4gY2FsbGJhY2soY29udHJvbGxlci5nZXRFdmVudFJhbmdlKHBvcywgZXZlbnRUeXBlKSwgZXZlbnRUeXBlKVxuICB9XG5cbiAgcHVibGljIGdldEV2ZW50UmFuZ2UgKFxuICAgIHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3MsIGNvbnRyb2xsZXJ9OiBJRXZlbnRSYW5nZVBhcmFtc0ludGVybmFsXG4gICk6IHtwb3M6IFBvaW50LCBjcmFuZ2U6IFJhbmdlfSB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHBvcykgeyBwb3MgPSBQb2ludC5mcm9tT2JqZWN0KHBvcykgfVxuICAgIGlmICghZXZlbnRUeXBlKSB7IGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpIH1cbiAgICBpZiAoIWNvbnRyb2xsZXIgJiYgZWRpdG9yKSB7IGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpIH1cbiAgICBpZiAoIWNvbnRyb2xsZXIpIHsgcmV0dXJuIH1cblxuICAgIHJldHVybiBjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UocG9zLCBldmVudFR5cGUpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNob3VsZFNob3dUb29sdGlwIChcbiAgICB7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZX06IHtlZGl0b3I6IFRleHRFZGl0b3IsIHBvczogUG9pbnQsIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlfVxuICApIHtcbiAgICBjb25zdCBzdWJzOiBBcnJheTxUVG9vbHRpcEhhbmRsZXJTcGVjICYge3BsdWdpbk5hbWU6IHN0cmluZ30+ID0gW11cbiAgICBmb3IgKGNvbnN0IFtwbHVnaW5OYW1lLCBpbnN0XSBvZiB0aGlzLmluc3RhbmNlcy5lbnRyaWVzKCkpIHtcbiAgICAgIGZvciAoY29uc3QgdnMgb2YgaW5zdC50b29sdGlwRXZlbnRzLnZhbHVlcygpKSB7XG4gICAgICAgIHN1YnMucHVzaCh7cGx1Z2luTmFtZSwgLi4udnN9KVxuICAgICAgfVxuICAgIH1cbiAgICBzdWJzLnNvcnQoKGEsIGIpID0+IGIucHJpb3JpdHkgLSBhLnByaW9yaXR5KVxuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpXG4gICAgaWYgKCFjb250cm9sbGVyKSB7IHJldHVybiB9XG4gICAgZm9yIChjb25zdCB7cGx1Z2luTmFtZSwgaGFuZGxlcn0gb2Ygc3Vicykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZXZlbnRSYW5nZSA9IHRoaXMuZ2V0RXZlbnRSYW5nZSh7Y29udHJvbGxlciwgcG9zLCBldmVudFR5cGV9KVxuICAgICAgICBpZiAoIWV2ZW50UmFuZ2UpIHsgY29udGludWUgfVxuICAgICAgICBjb25zdCB7Y3JhbmdlLCBwb3M6IG5ld1Bvc30gPSBldmVudFJhbmdlXG4gICAgICAgIGNvbnN0IHR0ID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKGhhbmRsZXIoZWRpdG9yLCBjcmFuZ2UsIGV2ZW50VHlwZSkpXG4gICAgICAgIGlmICh0dCkge1xuICAgICAgICAgIGNvbnN0IHtyYW5nZSwgdGV4dH0gPSB0dFxuICAgICAgICAgIGNvbnRyb2xsZXIuc2hvd1Rvb2x0aXAobmV3UG9zLCByYW5nZSwgdGV4dCwge2V2ZW50VHlwZSwgc3VidHlwZTogJ2V4dGVybmFsJ30pXG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGlmIChlLm1lc3NhZ2UpIHtcbiAgICAgICAgICBjb25zb2xlLndhcm4oZSlcbiAgICAgICAgICBlID0ge1xuICAgICAgICAgICAgc3RhdHVzOiAnd2FybmluZycsXG4gICAgICAgICAgICBkZXRhaWw6IGUubWVzc2FnZVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIWUuaWdub3JlKSB7XG4gICAgICAgICAgY29udHJvbGxlci5oaWRlVG9vbHRpcCh7ZXZlbnRUeXBlfSlcbiAgICAgICAgICB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0Vmlldy5iYWNrZW5kU3RhdHVzKHBsdWdpbk5hbWUsIGUpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==