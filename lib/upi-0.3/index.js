"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const instance_1 = require("./instance");
const error_1 = require("./error");
exports.UPIError = error_1.UPIError;
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
        this.instances = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.disposables.add(this.pluginManager.onShouldShowTooltip(this.shouldShowTooltip.bind(this)));
    }
    consume(options) {
        const { name, menu, messageTypes, events, controls, params, consumer, tooltipEvent } = options;
        if (!name) {
            throw new error_1.UPIError('name has to be specified for UPI');
        }
        if (this.instances.has(name)) {
            throw new error_1.UPIError(`Plugin ${name} already registered with UPI`);
        }
        const instance = new instance_1.UPIInstance(this.pluginManager, name, this);
        this.instances.set(name, instance);
        const disp = new atom_1.CompositeDisposable();
        if (menu) {
            disp.add(instance.menu.set(menu));
        }
        if (messageTypes) {
            instance.messages.setTypes(messageTypes);
        }
        if (events) {
            for (const k in events) {
                if (instance.events[k]) {
                    let v = events[k];
                    if (!Array.isArray(v)) {
                        v = [v];
                    }
                    for (const i of v) {
                        disp.add(instance.events[k](i));
                    }
                }
            }
        }
        if (tooltipEvent) {
            let handler, priority;
            if (typeof tooltipEvent === 'function') {
                handler = tooltipEvent;
                priority = 100;
            }
            else {
                ({ handler, priority } = tooltipEvent);
            }
            if (!priority) {
                priority = 100;
            }
            disp.add(instance.tooltips.onShouldShowTooltip(priority, handler));
        }
        if (controls) {
            for (const i of controls) {
                disp.add(instance.controls.add(i));
            }
        }
        if (params) {
            disp.add(instance.params.add(params));
        }
        if (consumer) {
            const d = consumer(instance);
            if (typeof d === 'object') {
                disp.add(d);
            }
        }
        disp.add(new atom_1.Disposable(() => {
            this.instances.delete(name);
            instance.destroy();
        }));
        this.disposables.add(disp);
        return disp;
    }
    dispose() {
        this.disposables.dispose();
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        if (pos) {
            pos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        return callback(controller.getEventRange(pos, eventType));
    }
    getEventRange({ editor, detail, eventType, pos, controller }) {
        if (pos) {
            pos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        return controller.getEventRange(pos, eventType);
    }
    shouldShowTooltip({ editor, pos, eventType }) {
        return __awaiter(this, void 0, void 0, function* () {
            const subs = [];
            for (const [pluginName, inst] of this.instances.entries()) {
                for (const vs of inst.tooltipEvents.values()) {
                    subs.push(Object.assign({ pluginName }, vs));
                }
            }
            subs.sort((a, b) => b.priority - a.priority);
            const controller = this.pluginManager.controller(editor);
            if (!controller) {
                return;
            }
            for (const { pluginName, handler } of subs) {
                try {
                    const eventRange = this.getEventRange({ controller, pos, eventType });
                    if (!eventRange) {
                        continue;
                    }
                    const { crange, pos: newPos } = eventRange;
                    const tt = yield Promise.resolve(handler(editor, crange, eventType));
                    if (tt) {
                        const { range, text } = tt;
                        controller.showTooltip(newPos, range, text, { eventType, subtype: 'external' });
                        break;
                    }
                    else {
                        continue;
                    }
                }
                catch (e) {
                    if (e.message) {
                        console.warn(e);
                        e = {
                            status: 'warning',
                            detail: e.message
                        };
                    }
                    if (!e.ignore) {
                        controller.hideTooltip({ eventType });
                        this.pluginManager.outputView.backendStatus(pluginName, e);
                    }
                }
            }
        });
    }
}
exports.UPI = UPI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTAuMy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQThFO0FBQzlFLG9DQUFxQztBQUVyQyx5Q0FBc0M7QUFDdEMsbUNBQWdDO0FBQ3hCLG9DQUFRO0FBb0NoQjtJQUdFLFlBQXFCLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQy9DLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUMxQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2pHLENBQUM7SUFTTSxPQUFPLENBQUUsT0FBNkI7UUFDM0MsTUFBTSxFQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUMsR0FBRyxPQUFPLENBQUE7UUFDNUYsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ1YsTUFBTSxJQUFJLGdCQUFRLENBQUMsa0NBQWtDLENBQUMsQ0FBQTtRQUN4RCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLE1BQU0sSUFBSSxnQkFBUSxDQUFDLFVBQVUsSUFBSSw4QkFBOEIsQ0FBQyxDQUFBO1FBQ2xFLENBQUM7UUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFJLHNCQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLEVB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VixDQUFDO2dCQUNILENBQUM7Z0JBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDWCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQzt3QkFDZCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO3dCQUNmLENBQUMsR0FBRzs0QkFDRixNQUFNLEVBQUUsU0FBUzs0QkFDakIsTUFBTSxFQUFFLENBQUMsQ0FBQyxPQUFPO3lCQUNsQixDQUFBO29CQUNILENBQUM7b0JBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQzt3QkFDZCxVQUFVLENBQUMsV0FBVyxDQUFDLEVBQUMsU0FBUyxFQUFDLENBQUMsQ0FBQTt3QkFDbkMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQTtvQkFDNUQsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7S0FBQTtDQUNGO0FBbkpELGtCQW1KQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgUG9pbnQsIERpc3Bvc2FibGUsIFRleHRFZGl0b3IsIFJhbmdlfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHtnZXRFdmVudFR5cGV9IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyfSBmcm9tICcuLi9wbHVnaW4tbWFuYWdlcidcbmltcG9ydCB7VVBJSW5zdGFuY2V9IGZyb20gJy4vaW5zdGFuY2UnXG5pbXBvcnQge1VQSUVycm9yfSBmcm9tICcuL2Vycm9yJ1xuZXhwb3J0IHtVUElFcnJvcn1cblxuaW1wb3J0IHtUUG9zaXRpb259IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQge1RFdmVudFJhbmdlVHlwZX0gZnJvbSAnLi4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge0lNZW51RGVmaW5pdGlvbn0gZnJvbSAnLi9pbnN0YW5jZS9tZW51J1xuaW1wb3J0IHtJU2V0VHlwZXNQYXJhbXN9IGZyb20gJy4uL291dHB1dC1wYW5lbCdcbmltcG9ydCB7VGV4dEJ1ZmZlckNhbGxiYWNrfSBmcm9tICcuL2luc3RhbmNlL2V2ZW50cydcbmltcG9ydCB7VFVQSUNvbnRyb2xEZWZpbml0aW9ufSBmcm9tICcuL2luc3RhbmNlL2NvbnRyb2xzJ1xuaW1wb3J0IHtJUGFyYW1TcGVjfSBmcm9tICcuLi9jb25maWctcGFyYW1zJ1xuaW1wb3J0IHtUVG9vbHRpcEhhbmRsZXJ9IGZyb20gJy4vaW5zdGFuY2UvdG9vbHRpcHMnXG5pbXBvcnQge1RFdmVudFJhbmdlQ2FsbGJhY2t9IGZyb20gJy4vaW5zdGFuY2UvdXRpbHMnXG5pbXBvcnQge1RUb29sdGlwSGFuZGxlclNwZWN9IGZyb20gJy4vaW5zdGFuY2UnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJlZ2lzdHJhdGlvbk9wdGlvbnMge1xuICBuYW1lOiBzdHJpbmdcbiAgY29uc3VtZXI/OiAoaW5zdGFuY2U6IFVQSUluc3RhbmNlKSA9PiBEaXNwb3NhYmxlIHwgdm9pZFxuICBtZW51PzogSU1lbnVEZWZpbml0aW9uXG4gIG1lc3NhZ2VUeXBlcz86IElTZXRUeXBlc1BhcmFtc1xuICBldmVudHM/OiB7XG4gICAgb25XaWxsU2F2ZUJ1ZmZlcj86IFRleHRCdWZmZXJDYWxsYmFjayB8IFRleHRCdWZmZXJDYWxsYmFja1tdXG4gICAgb25EaWRTYXZlQnVmZmVyPzogVGV4dEJ1ZmZlckNhbGxiYWNrIHwgVGV4dEJ1ZmZlckNhbGxiYWNrW11cbiAgICBvbkRpZFN0b3BDaGFuZ2luZz86IFRleHRCdWZmZXJDYWxsYmFjayB8IFRleHRCdWZmZXJDYWxsYmFja1tdXG4gIH1cbiAgY29udHJvbHM/OiBUVVBJQ29udHJvbERlZmluaXRpb25bXVxuICBwYXJhbXM/OiB7W3BhcmFtTmFtZTogc3RyaW5nXTogSVBhcmFtU3BlYzxhbnk+fVxuICB0b29sdGlwRXZlbnQ/OiBUVG9vbHRpcEhhbmRsZXIgfCB7cHJpb3JpdHk/OiBudW1iZXIsIGhhbmRsZXI6IFRUb29sdGlwSGFuZGxlcn1cbn1cblxuaW50ZXJmYWNlIElFdmVudFJhbmdlUGFyYW1zSW50ZXJuYWwge1xuICBlZGl0b3I/OiBUZXh0RWRpdG9yXG4gIGNvbnRyb2xsZXI6IGFueVxuICBkZXRhaWw/OiBhbnlcbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIHBvczogVFBvc2l0aW9uXG59XG5cbmV4cG9ydCBjbGFzcyBVUEkge1xuICBwcml2YXRlIGluc3RhbmNlczogTWFwPHN0cmluZywgVVBJSW5zdGFuY2U+XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgY29uc3RydWN0b3IgKHByaXZhdGUgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuaW5zdGFuY2VzID0gbmV3IE1hcCgpXG4gICAgdGhpcy5kaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLnBsdWdpbk1hbmFnZXIub25TaG91bGRTaG93VG9vbHRpcCh0aGlzLnNob3VsZFNob3dUb29sdGlwLmJpbmQodGhpcykpKVxuICB9XG5cbiAgLyoqXG4gIENhbGwgdGhpcyBmdW5jdGlvbiBpbiBjb25zdW1lciB0byBnZXQgYWN0dWFsIGludGVyZmFjZVxuXG4gIEBwYXJhbSBuYW1lOiBQbHVnaW4gcGFja2FnZSBuYW1lXG4gIEBwYXJhbSBjb25zdW1lcjogY2FsbGJhY2sgOjogVVBJSW5zdGFuY2UgLT4gKClcbiAgQHJldHVybnMge0Rpc3Bvc2FibGV9XG4gICovXG4gIHB1YmxpYyBjb25zdW1lIChvcHRpb25zOiBJUmVnaXN0cmF0aW9uT3B0aW9ucyk6IERpc3Bvc2FibGUge1xuICAgIGNvbnN0IHtuYW1lLCBtZW51LCBtZXNzYWdlVHlwZXMsIGV2ZW50cywgY29udHJvbHMsIHBhcmFtcywgY29uc3VtZXIsIHRvb2x0aXBFdmVudH0gPSBvcHRpb25zXG4gICAgaWYgKCFuYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgVVBJRXJyb3IoJ25hbWUgaGFzIHRvIGJlIHNwZWNpZmllZCBmb3IgVVBJJylcbiAgICB9XG4gICAgaWYgKHRoaXMuaW5zdGFuY2VzLmhhcyhuYW1lKSkge1xuICAgICAgdGhyb3cgbmV3IFVQSUVycm9yKGBQbHVnaW4gJHtuYW1lfSBhbHJlYWR5IHJlZ2lzdGVyZWQgd2l0aCBVUElgKVxuICAgIH1cbiAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBVUElJbnN0YW5jZSh0aGlzLnBsdWdpbk1hbmFnZXIsIG5hbWUsIHRoaXMpXG4gICAgdGhpcy5pbnN0YW5jZXMuc2V0KG5hbWUsIGluc3RhbmNlKVxuICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG5cbiAgICBpZiAobWVudSkge1xuICAgICAgZGlzcC5hZGQoaW5zdGFuY2UubWVudS5zZXQobWVudSkpXG4gICAgfVxuICAgIGlmIChtZXNzYWdlVHlwZXMpIHtcbiAgICAgIGluc3RhbmNlLm1lc3NhZ2VzLnNldFR5cGVzKG1lc3NhZ2VUeXBlcykgLy8gVE9ETzogTWFrZSBkaXNwb3NhYmxlXG4gICAgfVxuICAgIGlmIChldmVudHMpIHtcbiAgICAgIGZvciAoY29uc3QgayBpbiBldmVudHMpIHtcbiAgICAgICAgaWYgKGluc3RhbmNlLmV2ZW50c1trXSkge1xuICAgICAgICAgIGxldCB2OiBUZXh0QnVmZmVyQ2FsbGJhY2sgfCBUZXh0QnVmZmVyQ2FsbGJhY2tbXSA9IGV2ZW50c1trXVxuICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2KSkgeyB2ID0gW3ZdIH1cbiAgICAgICAgICBmb3IgKGNvbnN0IGkgb2Ygdikge1xuICAgICAgICAgICAgZGlzcC5hZGQoaW5zdGFuY2UuZXZlbnRzW2tdKGkpKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodG9vbHRpcEV2ZW50KSB7XG4gICAgICBsZXQgaGFuZGxlcjogVFRvb2x0aXBIYW5kbGVyLCBwcmlvcml0eTogbnVtYmVyIHwgdW5kZWZpbmVkXG4gICAgICBpZiAodHlwZW9mIHRvb2x0aXBFdmVudCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBoYW5kbGVyID0gdG9vbHRpcEV2ZW50XG4gICAgICAgIHByaW9yaXR5ID0gMTAwXG4gICAgICB9IGVsc2Uge1xuICAgICAgICAoe2hhbmRsZXIsIHByaW9yaXR5fSA9IHRvb2x0aXBFdmVudClcbiAgICAgIH1cbiAgICAgIGlmICghcHJpb3JpdHkpIHsgcHJpb3JpdHkgPSAxMDAgfVxuICAgICAgZGlzcC5hZGQoaW5zdGFuY2UudG9vbHRpcHMub25TaG91bGRTaG93VG9vbHRpcChwcmlvcml0eSwgaGFuZGxlcikpXG4gICAgfVxuICAgIGlmIChjb250cm9scykge1xuICAgICAgZm9yIChjb25zdCBpIG9mIGNvbnRyb2xzKSB7XG4gICAgICAgIGRpc3AuYWRkKGluc3RhbmNlLmNvbnRyb2xzLmFkZChpKSlcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHBhcmFtcykge1xuICAgICAgZGlzcC5hZGQoaW5zdGFuY2UucGFyYW1zLmFkZChwYXJhbXMpKVxuICAgIH1cblxuICAgIGlmIChjb25zdW1lcikge1xuICAgICAgY29uc3QgZCA9IGNvbnN1bWVyKGluc3RhbmNlKVxuICAgICAgaWYgKHR5cGVvZiBkID09PSAnb2JqZWN0Jykge1xuICAgICAgICBkaXNwLmFkZChkKVxuICAgICAgfVxuICAgIH1cblxuICAgIGRpc3AuYWRkKG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuaW5zdGFuY2VzLmRlbGV0ZShuYW1lKVxuICAgICAgaW5zdGFuY2UuZGVzdHJveSgpXG4gICAgfSkpXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgcHVibGljIGRpc3Bvc2UgKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICBwdWJsaWMgd2l0aEV2ZW50UmFuZ2U8VD4gKFxuICAgIHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3MsIGNvbnRyb2xsZXJ9OiBJRXZlbnRSYW5nZVBhcmFtc0ludGVybmFsLFxuICAgIGNhbGxiYWNrOiBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+XG4gICkge1xuICAgIGlmIChwb3MpIHsgcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpIH1cbiAgICBpZiAoIWV2ZW50VHlwZSkgeyBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKSB9XG4gICAgaWYgKCFjb250cm9sbGVyICYmIGVkaXRvcikgeyBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKSB9XG4gICAgaWYgKCFjb250cm9sbGVyKSB7IHJldHVybiB9XG5cbiAgICByZXR1cm4gY2FsbGJhY2soY29udHJvbGxlci5nZXRFdmVudFJhbmdlKHBvcywgZXZlbnRUeXBlKSlcbiAgfVxuXG4gIHB1YmxpYyBnZXRFdmVudFJhbmdlIChcbiAgICB7ZWRpdG9yLCBkZXRhaWwsIGV2ZW50VHlwZSwgcG9zLCBjb250cm9sbGVyfTogSUV2ZW50UmFuZ2VQYXJhbXNJbnRlcm5hbFxuICApOiB7cG9zOiBQb2ludCwgY3JhbmdlOiBSYW5nZX0gfCB1bmRlZmluZWQge1xuICAgIGlmIChwb3MpIHsgcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpIH1cbiAgICBpZiAoIWV2ZW50VHlwZSkgeyBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKSB9XG4gICAgaWYgKCFjb250cm9sbGVyICYmIGVkaXRvcikgeyBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKSB9XG4gICAgaWYgKCFjb250cm9sbGVyKSB7IHJldHVybiB9XG5cbiAgICByZXR1cm4gY29udHJvbGxlci5nZXRFdmVudFJhbmdlKHBvcywgZXZlbnRUeXBlKVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzaG91bGRTaG93VG9vbHRpcCAoXG4gICAge2VkaXRvciwgcG9zLCBldmVudFR5cGV9OiB7ZWRpdG9yOiBUZXh0RWRpdG9yLCBwb3M6IFBvaW50LCBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZX1cbiAgKSB7XG4gICAgY29uc3Qgc3ViczogQXJyYXk8VFRvb2x0aXBIYW5kbGVyU3BlYyAmIHtwbHVnaW5OYW1lOiBzdHJpbmd9PiA9IFtdXG4gICAgZm9yIChjb25zdCBbcGx1Z2luTmFtZSwgaW5zdF0gb2YgdGhpcy5pbnN0YW5jZXMuZW50cmllcygpKSB7XG4gICAgICBmb3IgKGNvbnN0IHZzIG9mIGluc3QudG9vbHRpcEV2ZW50cy52YWx1ZXMoKSkge1xuICAgICAgICBzdWJzLnB1c2goe3BsdWdpbk5hbWUsIC4uLnZzfSlcbiAgICAgIH1cbiAgICB9XG4gICAgc3Vicy5zb3J0KChhLCBiKSA9PiBiLnByaW9yaXR5IC0gYS5wcmlvcml0eSlcbiAgICBjb25zdCBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIGlmICghY29udHJvbGxlcikgeyByZXR1cm4gfVxuICAgIGZvciAoY29uc3Qge3BsdWdpbk5hbWUsIGhhbmRsZXJ9IG9mIHN1YnMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGV2ZW50UmFuZ2UgPSB0aGlzLmdldEV2ZW50UmFuZ2Uoe2NvbnRyb2xsZXIsIHBvcywgZXZlbnRUeXBlfSlcbiAgICAgICAgaWYgKCFldmVudFJhbmdlKSB7IGNvbnRpbnVlIH1cbiAgICAgICAgY29uc3Qge2NyYW5nZSwgcG9zOiBuZXdQb3N9ID0gZXZlbnRSYW5nZVxuICAgICAgICBjb25zdCB0dCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShoYW5kbGVyKGVkaXRvciwgY3JhbmdlLCBldmVudFR5cGUpKVxuICAgICAgICBpZiAodHQpIHtcbiAgICAgICAgICBjb25zdCB7cmFuZ2UsIHRleHR9ID0gdHRcbiAgICAgICAgICBjb250cm9sbGVyLnNob3dUb29sdGlwKG5ld1BvcywgcmFuZ2UsIHRleHQsIHtldmVudFR5cGUsIHN1YnR5cGU6ICdleHRlcm5hbCd9KVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29udGludWVcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZS5tZXNzYWdlKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGUpXG4gICAgICAgICAgZSA9IHtcbiAgICAgICAgICAgIHN0YXR1czogJ3dhcm5pbmcnLFxuICAgICAgICAgICAgZGV0YWlsOiBlLm1lc3NhZ2VcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFlLmlnbm9yZSkge1xuICAgICAgICAgIGNvbnRyb2xsZXIuaGlkZVRvb2x0aXAoe2V2ZW50VHlwZX0pXG4gICAgICAgICAgdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFZpZXcuYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lLCBlKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=