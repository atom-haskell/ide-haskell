"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const instance_1 = require("./instance");
const error_1 = require("./error");
exports.UPIError = error_1.UPIError;
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
        this.instances = new Map();
        this.disposables = new atom_1.CompositeDisposable();
        this.disposables.add(this.pluginManager.onShouldShowTooltip(this.shouldShowTooltip.bind(this)));
    }
    consume(options) {
        const { name, menu, messageTypes, events, controls, params, consumer, tooltipEvent } = options;
        if (!name) {
            throw new error_1.UPIError('name has to be specified for UPI');
        }
        if (this.instances.has(name)) {
            throw new error_1.UPIError(`Plugin ${name} already registered with UPI`);
        }
        const instance = new instance_1.UPIInstance(this.pluginManager, name, this);
        this.instances.set(name, instance);
        const disp = new atom_1.CompositeDisposable();
        if (menu) {
            disp.add(instance.menu.set(menu));
        }
        if (messageTypes) {
            instance.messages.setTypes(messageTypes);
        }
        if (events) {
            for (const k in events) {
                if (instance.events[k]) {
                    let v = events[k];
                    if (!Array.isArray(v)) {
                        v = [v];
                    }
                    for (const i of v) {
                        disp.add(instance.events[k](i));
                    }
                }
            }
        }
        if (tooltipEvent) {
            let handler, priority;
            if (typeof tooltipEvent === 'function') {
                handler = tooltipEvent;
                priority = 100;
            }
            else {
                ({ handler, priority } = tooltipEvent);
            }
            if (!priority) {
                priority = 100;
            }
            disp.add(instance.tooltips.onShouldShowTooltip(priority, handler));
        }
        if (controls) {
            for (const i of controls) {
                disp.add(instance.controls.add(i));
            }
        }
        if (params) {
            disp.add(instance.params.add(params));
        }
        if (consumer) {
            const d = consumer(instance);
            if (typeof d === 'object') {
                disp.add(d);
            }
        }
        disp.add(new atom_1.Disposable(() => {
            this.instances.delete(name);
            instance.destroy();
        }));
        this.disposables.add(disp);
        return disp;
    }
    dispose() {
        this.disposables.dispose();
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        if (pos) {
            pos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        return callback(controller.getEventRange(pos, eventType));
    }
    getEventRange({ editor, detail, eventType, pos, controller }) {
        if (pos) {
            pos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        if (!controller && editor) {
            controller = this.pluginManager.controller(editor);
        }
        if (!controller) {
            return;
        }
        return controller.getEventRange(pos, eventType);
    }
    shouldShowTooltip({ editor, pos, eventType }) {
        return __awaiter(this, void 0, void 0, function* () {
            const subs = [];
            for (const [pluginName, inst] of this.instances.entries()) {
                for (const vs of inst.tooltipEvents.values()) {
                    subs.push(Object.assign({ pluginName }, vs));
                }
            }
            subs.sort((a, b) => b.priority - a.priority);
            const controller = this.pluginManager.controller(editor);
            if (!controller) {
                return;
            }
            for (const { pluginName, handler } of subs) {
                try {
                    const eventRange = this.getEventRange({ controller, pos, eventType });
                    if (!eventRange) {
                        continue;
                    }
                    const { crange, pos: newPos } = eventRange;
                    const tt = yield Promise.resolve(handler(editor, crange, eventType));
                    if (tt) {
                        const { range, text } = tt;
                        controller.tooltips.show(range, utils_1.MessageObject.fromObject(text), { type: eventType, subtype: 'external' });
                        break;
                    }
                    else {
                        continue;
                    }
                }
                catch (e) {
                    if (e.message) {
                        console.warn(e);
                        e = {
                            status: 'warning',
                            detail: e.message
                        };
                    }
                    if (!e.ignore) {
                        controller.tooltips.hide({ type: eventType });
                        this.pluginManager.outputView.backendStatus(pluginName, e);
                    }
                }
            }
        });
    }
}
exports.UPI = UPI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTAuMy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsK0JBQThFO0FBQzlFLG9DQUFvRDtBQUVwRCx5Q0FBc0M7QUFDdEMsbUNBQWdDO0FBQ3hCLG9DQUFRO0FBb0NoQjtJQUdFLFlBQXFCLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQy9DLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUMxQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtRQUM1QyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2pHLENBQUM7SUFTTSxPQUFPLENBQUUsT0FBNkI7UUFDM0MsTUFBTSxFQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUMsR0FBRyxPQUFPLENBQUE7UUFDNUYsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ1YsTUFBTSxJQUFJLGdCQUFRLENBQUMsa0NBQWtDLENBQUMsQ0FBQTtRQUN4RCxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLE1BQU0sSUFBSSxnQkFBUSxDQUFDLFVBQVUsSUFBSSw4QkFBOEIsQ0FBQyxDQUFBO1FBQ2xFLENBQUM7UUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFJLHNCQUFXLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLEVB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LElBQUksQ0FBQyxDQUFDO3dCQUNOLFFBQVEsQ0FBQTtvQkFDVixDQUFDO2dCQUNILENBQUM7Z0JBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDWCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQzt3QkFDZCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO3dCQUNmLENBQUMsR0FBRzs0QkFDRixNQUFNLEVBQUUsU0FBUzs0QkFDakIsTUFBTSxFQUFFLENBQUMsQ0FBQyxPQUFPO3lCQUNsQixDQUFBO29CQUNILENBQUM7b0JBQ0QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQzt3QkFDZCxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLElBQUksRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFBO3dCQUMzQyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFBO29CQUM1RCxDQUFDO2dCQUNILENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztLQUFBO0NBQ0Y7QUFuSkQsa0JBbUpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlLCBQb2ludCwgRGlzcG9zYWJsZSwgVGV4dEVkaXRvciwgUmFuZ2V9IGZyb20gJ2F0b20nXG5pbXBvcnQge2dldEV2ZW50VHlwZSwgTWVzc2FnZU9iamVjdH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1BsdWdpbk1hbmFnZXJ9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtVUElJbnN0YW5jZX0gZnJvbSAnLi9pbnN0YW5jZSdcbmltcG9ydCB7VVBJRXJyb3J9IGZyb20gJy4vZXJyb3InXG5leHBvcnQge1VQSUVycm9yfVxuXG5pbXBvcnQge1RQb3NpdGlvbn0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7VEV2ZW50UmFuZ2VUeXBlfSBmcm9tICcuLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7SU1lbnVEZWZpbml0aW9ufSBmcm9tICcuL2luc3RhbmNlL21lbnUnXG5pbXBvcnQge0lTZXRUeXBlc1BhcmFtc30gZnJvbSAnLi4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHtUZXh0QnVmZmVyQ2FsbGJhY2t9IGZyb20gJy4vaW5zdGFuY2UvZXZlbnRzJ1xuaW1wb3J0IHtUVVBJQ29udHJvbERlZmluaXRpb259IGZyb20gJy4vaW5zdGFuY2UvY29udHJvbHMnXG5pbXBvcnQge0lQYXJhbVNwZWN9IGZyb20gJy4uL2NvbmZpZy1wYXJhbXMnXG5pbXBvcnQge1RUb29sdGlwSGFuZGxlcn0gZnJvbSAnLi9pbnN0YW5jZS90b29sdGlwcydcbmltcG9ydCB7VEV2ZW50UmFuZ2VDYWxsYmFja30gZnJvbSAnLi9pbnN0YW5jZS91dGlscydcbmltcG9ydCB7VFRvb2x0aXBIYW5kbGVyU3BlY30gZnJvbSAnLi9pbnN0YW5jZSdcblxuZXhwb3J0IGludGVyZmFjZSBJUmVnaXN0cmF0aW9uT3B0aW9ucyB7XG4gIG5hbWU6IHN0cmluZ1xuICBjb25zdW1lcj86IChpbnN0YW5jZTogVVBJSW5zdGFuY2UpID0+IERpc3Bvc2FibGUgfCB2b2lkXG4gIG1lbnU/OiBJTWVudURlZmluaXRpb25cbiAgbWVzc2FnZVR5cGVzPzogSVNldFR5cGVzUGFyYW1zXG4gIGV2ZW50cz86IHtcbiAgICBvbldpbGxTYXZlQnVmZmVyPzogVGV4dEJ1ZmZlckNhbGxiYWNrIHwgVGV4dEJ1ZmZlckNhbGxiYWNrW11cbiAgICBvbkRpZFNhdmVCdWZmZXI/OiBUZXh0QnVmZmVyQ2FsbGJhY2sgfCBUZXh0QnVmZmVyQ2FsbGJhY2tbXVxuICAgIG9uRGlkU3RvcENoYW5naW5nPzogVGV4dEJ1ZmZlckNhbGxiYWNrIHwgVGV4dEJ1ZmZlckNhbGxiYWNrW11cbiAgfVxuICBjb250cm9scz86IFRVUElDb250cm9sRGVmaW5pdGlvbltdXG4gIHBhcmFtcz86IHtbcGFyYW1OYW1lOiBzdHJpbmddOiBJUGFyYW1TcGVjPGFueT59XG4gIHRvb2x0aXBFdmVudD86IFRUb29sdGlwSGFuZGxlciB8IHtwcmlvcml0eT86IG51bWJlciwgaGFuZGxlcjogVFRvb2x0aXBIYW5kbGVyfVxufVxuXG5pbnRlcmZhY2UgSUV2ZW50UmFuZ2VQYXJhbXNJbnRlcm5hbCB7XG4gIGVkaXRvcj86IFRleHRFZGl0b3JcbiAgY29udHJvbGxlcjogYW55XG4gIGRldGFpbD86IGFueVxuICBldmVudFR5cGU/OiBURXZlbnRSYW5nZVR5cGVcbiAgcG9zOiBUUG9zaXRpb25cbn1cblxuZXhwb3J0IGNsYXNzIFVQSSB7XG4gIHByaXZhdGUgaW5zdGFuY2VzOiBNYXA8c3RyaW5nLCBVUElJbnN0YW5jZT5cbiAgcHJpdmF0ZSBkaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICBjb25zdHJ1Y3RvciAocHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyKSB7XG4gICAgdGhpcy5pbnN0YW5jZXMgPSBuZXcgTWFwKClcbiAgICB0aGlzLmRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucGx1Z2luTWFuYWdlci5vblNob3VsZFNob3dUb29sdGlwKHRoaXMuc2hvdWxkU2hvd1Rvb2x0aXAuYmluZCh0aGlzKSkpXG4gIH1cblxuICAvKipcbiAgQ2FsbCB0aGlzIGZ1bmN0aW9uIGluIGNvbnN1bWVyIHRvIGdldCBhY3R1YWwgaW50ZXJmYWNlXG5cbiAgQHBhcmFtIG5hbWU6IFBsdWdpbiBwYWNrYWdlIG5hbWVcbiAgQHBhcmFtIGNvbnN1bWVyOiBjYWxsYmFjayA6OiBVUElJbnN0YW5jZSAtPiAoKVxuICBAcmV0dXJucyB7RGlzcG9zYWJsZX1cbiAgKi9cbiAgcHVibGljIGNvbnN1bWUgKG9wdGlvbnM6IElSZWdpc3RyYXRpb25PcHRpb25zKTogRGlzcG9zYWJsZSB7XG4gICAgY29uc3Qge25hbWUsIG1lbnUsIG1lc3NhZ2VUeXBlcywgZXZlbnRzLCBjb250cm9scywgcGFyYW1zLCBjb25zdW1lciwgdG9vbHRpcEV2ZW50fSA9IG9wdGlvbnNcbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBVUElFcnJvcignbmFtZSBoYXMgdG8gYmUgc3BlY2lmaWVkIGZvciBVUEknKVxuICAgIH1cbiAgICBpZiAodGhpcy5pbnN0YW5jZXMuaGFzKG5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgVVBJRXJyb3IoYFBsdWdpbiAke25hbWV9IGFscmVhZHkgcmVnaXN0ZXJlZCB3aXRoIFVQSWApXG4gICAgfVxuICAgIGNvbnN0IGluc3RhbmNlID0gbmV3IFVQSUluc3RhbmNlKHRoaXMucGx1Z2luTWFuYWdlciwgbmFtZSwgdGhpcylcbiAgICB0aGlzLmluc3RhbmNlcy5zZXQobmFtZSwgaW5zdGFuY2UpXG4gICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcblxuICAgIGlmIChtZW51KSB7XG4gICAgICBkaXNwLmFkZChpbnN0YW5jZS5tZW51LnNldChtZW51KSlcbiAgICB9XG4gICAgaWYgKG1lc3NhZ2VUeXBlcykge1xuICAgICAgaW5zdGFuY2UubWVzc2FnZXMuc2V0VHlwZXMobWVzc2FnZVR5cGVzKSAvLyBUT0RPOiBNYWtlIGRpc3Bvc2FibGVcbiAgICB9XG4gICAgaWYgKGV2ZW50cykge1xuICAgICAgZm9yIChjb25zdCBrIGluIGV2ZW50cykge1xuICAgICAgICBpZiAoaW5zdGFuY2UuZXZlbnRzW2tdKSB7XG4gICAgICAgICAgbGV0IHY6IFRleHRCdWZmZXJDYWxsYmFjayB8IFRleHRCdWZmZXJDYWxsYmFja1tdID0gZXZlbnRzW2tdXG4gICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHYpKSB7IHYgPSBbdl0gfVxuICAgICAgICAgIGZvciAoY29uc3QgaSBvZiB2KSB7XG4gICAgICAgICAgICBkaXNwLmFkZChpbnN0YW5jZS5ldmVudHNba10oaSkpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0b29sdGlwRXZlbnQpIHtcbiAgICAgIGxldCBoYW5kbGVyOiBUVG9vbHRpcEhhbmRsZXIsIHByaW9yaXR5OiBudW1iZXIgfCB1bmRlZmluZWRcbiAgICAgIGlmICh0eXBlb2YgdG9vbHRpcEV2ZW50ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGhhbmRsZXIgPSB0b29sdGlwRXZlbnRcbiAgICAgICAgcHJpb3JpdHkgPSAxMDBcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgICh7aGFuZGxlciwgcHJpb3JpdHl9ID0gdG9vbHRpcEV2ZW50KVxuICAgICAgfVxuICAgICAgaWYgKCFwcmlvcml0eSkgeyBwcmlvcml0eSA9IDEwMCB9XG4gICAgICBkaXNwLmFkZChpbnN0YW5jZS50b29sdGlwcy5vblNob3VsZFNob3dUb29sdGlwKHByaW9yaXR5LCBoYW5kbGVyKSlcbiAgICB9XG4gICAgaWYgKGNvbnRyb2xzKSB7XG4gICAgICBmb3IgKGNvbnN0IGkgb2YgY29udHJvbHMpIHtcbiAgICAgICAgZGlzcC5hZGQoaW5zdGFuY2UuY29udHJvbHMuYWRkKGkpKVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAocGFyYW1zKSB7XG4gICAgICBkaXNwLmFkZChpbnN0YW5jZS5wYXJhbXMuYWRkKHBhcmFtcykpXG4gICAgfVxuXG4gICAgaWYgKGNvbnN1bWVyKSB7XG4gICAgICBjb25zdCBkID0gY29uc3VtZXIoaW5zdGFuY2UpXG4gICAgICBpZiAodHlwZW9mIGQgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGRpc3AuYWRkKGQpXG4gICAgICB9XG4gICAgfVxuXG4gICAgZGlzcC5hZGQobmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgdGhpcy5pbnN0YW5jZXMuZGVsZXRlKG5hbWUpXG4gICAgICBpbnN0YW5jZS5kZXN0cm95KClcbiAgICB9KSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICBwdWJsaWMgZGlzcG9zZSAoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgfVxuXG4gIHB1YmxpYyB3aXRoRXZlbnRSYW5nZTxUPiAoXG4gICAge2VkaXRvciwgZGV0YWlsLCBldmVudFR5cGUsIHBvcywgY29udHJvbGxlcn06IElFdmVudFJhbmdlUGFyYW1zSW50ZXJuYWwsXG4gICAgY2FsbGJhY2s6IFRFdmVudFJhbmdlQ2FsbGJhY2s8VD5cbiAgKSB7XG4gICAgaWYgKHBvcykgeyBwb3MgPSBQb2ludC5mcm9tT2JqZWN0KHBvcykgfVxuICAgIGlmICghZXZlbnRUeXBlKSB7IGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpIH1cbiAgICBpZiAoIWNvbnRyb2xsZXIgJiYgZWRpdG9yKSB7IGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpIH1cbiAgICBpZiAoIWNvbnRyb2xsZXIpIHsgcmV0dXJuIH1cblxuICAgIHJldHVybiBjYWxsYmFjayhjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UocG9zLCBldmVudFR5cGUpKVxuICB9XG5cbiAgcHVibGljIGdldEV2ZW50UmFuZ2UgKFxuICAgIHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3MsIGNvbnRyb2xsZXJ9OiBJRXZlbnRSYW5nZVBhcmFtc0ludGVybmFsXG4gICk6IHtwb3M6IFBvaW50LCBjcmFuZ2U6IFJhbmdlfSB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHBvcykgeyBwb3MgPSBQb2ludC5mcm9tT2JqZWN0KHBvcykgfVxuICAgIGlmICghZXZlbnRUeXBlKSB7IGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpIH1cbiAgICBpZiAoIWNvbnRyb2xsZXIgJiYgZWRpdG9yKSB7IGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpIH1cbiAgICBpZiAoIWNvbnRyb2xsZXIpIHsgcmV0dXJuIH1cblxuICAgIHJldHVybiBjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UocG9zLCBldmVudFR5cGUpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNob3VsZFNob3dUb29sdGlwIChcbiAgICB7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZX06IHtlZGl0b3I6IFRleHRFZGl0b3IsIHBvczogUG9pbnQsIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlfVxuICApIHtcbiAgICBjb25zdCBzdWJzOiBBcnJheTxUVG9vbHRpcEhhbmRsZXJTcGVjICYge3BsdWdpbk5hbWU6IHN0cmluZ30+ID0gW11cbiAgICBmb3IgKGNvbnN0IFtwbHVnaW5OYW1lLCBpbnN0XSBvZiB0aGlzLmluc3RhbmNlcy5lbnRyaWVzKCkpIHtcbiAgICAgIGZvciAoY29uc3QgdnMgb2YgaW5zdC50b29sdGlwRXZlbnRzLnZhbHVlcygpKSB7XG4gICAgICAgIHN1YnMucHVzaCh7cGx1Z2luTmFtZSwgLi4udnN9KVxuICAgICAgfVxuICAgIH1cbiAgICBzdWJzLnNvcnQoKGEsIGIpID0+IGIucHJpb3JpdHkgLSBhLnByaW9yaXR5KVxuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpXG4gICAgaWYgKCFjb250cm9sbGVyKSB7IHJldHVybiB9XG4gICAgZm9yIChjb25zdCB7cGx1Z2luTmFtZSwgaGFuZGxlcn0gb2Ygc3Vicykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZXZlbnRSYW5nZSA9IHRoaXMuZ2V0RXZlbnRSYW5nZSh7Y29udHJvbGxlciwgcG9zLCBldmVudFR5cGV9KVxuICAgICAgICBpZiAoIWV2ZW50UmFuZ2UpIHsgY29udGludWUgfVxuICAgICAgICBjb25zdCB7Y3JhbmdlLCBwb3M6IG5ld1Bvc30gPSBldmVudFJhbmdlXG4gICAgICAgIGNvbnN0IHR0ID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKGhhbmRsZXIoZWRpdG9yLCBjcmFuZ2UsIGV2ZW50VHlwZSkpXG4gICAgICAgIGlmICh0dCkge1xuICAgICAgICAgIGNvbnN0IHtyYW5nZSwgdGV4dH0gPSB0dFxuICAgICAgICAgIGNvbnRyb2xsZXIudG9vbHRpcHMuc2hvdyhyYW5nZSwgTWVzc2FnZU9iamVjdC5mcm9tT2JqZWN0KHRleHQpLCB7dHlwZTogZXZlbnRUeXBlLCBzdWJ0eXBlOiAnZXh0ZXJuYWwnfSlcbiAgICAgICAgICBicmVha1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnRpbnVlXG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUubWVzc2FnZSkge1xuICAgICAgICAgIGNvbnNvbGUud2FybihlKVxuICAgICAgICAgIGUgPSB7XG4gICAgICAgICAgICBzdGF0dXM6ICd3YXJuaW5nJyxcbiAgICAgICAgICAgIGRldGFpbDogZS5tZXNzYWdlXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghZS5pZ25vcmUpIHtcbiAgICAgICAgICBjb250cm9sbGVyLnRvb2x0aXBzLmhpZGUoe3R5cGU6IGV2ZW50VHlwZX0pXG4gICAgICAgICAgdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFZpZXcuYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lLCBlKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=