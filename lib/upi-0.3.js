var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("./utils");
class UPIError extends Error {
    constructor(message) {
        super(message);
        Object.defineProperty(this, "name", { value: this.constructor.name });
        Object.defineProperty(this, "message", { value: message });
        Error.captureStackTrace(this, this.constructor);
    }
}
exports.UPIError = UPIError;
class UPI {
    constructor(pluginManager) {
        this.pluginManager = pluginManager;
        this.instances = new Map;
        this.disposables = new atom_1.CompositeDisposable;
        this.disposables.add(this.pluginManager.onShouldShowTooltip(this.shouldShowTooltip.bind(this)));
    }
    shouldShowTooltip({ editor, pos, eventType }) {
        return __awaiter(this, void 0, void 0, function* () {
            let subs = [];
            for (const [pluginName, inst] of this.instances.entries()) {
                for (const vs of inst.tooltipEvents.values()) {
                    subs.push(Object.assign({ pluginName }, vs));
                }
            }
            subs.sort((a, b) => b.priority - a.priority);
            const controller = this.pluginManager.controller(editor);
            for (const { pluginName, handler } of subs) {
                try {
                    const eventRange = this.getEventRange({ controller, pos, eventType });
                    if (!eventRange)
                        continue;
                    const { crange, pos: newPos } = eventRange;
                    let tt = yield Promise.resolve(handler(editor, crange, eventType));
                    if (tt) {
                        const { range, text } = tt;
                        controller.showTooltip(newPos, range, text, { eventType, subtype: 'external' });
                    }
                    else {
                        continue;
                    }
                }
                catch (e) {
                    if (e.message) {
                        console.warn(e);
                        e = {
                            status: 'warning',
                            detail: e.message
                        };
                    }
                    if (!e.ignore) {
                        controller.hideTooltip({ eventType });
                        this.pluginManager.outputView.backendStatus(pluginName, e);
                    }
                }
            }
        });
    }
    consume(options = {}) {
        const { name, menu, messageTypes, events, controls, params, consumer, tooltipEvent } = options;
        if (!name)
            throw new UPIError("name has to be specified for UPI");
        if (this.instances.has(name))
            throw new UPIError(`Plugin ${name} already registered with UPI`);
        const instance = new UPIInstance(this.pluginManager, name, this);
        this.instances.set(name, instance);
        if (menu)
            instance.menu.set(menu);
        if (messageTypes)
            instance.messages.setTypes(messageTypes);
        if (events)
            for (const k of Object.keys(events)) {
                let v = events[k];
                if (!Array.isArray(v))
                    v = [v];
                for (const i of v)
                    instance.events[k](i);
            }
        if (tooltipEvent) {
            let { priority, handler } = tooltipEvent;
            if (!handler) {
                handler = tooltipEvent;
            }
            if (!priority)
                priority = 100;
            instance.tooltips.onShouldShowTooltip(priority, handler);
        }
        if (controls)
            for (const i of controls)
                instance.controls.add(i);
        if (params)
            for (const i of params)
                instance.params.add(i);
        consumer(instance);
        const disp = new atom_1.Disposable(() => {
            this.instances.delete(name);
            instance.destroy();
        });
        this.disposables.add(disp);
        return disp;
    }
    dispose() {
        this.disposables.dispose();
    }
    withEventRange({ editor, detail, eventType, pos, controller }, callback) {
        if (pos)
            pos = atom_1.Point.fromObject(pos);
        if (!eventType)
            eventType = utils_1.getEventType(detail);
        if (!controller)
            controller = this.pluginManager.controller(editor);
        if (!controller)
            return;
        callback(controller.getEventRange(pos), eventType);
    }
    getEventRange({ editor, detail, eventType, pos, controller }) {
        if (pos)
            pos = atom_1.Point.fromObject(pos);
        if (!eventType)
            eventType = utils_1.getEventType(detail);
        if (!controller)
            controller = this.pluginManager.controller(editor);
        if (!controller)
            return;
        return controller.getEventRange(pos);
    }
}
exports.UPI = UPI;
class UPIInstance {
    constructor(pluginManager, pluginName, { withEventRange }) {
        this.disposables = new atom_1.CompositeDisposable;
        this.tooltipEvents = new Set;
        this.destroyed = false;
        this.menu = {
            set({ label, menu }) {
                const menuDisp = atom.menu.add([{
                        label: utils_1.MainMenuLabel,
                        submenu: [{ label: label, submenu: menu }]
                    }]);
                this.disposables.add(menuDisp);
                return menuDisp;
            }
        };
        this.messages = {
            status(status) {
                pluginManager.outputView.backendStatus(pluginName, status);
            },
            add(messages, types) {
                messages = messages.map((m) => {
                    if (m.position)
                        m.position = atom_1.Point.fromObject(m.position);
                    return m;
                });
                pluginManager.checkResults.appendResults(messages, types);
            },
            set(messages, types) {
                messages = messages.map((m) => {
                    if (m.position)
                        m.position = atom_1.Point.fromObject(m.position);
                    return m;
                });
                pluginManager.checkResults.setResults(messages, types);
            },
            clear(types) {
                pluginManager.checkResults.setResults([], types);
            },
            setTypes(types) {
                for (const type in types) {
                    const opts = types[type];
                    pluginManager.outputView.createTab(type, opts);
                }
            },
        };
        this.tooltips = {
            show({ editor, pos, eventType, detail, tooltip }) {
                const controller = pluginManager.controller(editor);
                withEventRange({ controller, pos, detail, eventType }, ({ crange, pos, eventType }) => {
                    Promise.resolve(tooltip(crange)).then(({ range, text, persistOnCursorMove }) => controller.showTooltip(pos, range, text, { eventType, subtype: 'external', persistOnCursorMove }))
                        .catch((status = { status: 'warning' }) => {
                        if (status.message) {
                            console.warn(status);
                            status = { status: 'warning' };
                        }
                        if (!status.ignore) {
                            controller.hideTooltip({ eventType });
                            this.messages.status(status);
                        }
                    });
                });
            },
            onShouldShowTooltip(...args) {
                if (args.length < 2) {
                    args.unshift(100);
                }
                const [priority, handler] = args;
                const obj = { priority, handler };
                this.tooltipEvents.add(obj);
                return new atom_1.Disposable(() => this.tooltipEvents.delete(obj));
            }
        };
        this.events = {
            onWillSaveBuffer(callback) {
                const disp = pluginManager.onWillSaveBuffer(callback);
                this.disposables.add(disp);
                return disp;
            },
            onDidSaveBuffer(callback) {
                const disp = pluginManager.onDidSaveBuffer(callback);
                this.disposables.add(disp);
                return disp;
            },
            onDidStopChanging(callback) {
                const disp = pluginManager.onDidStopChanging(callback);
                this.disposables.add(disp);
                return disp;
            }
        };
        this.controls = {
            add({ element, opts }) {
                return pluginManager.outputView.addPanelControl(element, opts);
            }
        };
        this.params = {
            add(spec) {
                return pluginManager.addConfigParam(pluginName, spec);
            },
            get(...args) {
                if (args.length < 2) {
                    args.unshift(pluginName);
                }
                return pluginManager.getConfigParam(...args);
            },
            set(...args) {
                if (args.length < 3) {
                    args.unshift(pluginName);
                }
                return pluginManager.setConfigParam(...args);
            }
        };
        this.utils = { withEventRange };
    }
    destroy() {
        this.disposables.dispose();
        this.tooltipEvents.clear();
        Object.getOwnPropertyNames(this).forEach((p) => {
            this[p] = null;
        });
        this.destroyed = true;
    }
    check() {
        if (this.destroyed)
            throw new UPIError('This UPI interface was destroyed');
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBpLTAuMy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy91cGktMC4zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLCtCQUFtRjtBQUNuRixtQ0FBbUQ7QUFFbkQsY0FBc0IsU0FBUSxLQUFLO0lBQ2pDLFlBQVksT0FBTztRQUNqQixLQUFLLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDZCxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxNQUFNLEVBQ2hDLEVBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFDLENBQUMsQ0FBQTtRQUNqQyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQ25DLEVBQUMsS0FBSyxFQUFFLE9BQU8sRUFBQyxDQUFDLENBQUE7UUFDbkIsS0FBSyxDQUFDLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUE7SUFDakQsQ0FBQztDQUNGO0FBVEQsNEJBU0M7QUFFRDtJQUdFLFlBQW9CLGFBQWE7UUFBYixrQkFBYSxHQUFiLGFBQWEsQ0FBQTtRQUMvQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxDQUFBO1FBQ3hCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSwwQkFBbUIsQ0FBQTtRQUMxQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ2pHLENBQUM7SUFFYSxpQkFBaUIsQ0FBQyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUErRDs7WUFDcEgsSUFBSSxJQUFJLEdBQXNELEVBQUUsQ0FBQTtZQUNoRSxHQUFHLENBQUEsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxT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QUM7Z0JBQ0QsTUFBTSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQTtZQUM5QyxDQUFDO1lBQ0QsR0FBRyxDQUFFLEdBQUcsSUFBSTtnQkFDVixFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ25CLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7Z0JBQzFCLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQTtZQUM5QyxDQUFDO1NBQ0YsQ0FBQTtRQUVELElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBQyxjQUFjLEVBQUMsQ0FBQTtJQUMvQixDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUE7UUFDMUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsQ0FBQTtRQUMxQixNQUFNLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUN6QyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFBO1FBQ2hCLENBQUMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7SUFDdkIsQ0FBQztJQUVELEtBQUs7UUFDSCxFQUFFLENBQUEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ2hCLE1BQU0sSUFBSSxRQUFRLENBQUMsa0NBQWtDLENBQUMsQ0FBQTtRQUN4RCxNQUFNLENBQUMsSUFBSSxDQUFBO0lBQ2IsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlLCBQb2ludCwgRGlzcG9zYWJsZSwgVGV4dEJ1ZmZlciwgVGV4dEVkaXRvcn0gZnJvbSAnYXRvbSdcbmltcG9ydCB7TWFpbk1lbnVMYWJlbCwgZ2V0RXZlbnRUeXBlfSBmcm9tICcuL3V0aWxzJ1xuXG5leHBvcnQgY2xhc3MgVVBJRXJyb3IgZXh0ZW5kcyBFcnJvciB7XG4gIGNvbnN0cnVjdG9yKG1lc3NhZ2UpIHtcbiAgICBzdXBlcihtZXNzYWdlKVxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBcIm5hbWVcIixcbiAgICAgIHt2YWx1ZTogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lfSlcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgXCJtZXNzYWdlXCIsXG4gICAgICB7dmFsdWU6IG1lc3NhZ2V9KVxuICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIHRoaXMuY29uc3RydWN0b3IpXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFVQSSB7XG4gIGluc3RhbmNlczogTWFwPHN0cmluZywgVVBJSW5zdGFuY2U+XG4gIGRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcGx1Z2luTWFuYWdlcikge1xuICAgIHRoaXMuaW5zdGFuY2VzID0gbmV3IE1hcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMucGx1Z2luTWFuYWdlci5vblNob3VsZFNob3dUb29sdGlwKHRoaXMuc2hvdWxkU2hvd1Rvb2x0aXAuYmluZCh0aGlzKSkpXG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNob3VsZFNob3dUb29sdGlwKHtlZGl0b3IsIHBvcywgZXZlbnRUeXBlfToge2VkaXRvcjogVGV4dEVkaXRvciwgcG9zOiBQb2ludCwgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGV9KSB7XG4gICAgbGV0IHN1YnM6IEFycmF5PFRUb29sdGlwSGFuZGxlclNwZWMgJiB7cGx1Z2luTmFtZTogc3RyaW5nfT4gPSBbXVxuICAgIGZvcihjb25zdCBbcGx1Z2luTmFtZSwgaW5zdF0gb2YgdGhpcy5pbnN0YW5jZXMuZW50cmllcygpKSB7XG4gICAgICBmb3IoY29uc3QgdnMgb2YgaW5zdC50b29sdGlwRXZlbnRzLnZhbHVlcygpKSB7XG4gICAgICAgIHN1YnMucHVzaCh7cGx1Z2luTmFtZSwgLi4udnN9KVxuICAgICAgfVxuICAgIH1cbiAgICBzdWJzLnNvcnQoKGEsIGIpID0+IGIucHJpb3JpdHkgLSBhLnByaW9yaXR5KVxuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpXG4gICAgZm9yIChjb25zdCB7cGx1Z2luTmFtZSwgaGFuZGxlcn0gb2Ygc3Vicykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZXZlbnRSYW5nZSA9IHRoaXMuZ2V0RXZlbnRSYW5nZSh7Y29udHJvbGxlciwgcG9zLCBldmVudFR5cGV9KVxuICAgICAgICBpZiAoIWV2ZW50UmFuZ2UpIGNvbnRpbnVlXG4gICAgICAgIGNvbnN0IHtjcmFuZ2UsIHBvczogbmV3UG9zfSA9IGV2ZW50UmFuZ2VcbiAgICAgICAgbGV0IHR0ID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKGhhbmRsZXIoZWRpdG9yLCBjcmFuZ2UsIGV2ZW50VHlwZSkpXG4gICAgICAgIGlmICh0dCkge1xuICAgICAgICAgIGNvbnN0IHtyYW5nZSwgdGV4dH0gPSB0dFxuICAgICAgICAgIGNvbnRyb2xsZXIuc2hvd1Rvb2x0aXAobmV3UG9zLCByYW5nZSwgdGV4dCwge2V2ZW50VHlwZSwgc3VidHlwZTogJ2V4dGVybmFsJ30pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29udGludWVcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBpZiAoZS5tZXNzYWdlKSB7XG4gICAgICAgICAgY29uc29sZS53YXJuKGUpXG4gICAgICAgICAgZSA9IHtcbiAgICAgICAgICAgIHN0YXR1czogJ3dhcm5pbmcnLFxuICAgICAgICAgICAgZGV0YWlsOiBlLm1lc3NhZ2VcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFlLmlnbm9yZSkge1xuICAgICAgICAgIGNvbnRyb2xsZXIuaGlkZVRvb2x0aXAoe2V2ZW50VHlwZX0pXG4gICAgICAgICAgdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFZpZXcuYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lLCBlKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cblxuICAvKipcbiAgQ2FsbCB0aGlzIGZ1bmN0aW9uIGluIGNvbnN1bWVyIHRvIGdldCBhY3R1YWwgaW50ZXJmYWNlXG5cbiAgQHBhcmFtIG5hbWU6IFBsdWdpbiBwYWNrYWdlIG5hbWVcbiAgQHBhcmFtIGNvbnN1bWVyOiBjYWxsYmFjayA6OiBVUElJbnN0YW5jZSAtPiAoKVxuICBAcmV0dXJucyB7RGlzcG9zYWJsZX1cbiAgKi9cbiAgcHVibGljIGNvbnN1bWUob3B0aW9uczogYW55ID0ge30pIHtcbiAgICBjb25zdCB7bmFtZSwgbWVudSwgbWVzc2FnZVR5cGVzLCBldmVudHMsIGNvbnRyb2xzLCBwYXJhbXMsIGNvbnN1bWVyLCB0b29sdGlwRXZlbnR9ID0gb3B0aW9uc1xuICAgIGlmICghbmFtZSlcbiAgICAgIHRocm93IG5ldyBVUElFcnJvcihcIm5hbWUgaGFzIHRvIGJlIHNwZWNpZmllZCBmb3IgVVBJXCIpXG4gICAgaWYodGhpcy5pbnN0YW5jZXMuaGFzKG5hbWUpKVxuICAgICAgdGhyb3cgbmV3IFVQSUVycm9yKGBQbHVnaW4gJHtuYW1lfSBhbHJlYWR5IHJlZ2lzdGVyZWQgd2l0aCBVUElgKVxuICAgIGNvbnN0IGluc3RhbmNlID0gbmV3IFVQSUluc3RhbmNlKHRoaXMucGx1Z2luTWFuYWdlciwgbmFtZSwgdGhpcylcbiAgICB0aGlzLmluc3RhbmNlcy5zZXQobmFtZSwgaW5zdGFuY2UpXG5cbiAgICBpZiAobWVudSlcbiAgICAgIGluc3RhbmNlLm1lbnUuc2V0KG1lbnUpXG4gICAgaWYgKG1lc3NhZ2VUeXBlcylcbiAgICAgIGluc3RhbmNlLm1lc3NhZ2VzLnNldFR5cGVzKG1lc3NhZ2VUeXBlcylcbiAgICBpZiAoZXZlbnRzKVxuICAgICAgZm9yIChjb25zdCBrIG9mIE9iamVjdC5rZXlzKGV2ZW50cykpIHtcbiAgICAgICAgbGV0IHYgPSBldmVudHNba11cbiAgICAgICAgaWYoIUFycmF5LmlzQXJyYXkodikpIHYgPSBbdl1cbiAgICAgICAgZm9yIChjb25zdCBpIG9mIHYpXG4gICAgICAgICAgaW5zdGFuY2UuZXZlbnRzW2tdKGkpXG4gICAgICB9XG4gICAgaWYgKHRvb2x0aXBFdmVudCkge1xuICAgICAgbGV0IHtwcmlvcml0eSwgaGFuZGxlcn0gPSB0b29sdGlwRXZlbnRcbiAgICAgIGlmICghaGFuZGxlcikge1xuICAgICAgICBoYW5kbGVyID0gdG9vbHRpcEV2ZW50XG4gICAgICB9XG4gICAgICBpZiAoIXByaW9yaXR5KSBwcmlvcml0eSA9IDEwMFxuICAgICAgaW5zdGFuY2UudG9vbHRpcHMub25TaG91bGRTaG93VG9vbHRpcChwcmlvcml0eSwgaGFuZGxlcilcbiAgICB9XG4gICAgaWYgKGNvbnRyb2xzKVxuICAgICAgZm9yIChjb25zdCBpIG9mIGNvbnRyb2xzKVxuICAgICAgICBpbnN0YW5jZS5jb250cm9scy5hZGQoaSlcbiAgICBpZiAocGFyYW1zKVxuICAgICAgZm9yIChjb25zdCBpIG9mIHBhcmFtcylcbiAgICAgICAgaW5zdGFuY2UucGFyYW1zLmFkZChpKVxuXG4gICAgY29uc3VtZXIoaW5zdGFuY2UpXG5cbiAgICBjb25zdCBkaXNwID0gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgdGhpcy5pbnN0YW5jZXMuZGVsZXRlKG5hbWUpXG4gICAgICBpbnN0YW5jZS5kZXN0cm95KClcbiAgICB9KVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIGRpc3Bvc2UgKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXG4gIH1cblxuICB3aXRoRXZlbnRSYW5nZSAoe2VkaXRvciwgZGV0YWlsLCBldmVudFR5cGUsIHBvcywgY29udHJvbGxlcn06IFRFdmVudFJhbmdlUGFyYW1zSW50ZXJuYWwsIGNhbGxiYWNrOiBURXZlbnRSYW5nZUNhbGxiYWNrKSB7XG4gICAgaWYgKHBvcykgcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpXG4gICAgaWYgKCFldmVudFR5cGUpIGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpXG4gICAgaWYgKCFjb250cm9sbGVyKSBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIGlmICghY29udHJvbGxlcikgcmV0dXJuXG5cbiAgICBjYWxsYmFjayAoY29udHJvbGxlci5nZXRFdmVudFJhbmdlKHBvcyksIGV2ZW50VHlwZSlcbiAgfVxuXG4gIGdldEV2ZW50UmFuZ2Uoe2VkaXRvciwgZGV0YWlsLCBldmVudFR5cGUsIHBvcywgY29udHJvbGxlcn06IFRFdmVudFJhbmdlUGFyYW1zSW50ZXJuYWwpIDoge3BvczogUG9pbnQsIGNyYW5nZTogUmFuZ2V9IHwgdW5kZWZpbmVkIHtcbiAgICBpZiAocG9zKSBwb3MgPSBQb2ludC5mcm9tT2JqZWN0KHBvcylcbiAgICBpZiAoIWV2ZW50VHlwZSkgZXZlbnRUeXBlID0gZ2V0RXZlbnRUeXBlKGRldGFpbClcbiAgICBpZiAoIWNvbnRyb2xsZXIpIGNvbnRyb2xsZXIgPSB0aGlzLnBsdWdpbk1hbmFnZXIuY29udHJvbGxlcihlZGl0b3IpXG4gICAgaWYgKCFjb250cm9sbGVyKSByZXR1cm5cblxuICAgIHJldHVybiBjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UocG9zKVxuICB9XG59XG5cbmludGVyZmFjZSBURXZlbnRSYW5nZVBhcmFtc0ludGVybmFsIHtcbiAgZWRpdG9yPzogVGV4dEVkaXRvclxuICBjb250cm9sbGVyOiBhbnlcbiAgZGV0YWlsPzogYW55XG4gIGV2ZW50VHlwZTogVEV2ZW50UmFuZ2VUeXBlXG4gIHBvczogVFBvc2l0aW9uXG59XG5cbmNsYXNzIFVQSUluc3RhbmNlIHtcbiAgcHVibGljIG1lbnU6IElVUElNZW51XG4gIHB1YmxpYyBtZXNzYWdlczogSVVQSU1lc3NhZ2VzXG4gIHB1YmxpYyBldmVudHM6IElVUElFdmVudHNcbiAgcHVibGljIHRvb2x0aXBzOiBJVVBJVG9vbHRpcHNcbiAgcHVibGljIGNvbnRyb2xzOiBJVVBJQ29udHJvbHNcbiAgcHVibGljIHBhcmFtczogSVVQSVBhcmFtc1xuICBwdWJsaWMgdXRpbHM6IElVUElVdGlsc1xuICBwdWJsaWMgdG9vbHRpcEV2ZW50czogU2V0PFRUb29sdGlwSGFuZGxlclNwZWM+XG4gIHByaXZhdGUgZGlzcG9zYWJsZXM6IENvbXBvc2l0ZURpc3Bvc2FibGVcbiAgcHJpdmF0ZSBkZXN0cm95ZWQ6IGJvb2xlYW5cbiAgY29uc3RydWN0b3IocGx1Z2luTWFuYWdlciwgcGx1Z2luTmFtZSwge3dpdGhFdmVudFJhbmdlfSkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZVxuICAgIHRoaXMudG9vbHRpcEV2ZW50cyA9IG5ldyBTZXRcbiAgICB0aGlzLmRlc3Ryb3llZCA9IGZhbHNlXG5cbiAgICB0aGlzLm1lbnUgPSB7XG4gICAgICBzZXQoe2xhYmVsLCBtZW51fSkge1xuICAgICAgICBjb25zdCBtZW51RGlzcCA9IGF0b20ubWVudS5hZGQoW3tcbiAgICAgICAgICBsYWJlbDogTWFpbk1lbnVMYWJlbCxcbiAgICAgICAgICBzdWJtZW51OiBbIHtsYWJlbDogbGFiZWwsIHN1Ym1lbnU6IG1lbnV9IF1cbiAgICAgICAgfV0pXG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKG1lbnVEaXNwKVxuICAgICAgICByZXR1cm4gbWVudURpc3BcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5tZXNzYWdlcyA9IHtcbiAgICAgIHN0YXR1cyAoc3RhdHVzKSB7XG4gICAgICAgIHBsdWdpbk1hbmFnZXIub3V0cHV0Vmlldy5iYWNrZW5kU3RhdHVzKHBsdWdpbk5hbWUsIHN0YXR1cylcbiAgICAgIH0sXG4gICAgICBhZGQgKG1lc3NhZ2VzLCB0eXBlcykge1xuICAgICAgICBtZXNzYWdlcyA9IG1lc3NhZ2VzLm1hcCgobSkgPT4ge1xuICAgICAgICAgIGlmIChtLnBvc2l0aW9uKVxuICAgICAgICAgICAgbS5wb3NpdGlvbiA9IFBvaW50LmZyb21PYmplY3QobS5wb3NpdGlvbilcbiAgICAgICAgICByZXR1cm4gbVxuICAgICAgICB9KVxuICAgICAgICBwbHVnaW5NYW5hZ2VyLmNoZWNrUmVzdWx0cy5hcHBlbmRSZXN1bHRzKG1lc3NhZ2VzLCB0eXBlcylcbiAgICAgIH0sXG4gICAgICBzZXQobWVzc2FnZXMsIHR5cGVzKSB7XG4gICAgICAgIG1lc3NhZ2VzID0gbWVzc2FnZXMubWFwKChtKSA9PiB7XG4gICAgICAgICAgaWYgKG0ucG9zaXRpb24pXG4gICAgICAgICAgICBtLnBvc2l0aW9uID0gUG9pbnQuZnJvbU9iamVjdChtLnBvc2l0aW9uKVxuICAgICAgICAgIHJldHVybiBtXG4gICAgICAgIH0pXG4gICAgICAgIHBsdWdpbk1hbmFnZXIuY2hlY2tSZXN1bHRzLnNldFJlc3VsdHMobWVzc2FnZXMsIHR5cGVzKVxuICAgICAgfSxcbiAgICAgIGNsZWFyICh0eXBlcykge1xuICAgICAgICBwbHVnaW5NYW5hZ2VyLmNoZWNrUmVzdWx0cy5zZXRSZXN1bHRzKFtdLCB0eXBlcylcbiAgICAgIH0sXG4gICAgICBzZXRUeXBlcyAodHlwZXMpIHtcbiAgICAgICAgZm9yIChjb25zdCB0eXBlIGluIHR5cGVzKSB7XG4gICAgICAgICAgY29uc3Qgb3B0cyA9IHR5cGVzW3R5cGVdXG4gICAgICAgICAgcGx1Z2luTWFuYWdlci5vdXRwdXRWaWV3LmNyZWF0ZVRhYih0eXBlLCBvcHRzKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIH1cblxuICAgIHRoaXMudG9vbHRpcHMgPSB7XG4gICAgICBzaG93ICh7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZSwgZGV0YWlsLCB0b29sdGlwfSkge1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gcGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcilcbiAgICAgICAgd2l0aEV2ZW50UmFuZ2Uoe2NvbnRyb2xsZXIsIHBvcywgZGV0YWlsLCBldmVudFR5cGV9LCAoe2NyYW5nZSwgcG9zLCBldmVudFR5cGV9KSA9PiB7XG4gICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKHRvb2x0aXAoY3JhbmdlKSkudGhlbigoe3JhbmdlLCB0ZXh0LCBwZXJzaXN0T25DdXJzb3JNb3ZlfSkgPT5cbiAgICAgICAgICAgIGNvbnRyb2xsZXIuc2hvd1Rvb2x0aXAocG9zLCByYW5nZSwgdGV4dCwge2V2ZW50VHlwZSwgc3VidHlwZTogJ2V4dGVybmFsJywgcGVyc2lzdE9uQ3Vyc29yTW92ZX0pKVxuICAgICAgICAgIC5jYXRjaCgoc3RhdHVzID0ge3N0YXR1czogJ3dhcm5pbmcnfSkgPT4ge1xuICAgICAgICAgICAgaWYgKHN0YXR1cy5tZXNzYWdlKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUud2FybihzdGF0dXMpXG4gICAgICAgICAgICAgIHN0YXR1cyA9IHtzdGF0dXM6ICd3YXJuaW5nJ31cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghc3RhdHVzLmlnbm9yZSkge1xuICAgICAgICAgICAgICBjb250cm9sbGVyLmhpZGVUb29sdGlwKHtldmVudFR5cGV9KVxuICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VzLnN0YXR1cyhzdGF0dXMpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgIH0sXG4gICAgICBvblNob3VsZFNob3dUb29sdGlwICguLi5hcmdzKSB7XG4gICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICBhcmdzLnVuc2hpZnQoMTAwKVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IFtwcmlvcml0eSwgaGFuZGxlcl0gPSBhcmdzXG4gICAgICAgIGNvbnN0IG9iaiA9IHtwcmlvcml0eSwgaGFuZGxlcn1cbiAgICAgICAgdGhpcy50b29sdGlwRXZlbnRzLmFkZChvYmopXG4gICAgICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoKSA9PiB0aGlzLnRvb2x0aXBFdmVudHMuZGVsZXRlKG9iaikpXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZXZlbnRzID0ge1xuICAgICAgb25XaWxsU2F2ZUJ1ZmZlciAoY2FsbGJhY2spIHtcbiAgICAgICAgY29uc3QgZGlzcCA9IHBsdWdpbk1hbmFnZXIub25XaWxsU2F2ZUJ1ZmZlcihjYWxsYmFjaylcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICAgICAgcmV0dXJuIGRpc3BcbiAgICAgIH0sXG4gICAgICBvbkRpZFNhdmVCdWZmZXIoY2FsbGJhY2spIHtcbiAgICAgICAgY29uc3QgZGlzcCA9IHBsdWdpbk1hbmFnZXIub25EaWRTYXZlQnVmZmVyKGNhbGxiYWNrKVxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgICAgICByZXR1cm4gZGlzcFxuICAgICAgfSxcbiAgICAgIG9uRGlkU3RvcENoYW5naW5nKGNhbGxiYWNrKSB7XG4gICAgICAgIGNvbnN0IGRpc3AgPSBwbHVnaW5NYW5hZ2VyLm9uRGlkU3RvcENoYW5naW5nKGNhbGxiYWNrKVxuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgICAgICByZXR1cm4gZGlzcFxuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmNvbnRyb2xzID0ge1xuICAgICAgYWRkICh7ZWxlbWVudCwgb3B0c30pIHtcbiAgICAgICAgcmV0dXJuIHBsdWdpbk1hbmFnZXIub3V0cHV0Vmlldy5hZGRQYW5lbENvbnRyb2woZWxlbWVudCwgb3B0cylcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5wYXJhbXMgPSB7XG4gICAgICBhZGQgKHNwZWMpIHtcbiAgICAgICAgcmV0dXJuIHBsdWdpbk1hbmFnZXIuYWRkQ29uZmlnUGFyYW0ocGx1Z2luTmFtZSwgc3BlYylcbiAgICAgIH0sXG4gICAgICBnZXQgKC4uLmFyZ3MpIHtcbiAgICAgICAgaWYoYXJncy5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgYXJncy51bnNoaWZ0KHBsdWdpbk5hbWUpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBsdWdpbk1hbmFnZXIuZ2V0Q29uZmlnUGFyYW0oLi4uYXJncylcbiAgICAgIH0sXG4gICAgICBzZXQgKC4uLmFyZ3MpIHtcbiAgICAgICAgaWYoYXJncy5sZW5ndGggPCAzKSB7XG4gICAgICAgICAgYXJncy51bnNoaWZ0KHBsdWdpbk5hbWUpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBsdWdpbk1hbmFnZXIuc2V0Q29uZmlnUGFyYW0oLi4uYXJncylcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnV0aWxzID0ge3dpdGhFdmVudFJhbmdlfVxuICB9XG5cbiAgZGVzdHJveSAoKSB7XG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLnRvb2x0aXBFdmVudHMuY2xlYXIoKVxuICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRoaXMpLmZvckVhY2goKHApID0+IHtcbiAgICAgIHRoaXNbcF0gPSBudWxsXG4gICAgfSlcbiAgICB0aGlzLmRlc3Ryb3llZCA9IHRydWVcbiAgfVxuXG4gIGNoZWNrICgpIHtcbiAgICBpZih0aGlzLmRlc3Ryb3llZClcbiAgICAgIHRocm93IG5ldyBVUElFcnJvcignVGhpcyBVUEkgaW50ZXJmYWNlIHdhcyBkZXN0cm95ZWQnKVxuICAgIHJldHVybiB0aGlzXG4gIH1cbn1cblxuZGVjbGFyZSBpbnRlcmZhY2UgSVVQSU1lbnUge1xuICAvKipcbiAgQWRkcyBuZXcgc3VtYmVudSB0byAnSGFza2VsbCBJREUnIG1lbnUgaXRlbVxuXG4gIEBwYXJhbSBuYW1lIC0tIHN1Ym1lbnUgbGFiZWwsIHNob3VsZCBiZSBkZXNjcmlwdGl2ZSBvZiBhIHBhY2thZ2VcbiAgQHBhcmFtIG1lbnUgLS0gQXRvbSBtZW51IG9iamVjdFxuXG4gIEByZXR1cm5zIERpc3Bvc2FibGUuXG4gICovXG4gIHNldChvcHRpb25zOiB7bGFiZWw6IHN0cmluZywgbWVudTogYW55W119KSA6IERpc3Bvc2FibGVcbn1cblxuZGVjbGFyZSBpbnRlcmZhY2UgSVVQSU5vcm1hbFN0YXR1cyB7XG4gIHN0YXR1czogJ3JlYWR5JyB8ICdlcnJvcicgfCAnd2FybmluZydcbn1cblxuZGVjbGFyZSBpbnRlcmZhY2UgSVVQSVByb2dyZXNzU3RhdHVzIHtcbiAgc3RhdHVzOiAncHJvZ3Jlc3MnXG4gIHByb2dyZXNzPzogbnVtYmVyXG59XG5cbmRlY2xhcmUgdHlwZSBJVVBJU3RhdHVzID0gSVVQSU5vcm1hbFN0YXR1cyB8IElVUElQcm9ncmVzc1N0YXR1c1xuXG5kZWNsYXJlIGludGVyZmFjZSBJVVBJTWVzc2FnZVRleHQge1xuICB0ZXh0OiBzdHJpbmdcbiAgaGlnaGxpZ2h0ZXI/OiBzdHJpbmdcbn1cblxuZGVjbGFyZSBpbnRlcmZhY2UgSVVQSU1lc3NhZ2VIVE1MIHtcbiAgaHRtbDogc3RyaW5nXG59XG5cbmRlY2xhcmUgdHlwZSBUU2V2ZXJpdHkgPSAnZXJyb3InIHwgJ3dhcm5pbmcnIHwgJ2xpbnQnIHwgc3RyaW5nXG5kZWNsYXJlIHR5cGUgVFBvc2l0aW9uID0gUG9pbnQgfCBbbnVtYmVyLCBudW1iZXJdIHwge3JvdzogbnVtYmVyLCBjb2x1bW46IG51bWJlcn1cbmRlY2xhcmUgdHlwZSBUVVBJVGV4dCA9IFN0cmluZyB8IElVUElNZXNzYWdlVGV4dCB8IElVUElNZXNzYWdlSFRNTFxuXG5kZWNsYXJlIGludGVyZmFjZSBJVVBJTWVzc2FnZSB7XG4gIHVyaT86IHN0cmluZ1xuICBwb3NpdGlvbj86IFRQb3NpdGlvblxuICBtZXNzYWdlOiBUVVBJVGV4dFxuICBzZXZlcml0eTogVFNldmVyaXR5XG59XG5cbmRlY2xhcmUgaW50ZXJmYWNlIElTZXZlcml0eVRhYkRlZmluaXRpb24ge1xuICB1cmlGaWx0ZXI/OiBib29sZWFuXG4gIGF1dG9TY3JvbGw/OiBib29sZWFuXG59XG5cbmRlY2xhcmUgaW50ZXJmYWNlIElVUElNZXNzYWdlcyB7XG4gIC8qKlxuICBTZXRzIGJhY2tlbmQgc3RhdHVzXG4gIEBwYXJhbSBzdGF0dXMge09iamVjdH1cbiAgICBzdGF0dXM6IG9uZSBvZiAncHJvZ3Jlc3MnLCAncmVhZHknLCAnZXJyb3InLCAnd2FybmluZydcbiAgICBwcm9ncmVzczogZmxvYXQgYmV0d2VlbiAwIGFuZCAxLCBvbmx5IHJlbGV2YW50IHdoZW4gc3RhdHVzIGlzICdwcm9ncmVzcydcbiAgICAgICAgICAgICAgaWYgMCBvciB1bmRlZmluZWQsIHByb2dyZXNzIGJhciBpcyBub3Qgc2hvd25cbiAgKi9cbiAgc3RhdHVzIChzdGF0dXM6IElVUElTdGF0dXMpOiB2b2lkXG5cbiAgLyoqXG4gIEFkZCBtZXNzYWdlcyB0byBpZGUtaGFza2VsbCBvdXRwdXRcbiAgQHBhcmFtIG1lc3NhZ2VzOiB7QXJyYXk8T2JqZWN0Pn1cbiAgICB1cmk6IFN0cmluZywgRmlsZSBVUkkgbWVzc2FnZSByZWxhdGVzIHRvXG4gICAgcG9zaXRpb246IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgcG9zaXRpb24gdG8gd2hpY2ggbWVzc2FnZSByZWxhdGVzXG4gICAgbWVzc2FnZTogU3RyaW5nIG9yIHs8dGV4dCB8IGh0bWw+LCBoaWdobGlnaHRlcj99LCBtZXNzYWdlXG4gICAgc2V2ZXJpdHk6IFN0cmluZywgb25lIG9mICdlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnLCAnYnVpbGQnLFxuICAgICAgICAgICAgICBvciB1c2VyLWRlZmluZWQsIHNlZSBgc2V0TWVzc2FnZVR5cGVzYFxuICBAcGFyYW0gdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIGFkZCAobWVzc2FnZXM6IElVUElNZXNzYWdlW10sIHR5cGVzOiBUU2V2ZXJpdHlbXSk6IHZvaWRcblxuICAvKipcbiAgU2V0IG1lc3NhZ2VzIGluIGlkZS1oYXNrZWxsIG91dHB1dC4gQ2xlYXJzIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoXG4gIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuICBtZXNzYWdlczogQXJyYXkgb2YgT2JqZWN0XG4gICAgdXJpOiBTdHJpbmcsIEZpbGUgVVJJIG1lc3NhZ2UgcmVsYXRlcyB0b1xuICAgIHBvc2l0aW9uOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIHBvc2l0aW9uIHRvIHdoaWNoIG1lc3NhZ2UgcmVsYXRlc1xuICAgIG1lc3NhZ2U6IFN0cmluZywgbWVzc2FnZVxuICAgIHNldmVyaXR5OiBTdHJpbmcsIG9uZSBvZiAnZXJyb3InLCAnd2FybmluZycsICdsaW50JywgJ2J1aWxkJyxcbiAgICAgICAgICAgICAgb3IgdXNlci1kZWZpbmVkLCBzZWUgYHNldE1lc3NhZ2VUeXBlc2BcbiAgdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIHNldChtZXNzYWdlczogSVVQSU1lc3NhZ2VbXSwgdHlwZXM6IFRTZXZlcml0eVtdKTogdm9pZFxuXG4gIC8qKlxuICBDbGVhciBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aCBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgVGhpcyBpcyBzaG9ydGhhbmQgZnJvbSBgc2V0TWVzc2FnZXMoW10sdHlwZXMpYFxuICAqL1xuICBjbGVhciAodHlwZXM6IFRTZXZlcml0eVtdKTogdm9pZFxuXG4gIC8qKlxuICBTZXQgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgIHRoYXQgeW91ciBwYWNrYWdlIHdpbGwgdXNlLlxuICB0eXBlczogT2JqZWN0IHdpdGgga2V5cyByZXByZXNlbnRpbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgIChpLmUuIHRhYiBuYW1lKVxuICAgICAgICAgYW5kIHZhbHVlcyBiZWluZyBPYmplY3RzIHdpdGgga2V5c1xuICAgIHVyaUZpbHRlcjogQm9vbCwgc2hvdWxkIHVyaSBmaWx0ZXIgYXBwbHkgdG8gdGFiP1xuICAgIGF1dG9TY3JvbGw6IEJvb2wsIHNob3VsZCB0YWIgYXV0by1zY3JvbGw/XG5cbiAgVGhpcyBhbGxvd3MgdG8gZGVmaW5lIGN1c3RvbSBvdXRwdXQgcGFuZWwgdGFicy5cbiAgKi9cbiAgc2V0VHlwZXMgKHR5cGVzOiB7W3NldmVyaXR5OiBzdHJpbmddOiBJU2V2ZXJpdHlUYWJEZWZpbml0aW9ufSk6IHZvaWRcbn1cblxuZGVjbGFyZSB0eXBlIFRleHRCdWZmZXJDYWxsYmFjayA9IChidWZmZXI6IFRleHRCdWZmZXIpID0+IHZvaWRcblxuZGVjbGFyZSBpbnRlcmZhY2UgSVVQSUV2ZW50cyB7XG4gIC8qKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGJlZm9yZSBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cblxuICBjYWxsYmFjazogY2FsbGJhY2soYnVmZmVyKVxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG5cbiAgQHJldHVybnMge0Rpc3Bvc2FibGV9XG4gICovXG4gIG9uV2lsbFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUZXh0QnVmZmVyQ2FsbGJhY2spOiBEaXNwb3NhYmxlXG5cbiAgLyoqXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYWZ0ZXIgSGFza2VsbCBidWZmZXIgaXMgc2F2ZWQuXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKGJ1ZmZlcilcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0aGF0IGdlbmVyYXRlZCBldmVudFxuXG4gIEByZXR1cm5zIHtEaXNwb3NhYmxlfVxuICAqL1xuICBvbkRpZFNhdmVCdWZmZXIoY2FsbGJhY2s6IFRleHRCdWZmZXJDYWxsYmFjayk6IERpc3Bvc2FibGVcblxuICAvKipcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBhZnRlciBIYXNrZWxsIGJ1ZmZlciBoYXMgc3RvcHBlZCBjaGFuZ2luZyBmb3JcbiAgc29tZSBmcmFjdGlvbiBvZiBhIHNlY29uZCAodXN1YWxseSAzMDAgbXMpLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhidWZmZXIpXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcblxuICBAcmV0dXJucyB7RGlzcG9zYWJsZX1cbiAgKi9cbiAgb25EaWRTdG9wQ2hhbmdpbmcoY2FsbGJhY2s6IFRleHRCdWZmZXJDYWxsYmFjayk6IERpc3Bvc2FibGVcbn1cbmRlY2xhcmUgaW50ZXJmYWNlIElTaG93VG9vbHRpcFBhcmFtcyB7XG4gIGVkaXRvcjogVGV4dEVkaXRvclxuICBwb3M6IFRQb3NpdGlvblxuICBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZVxuICBkZXRhaWw6IGFueVxuICB0b29sdGlwOiBUVG9vbHRpcEZ1bmN0aW9uXG59XG5kZWNsYXJlIHR5cGUgVFRvb2x0aXBGdW5jdGlvbiA9IChjcmFuZ2U6IFJhbmdlKSA9PiBJVG9vbHRpcERhdGEgfCBQcm9taXNlPElUb29sdGlwRGF0YT5cbmRlY2xhcmUgaW50ZXJmYWNlIElUb29sdGlwRGF0YSB7XG4gIHJhbmdlOiBSYW5nZVxuICB0ZXh0OiBUVVBJVGV4dFxuICBwZXJzaXN0T25DdXJzb3JNb3ZlPzogYm9vbGVhblxufVxuZGVjbGFyZSB0eXBlIFRUb29sdGlwSGFuZGxlciA9IChlZGl0b3I6IFRleHRFZGl0b3IsIGNyYW5nZTogUmFuZ2UsIHR5cGU6IFRFdmVudFJhbmdlVHlwZSkgPT4gSVRvb2x0aXBEYXRhIHwgUHJvbWlzZTxJVG9vbHRpcERhdGE+XG5kZWNsYXJlIGludGVyZmFjZSBJVVBJVG9vbHRpcHMge1xuICAvKipcbiAgU2hvdyB0b29sdGlwIGluIGVkaXRvci5cblxuICBlZGl0b3I6IGVkaXRvciB0aGF0IHdpbGwgc2hvdyB0b29sdGlwXG4gIHBvczogdG9vbHRpcCBwb3NpdGlvblxuICBldmVudFR5cGU6IG9uZSBvZiAnY29udGV4dCcsICdrZXlib2FyZCcgYW5kICdtb3VzZSdcbiAgZGV0YWlsOiBmb3IgYXV0b21hdGljIHNlbGVjdGlvbiBiZXR3ZWVuICdjb250ZXh0JyBhbmQgJ2tleWJvYXJkJy5cbiAgICAgICAgICBJZ25vcmVkIGlmICdldmVudFR5cGUnIGlzIHNldC5cbiAgdG9vbHRpcDogZnVuY3Rpb24oY3JhbmdlKVxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnJlbnRseSBzZWxlY3RlZCByYW5nZSBpbiBlZGl0b3IgKHBvc3NpYmx5IGVtcHR5KVxuXG4gICAgUmV0dXJucyB7cmFuZ2UsIHRleHR9IG9yIFByb21pc2VcbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHBlcnNpc3RPbkN1cnNvck1vdmU6IEJvb2xlYW4sIG9wdGlvbmFsLCBkZWZhdWx0IGZhbHNlLCBwZXJzaXN0IG9uIGN1cnNvciBtb3ZlIHJlZ2FyZGxlc3Mgb2Ygc2V0dGluZ3NcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcbiAgKi9cbiAgc2hvdyAocGFyYW1zOiBJU2hvd1Rvb2x0aXBQYXJhbXMpOiB2b2lkXG5cbiAgLyoqXG4gIEVkaXRvciBldmVudCBzdWJzY3JpcHRpb24uIEZpcmVzIHdoZW4gbW91c2UgY3Vyc29yIHN0b3BwZWQgb3ZlciBhIHN5bWJvbCBpblxuICBlZGl0b3IuXG5cbiAgcHJpb3JpdHk6IGV2ZW50IHByaW9yaXR5LCBoaWdoZXIgdmFsdWUgbWVhbnMgaGlnaGVyIHByaW9yaXR5LFxuICAgICAgICAgICAgc3Vic2NyaXB0aW9uIHdpdGggaGlnaHRlc3QgcHJpb3JpdHkgd2lsbCBiZSBjYWxsZWQgZmlyc3QuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhlZGl0b3IsIGNyYW5nZSwgdHlwZSlcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnNvciByYW5nZSB0aGF0IGdlbmVyYXRlZCBldmVudC5cbiAgICB0eXBlOiBPbmUgb2YgJ21vdXNlJywgJ3NlbGVjdGlvbicgLS0gdHlwZSBvZiBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGlzXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZS5cbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcblxuICByZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25TaG91bGRTaG93VG9vbHRpcCAocHJpb3JpdHk6IG51bWJlciwgaGFuZGxlcjogVFRvb2x0aXBIYW5kbGVyKTogRGlzcG9zYWJsZVxuICBvblNob3VsZFNob3dUb29sdGlwIChoYW5kbGVyOiBUVG9vbHRpcEhhbmRsZXIpOiBEaXNwb3NhYmxlXG59XG5kZWNsYXJlIGludGVyZmFjZSBJQ29udHJvbE9wdHMge1xuICBpZDogc3RyaW5nXG4gIGV2ZW50czoge1trZXk6IHN0cmluZ106IEZ1bmN0aW9ufVxuICBjbGFzc2VzOiBzdHJpbmdbXVxuICBzdHlsZToge1trZXk6IHN0cmluZ106IHN0cmluZ31cbiAgYXR0cnM6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9XG59XG5kZWNsYXJlIGludGVyZmFjZSBJVVBJQ29udHJvbERlZmluaXRpb24ge1xuICBlbGVtZW50OiBzdHJpbmcgfCBIVE1MRWxlbWVudFxuICBvcHRzOiBJQ29udHJvbE9wdHNcbn1cbmRlY2xhcmUgaW50ZXJmYWNlIElVUElDb250cm9scyB7XG4gIC8qKlxuICBBZGQgYSBuZXcgY29udHJvbCB0byBvdXB0dXQgcGFuZWwgaGVhZGluZy5cblxuICBlbGVtZW50OiBIVE1MRWxlbWVudCBvZiBjb250cm9sLCBvciBTdHJpbmcgd2l0aCB0YWcgbmFtZVxuICBvcHRzOiB2YXJpb3VzIG9wdGlvbnNcbiAgICBpZDogU3RyaW5nLCBpZFxuICAgIGV2ZW50czogT2JqZWN0LCBldmVudCBjYWxsYmFja3MsIGtleSBpcyBldmVudCBuYW1lLCBlLmcuIFwiY2xpY2tcIixcbiAgICAgICAgICAgIHZhbHVlIGlzIGNhbGxiYWNrXG4gICAgY2xhc3NlczogQXJyYXkgb2YgU3RyaW5nLCBjbGFzc2VzXG4gICAgc3R5bGU6IE9iamVjdCwgY3NzIHN0eWxlLCBrZXlzIGFyZSBzdHlsZSBhdHRyaWJ1dGVzLCB2YWx1ZXMgYXJlIHZhbHVlc1xuICAgIGF0dHJzOiBPYmplY3QsIG90aGVyIGF0dHJpYnV0ZXMsIGtleXMgYXJlIGF0dHJpYnV0ZSBuYW1lcywgdmFsdWVzIGFyZSB2YWx1ZXNcbiAgICBiZWZvcmU6IFN0cmluZywgQ1NTIHNlbGVjdG9yIG9mIGVsZW1lbnQsIHRoYXQgdGhpcyBvbmUgc2hvdWxkIGJlIGluc2VydGVkXG4gICAgICAgICAgICBiZWZvcmUsIGUuZy4gJyNwcm9ncmVzc0JhcidcblxuICBSZXR1cm5zIERpc3Bvc2FibGUuXG4gICovXG4gIGFkZCAoZGVmOiBJVVBJQ29udHJvbERlZmluaXRpb24pOiBEaXNwb3NhYmxlXG59XG5kZWNsYXJlIGludGVyZmFjZSBJUGFyYW1TcGVjPFQ+IHtcbiAgb25DaGFuZ2VkOiAodmFsdWU6IFQpID0+IHZvaWRcbiAgaXRlbXM6IEFycmF5PFQ+IHwgKCgpID0+IEFycmF5PFQ+KVxuICBpdGVtVGVtcGxhdGU6IChpdGVtOiBUKSA9PiBTdHJpbmdcbiAgaXRlbUZpbHRlcktleTogc3RyaW5nXG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nXG4gIGRpc3BsYXlOYW1lPzogc3RyaW5nXG4gIGRpc3BsYXlUZW1wbGF0ZTogKGl0ZW06IFQpID0+IFN0cmluZ1xuICBkZWZhdWx0OiBUXG59XG5kZWNsYXJlIGludGVyZmFjZSBJVVBJUGFyYW1zIHtcbiAgLyoqXG4gIGFkZENvbmZpZ1BhcmFtXG4gICAgcGFyYW1fbmFtZTpcbiAgICAgIG9uQ2hhbmdlZDogY2FsbGJhY2sgdm9pZCh2YWx1ZSlcbiAgICAgIGl0ZW1zOiBBcnJheSBvciBjYWxsYmFjayBBcnJheSh2b2lkKVxuICAgICAgaXRlbVRlbXBsYXRlOiBjYWxsYmFjaywgU3RyaW5nKGl0ZW0pLCBodG1sIHRlbXBsYXRlXG4gICAgICBpdGVtRmlsdGVyS2V5OiBTdHJpbmcsIGl0ZW0gZmlsdGVyIGtleVxuICAgICAgZGVzY3JpcHRpb246IFN0cmluZyBbb3B0aW9uYWxdXG4gICAgICBkaXNwbGF5TmFtZTogU3RyaW5nIFtvcHRpb25hbCwgY2FwaXRhbGl6ZWQgcGFyYW1fbmFtZSBkZWZhdWx0XVxuICAgICAgZGlzcGxheVRlbXBsYXRlOiBjYWxsYmFjaywgU3RyaW5nKGl0ZW0pLCBzdHJpbmcgdGVtcGxhdGVcbiAgICAgIGRlZmF1bHQ6IGl0ZW0sIGRlZmF1bHQgdmFsdWVcblxuICBSZXR1cm5zXG4gICAgZGlzcDogRGlzcG9zYWJsZVxuICAgIGNoYW5nZTogb2JqZWN0IG9mIGNoYW5nZSBmdW5jdGlvbnMsIGtleXMgYmVpbmcgcGFyYW1fbmFtZVxuICAqL1xuICBhZGQgKHNwZWM6IHtbcGFyYW1fbmFtZTogc3RyaW5nXTogSVBhcmFtU3BlYzxhbnk+fSlcblxuICAvKipcbiAgZ2V0Q29uZmlnUGFyYW0ocGFyYW1OYW1lKSBvciBnZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUpXG5cbiAgcmV0dXJucyBhIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXJcbiAgdmFsdWUuXG5cbiAgUHJvbWlzZSBjYW4gYmUgcmVqZWN0ZWQgd2l0aCBlaXRoZXIgZXJyb3IsIG9yICd1bmRlZmluZWQnLiBMYXR0ZXJcbiAgaW4gY2FzZSB1c2VyIGNhbmNlbHMgcGFyYW0gc2VsZWN0aW9uIGRpYWxvZy5cbiAgKi9cbiAgZ2V0PFQ+IChwbHVnaW46IHN0cmluZywgbmFtZTogc3RyaW5nKTogUHJvbWlzZTxUPlxuICBnZXQ8VD4gKG5hbWUpOiBQcm9taXNlPFQ+XG5cbiAgLyoqXG4gIHNldENvbmZpZ1BhcmFtKHBhcmFtTmFtZSwgdmFsdWUpIG9yIHNldENvbmZpZ1BhcmFtKHBsdWdpbk5hbWUsIHBhcmFtTmFtZSwgdmFsdWUpXG5cbiAgdmFsdWUgaXMgb3B0aW9uYWwuIElmIG9taXR0ZWQsIGEgc2VsZWN0aW9uIGRpYWxvZyB3aWxsIGJlIHByZXNlbnRlZCB0byB1c2VyLlxuXG4gIHJldHVybnMgYSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gcGFyYW1ldGVyIHZhbHVlLlxuXG4gIFByb21pc2UgY2FuIGJlIHJlamVjdGVkIHdpdGggZWl0aGVyIGVycm9yLCBvciAndW5kZWZpbmVkJy4gTGF0dGVyXG4gIGluIGNhc2UgdXNlciBjYW5jZWxzIHBhcmFtIHNlbGVjdGlvbiBkaWFsb2cuXG4gICovXG4gIHNldDxUPiAocGx1Z2luOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgdmFsdWU/OiBUKTogUHJvbWlzZTxUPlxuICBzZXQ8VD4gKG5hbWU6IHN0cmluZywgdmFsdWU/OiBUKTogUHJvbWlzZTxUPlxufVxuZGVjbGFyZSB0eXBlIFRFdmVudFJhbmdlVHlwZSA9ICdrZXlib2FyZCcgfCAnY29udGV4dCcgfCAnbW91c2UnIHwgJ3NlbGVjdGlvbidcbmRlY2xhcmUgaW50ZXJmYWNlIElFdmVudFJhbmdlUGFyYW1zIHtcbiAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gIGRldGFpbD86IGFueVxuICBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZVxuICBwb3M6IFRQb3NpdGlvblxuICBjb250cm9sbGVyOiB1bmRlZmluZWRcbn1cbmRlY2xhcmUgdHlwZSBURXZlbnRSYW5nZUNhbGxiYWNrID0gKHBhcnM6IHtwb3M6IFBvaW50LCBjcmFuZ2U6IFJhbmdlfSwgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGUpID0+IHZvaWRcbmRlY2xhcmUgaW50ZXJmYWNlIElVUElVdGlscyB7XG4gIC8qKlxuICBVdGlsaXR5IGZ1bmN0aW9uIHRvIGV4dHJhY3QgZXZlbnQgcmFuZ2UvdHlwZSBmb3IgYSBnaXZlbiBldmVudFxuXG4gIGVkaXRvcjogVGV4dEVkaXRvciwgZWRpdG9yIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG4gIGRldGFpbDogZXZlbnQgZGV0YWlsLCBpZ25vcmVkIGlmIGV2ZW50VHlwZSBpcyBzZXRcbiAgZXZlbnRUeXBlOiBTdHJpbmcsIGV2ZW50IHR5cGUsIG9uZSBvZiAna2V5Ym9hcmQnLCAnY29udGV4dCcsICdtb3VzZSdcbiAgcG9zOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIGV2ZW50IHBvc2l0aW9uLCBjYW4gYmUgdW5kZWZpbmVkXG4gIGNvbnRyb2xsZXI6IGxlYXZlIHVuZGVmaW5lZCwgdGhpcyBpcyBpbnRlcm5hbCBmaWVsZFxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayh7cG9zLCBjcmFuZ2V9LCBldmVudFR5cGUpXG4gICAgcG9zOiBQb2ludCwgZXZlbnQgcG9zaXRpb25cbiAgICBjcmFuZ2U6IFJhbmdlLCBldmVudCByYW5nZVxuICAgIGV2ZW50VHlwZTogU3RyaW5nLCBldmVudCB0eXBlLCBvbmUgb2YgJ2tleWJvYXJkJywgJ2NvbnRleHQnLCAnbW91c2UnXG4gICovXG4gIHdpdGhFdmVudFJhbmdlKHBhcmFtczogSUV2ZW50UmFuZ2VQYXJhbXMsIGNhbGxiYWNrOiBURXZlbnRSYW5nZUNhbGxiYWNrKVxufVxuZGVjbGFyZSB0eXBlIFRUb29sdGlwSGFuZGxlclNwZWMgPSB7cHJpb3JpdHk6IG51bWJlciwgaGFuZGxlcjogVFRvb2x0aXBIYW5kbGVyfVxuIl19