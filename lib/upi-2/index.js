"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const dummy_element_1 = require("./dummy-element");
function instance(pluginManager, outerDisposables, pluginName) {
    const disposables = new atom_1.CompositeDisposable();
    outerDisposables.add(disposables);
    const messageProvider = pluginManager.resultsDB.registerProvider(pluginName);
    disposables.add(messageProvider);
    let messages = [];
    return {
        setMenu(name, menu) {
            let menuDisp;
            disposables.add(menuDisp = atom.menu.add([{
                    label: utils_1.MAIN_MENU_LABEL,
                    submenu: [{ label: name, submenu: menu }]
                }
            ]));
            return menuDisp;
        },
        setStatus(status) {
            return pluginManager.outputPanel.backendStatus(pluginName, status);
        },
        addMessages(newMessages, types) {
            messages.push(...newMessages);
            messageProvider.setMessages(messages);
        },
        setMessages(newMessages, types) {
            messages = [...newMessages];
            messageProvider.setMessages(messages);
        },
        clearMessages(types) {
            messages = messages.filter(({ severity }) => !types.includes(severity));
            messageProvider.setMessages(messages);
        },
        setMessageTypes(types) {
            return (() => {
                const result = [];
                for (const type of Object.keys(types)) {
                    const opts = types[type];
                    result.push(pluginManager.outputPanel.createTab(type, opts));
                }
                return result;
            })();
        },
        onShouldShowTooltip(callback) {
            const disp = pluginManager.tooltipRegistry.register(pluginName, { priority: 100, handler: callback });
            disposables.add(disp);
            return disp;
        },
        showTooltip({ editor, pos, eventType, detail, tooltip }) {
            if (!eventType) {
                eventType = utils_1.getEventType(detail);
            }
            pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName, tooltip });
        },
        onWillSaveBuffer(callback) {
            let disp;
            disposables.add(disp = pluginManager.onWillSaveBuffer(callback));
            return disp;
        },
        onDidSaveBuffer(callback) {
            let disp;
            disposables.add(disp = pluginManager.onDidSaveBuffer(callback));
            return disp;
        },
        onDidStopChanging(callback) {
            let disp;
            disposables.add(disp = pluginManager.onDidStopChanging(callback));
            return disp;
        },
        addPanelControl(element, opts) {
            if (typeof element === 'string') {
                return pluginManager.outputPanel.addPanelControl(element, opts);
            }
            else {
                const newOpts = Object.assign({}, opts, { element });
                return pluginManager.outputPanel.addPanelControl(dummy_element_1.DummyElement, newOpts);
            }
        },
        addConfigParam(specs) {
            const disp = new atom_1.CompositeDisposable();
            for (const name of Object.keys(specs)) {
                const spec = specs[name];
                disp.add(pluginManager.configParamManager.add(pluginName, name, spec));
            }
            return disp;
        },
        getConfigParam(otherPluginName, name) {
            return __awaiter(this, void 0, void 0, function* () {
                if (!name) {
                    name = otherPluginName;
                    otherPluginName = pluginName;
                }
                return pluginManager.configParamManager.get(otherPluginName, name);
            });
        },
        setConfigParam(otherPluginName, name, value) {
            return __awaiter(this, void 0, void 0, function* () {
                if (value === undefined) {
                    value = name;
                    name = otherPluginName;
                    otherPluginName = pluginName;
                }
                return pluginManager.configParamManager.set(otherPluginName, name, value);
            });
        },
        withEventRange({ editor, detail, eventType, pos }, callback) {
            let ppos;
            if (pos) {
                ppos = atom_1.Point.fromObject(pos);
            }
            if (!eventType) {
                eventType = utils_1.getEventType(detail);
            }
            const controller = pluginManager.controller(editor);
            if (!controller) {
                return;
            }
            const res = controller.getEventRange(eventType);
            if (!res) {
                return;
            }
            return callback(res);
        }
    };
}
exports.instance = instance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLCtCQUFvRTtBQUNwRSxvQ0FBd0Q7QUFTeEQsbURBQTRDO0FBK0I1QyxrQkFBMEIsYUFBNEIsRUFBRSxnQkFBcUMsRUFBRSxVQUFrQjtJQUMvRyxNQUFNLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7SUFDN0MsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQ2pDLE1BQU0sZUFBZSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDNUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQTtJQUNoQyxJQUFJLFFBQVEsR0FBa0IsRUFBRSxDQUFBO0lBQ2hDLE1BQU0sQ0FBQztRQVFQLE9BQU8sQ0FBRSxJQUFZLEVBQUUsSUFBaUI7WUFDdEMsSUFBSSxRQUFRLENBQUE7WUFDWixXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUN4QyxLQUFLLEVBQUUsdUJBQWU7b0JBQ3RCLE9BQU8sRUFBRSxDQUFFLEVBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUU7aUJBQzFDO2FBQ0EsQ0FBQyxDQUFDLENBQUE7WUFDSCxNQUFNLENBQUMsUUFBUSxDQUFBO1FBQ2pCLENBQUM7UUFTRCxTQUFTLENBQUUsTUFBZTtZQUN4QixNQUFNLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFBO1FBQ3BFLENBQUM7UUFhRCxXQUFXLENBQUUsV0FBMEIsRUFBRSxLQUFtQjtZQUMxRCxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDLENB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Q0FBQTtvQkFDWixJQUFJLEdBQUcsZUFBZSxDQUFBO29CQUN0QixlQUFlLEdBQUcsVUFBVSxDQUFBO2dCQUM5QixDQUFDO2dCQUNELE1BQU0sQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLGVBQWUsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUE7WUFDM0UsQ0FBQztTQUFBO1FBZ0JELGNBQWMsQ0FBSyxFQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBb0IsRUFBRSxRQUFnQztZQUN0RyxJQUFJLElBQXVCLENBQUE7WUFDM0IsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFBQyxJQUFJLEdBQUcsWUFBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUFDLENBQUM7WUFDekMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUFDLFNBQVMsR0FBRyxvQkFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQUMsQ0FBQztZQUNwRCxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQ25ELEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFBQyxNQUFNLENBQUE7WUFBQyxDQUFDO1lBQzNCLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUE7WUFDL0MsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUFDLE1BQU0sQ0FBQTtZQUFDLENBQUM7WUFDcEIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUN0QixDQUFDO0tBQ0EsQ0FBQTtBQUNILENBQUM7QUExU0QsNEJBMFNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUG9pbnQsIFRleHRFZGl0b3IsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCwgZ2V0RXZlbnRUeXBlIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1BsdWdpbk1hbmFnZXJ9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtJU3RhdHVzLCBJU2V2ZXJpdHlUYWJEZWZpbml0aW9uLCBJQ29udHJvbE9wdHN9IGZyb20gJy4uL291dHB1dC1wYW5lbCdcbmltcG9ydCB7SVJlc3VsdEl0ZW0sIFRTZXZlcml0eX0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7VEV2ZW50UmFuZ2VUeXBlfSBmcm9tICcuLi9lZGl0b3ItY29udHJvbC90b29sdGlwLW1hbmFnZXInXG5pbXBvcnQge1RQb3NpdGlvbn0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7SVBhcmFtU3BlY30gZnJvbSAnLi4vY29uZmlnLXBhcmFtcydcbmltcG9ydCB7VFRleHRCdWZmZXJDYWxsYmFja30gZnJvbSAnLi4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge1RUb29sdGlwSGFuZGxlciwgVFRvb2x0aXBGdW5jdGlvbn0gZnJvbSAnLi4vdG9vbHRpcC1yZWdpc3RyeSdcbmltcG9ydCB7RHVtbXlFbGVtZW50fSBmcm9tICcuL2R1bW15LWVsZW1lbnQnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNob3dUb29sdGlwUGFyYW1zIHtcbiAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gIHBvczogVFBvc2l0aW9uXG4gIGV2ZW50VHlwZT86IFRFdmVudFJhbmdlVHlwZVxuICBkZXRhaWw/OiBPYmplY3RcbiAgdG9vbHRpcDogVFRvb2x0aXBGdW5jdGlvblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElFdmVudFJhbmdlUGFyYW1zIHtcbiAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gIGRldGFpbD86IE9iamVjdFxuICBldmVudFR5cGU/OiBURXZlbnRSYW5nZVR5cGVcbiAgcG9zOiBUUG9zaXRpb25cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQXRvbU1lbnVDb21tYW5kIHtcbiAgbGFiZWw6IHN0cmluZ1xuICBjb21tYW5kOiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQXRvbVN1Ym1lbnUge1xuICBsYWJlbDogc3RyaW5nXG4gIHN1Ym1lbnU6IFRBdG9tTWVudVtdXG59XG5cbmV4cG9ydCB0eXBlIFRBdG9tTWVudSA9IElBdG9tTWVudUNvbW1hbmQgfCBJQXRvbVN1Ym1lbnVcblxuZXhwb3J0IHR5cGUgVEV2ZW50UmFuZ2VDYWxsYmFjazxUPiA9IChwYXJzOiB7cG9zOiBQb2ludCwgY3JhbmdlOiBSYW5nZSwgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGV9KSA9PiBUXG5cbmV4cG9ydCBmdW5jdGlvbiBpbnN0YW5jZSAocGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlciwgb3V0ZXJEaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgcGx1Z2luTmFtZTogc3RyaW5nKSB7XG4gIGNvbnN0IGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBvdXRlckRpc3Bvc2FibGVzLmFkZChkaXNwb3NhYmxlcylcbiAgY29uc3QgbWVzc2FnZVByb3ZpZGVyID0gcGx1Z2luTWFuYWdlci5yZXN1bHRzREIucmVnaXN0ZXJQcm92aWRlcihwbHVnaW5OYW1lKVxuICBkaXNwb3NhYmxlcy5hZGQobWVzc2FnZVByb3ZpZGVyKVxuICBsZXQgbWVzc2FnZXM6IElSZXN1bHRJdGVtW10gPSBbXVxuICByZXR1cm4ge1xuICAvKlxuICBBZGRzIG5ldyBzdW1iZW51IHRvICdIYXNrZWxsIElERScgbWVudSBpdGVtXG4gIG5hbWUgLS0gc3VibWVudSBsYWJlbCwgc2hvdWxkIGJlIGRlc2NyaXB0aXZlIG9mIGEgcGFja2FnZVxuICBtZW51IC0tIEF0b20gbWVudSBvYmplY3RcblxuICBSZXR1cm5zIERpc3Bvc2FibGUuXG4gICovXG4gIHNldE1lbnUgKG5hbWU6IHN0cmluZywgbWVudTogVEF0b21NZW51W10pIHtcbiAgICBsZXQgbWVudURpc3BcbiAgICBkaXNwb3NhYmxlcy5hZGQobWVudURpc3AgPSBhdG9tLm1lbnUuYWRkKFt7XG4gICAgICBsYWJlbDogTUFJTl9NRU5VX0xBQkVMLFxuICAgICAgc3VibWVudTogWyB7bGFiZWw6IG5hbWUsIHN1Ym1lbnU6IG1lbnV9IF1cbiAgICB9XG4gICAgXSkpXG4gICAgcmV0dXJuIG1lbnVEaXNwXG4gIH0sXG5cbiAgLypcbiAgU2V0cyBiYWNrZW5kIHN0YXR1c1xuICBzdGF0dXMgLS0gb2JqZWN0XG4gICAgc3RhdHVzOiBvbmUgb2YgJ3Byb2dyZXNzJywgJ3JlYWR5JywgJ2Vycm9yJywgJ3dhcm5pbmcnXG4gICAgcHJvZ3Jlc3M6IGZsb2F0IGJldHdlZW4gMCBhbmQgMSwgb25seSByZWxldmFudCB3aGVuIHN0YXR1cyBpcyAncHJvZ3Jlc3MnXG4gICAgICAgICAgICAgIGlmIDAgb3IgdW5kZWZpbmVkLCBwcm9ncmVzcyBiYXIgaXMgbm90IHNob3duXG4gICovXG4gIHNldFN0YXR1cyAoc3RhdHVzOiBJU3RhdHVzKSB7XG4gICAgcmV0dXJuIHBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYmFja2VuZFN0YXR1cyhwbHVnaW5OYW1lLCBzdGF0dXMpXG4gIH0sXG5cbiAgLypcbiAgQWRkIG1lc3NhZ2VzIHRvIGlkZS1oYXNrZWxsIG91dHB1dFxuICBtZXNzYWdlczogQXJyYXkgb2YgT2JqZWN0XG4gICAgdXJpOiBTdHJpbmcsIEZpbGUgVVJJIG1lc3NhZ2UgcmVsYXRlcyB0b1xuICAgIHBvc2l0aW9uOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIHBvc2l0aW9uIHRvIHdoaWNoIG1lc3NhZ2UgcmVsYXRlc1xuICAgIG1lc3NhZ2U6IFN0cmluZyBvciB7PHRleHQgfCBodG1sPiwgaGlnaGxpZ2h0ZXI/fSwgbWVzc2FnZVxuICAgIHNldmVyaXR5OiBTdHJpbmcsIG9uZSBvZiAnZXJyb3InLCAnd2FybmluZycsICdsaW50JywgJ2J1aWxkJyxcbiAgICAgICAgICAgICAgb3IgdXNlci1kZWZpbmVkLCBzZWUgYHNldE1lc3NhZ2VUeXBlc2BcbiAgdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIGFkZE1lc3NhZ2VzIChuZXdNZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM/OiBUU2V2ZXJpdHlbXSkge1xuICAgIG1lc3NhZ2VzLnB1c2goLi4ubmV3TWVzc2FnZXMpXG4gICAgbWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKG1lc3NhZ2VzKVxuICB9LFxuXG4gIC8qXG4gIFNldCBtZXNzYWdlcyBpbiBpZGUtaGFza2VsbCBvdXRwdXQuIENsZWFycyBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aFxuICBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgbWVzc2FnZXM6IEFycmF5IG9mIE9iamVjdFxuICAgIHVyaTogU3RyaW5nLCBGaWxlIFVSSSBtZXNzYWdlIHJlbGF0ZXMgdG9cbiAgICBwb3NpdGlvbjogUG9pbnQsIG9yIFBvaW50LWxpa2UgT2JqZWN0LCBwb3NpdGlvbiB0byB3aGljaCBtZXNzYWdlIHJlbGF0ZXNcbiAgICBtZXNzYWdlOiBTdHJpbmcsIG1lc3NhZ2VcbiAgICBzZXZlcml0eTogU3RyaW5nLCBvbmUgb2YgJ2Vycm9yJywgJ3dhcm5pbmcnLCAnbGludCcsICdidWlsZCcsXG4gICAgICAgICAgICAgIG9yIHVzZXItZGVmaW5lZCwgc2VlIGBzZXRNZXNzYWdlVHlwZXNgXG4gIHR5cGVzOiBBcnJheSBvZiBTdHJpbmcsIGNvbnRhaW5pbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgLiBJZiB1bmRlZmluZWQsXG4gICAgICAgICB3aWxsIGJlIHRha2VuIGZyb20gYG1lc3NhZ2VzYFxuICAqL1xuICBzZXRNZXNzYWdlcyAobmV3TWVzc2FnZXM6IElSZXN1bHRJdGVtW10sIHR5cGVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIG1lc3NhZ2VzID0gWy4uLm5ld01lc3NhZ2VzXVxuICAgIG1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyhtZXNzYWdlcylcbiAgfSxcblxuICAvKlxuICBDbGVhciBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aCBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgVGhpcyBpcyBzaG9ydGhhbmQgZnJvbSBgc2V0TWVzc2FnZXMoW10sdHlwZXMpYFxuICAqL1xuICBjbGVhck1lc3NhZ2VzICh0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICBtZXNzYWdlcyA9IG1lc3NhZ2VzLmZpbHRlcigoe3NldmVyaXR5fSkgPT4gIXR5cGVzLmluY2x1ZGVzKHNldmVyaXR5KSlcbiAgICBtZXNzYWdlUHJvdmlkZXIuc2V0TWVzc2FnZXMobWVzc2FnZXMpXG4gIH0sXG5cbiAgLypcbiAgU2V0IHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YCB0aGF0IHlvdXIgcGFja2FnZSB3aWxsIHVzZS5cbiAgdHlwZXM6IE9iamVjdCB3aXRoIGtleXMgcmVwcmVzZW50aW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YCAoaS5lLiB0YWIgbmFtZSlcbiAgICAgICAgIGFuZCB2YWx1ZXMgYmVpbmcgT2JqZWN0cyB3aXRoIGtleXNcbiAgICB1cmlGaWx0ZXI6IEJvb2wsIHNob3VsZCB1cmkgZmlsdGVyIGFwcGx5IHRvIHRhYj9cbiAgICBhdXRvU2Nyb2xsOiBCb29sLCBzaG91bGQgdGFiIGF1dG8tc2Nyb2xsP1xuXG4gIFRoaXMgYWxsb3dzIHRvIGRlZmluZSBjdXN0b20gb3V0cHV0IHBhbmVsIHRhYnMuXG4gICovXG4gIHNldE1lc3NhZ2VUeXBlcyAodHlwZXM6IHsgW3NldmVyaXR5OiBzdHJpbmddOiBJU2V2ZXJpdHlUYWJEZWZpbml0aW9ufSkge1xuICAgIHJldHVybiAoKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gW11cbiAgICAgIGZvciAoY29uc3QgdHlwZSBvZiBPYmplY3Qua2V5cyh0eXBlcykpIHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IHR5cGVzW3R5cGVdXG4gICAgICAgIHJlc3VsdC5wdXNoKHBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuY3JlYXRlVGFiKHR5cGUsIG9wdHMpKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0pKClcbiAgfSxcblxuICAvKlxuICBFZGl0b3IgZXZlbnQgc3Vic2NyaXB0aW9uLiBGaXJlcyB3aGVuIG1vdXNlIGN1cnNvciBzdG9wcGVkIG92ZXIgYSBzeW1ib2wgaW5cbiAgZWRpdG9yLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhlZGl0b3IsIGNyYW5nZSwgdHlwZSlcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnNvciByYW5nZSB0aGF0IGdlbmVyYXRlZCBldmVudC5cbiAgICB0eXBlOiBPbmUgb2YgJ21vdXNlJywgJ3NlbGVjdGlvbicgLS0gdHlwZSBvZiBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGlzXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZS5cbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcblxuICByZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25TaG91bGRTaG93VG9vbHRpcCAoY2FsbGJhY2s6IFRUb29sdGlwSGFuZGxlcikge1xuICAgIGNvbnN0IGRpc3AgPSBwbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5yZWdpc3RlcihcbiAgICAgIHBsdWdpbk5hbWUsIHtwcmlvcml0eTogMTAwLCBoYW5kbGVyOiBjYWxsYmFja31cbiAgICApXG4gICAgZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfSxcblxuICAvKlxuICBTaG93IHRvb2x0aXAgaW4gZWRpdG9yLlxuXG4gIGVkaXRvcjogZWRpdG9yIHRoYXQgd2lsbCBzaG93IHRvb2x0aXBcbiAgcG9zOiB0b29sdGlwIHBvc2l0aW9uXG4gIGV2ZW50VHlwZTogb25lIG9mICdjb250ZXh0JywgJ2tleWJvYXJkJyBhbmQgJ21vdXNlJ1xuICBkZXRhaWw6IGZvciBhdXRvbWF0aWMgc2VsZWN0aW9uIGJldHdlZW4gJ2NvbnRleHQnIGFuZCAna2V5Ym9hcmQnLlxuICAgICAgICAgIElnbm9yZWQgaWYgJ2V2ZW50VHlwZScgaXMgc2V0LlxuICB0b29sdGlwOiBmdW5jdGlvbihjcmFuZ2UpXG4gICAgY3JhbmdlOiBSYW5nZSwgY3VycmVudGx5IHNlbGVjdGVkIHJhbmdlIGluIGVkaXRvciAocG9zc2libHkgZW1wdHkpXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZVxuICAgICAgcmFuZ2U6IFJhbmdlLCB0b29sdGlwIGhpZ2hsaWdodGluZyByYW5nZVxuICAgICAgcGVyc2lzdE9uQ3Vyc29yTW92ZTogQm9vbGVhbiwgb3B0aW9uYWwsIGRlZmF1bHQgZmFsc2UsIHBlcnNpc3Qgb24gY3Vyc29yIG1vdmUgcmVnYXJkbGVzcyBvZiBzZXR0aW5nc1xuICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0LiBTdHJpbmcgb3Ige3RleHQsIGhpZ2hsaWdodGVyfSBvciB7aHRtbH1cbiAgICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0XG4gICAgICAgIGhpZ2hsaWdodGVyOiBncmFtbWFyIHNjb3BlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGhpZ2hsaWdodCB0b29sdGlwIHRleHRcbiAgICAgICAgaHRtbDogaHRtbCB0byBiZSBkaXNwbGF5ZWQgaW4gdG9vbHRpcFxuICAqL1xuICBzaG93VG9vbHRpcCAoe2VkaXRvciwgcG9zLCBldmVudFR5cGUsIGRldGFpbCwgdG9vbHRpcH06IElTaG93VG9vbHRpcFBhcmFtcykge1xuICAgIGlmICghZXZlbnRUeXBlKSB7XG4gICAgICBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKVxuICAgIH1cbiAgICBwbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5zaG93VG9vbHRpcChcbiAgICAgIGVkaXRvciwgZXZlbnRUeXBlLCB7cGx1Z2luTmFtZSwgdG9vbHRpcH1cbiAgICApXG4gIH0sXG5cbiAgLypcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBiZWZvcmUgSGFza2VsbCBidWZmZXIgaXMgc2F2ZWQuXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKGJ1ZmZlcilcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0aGF0IGdlbmVyYXRlZCBldmVudFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZVxuICAqL1xuICBvbldpbGxTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGxldCBkaXNwXG4gICAgZGlzcG9zYWJsZXMuYWRkKGRpc3AgPSBwbHVnaW5NYW5hZ2VyLm9uV2lsbFNhdmVCdWZmZXIoY2FsbGJhY2spKVxuICAgIHJldHVybiBkaXNwXG4gIH0sXG5cbiAgLypcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBhZnRlciBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cblxuICBjYWxsYmFjazogY2FsbGJhY2soYnVmZmVyKVxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBsZXQgZGlzcFxuICAgIGRpc3Bvc2FibGVzLmFkZChkaXNwID0gcGx1Z2luTWFuYWdlci5vbkRpZFNhdmVCdWZmZXIoY2FsbGJhY2spKVxuICAgIHJldHVybiBkaXNwXG4gIH0sXG5cbiAgb25EaWRTdG9wQ2hhbmdpbmcgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgbGV0IGRpc3BcbiAgICBkaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcoY2FsbGJhY2spKVxuICAgIHJldHVybiBkaXNwXG4gIH0sXG5cbiAgLypcbiAgQWRkIGEgbmV3IGNvbnRyb2wgdG8gb3VwdHV0IHBhbmVsIGhlYWRpbmcuXG5cbiAgZWxlbWVudDogSFRNTEVsZW1lbnQgb2YgY29udHJvbCwgb3IgU3RyaW5nIHdpdGggdGFnIG5hbWVcbiAgb3B0czogdmFyaW91cyBvcHRpb25zXG4gICAgaWQ6IFN0cmluZywgaWRcbiAgICBldmVudHM6IE9iamVjdCwgZXZlbnQgY2FsbGJhY2tzLCBrZXkgaXMgZXZlbnQgbmFtZSwgZS5nLiBcImNsaWNrXCIsXG4gICAgICAgICAgICB2YWx1ZSBpcyBjYWxsYmFja1xuICAgIGNsYXNzZXM6IEFycmF5IG9mIFN0cmluZywgY2xhc3Nlc1xuICAgIHN0eWxlOiBPYmplY3QsIGNzcyBzdHlsZSwga2V5cyBhcmUgc3R5bGUgYXR0cmlidXRlcywgdmFsdWVzIGFyZSB2YWx1ZXNcbiAgICBhdHRyczogT2JqZWN0LCBvdGhlciBhdHRyaWJ1dGVzLCBrZXlzIGFyZSBhdHRyaWJ1dGUgbmFtZXMsIHZhbHVlcyBhcmUgdmFsdWVzXG4gICAgYmVmb3JlOiBTdHJpbmcsIENTUyBzZWxlY3RvciBvZiBlbGVtZW50LCB0aGF0IHRoaXMgb25lIHNob3VsZCBiZSBpbnNlcnRlZFxuICAgICAgICAgICAgYmVmb3JlLCBlLmcuICcjcHJvZ3Jlc3NCYXInXG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlLlxuICAqL1xuICBhZGRQYW5lbENvbnRyb2wgKGVsZW1lbnQ6IHN0cmluZyB8IEhUTUxFbGVtZW50LCBvcHRzOiBJQ29udHJvbE9wdHMpIHtcbiAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gcGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5hZGRQYW5lbENvbnRyb2woZWxlbWVudCwgb3B0cylcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbmV3T3B0czogSUNvbnRyb2xPcHRzICYge2VsZW1lbnQ6IEhUTUxFbGVtZW50fSA9IHsuLi5vcHRzLCBlbGVtZW50fVxuICAgICAgcmV0dXJuIHBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYWRkUGFuZWxDb250cm9sKER1bW15RWxlbWVudCwgbmV3T3B0cylcbiAgICB9XG4gIH0sXG5cbiAgLypcbiAgYWRkQ29uZmlnUGFyYW1cbiAgICBwYXJhbV9uYW1lOlxuICAgICAgb25DaGFuZ2VkOiBjYWxsYmFjayB2b2lkKHZhbHVlKVxuICAgICAgaXRlbXM6IEFycmF5IG9yIGNhbGxiYWNrIEFycmF5KHZvaWQpXG4gICAgICBpdGVtVGVtcGxhdGU6IGNhbGxiYWNrLCBTdHJpbmcoaXRlbSksIGh0bWwgdGVtcGxhdGVcbiAgICAgIGl0ZW1GaWx0ZXJLZXk6IFN0cmluZywgaXRlbSBmaWx0ZXIga2V5XG4gICAgICBkZXNjcmlwdGlvbjogU3RyaW5nIFtvcHRpb25hbF1cbiAgICAgIGRpc3BsYXlOYW1lOiBTdHJpbmcgW29wdGlvbmFsLCBjYXBpdGFsaXplZCBwYXJhbV9uYW1lIGRlZmF1bHRdXG4gICAgICBkaXNwbGF5VGVtcGxhdGU6IGNhbGxiYWNrLCBTdHJpbmcoaXRlbSksIHN0cmluZyB0ZW1wbGF0ZVxuICAgICAgZGVmYXVsdDogaXRlbSwgZGVmYXVsdCB2YWx1ZVxuXG4gIFJldHVybnNcbiAgICBkaXNwOiBEaXNwb3NhYmxlXG4gICAgY2hhbmdlOiBvYmplY3Qgb2YgY2hhbmdlIGZ1bmN0aW9ucywga2V5cyBiZWluZyBwYXJhbV9uYW1lXG4gICovXG4gIGFkZENvbmZpZ1BhcmFtIChzcGVjczogeyBbcGFyYW1OYW1lOiBzdHJpbmddOiBJUGFyYW1TcGVjPE9iamVjdD4gfSkge1xuICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgZm9yIChjb25zdCBuYW1lIG9mIE9iamVjdC5rZXlzKHNwZWNzKSkge1xuICAgICAgY29uc3Qgc3BlYyA9IHNwZWNzW25hbWVdXG4gICAgICBkaXNwLmFkZChcbiAgICAgICAgcGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuYWRkKHBsdWdpbk5hbWUsIG5hbWUsIHNwZWMpXG4gICAgICApXG4gICAgfVxuICAgIHJldHVybiBkaXNwXG4gIH0sXG5cbiAgLypcbiAgZ2V0Q29uZmlnUGFyYW0ocGFyYW1OYW1lKSBvciBnZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUpXG5cbiAgcmV0dXJucyBhIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXJcbiAgdmFsdWUuXG5cbiAgUHJvbWlzZSBjYW4gYmUgcmVqZWN0ZWQgd2l0aCBlaXRoZXIgZXJyb3IsIG9yICd1bmRlZmluZWQnLiBMYXR0ZXJcbiAgaW4gY2FzZSB1c2VyIGNhbmNlbHMgcGFyYW0gc2VsZWN0aW9uIGRpYWxvZy5cbiAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnUGFyYW0gKG90aGVyUGx1Z2luTmFtZTogc3RyaW5nLCBuYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAoIW5hbWUpIHtcbiAgICAgIG5hbWUgPSBvdGhlclBsdWdpbk5hbWVcbiAgICAgIG90aGVyUGx1Z2luTmFtZSA9IHBsdWdpbk5hbWVcbiAgICB9XG4gICAgcmV0dXJuIHBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmdldChvdGhlclBsdWdpbk5hbWUsIG5hbWUpXG4gIH0sXG5cbiAgLypcbiAgc2V0Q29uZmlnUGFyYW0ocGFyYW1OYW1lLCB2YWx1ZSkgb3Igc2V0Q29uZmlnUGFyYW0ocGx1Z2luTmFtZSwgcGFyYW1OYW1lLCB2YWx1ZSlcblxuICB2YWx1ZSBpcyBvcHRpb25hbC4gSWYgb21pdHRlZCwgYSBzZWxlY3Rpb24gZGlhbG9nIHdpbGwgYmUgcHJlc2VudGVkIHRvIHVzZXIuXG5cbiAgcmV0dXJucyBhIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBwYXJhbWV0ZXIgdmFsdWUuXG5cbiAgUHJvbWlzZSBjYW4gYmUgcmVqZWN0ZWQgd2l0aCBlaXRoZXIgZXJyb3IsIG9yICd1bmRlZmluZWQnLiBMYXR0ZXJcbiAgaW4gY2FzZSB1c2VyIGNhbmNlbHMgcGFyYW0gc2VsZWN0aW9uIGRpYWxvZy5cbiAgKi9cbiAgYXN5bmMgc2V0Q29uZmlnUGFyYW0gKG90aGVyUGx1Z2luTmFtZTogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIHZhbHVlPzogT2JqZWN0KSB7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHZhbHVlID0gbmFtZVxuICAgICAgbmFtZSA9IG90aGVyUGx1Z2luTmFtZVxuICAgICAgb3RoZXJQbHVnaW5OYW1lID0gcGx1Z2luTmFtZVxuICAgIH1cbiAgICByZXR1cm4gcGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuc2V0KG90aGVyUGx1Z2luTmFtZSwgbmFtZSwgdmFsdWUpXG4gIH0sXG5cbiAgLypcbiAgVXRpbGl0eSBmdW5jdGlvbiB0byBleHRyYWN0IGV2ZW50IHJhbmdlL3R5cGUgZm9yIGEgZ2l2ZW4gZXZlbnRcblxuICBlZGl0b3I6IFRleHRFZGl0b3IsIGVkaXRvciB0aGF0IGdlbmVyYXRlZCBldmVudFxuICBkZXRhaWw6IGV2ZW50IGRldGFpbCwgaWdub3JlZCBpZiBldmVudFR5cGUgaXMgc2V0XG4gIGV2ZW50VHlwZTogU3RyaW5nLCBldmVudCB0eXBlLCBvbmUgb2YgJ2tleWJvYXJkJywgJ2NvbnRleHQnLCAnbW91c2UnXG4gIHBvczogUG9pbnQsIG9yIFBvaW50LWxpa2UgT2JqZWN0LCBldmVudCBwb3NpdGlvbiwgY2FuIGJlIHVuZGVmaW5lZFxuICBjb250cm9sbGVyOiBsZWF2ZSB1bmRlZmluZWQsIHRoaXMgaXMgaW50ZXJuYWwgZmllbGRcblxuICBjYWxsYmFjazogY2FsbGJhY2soe3BvcywgY3JhbmdlLCBldmVudFR5cGV9KVxuICAgIHBvczogUG9pbnQsIGV2ZW50IHBvc2l0aW9uXG4gICAgY3JhbmdlOiBSYW5nZSwgZXZlbnQgcmFuZ2VcbiAgICBldmVudFR5cGU6IFN0cmluZywgZXZlbnQgdHlwZSwgb25lIG9mICdrZXlib2FyZCcsICdjb250ZXh0JywgJ21vdXNlJ1xuICAqL1xuICB3aXRoRXZlbnRSYW5nZTxUPiAoe2VkaXRvciwgZGV0YWlsLCBldmVudFR5cGUsIHBvc306IElFdmVudFJhbmdlUGFyYW1zLCBjYWxsYmFjazogVEV2ZW50UmFuZ2VDYWxsYmFjazxUPikge1xuICAgIGxldCBwcG9zOiBQb2ludCB8IHVuZGVmaW5lZFxuICAgIGlmIChwb3MpIHsgcHBvcyA9IFBvaW50LmZyb21PYmplY3QocG9zKSB9XG4gICAgaWYgKCFldmVudFR5cGUpIHsgZXZlbnRUeXBlID0gZ2V0RXZlbnRUeXBlKGRldGFpbCkgfVxuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBwbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIGlmICghY29udHJvbGxlcikgeyByZXR1cm4gfVxuICAgIGNvbnN0IHJlcyA9IGNvbnRyb2xsZXIuZ2V0RXZlbnRSYW5nZShldmVudFR5cGUpXG4gICAgaWYgKCFyZXMpIHsgcmV0dXJuIH1cbiAgICByZXR1cm4gY2FsbGJhY2socmVzKVxuICB9XG4gIH1cbn1cbiJdfQ==