"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const dummy_element_1 = require("./dummy-element");
function instance(pluginManager, outerDisposables, pluginName) {
    const disposables = new atom_1.CompositeDisposable();
    outerDisposables.add(disposables);
    const messageProvider = pluginManager.resultsDB.registerProvider(pluginName);
    disposables.add(messageProvider);
    let messages = [];
    return {
        setMenu(name, menu) {
            let menuDisp;
            disposables.add(menuDisp = atom.menu.add([{
                    label: utils_1.MAIN_MENU_LABEL,
                    submenu: [{ label: name, submenu: menu }]
                }
            ]));
            return menuDisp;
        },
        setStatus(status) {
            return pluginManager.outputPanel.backendStatus(pluginName, status);
        },
        addMessages(newMessages, types) {
            messages.push(...newMessages);
            messageProvider.setMessages(messages);
        },
        setMessages(newMessages, types) {
            messages = [...newMessages];
            messageProvider.setMessages(messages);
        },
        clearMessages(types) {
            messages = messages.filter(({ severity }) => !types.includes(severity));
            messageProvider.setMessages(messages);
        },
        setMessageTypes(types) {
            return (() => {
                const result = [];
                for (const type of Object.keys(types)) {
                    const opts = types[type];
                    result.push(pluginManager.outputPanel.createTab(type, opts));
                }
                return result;
            })();
        },
        onShouldShowTooltip(callback) {
            const disp = pluginManager.tooltipRegistry.register(pluginName, { priority: 100, handler: callback });
            disposables.add(disp);
            return disp;
        },
        showTooltip({ editor, pos, eventType, detail, tooltip }) {
            if (!eventType) {
                eventType = utils_1.getEventType(detail);
            }
            pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName, tooltip });
        },
        onWillSaveBuffer(callback) {
            let disp;
            disposables.add(disp = pluginManager.onWillSaveBuffer(callback));
            return disp;
        },
        onDidSaveBuffer(callback) {
            let disp;
            disposables.add(disp = pluginManager.onDidSaveBuffer(callback));
            return disp;
        },
        onDidStopChanging(callback) {
            let disp;
            disposables.add(disp = pluginManager.onDidStopChanging(callback));
            return disp;
        },
        addPanelControl(element, opts) {
            if (typeof element === 'string') {
                return pluginManager.outputPanel.addPanelControl(element, opts);
            }
            else {
                const newOpts = Object.assign({}, opts, { element });
                return pluginManager.outputPanel.addPanelControl(dummy_element_1.DummyElement, newOpts);
            }
        },
        addConfigParam(specs) {
            const disp = new atom_1.CompositeDisposable();
            for (const name of Object.keys(specs)) {
                const spec = specs[name];
                disp.add(pluginManager.configParamManager.add(pluginName, name, spec));
            }
            return disp;
        },
        getConfigParam(otherPluginName, name) {
            return __awaiter(this, void 0, void 0, function* () {
                if (!name) {
                    name = otherPluginName;
                    otherPluginName = pluginName;
                }
                return pluginManager.configParamManager.get(otherPluginName, name);
            });
        },
        setConfigParam(otherPluginName, name, value) {
            return __awaiter(this, void 0, void 0, function* () {
                if (value === undefined) {
                    value = name;
                    name = otherPluginName;
                    otherPluginName = pluginName;
                }
                return pluginManager.configParamManager.set(otherPluginName, name, value);
            });
        },
        withEventRange({ editor, detail, eventType, pos }, callback) {
            let ppos;
            if (pos) {
                ppos = atom_1.Point.fromObject(pos);
            }
            if (!eventType) {
                eventType = utils_1.getEventType(detail);
            }
            const controller = pluginManager.controller(editor);
            if (!controller) {
                return;
            }
            const res = controller.getEventRange(eventType);
            if (!res) {
                return;
            }
            return callback(res);
        }
    };
}
exports.instance = instance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBLCtCQUFvRTtBQUNwRSxvQ0FBd0Q7QUFTeEQsbURBQTRDO0FBbUI1QyxrQkFBMEIsYUFBNEIsRUFBRSxnQkFBcUMsRUFBRSxVQUFrQjtJQUMvRyxNQUFNLFdBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7SUFDN0MsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0lBQ2pDLE1BQU0sZUFBZSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDNUUsV0FBVyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQTtJQUNoQyxJQUFJLFFBQVEsR0FBa0IsRUFBRSxDQUFBO0lBQ2hDLE1BQU0sQ0FBQztRQVFQLE9BQU8sQ0FBRSxJQUFZLEVBQUUsSUFBVztZQUNoQyxJQUFJLFFBQVEsQ0FBQTtZQUNaLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ3hDLEtBQUssRUFBRSx1QkFBZTtvQkFDdEIsT0FBTyxFQUFFLENBQUUsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBRTtpQkFDMUM7YUFDQSxDQUFDLENBQUMsQ0FBQTtZQUNILE1BQU0sQ0FBQyxRQUFRLENBQUE7UUFDakIsQ0FBQztRQVNELFNBQVMsQ0FBRSxNQUFlO1lBQ3hCLE1BQU0sQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFDcEUsQ0FBQztRQWFELFdBQVcsQ0FBRSxXQUEwQixFQUFFLEtBQW1CO1lBQzFELFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxXQUFXLENBQUMsQ0FB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QUFBO29CQUNaLElBQUksR0FBRyxlQUFlLENBQUE7b0JBQ3RCLGVBQWUsR0FBRyxVQUFVLENBQUE7Z0JBQzlCLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQTtZQUMzRSxDQUFDO1NBQUE7UUFnQkQsY0FBYyxDQUFFLEVBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFvQixFQUFFLFFBQWtDO1lBQ3JHLElBQUksSUFBdUIsQ0FBQTtZQUMzQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUFDLElBQUksR0FBRyxZQUFLLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1lBQUMsQ0FBQztZQUN6QyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsU0FBUyxHQUFHLG9CQUFZLENBQUMsTUFBTSxDQUFDLENBQUE7WUFBQyxDQUFDO1lBQ3BELE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDbkQsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUFDLE1BQU0sQ0FBQTtZQUFDLENBQUM7WUFDM0IsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtZQUMvQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsTUFBTSxDQUFBO1lBQUMsQ0FBQztZQUNwQixNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ3RCLENBQUM7S0FDQSxDQUFBO0FBQ0gsQ0FBQztBQTFTRCw0QkEwU0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBQb2ludCwgVGV4dEVkaXRvciwgUmFuZ2UgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgTUFJTl9NRU5VX0xBQkVMLCBnZXRFdmVudFR5cGUgfSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7UGx1Z2luTWFuYWdlcn0gZnJvbSAnLi4vcGx1Z2luLW1hbmFnZXInXG5pbXBvcnQge0lTdGF0dXMsIElTZXZlcml0eVRhYkRlZmluaXRpb24sIElDb250cm9sT3B0c30gZnJvbSAnLi4vb3V0cHV0LXBhbmVsJ1xuaW1wb3J0IHtJUmVzdWx0SXRlbSwgVFNldmVyaXR5fSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtURXZlbnRSYW5nZVR5cGV9IGZyb20gJy4uL2VkaXRvci1jb250cm9sL3Rvb2x0aXAtbWFuYWdlcidcbmltcG9ydCB7VFBvc2l0aW9ufSBmcm9tICcuLi9yZXN1bHRzLWRiJ1xuaW1wb3J0IHtJUGFyYW1TcGVjfSBmcm9tICcuLi9jb25maWctcGFyYW1zJ1xuaW1wb3J0IHtUVGV4dEJ1ZmZlckNhbGxiYWNrfSBmcm9tICcuLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7VFRvb2x0aXBIYW5kbGVyLCBUVG9vbHRpcEZ1bmN0aW9ufSBmcm9tICcuLi90b29sdGlwLXJlZ2lzdHJ5J1xuaW1wb3J0IHtEdW1teUVsZW1lbnR9IGZyb20gJy4vZHVtbXktZWxlbWVudCdcblxuZXhwb3J0IGludGVyZmFjZSBJU2hvd1Rvb2x0aXBQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgcG9zOiBUUG9zaXRpb25cbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIGRldGFpbD86IGFueVxuICB0b29sdGlwOiBUVG9vbHRpcEZ1bmN0aW9uXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUV2ZW50UmFuZ2VQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgZGV0YWlsPzogYW55XG4gIGV2ZW50VHlwZT86IFRFdmVudFJhbmdlVHlwZVxuICBwb3M6IFRQb3NpdGlvblxufVxuXG5leHBvcnQgdHlwZSBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+ID0gKHBhcnM6IHtwb3M6IFBvaW50LCBjcmFuZ2U6IFJhbmdlLCBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZX0pID0+IFRcblxuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbmNlIChwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLCBvdXRlckRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLCBwbHVnaW5OYW1lOiBzdHJpbmcpIHtcbiAgY29uc3QgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIG91dGVyRGlzcG9zYWJsZXMuYWRkKGRpc3Bvc2FibGVzKVxuICBjb25zdCBtZXNzYWdlUHJvdmlkZXIgPSBwbHVnaW5NYW5hZ2VyLnJlc3VsdHNEQi5yZWdpc3RlclByb3ZpZGVyKHBsdWdpbk5hbWUpXG4gIGRpc3Bvc2FibGVzLmFkZChtZXNzYWdlUHJvdmlkZXIpXG4gIGxldCBtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSA9IFtdXG4gIHJldHVybiB7XG4gIC8qXG4gIEFkZHMgbmV3IHN1bWJlbnUgdG8gJ0hhc2tlbGwgSURFJyBtZW51IGl0ZW1cbiAgbmFtZSAtLSBzdWJtZW51IGxhYmVsLCBzaG91bGQgYmUgZGVzY3JpcHRpdmUgb2YgYSBwYWNrYWdlXG4gIG1lbnUgLS0gQXRvbSBtZW51IG9iamVjdFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZS5cbiAgKi9cbiAgc2V0TWVudSAobmFtZTogc3RyaW5nLCBtZW51OiBhbnlbXSkge1xuICAgIGxldCBtZW51RGlzcFxuICAgIGRpc3Bvc2FibGVzLmFkZChtZW51RGlzcCA9IGF0b20ubWVudS5hZGQoW3tcbiAgICAgIGxhYmVsOiBNQUlOX01FTlVfTEFCRUwsXG4gICAgICBzdWJtZW51OiBbIHtsYWJlbDogbmFtZSwgc3VibWVudTogbWVudX0gXVxuICAgIH1cbiAgICBdKSlcbiAgICByZXR1cm4gbWVudURpc3BcbiAgfSxcblxuICAvKlxuICBTZXRzIGJhY2tlbmQgc3RhdHVzXG4gIHN0YXR1cyAtLSBvYmplY3RcbiAgICBzdGF0dXM6IG9uZSBvZiAncHJvZ3Jlc3MnLCAncmVhZHknLCAnZXJyb3InLCAnd2FybmluZydcbiAgICBwcm9ncmVzczogZmxvYXQgYmV0d2VlbiAwIGFuZCAxLCBvbmx5IHJlbGV2YW50IHdoZW4gc3RhdHVzIGlzICdwcm9ncmVzcydcbiAgICAgICAgICAgICAgaWYgMCBvciB1bmRlZmluZWQsIHByb2dyZXNzIGJhciBpcyBub3Qgc2hvd25cbiAgKi9cbiAgc2V0U3RhdHVzIChzdGF0dXM6IElTdGF0dXMpIHtcbiAgICByZXR1cm4gcGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5iYWNrZW5kU3RhdHVzKHBsdWdpbk5hbWUsIHN0YXR1cylcbiAgfSxcblxuICAvKlxuICBBZGQgbWVzc2FnZXMgdG8gaWRlLWhhc2tlbGwgb3V0cHV0XG4gIG1lc3NhZ2VzOiBBcnJheSBvZiBPYmplY3RcbiAgICB1cmk6IFN0cmluZywgRmlsZSBVUkkgbWVzc2FnZSByZWxhdGVzIHRvXG4gICAgcG9zaXRpb246IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgcG9zaXRpb24gdG8gd2hpY2ggbWVzc2FnZSByZWxhdGVzXG4gICAgbWVzc2FnZTogU3RyaW5nIG9yIHs8dGV4dCB8IGh0bWw+LCBoaWdobGlnaHRlcj99LCBtZXNzYWdlXG4gICAgc2V2ZXJpdHk6IFN0cmluZywgb25lIG9mICdlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnLCAnYnVpbGQnLFxuICAgICAgICAgICAgICBvciB1c2VyLWRlZmluZWQsIHNlZSBgc2V0TWVzc2FnZVR5cGVzYFxuICB0eXBlczogQXJyYXkgb2YgU3RyaW5nLCBjb250YWluaW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YC4gSWYgdW5kZWZpbmVkLFxuICAgICAgICAgd2lsbCBiZSB0YWtlbiBmcm9tIGBtZXNzYWdlc2BcbiAgKi9cbiAgYWRkTWVzc2FnZXMgKG5ld01lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdLCB0eXBlcz86IFRTZXZlcml0eVtdKSB7XG4gICAgbWVzc2FnZXMucHVzaCguLi5uZXdNZXNzYWdlcylcbiAgICBtZXNzYWdlUHJvdmlkZXIuc2V0TWVzc2FnZXMobWVzc2FnZXMpXG4gIH0sXG5cbiAgLypcbiAgU2V0IG1lc3NhZ2VzIGluIGlkZS1oYXNrZWxsIG91dHB1dC4gQ2xlYXJzIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoXG4gIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuICBtZXNzYWdlczogQXJyYXkgb2YgT2JqZWN0XG4gICAgdXJpOiBTdHJpbmcsIEZpbGUgVVJJIG1lc3NhZ2UgcmVsYXRlcyB0b1xuICAgIHBvc2l0aW9uOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIHBvc2l0aW9uIHRvIHdoaWNoIG1lc3NhZ2UgcmVsYXRlc1xuICAgIG1lc3NhZ2U6IFN0cmluZywgbWVzc2FnZVxuICAgIHNldmVyaXR5OiBTdHJpbmcsIG9uZSBvZiAnZXJyb3InLCAnd2FybmluZycsICdsaW50JywgJ2J1aWxkJyxcbiAgICAgICAgICAgICAgb3IgdXNlci1kZWZpbmVkLCBzZWUgYHNldE1lc3NhZ2VUeXBlc2BcbiAgdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIHNldE1lc3NhZ2VzIChuZXdNZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM6IFRTZXZlcml0eVtdKSB7XG4gICAgbWVzc2FnZXMgPSBbLi4ubmV3TWVzc2FnZXNdXG4gICAgbWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKG1lc3NhZ2VzKVxuICB9LFxuXG4gIC8qXG4gIENsZWFyIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuICBUaGlzIGlzIHNob3J0aGFuZCBmcm9tIGBzZXRNZXNzYWdlcyhbXSx0eXBlcylgXG4gICovXG4gIGNsZWFyTWVzc2FnZXMgKHR5cGVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIG1lc3NhZ2VzID0gbWVzc2FnZXMuZmlsdGVyKCh7c2V2ZXJpdHl9KSA9PiAhdHlwZXMuaW5jbHVkZXMoc2V2ZXJpdHkpKVxuICAgIG1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyhtZXNzYWdlcylcbiAgfSxcblxuICAvKlxuICBTZXQgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgIHRoYXQgeW91ciBwYWNrYWdlIHdpbGwgdXNlLlxuICB0eXBlczogT2JqZWN0IHdpdGgga2V5cyByZXByZXNlbnRpbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgIChpLmUuIHRhYiBuYW1lKVxuICAgICAgICAgYW5kIHZhbHVlcyBiZWluZyBPYmplY3RzIHdpdGgga2V5c1xuICAgIHVyaUZpbHRlcjogQm9vbCwgc2hvdWxkIHVyaSBmaWx0ZXIgYXBwbHkgdG8gdGFiP1xuICAgIGF1dG9TY3JvbGw6IEJvb2wsIHNob3VsZCB0YWIgYXV0by1zY3JvbGw/XG5cbiAgVGhpcyBhbGxvd3MgdG8gZGVmaW5lIGN1c3RvbSBvdXRwdXQgcGFuZWwgdGFicy5cbiAgKi9cbiAgc2V0TWVzc2FnZVR5cGVzICh0eXBlczogeyBbc2V2ZXJpdHk6IHN0cmluZ106IElTZXZlcml0eVRhYkRlZmluaXRpb259KSB7XG4gICAgcmV0dXJuICgoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBbXVxuICAgICAgZm9yIChjb25zdCB0eXBlIG9mIE9iamVjdC5rZXlzKHR5cGVzKSkge1xuICAgICAgICBjb25zdCBvcHRzID0gdHlwZXNbdHlwZV1cbiAgICAgICAgcmVzdWx0LnB1c2gocGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5jcmVhdGVUYWIodHlwZSwgb3B0cykpXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0XG4gICAgfSkoKVxuICB9LFxuXG4gIC8qXG4gIEVkaXRvciBldmVudCBzdWJzY3JpcHRpb24uIEZpcmVzIHdoZW4gbW91c2UgY3Vyc29yIHN0b3BwZWQgb3ZlciBhIHN5bWJvbCBpblxuICBlZGl0b3IuXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKGVkaXRvciwgY3JhbmdlLCB0eXBlKVxuICAgIGVkaXRvcjogVGV4dEVkaXRvciwgZWRpdG9yIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG4gICAgY3JhbmdlOiBSYW5nZSwgY3Vyc29yIHJhbmdlIHRoYXQgZ2VuZXJhdGVkIGV2ZW50LlxuICAgIHR5cGU6IE9uZSBvZiAnbW91c2UnLCAnc2VsZWN0aW9uJyAtLSB0eXBlIG9mIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoaXNcblxuICAgIFJldHVybnMge3JhbmdlLCB0ZXh0fSBvciBQcm9taXNlLlxuICAgICAgcmFuZ2U6IFJhbmdlLCB0b29sdGlwIGhpZ2hsaWdodGluZyByYW5nZVxuICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0LiBTdHJpbmcgb3Ige3RleHQsIGhpZ2hsaWdodGVyfSBvciB7aHRtbH1cbiAgICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0XG4gICAgICAgIGhpZ2hsaWdodGVyOiBncmFtbWFyIHNjb3BlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGhpZ2hsaWdodCB0b29sdGlwIHRleHRcbiAgICAgICAgaHRtbDogaHRtbCB0byBiZSBkaXNwbGF5ZWQgaW4gdG9vbHRpcFxuXG4gIHJldHVybnMgRGlzcG9zYWJsZVxuICAqL1xuICBvblNob3VsZFNob3dUb29sdGlwIChjYWxsYmFjazogVFRvb2x0aXBIYW5kbGVyKSB7XG4gICAgY29uc3QgZGlzcCA9IHBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnJlZ2lzdGVyKFxuICAgICAgcGx1Z2luTmFtZSwge3ByaW9yaXR5OiAxMDAsIGhhbmRsZXI6IGNhbGxiYWNrfVxuICAgIClcbiAgICBkaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9LFxuXG4gIC8qXG4gIFNob3cgdG9vbHRpcCBpbiBlZGl0b3IuXG5cbiAgZWRpdG9yOiBlZGl0b3IgdGhhdCB3aWxsIHNob3cgdG9vbHRpcFxuICBwb3M6IHRvb2x0aXAgcG9zaXRpb25cbiAgZXZlbnRUeXBlOiBvbmUgb2YgJ2NvbnRleHQnLCAna2V5Ym9hcmQnIGFuZCAnbW91c2UnXG4gIGRldGFpbDogZm9yIGF1dG9tYXRpYyBzZWxlY3Rpb24gYmV0d2VlbiAnY29udGV4dCcgYW5kICdrZXlib2FyZCcuXG4gICAgICAgICAgSWdub3JlZCBpZiAnZXZlbnRUeXBlJyBpcyBzZXQuXG4gIHRvb2x0aXA6IGZ1bmN0aW9uKGNyYW5nZSlcbiAgICBjcmFuZ2U6IFJhbmdlLCBjdXJyZW50bHkgc2VsZWN0ZWQgcmFuZ2UgaW4gZWRpdG9yIChwb3NzaWJseSBlbXB0eSlcblxuICAgIFJldHVybnMge3JhbmdlLCB0ZXh0fSBvciBQcm9taXNlXG4gICAgICByYW5nZTogUmFuZ2UsIHRvb2x0aXAgaGlnaGxpZ2h0aW5nIHJhbmdlXG4gICAgICBwZXJzaXN0T25DdXJzb3JNb3ZlOiBCb29sZWFuLCBvcHRpb25hbCwgZGVmYXVsdCBmYWxzZSwgcGVyc2lzdCBvbiBjdXJzb3IgbW92ZSByZWdhcmRsZXNzIG9mIHNldHRpbmdzXG4gICAgICB0ZXh0OiB0b29sdGlwIHRleHQuIFN0cmluZyBvciB7dGV4dCwgaGlnaGxpZ2h0ZXJ9IG9yIHtodG1sfVxuICAgICAgICB0ZXh0OiB0b29sdGlwIHRleHRcbiAgICAgICAgaGlnaGxpZ2h0ZXI6IGdyYW1tYXIgc2NvcGUgdGhhdCB3aWxsIGJlIHVzZWQgdG8gaGlnaGxpZ2h0IHRvb2x0aXAgdGV4dFxuICAgICAgICBodG1sOiBodG1sIHRvIGJlIGRpc3BsYXllZCBpbiB0b29sdGlwXG4gICovXG4gIHNob3dUb29sdGlwICh7ZWRpdG9yLCBwb3MsIGV2ZW50VHlwZSwgZGV0YWlsLCB0b29sdGlwfTogSVNob3dUb29sdGlwUGFyYW1zKSB7XG4gICAgaWYgKCFldmVudFR5cGUpIHtcbiAgICAgIGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpXG4gICAgfVxuICAgIHBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnNob3dUb29sdGlwKFxuICAgICAgZWRpdG9yLCBldmVudFR5cGUsIHtwbHVnaW5OYW1lLCB0b29sdGlwfVxuICAgIClcbiAgfSxcblxuICAvKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGJlZm9yZSBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cblxuICBjYWxsYmFjazogY2FsbGJhY2soYnVmZmVyKVxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uV2lsbFNhdmVCdWZmZXIgKGNhbGxiYWNrOiBUVGV4dEJ1ZmZlckNhbGxiYWNrKSB7XG4gICAgbGV0IGRpc3BcbiAgICBkaXNwb3NhYmxlcy5hZGQoZGlzcCA9IHBsdWdpbk1hbmFnZXIub25XaWxsU2F2ZUJ1ZmZlcihjYWxsYmFjaykpXG4gICAgcmV0dXJuIGRpc3BcbiAgfSxcblxuICAvKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGFmdGVyIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhidWZmZXIpXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcblxuICBSZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25EaWRTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGxldCBkaXNwXG4gICAgZGlzcG9zYWJsZXMuYWRkKGRpc3AgPSBwbHVnaW5NYW5hZ2VyLm9uRGlkU2F2ZUJ1ZmZlcihjYWxsYmFjaykpXG4gICAgcmV0dXJuIGRpc3BcbiAgfSxcblxuICBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBsZXQgZGlzcFxuICAgIGRpc3Bvc2FibGVzLmFkZChkaXNwID0gcGx1Z2luTWFuYWdlci5vbkRpZFN0b3BDaGFuZ2luZyhjYWxsYmFjaykpXG4gICAgcmV0dXJuIGRpc3BcbiAgfSxcblxuICAvKlxuICBBZGQgYSBuZXcgY29udHJvbCB0byBvdXB0dXQgcGFuZWwgaGVhZGluZy5cblxuICBlbGVtZW50OiBIVE1MRWxlbWVudCBvZiBjb250cm9sLCBvciBTdHJpbmcgd2l0aCB0YWcgbmFtZVxuICBvcHRzOiB2YXJpb3VzIG9wdGlvbnNcbiAgICBpZDogU3RyaW5nLCBpZFxuICAgIGV2ZW50czogT2JqZWN0LCBldmVudCBjYWxsYmFja3MsIGtleSBpcyBldmVudCBuYW1lLCBlLmcuIFwiY2xpY2tcIixcbiAgICAgICAgICAgIHZhbHVlIGlzIGNhbGxiYWNrXG4gICAgY2xhc3NlczogQXJyYXkgb2YgU3RyaW5nLCBjbGFzc2VzXG4gICAgc3R5bGU6IE9iamVjdCwgY3NzIHN0eWxlLCBrZXlzIGFyZSBzdHlsZSBhdHRyaWJ1dGVzLCB2YWx1ZXMgYXJlIHZhbHVlc1xuICAgIGF0dHJzOiBPYmplY3QsIG90aGVyIGF0dHJpYnV0ZXMsIGtleXMgYXJlIGF0dHJpYnV0ZSBuYW1lcywgdmFsdWVzIGFyZSB2YWx1ZXNcbiAgICBiZWZvcmU6IFN0cmluZywgQ1NTIHNlbGVjdG9yIG9mIGVsZW1lbnQsIHRoYXQgdGhpcyBvbmUgc2hvdWxkIGJlIGluc2VydGVkXG4gICAgICAgICAgICBiZWZvcmUsIGUuZy4gJyNwcm9ncmVzc0JhcidcblxuICBSZXR1cm5zIERpc3Bvc2FibGUuXG4gICovXG4gIGFkZFBhbmVsQ29udHJvbCAoZWxlbWVudDogc3RyaW5nIHwgSFRNTEVsZW1lbnQsIG9wdHM6IElDb250cm9sT3B0cykge1xuICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBwbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmFkZFBhbmVsQ29udHJvbChlbGVtZW50LCBvcHRzKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBuZXdPcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9ID0gey4uLm9wdHMsIGVsZW1lbnR9XG4gICAgICByZXR1cm4gcGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5hZGRQYW5lbENvbnRyb2woRHVtbXlFbGVtZW50LCBuZXdPcHRzKVxuICAgIH1cbiAgfSxcblxuICAvKlxuICBhZGRDb25maWdQYXJhbVxuICAgIHBhcmFtX25hbWU6XG4gICAgICBvbkNoYW5nZWQ6IGNhbGxiYWNrIHZvaWQodmFsdWUpXG4gICAgICBpdGVtczogQXJyYXkgb3IgY2FsbGJhY2sgQXJyYXkodm9pZClcbiAgICAgIGl0ZW1UZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgaHRtbCB0ZW1wbGF0ZVxuICAgICAgaXRlbUZpbHRlcktleTogU3RyaW5nLCBpdGVtIGZpbHRlciBrZXlcbiAgICAgIGRlc2NyaXB0aW9uOiBTdHJpbmcgW29wdGlvbmFsXVxuICAgICAgZGlzcGxheU5hbWU6IFN0cmluZyBbb3B0aW9uYWwsIGNhcGl0YWxpemVkIHBhcmFtX25hbWUgZGVmYXVsdF1cbiAgICAgIGRpc3BsYXlUZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgc3RyaW5nIHRlbXBsYXRlXG4gICAgICBkZWZhdWx0OiBpdGVtLCBkZWZhdWx0IHZhbHVlXG5cbiAgUmV0dXJuc1xuICAgIGRpc3A6IERpc3Bvc2FibGVcbiAgICBjaGFuZ2U6IG9iamVjdCBvZiBjaGFuZ2UgZnVuY3Rpb25zLCBrZXlzIGJlaW5nIHBhcmFtX25hbWVcbiAgKi9cbiAgYWRkQ29uZmlnUGFyYW0gKHNwZWNzOiB7IFtwYXJhbU5hbWU6IHN0cmluZ106IElQYXJhbVNwZWM8YW55PiB9KSB7XG4gICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoc3BlY3MpKSB7XG4gICAgICBjb25zdCBzcGVjID0gc3BlY3NbbmFtZV1cbiAgICAgIGRpc3AuYWRkKFxuICAgICAgICBwbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5hZGQocGx1Z2luTmFtZSwgbmFtZSwgc3BlYylcbiAgICAgIClcbiAgICB9XG4gICAgcmV0dXJuIGRpc3BcbiAgfSxcblxuICAvKlxuICBnZXRDb25maWdQYXJhbShwYXJhbU5hbWUpIG9yIGdldENvbmZpZ1BhcmFtKHBsdWdpbk5hbWUsIHBhcmFtTmFtZSlcblxuICByZXR1cm5zIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlclxuICB2YWx1ZS5cblxuICBQcm9taXNlIGNhbiBiZSByZWplY3RlZCB3aXRoIGVpdGhlciBlcnJvciwgb3IgJ3VuZGVmaW5lZCcuIExhdHRlclxuICBpbiBjYXNlIHVzZXIgY2FuY2VscyBwYXJhbSBzZWxlY3Rpb24gZGlhbG9nLlxuICAqL1xuICBhc3luYyBnZXRDb25maWdQYXJhbSAob3RoZXJQbHVnaW5OYW1lOiBzdHJpbmcsIG5hbWU6IHN0cmluZykge1xuICAgIGlmICghbmFtZSkge1xuICAgICAgbmFtZSA9IG90aGVyUGx1Z2luTmFtZVxuICAgICAgb3RoZXJQbHVnaW5OYW1lID0gcGx1Z2luTmFtZVxuICAgIH1cbiAgICByZXR1cm4gcGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuZ2V0KG90aGVyUGx1Z2luTmFtZSwgbmFtZSlcbiAgfSxcblxuICAvKlxuICBzZXRDb25maWdQYXJhbShwYXJhbU5hbWUsIHZhbHVlKSBvciBzZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUsIHZhbHVlKVxuXG4gIHZhbHVlIGlzIG9wdGlvbmFsLiBJZiBvbWl0dGVkLCBhIHNlbGVjdGlvbiBkaWFsb2cgd2lsbCBiZSBwcmVzZW50ZWQgdG8gdXNlci5cblxuICByZXR1cm5zIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlciB2YWx1ZS5cblxuICBQcm9taXNlIGNhbiBiZSByZWplY3RlZCB3aXRoIGVpdGhlciBlcnJvciwgb3IgJ3VuZGVmaW5lZCcuIExhdHRlclxuICBpbiBjYXNlIHVzZXIgY2FuY2VscyBwYXJhbSBzZWxlY3Rpb24gZGlhbG9nLlxuICAqL1xuICBhc3luYyBzZXRDb25maWdQYXJhbSAob3RoZXJQbHVnaW5OYW1lOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB2YWx1ZSA9IG5hbWVcbiAgICAgIG5hbWUgPSBvdGhlclBsdWdpbk5hbWVcbiAgICAgIG90aGVyUGx1Z2luTmFtZSA9IHBsdWdpbk5hbWVcbiAgICB9XG4gICAgcmV0dXJuIHBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLnNldChvdGhlclBsdWdpbk5hbWUsIG5hbWUsIHZhbHVlKVxuICB9LFxuXG4gIC8qXG4gIFV0aWxpdHkgZnVuY3Rpb24gdG8gZXh0cmFjdCBldmVudCByYW5nZS90eXBlIGZvciBhIGdpdmVuIGV2ZW50XG5cbiAgZWRpdG9yOiBUZXh0RWRpdG9yLCBlZGl0b3IgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcbiAgZGV0YWlsOiBldmVudCBkZXRhaWwsIGlnbm9yZWQgaWYgZXZlbnRUeXBlIGlzIHNldFxuICBldmVudFR5cGU6IFN0cmluZywgZXZlbnQgdHlwZSwgb25lIG9mICdrZXlib2FyZCcsICdjb250ZXh0JywgJ21vdXNlJ1xuICBwb3M6IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgZXZlbnQgcG9zaXRpb24sIGNhbiBiZSB1bmRlZmluZWRcbiAgY29udHJvbGxlcjogbGVhdmUgdW5kZWZpbmVkLCB0aGlzIGlzIGludGVybmFsIGZpZWxkXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKHtwb3MsIGNyYW5nZSwgZXZlbnRUeXBlfSlcbiAgICBwb3M6IFBvaW50LCBldmVudCBwb3NpdGlvblxuICAgIGNyYW5nZTogUmFuZ2UsIGV2ZW50IHJhbmdlXG4gICAgZXZlbnRUeXBlOiBTdHJpbmcsIGV2ZW50IHR5cGUsIG9uZSBvZiAna2V5Ym9hcmQnLCAnY29udGV4dCcsICdtb3VzZSdcbiAgKi9cbiAgd2l0aEV2ZW50UmFuZ2UgKHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3N9OiBJRXZlbnRSYW5nZVBhcmFtcywgY2FsbGJhY2s6IFRFdmVudFJhbmdlQ2FsbGJhY2s8YW55Pikge1xuICAgIGxldCBwcG9zOiBQb2ludCB8IHVuZGVmaW5lZFxuICAgIGlmIChwb3MpIHsgcHBvcyA9IFBvaW50LmZyb21PYmplY3QocG9zKSB9XG4gICAgaWYgKCFldmVudFR5cGUpIHsgZXZlbnRUeXBlID0gZ2V0RXZlbnRUeXBlKGRldGFpbCkgfVxuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBwbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIGlmICghY29udHJvbGxlcikgeyByZXR1cm4gfVxuICAgIGNvbnN0IHJlcyA9IGNvbnRyb2xsZXIuZ2V0RXZlbnRSYW5nZShldmVudFR5cGUpXG4gICAgaWYgKCFyZXMpIHsgcmV0dXJuIH1cbiAgICByZXR1cm4gY2FsbGJhY2socmVzKVxuICB9XG4gIH1cbn1cbiJdfQ==