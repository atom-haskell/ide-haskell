"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const dummy_element_1 = require("./dummy-element");
function instance(pluginManager, outerDisposables, pluginName) {
    return new UPIInstance(pluginManager, outerDisposables, pluginName);
}
exports.instance = instance;
class UPIInstance {
    constructor(pluginManager, outerDisposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        this.messages = [];
        this.disposables = new atom_1.CompositeDisposable();
        outerDisposables.add(this.disposables);
        this.messageProvider = pluginManager.resultsDB.registerProvider(pluginName);
        this.disposables.add(this.messageProvider);
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputPanel.backendStatus(this.pluginName, status);
    }
    addMessages(newMessages, types) {
        this.messages.push(...newMessages);
        this.messageProvider.setMessages(this.messages);
    }
    setMessages(newMessages, types) {
        this.messages = [...newMessages];
        this.messageProvider.setMessages(this.messages);
    }
    clearMessages(types) {
        this.messages = this.messages.filter(({ severity }) => !types.includes(severity));
        this.messageProvider.setMessages(this.messages);
    }
    setMessageTypes(types) {
        return (() => {
            const result = [];
            for (const type of Object.keys(types)) {
                const opts = types[type];
                result.push(this.pluginManager.outputPanel.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        const disp = this.pluginManager.tooltipRegistry.register(this.pluginName, { priority: 100, handler: callback });
        this.disposables.add(disp);
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        this.pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName: this.pluginName, tooltip });
    }
    onWillSaveBuffer(callback) {
        const disp = this.pluginManager.onWillSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidSaveBuffer(callback) {
        const disp = this.pluginManager.onDidSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidStopChanging(callback) {
        const disp = this.pluginManager.onDidStopChanging(callback);
        this.disposables.add(disp);
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            return this.pluginManager.outputPanel.addPanelControl({ element, opts });
        }
        else {
            const newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputPanel.addPanelControl({ element: dummy_element_1.DummyElement, opts: newOpts });
        }
    }
    addConfigParam(specs) {
        const disp = new atom_1.CompositeDisposable();
        for (const name of Object.keys(specs)) {
            const spec = specs[name];
            disp.add(this.pluginManager.configParamManager.add(this.pluginName, name, spec));
        }
        return disp;
    }
    getConfigParam(otherPluginName, name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!name) {
                name = otherPluginName;
                otherPluginName = this.pluginName;
            }
            return this.pluginManager.configParamManager.get(otherPluginName, name);
        });
    }
    setConfigParam(otherPluginName, name, value) {
        return __awaiter(this, void 0, void 0, function* () {
            if (value === undefined) {
                value = name;
                name = otherPluginName;
                otherPluginName = this.pluginName;
            }
            return this.pluginManager.configParamManager.set(otherPluginName, name, value);
        });
    }
    withEventRange({ editor, detail, eventType, pos }, callback) {
        let ppos;
        if (pos) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        const controller = this.pluginManager.controller(editor);
        if (!controller) {
            return;
        }
        const res = controller.getEventRange(eventType);
        if (!res) {
            return;
        }
        return callback(res);
    }
}
exports.UPIInstance = UPIInstance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUNBLCtCQUFvRTtBQUNwRSxvQ0FBd0Q7QUFVeEQsbURBQTRDO0FBK0I1QyxrQkFBMEIsYUFBNEIsRUFBRSxnQkFBcUMsRUFBRSxVQUFrQjtJQUMvRyxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsYUFBYSxFQUFFLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQ3JFLENBQUM7QUFGRCw0QkFFQztBQUVEO0lBSUUsWUFDVSxhQUE0QixFQUFFLGdCQUFxQyxFQUFVLFVBQWtCO1FBQS9GLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQWlELGVBQVUsR0FBVixVQUFVLENBQVE7UUFKakcsYUFBUSxHQUFrQixFQUFFLENBQUE7UUFDNUIsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFLN0MsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUN0QyxJQUFJLENBQUMsZUFBZSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDM0UsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFRRCxPQUFPLENBQUUsSUFBWSxFQUFFLElBQWlCO1FBQ3RDLElBQUksUUFBUSxDQUFBO1FBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUUsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBRTthQUMxQztTQUNBLENBQUMsQ0FBQyxD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QUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUFDLENBQUM7UUFDekMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQUMsU0FBUyxHQUFHLG9CQUFZLENBQUMsTUFBTSxDQUFDLENBQUE7UUFBQyxDQUFDO1FBQ3BELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3hELEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUFDLENBQUM7UUFDM0IsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUMvQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBQyxNQUFNLENBQUE7UUFBQyxDQUFDO1FBQ3BCLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDdEIsQ0FBQztDQUNGO0FBN1NELGtDQTZTQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIHRzbGludDpkaXNhYmxlOm1lbWJlci1hY2Nlc3MgKi9cbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFBvaW50LCBUZXh0RWRpdG9yLCBSYW5nZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBNQUlOX01FTlVfTEFCRUwsIGdldEV2ZW50VHlwZSB9IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0IHtQbHVnaW5NYW5hZ2VyfSBmcm9tICcuLi9wbHVnaW4tbWFuYWdlcidcbmltcG9ydCB7SVN0YXR1cywgSVNldmVyaXR5VGFiRGVmaW5pdGlvbiwgSUNvbnRyb2xPcHRzfSBmcm9tICcuLi9vdXRwdXQtcGFuZWwnXG5pbXBvcnQge0lSZXN1bHRJdGVtLCBUU2V2ZXJpdHl9IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQge1RFdmVudFJhbmdlVHlwZX0gZnJvbSAnLi4vZWRpdG9yLWNvbnRyb2wvdG9vbHRpcC1tYW5hZ2VyJ1xuaW1wb3J0IHtUUG9zaXRpb259IGZyb20gJy4uL3Jlc3VsdHMtZGInXG5pbXBvcnQge1Byb3ZpZGVyIGFzIE1lc3NhZ2VQcm92aWRlcn0gZnJvbSAnLi4vcmVzdWx0cy1kYi9wcm92aWRlcidcbmltcG9ydCB7SVBhcmFtU3BlY30gZnJvbSAnLi4vY29uZmlnLXBhcmFtcydcbmltcG9ydCB7VFRleHRCdWZmZXJDYWxsYmFja30gZnJvbSAnLi4vZWRpdG9yLWNvbnRyb2wnXG5pbXBvcnQge1RUb29sdGlwSGFuZGxlciwgVFRvb2x0aXBGdW5jdGlvbn0gZnJvbSAnLi4vdG9vbHRpcC1yZWdpc3RyeSdcbmltcG9ydCB7RHVtbXlFbGVtZW50fSBmcm9tICcuL2R1bW15LWVsZW1lbnQnXG5cbmV4cG9ydCBpbnRlcmZhY2UgSVNob3dUb29sdGlwUGFyYW1zIHtcbiAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gIHBvczogVFBvc2l0aW9uXG4gIGV2ZW50VHlwZT86IFRFdmVudFJhbmdlVHlwZVxuICBkZXRhaWw/OiBPYmplY3RcbiAgdG9vbHRpcDogVFRvb2x0aXBGdW5jdGlvblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElFdmVudFJhbmdlUGFyYW1zIHtcbiAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gIGRldGFpbD86IE9iamVjdFxuICBldmVudFR5cGU/OiBURXZlbnRSYW5nZVR5cGVcbiAgcG9zOiBUUG9zaXRpb25cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQXRvbU1lbnVDb21tYW5kIHtcbiAgbGFiZWw6IHN0cmluZ1xuICBjb21tYW5kOiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQXRvbVN1Ym1lbnUge1xuICBsYWJlbDogc3RyaW5nXG4gIHN1Ym1lbnU6IFRBdG9tTWVudVtdXG59XG5cbmV4cG9ydCB0eXBlIFRBdG9tTWVudSA9IElBdG9tTWVudUNvbW1hbmQgfCBJQXRvbVN1Ym1lbnVcblxuZXhwb3J0IHR5cGUgVEV2ZW50UmFuZ2VDYWxsYmFjazxUPiA9IChwYXJzOiB7cG9zOiBQb2ludCwgY3JhbmdlOiBSYW5nZSwgZXZlbnRUeXBlOiBURXZlbnRSYW5nZVR5cGV9KSA9PiBUXG5cbmV4cG9ydCBmdW5jdGlvbiBpbnN0YW5jZSAocGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlciwgb3V0ZXJEaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgcGx1Z2luTmFtZTogc3RyaW5nKSB7XG4gIHJldHVybiBuZXcgVVBJSW5zdGFuY2UocGx1Z2luTWFuYWdlciwgb3V0ZXJEaXNwb3NhYmxlcywgcGx1Z2luTmFtZSlcbn1cblxuZXhwb3J0IGNsYXNzIFVQSUluc3RhbmNlIHtcbiAgcHJpdmF0ZSBtZXNzYWdlczogSVJlc3VsdEl0ZW1bXSA9IFtdXG4gIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHByaXZhdGUgbWVzc2FnZVByb3ZpZGVyOiBNZXNzYWdlUHJvdmlkZXJcbiAgY29uc3RydWN0b3IgKFxuICAgIHByaXZhdGUgcGx1Z2luTWFuYWdlcjogUGx1Z2luTWFuYWdlciwgb3V0ZXJEaXNwb3NhYmxlczogQ29tcG9zaXRlRGlzcG9zYWJsZSwgcHJpdmF0ZSBwbHVnaW5OYW1lOiBzdHJpbmdcbiAgKSB7XG4gICAgb3V0ZXJEaXNwb3NhYmxlcy5hZGQodGhpcy5kaXNwb3NhYmxlcylcbiAgICB0aGlzLm1lc3NhZ2VQcm92aWRlciA9IHBsdWdpbk1hbmFnZXIucmVzdWx0c0RCLnJlZ2lzdGVyUHJvdmlkZXIocGx1Z2luTmFtZSlcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZCh0aGlzLm1lc3NhZ2VQcm92aWRlcilcbiAgfVxuICAvKlxuICBBZGRzIG5ldyBzdW1iZW51IHRvICdIYXNrZWxsIElERScgbWVudSBpdGVtXG4gIG5hbWUgLS0gc3VibWVudSBsYWJlbCwgc2hvdWxkIGJlIGRlc2NyaXB0aXZlIG9mIGEgcGFja2FnZVxuICBtZW51IC0tIEF0b20gbWVudSBvYmplY3RcblxuICBSZXR1cm5zIERpc3Bvc2FibGUuXG4gICovXG4gIHNldE1lbnUgKG5hbWU6IHN0cmluZywgbWVudTogVEF0b21NZW51W10pIHtcbiAgICBsZXQgbWVudURpc3BcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChtZW51RGlzcCA9IGF0b20ubWVudS5hZGQoW3tcbiAgICAgIGxhYmVsOiBNQUlOX01FTlVfTEFCRUwsXG4gICAgICBzdWJtZW51OiBbIHtsYWJlbDogbmFtZSwgc3VibWVudTogbWVudX0gXVxuICAgIH1cbiAgICBdKSlcbiAgICByZXR1cm4gbWVudURpc3BcbiAgfVxuXG4gIC8qXG4gIFNldHMgYmFja2VuZCBzdGF0dXNcbiAgc3RhdHVzIC0tIG9iamVjdFxuICAgIHN0YXR1czogb25lIG9mICdwcm9ncmVzcycsICdyZWFkeScsICdlcnJvcicsICd3YXJuaW5nJ1xuICAgIHByb2dyZXNzOiBmbG9hdCBiZXR3ZWVuIDAgYW5kIDEsIG9ubHkgcmVsZXZhbnQgd2hlbiBzdGF0dXMgaXMgJ3Byb2dyZXNzJ1xuICAgICAgICAgICAgICBpZiAwIG9yIHVuZGVmaW5lZCwgcHJvZ3Jlc3MgYmFyIGlzIG5vdCBzaG93blxuICAqL1xuICBzZXRTdGF0dXMgKHN0YXR1czogSVN0YXR1cykge1xuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYmFja2VuZFN0YXR1cyh0aGlzLnBsdWdpbk5hbWUsIHN0YXR1cylcbiAgfVxuXG4gIC8qXG4gIEFkZCBtZXNzYWdlcyB0byBpZGUtaGFza2VsbCBvdXRwdXRcbiAgbWVzc2FnZXM6IEFycmF5IG9mIE9iamVjdFxuICAgIHVyaTogU3RyaW5nLCBGaWxlIFVSSSBtZXNzYWdlIHJlbGF0ZXMgdG9cbiAgICBwb3NpdGlvbjogUG9pbnQsIG9yIFBvaW50LWxpa2UgT2JqZWN0LCBwb3NpdGlvbiB0byB3aGljaCBtZXNzYWdlIHJlbGF0ZXNcbiAgICBtZXNzYWdlOiBTdHJpbmcgb3Igezx0ZXh0IHwgaHRtbD4sIGhpZ2hsaWdodGVyP30sIG1lc3NhZ2VcbiAgICBzZXZlcml0eTogU3RyaW5nLCBvbmUgb2YgJ2Vycm9yJywgJ3dhcm5pbmcnLCAnbGludCcsICdidWlsZCcsXG4gICAgICAgICAgICAgIG9yIHVzZXItZGVmaW5lZCwgc2VlIGBzZXRNZXNzYWdlVHlwZXNgXG4gIHR5cGVzOiBBcnJheSBvZiBTdHJpbmcsIGNvbnRhaW5pbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgLiBJZiB1bmRlZmluZWQsXG4gICAgICAgICB3aWxsIGJlIHRha2VuIGZyb20gYG1lc3NhZ2VzYFxuICAqL1xuICBhZGRNZXNzYWdlcyAobmV3TWVzc2FnZXM6IElSZXN1bHRJdGVtW10sIHR5cGVzPzogVFNldmVyaXR5W10pIHtcbiAgICB0aGlzLm1lc3NhZ2VzLnB1c2goLi4ubmV3TWVzc2FnZXMpXG4gICAgdGhpcy5tZXNzYWdlUHJvdmlkZXIuc2V0TWVzc2FnZXModGhpcy5tZXNzYWdlcylcbiAgfVxuXG4gIC8qXG4gIFNldCBtZXNzYWdlcyBpbiBpZGUtaGFza2VsbCBvdXRwdXQuIENsZWFycyBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aFxuICBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgbWVzc2FnZXM6IEFycmF5IG9mIE9iamVjdFxuICAgIHVyaTogU3RyaW5nLCBGaWxlIFVSSSBtZXNzYWdlIHJlbGF0ZXMgdG9cbiAgICBwb3NpdGlvbjogUG9pbnQsIG9yIFBvaW50LWxpa2UgT2JqZWN0LCBwb3NpdGlvbiB0byB3aGljaCBtZXNzYWdlIHJlbGF0ZXNcbiAgICBtZXNzYWdlOiBTdHJpbmcsIG1lc3NhZ2VcbiAgICBzZXZlcml0eTogU3RyaW5nLCBvbmUgb2YgJ2Vycm9yJywgJ3dhcm5pbmcnLCAnbGludCcsICdidWlsZCcsXG4gICAgICAgICAgICAgIG9yIHVzZXItZGVmaW5lZCwgc2VlIGBzZXRNZXNzYWdlVHlwZXNgXG4gIHR5cGVzOiBBcnJheSBvZiBTdHJpbmcsIGNvbnRhaW5pbmcgcG9zc2libGUgbWVzc2FnZSBgc2V2ZXJpdHlgLiBJZiB1bmRlZmluZWQsXG4gICAgICAgICB3aWxsIGJlIHRha2VuIGZyb20gYG1lc3NhZ2VzYFxuICAqL1xuICBzZXRNZXNzYWdlcyAobmV3TWVzc2FnZXM6IElSZXN1bHRJdGVtW10sIHR5cGVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIHRoaXMubWVzc2FnZXMgPSBbLi4ubmV3TWVzc2FnZXNdXG4gICAgdGhpcy5tZXNzYWdlUHJvdmlkZXIuc2V0TWVzc2FnZXModGhpcy5tZXNzYWdlcylcbiAgfVxuXG4gIC8qXG4gIENsZWFyIGFsbCBleGlzdGluZyBtZXNzYWdlcyB3aXRoIGBzZXZlcml0eWAgaW4gYHR5cGVzYFxuICBUaGlzIGlzIHNob3J0aGFuZCBmcm9tIGBzZXRNZXNzYWdlcyhbXSx0eXBlcylgXG4gICovXG4gIGNsZWFyTWVzc2FnZXMgKHR5cGVzOiBUU2V2ZXJpdHlbXSkge1xuICAgIHRoaXMubWVzc2FnZXMgPSB0aGlzLm1lc3NhZ2VzLmZpbHRlcigoe3NldmVyaXR5fSkgPT4gIXR5cGVzLmluY2x1ZGVzKHNldmVyaXR5KSlcbiAgICB0aGlzLm1lc3NhZ2VQcm92aWRlci5zZXRNZXNzYWdlcyh0aGlzLm1lc3NhZ2VzKVxuICB9XG5cbiAgLypcbiAgU2V0IHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YCB0aGF0IHlvdXIgcGFja2FnZSB3aWxsIHVzZS5cbiAgdHlwZXM6IE9iamVjdCB3aXRoIGtleXMgcmVwcmVzZW50aW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YCAoaS5lLiB0YWIgbmFtZSlcbiAgICAgICAgIGFuZCB2YWx1ZXMgYmVpbmcgT2JqZWN0cyB3aXRoIGtleXNcbiAgICB1cmlGaWx0ZXI6IEJvb2wsIHNob3VsZCB1cmkgZmlsdGVyIGFwcGx5IHRvIHRhYj9cbiAgICBhdXRvU2Nyb2xsOiBCb29sLCBzaG91bGQgdGFiIGF1dG8tc2Nyb2xsP1xuXG4gIFRoaXMgYWxsb3dzIHRvIGRlZmluZSBjdXN0b20gb3V0cHV0IHBhbmVsIHRhYnMuXG4gICovXG4gIHNldE1lc3NhZ2VUeXBlcyAodHlwZXM6IHsgW3NldmVyaXR5OiBzdHJpbmddOiBJU2V2ZXJpdHlUYWJEZWZpbml0aW9ufSkge1xuICAgIHJldHVybiAoKCkgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0ID0gW11cbiAgICAgIGZvciAoY29uc3QgdHlwZSBvZiBPYmplY3Qua2V5cyh0eXBlcykpIHtcbiAgICAgICAgY29uc3Qgb3B0cyA9IHR5cGVzW3R5cGVdXG4gICAgICAgIHJlc3VsdC5wdXNoKHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5jcmVhdGVUYWIodHlwZSwgb3B0cykpXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0XG4gICAgfSkoKVxuICB9XG5cbiAgLypcbiAgRWRpdG9yIGV2ZW50IHN1YnNjcmlwdGlvbi4gRmlyZXMgd2hlbiBtb3VzZSBjdXJzb3Igc3RvcHBlZCBvdmVyIGEgc3ltYm9sIGluXG4gIGVkaXRvci5cblxuICBjYWxsYmFjazogY2FsbGJhY2soZWRpdG9yLCBjcmFuZ2UsIHR5cGUpXG4gICAgZWRpdG9yOiBUZXh0RWRpdG9yLCBlZGl0b3IgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcbiAgICBjcmFuZ2U6IFJhbmdlLCBjdXJzb3IgcmFuZ2UgdGhhdCBnZW5lcmF0ZWQgZXZlbnQuXG4gICAgdHlwZTogT25lIG9mICdtb3VzZScsICdzZWxlY3Rpb24nIC0tIHR5cGUgb2YgZXZlbnQgdGhhdCB0cmlnZ2VyZWQgdGhpc1xuXG4gICAgUmV0dXJucyB7cmFuZ2UsIHRleHR9IG9yIFByb21pc2UuXG4gICAgICByYW5nZTogUmFuZ2UsIHRvb2x0aXAgaGlnaGxpZ2h0aW5nIHJhbmdlXG4gICAgICB0ZXh0OiB0b29sdGlwIHRleHQuIFN0cmluZyBvciB7dGV4dCwgaGlnaGxpZ2h0ZXJ9IG9yIHtodG1sfVxuICAgICAgICB0ZXh0OiB0b29sdGlwIHRleHRcbiAgICAgICAgaGlnaGxpZ2h0ZXI6IGdyYW1tYXIgc2NvcGUgdGhhdCB3aWxsIGJlIHVzZWQgdG8gaGlnaGxpZ2h0IHRvb2x0aXAgdGV4dFxuICAgICAgICBodG1sOiBodG1sIHRvIGJlIGRpc3BsYXllZCBpbiB0b29sdGlwXG5cbiAgcmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uU2hvdWxkU2hvd1Rvb2x0aXAgKGNhbGxiYWNrOiBUVG9vbHRpcEhhbmRsZXIpIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5yZWdpc3RlcihcbiAgICAgIHRoaXMucGx1Z2luTmFtZSwge3ByaW9yaXR5OiAxMDAsIGhhbmRsZXI6IGNhbGxiYWNrfVxuICAgIClcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKlxuICBTaG93IHRvb2x0aXAgaW4gZWRpdG9yLlxuXG4gIGVkaXRvcjogZWRpdG9yIHRoYXQgd2lsbCBzaG93IHRvb2x0aXBcbiAgcG9zOiB0b29sdGlwIHBvc2l0aW9uXG4gIGV2ZW50VHlwZTogb25lIG9mICdjb250ZXh0JywgJ2tleWJvYXJkJyBhbmQgJ21vdXNlJ1xuICBkZXRhaWw6IGZvciBhdXRvbWF0aWMgc2VsZWN0aW9uIGJldHdlZW4gJ2NvbnRleHQnIGFuZCAna2V5Ym9hcmQnLlxuICAgICAgICAgIElnbm9yZWQgaWYgJ2V2ZW50VHlwZScgaXMgc2V0LlxuICB0b29sdGlwOiBmdW5jdGlvbihjcmFuZ2UpXG4gICAgY3JhbmdlOiBSYW5nZSwgY3VycmVudGx5IHNlbGVjdGVkIHJhbmdlIGluIGVkaXRvciAocG9zc2libHkgZW1wdHkpXG5cbiAgICBSZXR1cm5zIHtyYW5nZSwgdGV4dH0gb3IgUHJvbWlzZVxuICAgICAgcmFuZ2U6IFJhbmdlLCB0b29sdGlwIGhpZ2hsaWdodGluZyByYW5nZVxuICAgICAgcGVyc2lzdE9uQ3Vyc29yTW92ZTogQm9vbGVhbiwgb3B0aW9uYWwsIGRlZmF1bHQgZmFsc2UsIHBlcnNpc3Qgb24gY3Vyc29yIG1vdmUgcmVnYXJkbGVzcyBvZiBzZXR0aW5nc1xuICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0LiBTdHJpbmcgb3Ige3RleHQsIGhpZ2hsaWdodGVyfSBvciB7aHRtbH1cbiAgICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0XG4gICAgICAgIGhpZ2hsaWdodGVyOiBncmFtbWFyIHNjb3BlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGhpZ2hsaWdodCB0b29sdGlwIHRleHRcbiAgICAgICAgaHRtbDogaHRtbCB0byBiZSBkaXNwbGF5ZWQgaW4gdG9vbHRpcFxuICAqL1xuICBzaG93VG9vbHRpcCAoe2VkaXRvciwgcG9zLCBldmVudFR5cGUsIGRldGFpbCwgdG9vbHRpcH06IElTaG93VG9vbHRpcFBhcmFtcykge1xuICAgIGlmICghZXZlbnRUeXBlKSB7XG4gICAgICBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKVxuICAgIH1cbiAgICB0aGlzLnBsdWdpbk1hbmFnZXIudG9vbHRpcFJlZ2lzdHJ5LnNob3dUb29sdGlwKFxuICAgICAgZWRpdG9yLCBldmVudFR5cGUsIHtwbHVnaW5OYW1lOiB0aGlzLnBsdWdpbk5hbWUsIHRvb2x0aXB9XG4gICAgKVxuICB9XG5cbiAgLypcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBiZWZvcmUgSGFza2VsbCBidWZmZXIgaXMgc2F2ZWQuXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKGJ1ZmZlcilcbiAgICBidWZmZXI6IFRleHRCdWZmZXIsIGJ1ZmZlciB0aGF0IGdlbmVyYXRlZCBldmVudFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZVxuICAqL1xuICBvbldpbGxTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGNvbnN0IGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25XaWxsU2F2ZUJ1ZmZlcihjYWxsYmFjaylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKlxuICBDb252ZW5pZW5jZSBmdW5jdGlvbi4gV2lsbCBmaXJlIGFmdGVyIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhidWZmZXIpXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcblxuICBSZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25EaWRTYXZlQnVmZmVyIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGNvbnN0IGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25EaWRTYXZlQnVmZmVyKGNhbGxiYWNrKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIG9uRGlkU3RvcENoYW5naW5nIChjYWxsYmFjazogVFRleHRCdWZmZXJDYWxsYmFjaykge1xuICAgIGNvbnN0IGRpc3AgPSB0aGlzLnBsdWdpbk1hbmFnZXIub25EaWRTdG9wQ2hhbmdpbmcoY2FsbGJhY2spXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLypcbiAgQWRkIGEgbmV3IGNvbnRyb2wgdG8gb3VwdHV0IHBhbmVsIGhlYWRpbmcuXG5cbiAgZWxlbWVudDogSFRNTEVsZW1lbnQgb2YgY29udHJvbCwgb3IgU3RyaW5nIHdpdGggdGFnIG5hbWVcbiAgb3B0czogdmFyaW91cyBvcHRpb25zXG4gICAgaWQ6IFN0cmluZywgaWRcbiAgICBldmVudHM6IE9iamVjdCwgZXZlbnQgY2FsbGJhY2tzLCBrZXkgaXMgZXZlbnQgbmFtZSwgZS5nLiBcImNsaWNrXCIsXG4gICAgICAgICAgICB2YWx1ZSBpcyBjYWxsYmFja1xuICAgIGNsYXNzZXM6IEFycmF5IG9mIFN0cmluZywgY2xhc3Nlc1xuICAgIHN0eWxlOiBPYmplY3QsIGNzcyBzdHlsZSwga2V5cyBhcmUgc3R5bGUgYXR0cmlidXRlcywgdmFsdWVzIGFyZSB2YWx1ZXNcbiAgICBhdHRyczogT2JqZWN0LCBvdGhlciBhdHRyaWJ1dGVzLCBrZXlzIGFyZSBhdHRyaWJ1dGUgbmFtZXMsIHZhbHVlcyBhcmUgdmFsdWVzXG4gICAgYmVmb3JlOiBTdHJpbmcsIENTUyBzZWxlY3RvciBvZiBlbGVtZW50LCB0aGF0IHRoaXMgb25lIHNob3VsZCBiZSBpbnNlcnRlZFxuICAgICAgICAgICAgYmVmb3JlLCBlLmcuICcjcHJvZ3Jlc3NCYXInXG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlLlxuICAqL1xuICBhZGRQYW5lbENvbnRyb2wgKGVsZW1lbnQ6IHN0cmluZyB8IEhUTUxFbGVtZW50LCBvcHRzOiBJQ29udHJvbE9wdHMpIHtcbiAgICBpZiAodHlwZW9mIGVsZW1lbnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmFkZFBhbmVsQ29udHJvbCh7ZWxlbWVudCwgb3B0c30pXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG5ld09wdHM6IElDb250cm9sT3B0cyAmIHtlbGVtZW50OiBIVE1MRWxlbWVudH0gPSB7Li4ub3B0cywgZWxlbWVudH1cbiAgICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuYWRkUGFuZWxDb250cm9sKHtlbGVtZW50OiBEdW1teUVsZW1lbnQsIG9wdHM6IG5ld09wdHN9KVxuICAgIH1cbiAgfVxuXG4gIC8qXG4gIGFkZENvbmZpZ1BhcmFtXG4gICAgcGFyYW1fbmFtZTpcbiAgICAgIG9uQ2hhbmdlZDogY2FsbGJhY2sgdm9pZCh2YWx1ZSlcbiAgICAgIGl0ZW1zOiBBcnJheSBvciBjYWxsYmFjayBBcnJheSh2b2lkKVxuICAgICAgaXRlbVRlbXBsYXRlOiBjYWxsYmFjaywgU3RyaW5nKGl0ZW0pLCBodG1sIHRlbXBsYXRlXG4gICAgICBpdGVtRmlsdGVyS2V5OiBTdHJpbmcsIGl0ZW0gZmlsdGVyIGtleVxuICAgICAgZGVzY3JpcHRpb246IFN0cmluZyBbb3B0aW9uYWxdXG4gICAgICBkaXNwbGF5TmFtZTogU3RyaW5nIFtvcHRpb25hbCwgY2FwaXRhbGl6ZWQgcGFyYW1fbmFtZSBkZWZhdWx0XVxuICAgICAgZGlzcGxheVRlbXBsYXRlOiBjYWxsYmFjaywgU3RyaW5nKGl0ZW0pLCBzdHJpbmcgdGVtcGxhdGVcbiAgICAgIGRlZmF1bHQ6IGl0ZW0sIGRlZmF1bHQgdmFsdWVcblxuICBSZXR1cm5zXG4gICAgZGlzcDogRGlzcG9zYWJsZVxuICAgIGNoYW5nZTogb2JqZWN0IG9mIGNoYW5nZSBmdW5jdGlvbnMsIGtleXMgYmVpbmcgcGFyYW1fbmFtZVxuICAqL1xuICBhZGRDb25maWdQYXJhbSAoc3BlY3M6IHsgW3BhcmFtTmFtZTogc3RyaW5nXTogSVBhcmFtU3BlYzxPYmplY3Q+IH0pIHtcbiAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIGZvciAoY29uc3QgbmFtZSBvZiBPYmplY3Qua2V5cyhzcGVjcykpIHtcbiAgICAgIGNvbnN0IHNwZWMgPSBzcGVjc1tuYW1lXVxuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuYWRkKHRoaXMucGx1Z2luTmFtZSwgbmFtZSwgc3BlYylcbiAgICAgIClcbiAgICB9XG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qXG4gIGdldENvbmZpZ1BhcmFtKHBhcmFtTmFtZSkgb3IgZ2V0Q29uZmlnUGFyYW0ocGx1Z2luTmFtZSwgcGFyYW1OYW1lKVxuXG4gIHJldHVybnMgYSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gcGFyYW1ldGVyXG4gIHZhbHVlLlxuXG4gIFByb21pc2UgY2FuIGJlIHJlamVjdGVkIHdpdGggZWl0aGVyIGVycm9yLCBvciAndW5kZWZpbmVkJy4gTGF0dGVyXG4gIGluIGNhc2UgdXNlciBjYW5jZWxzIHBhcmFtIHNlbGVjdGlvbiBkaWFsb2cuXG4gICovXG4gIGFzeW5jIGdldENvbmZpZ1BhcmFtIChvdGhlclBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKCFuYW1lKSB7XG4gICAgICBuYW1lID0gb3RoZXJQbHVnaW5OYW1lXG4gICAgICBvdGhlclBsdWdpbk5hbWUgPSB0aGlzLnBsdWdpbk5hbWVcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuZ2V0KG90aGVyUGx1Z2luTmFtZSwgbmFtZSlcbiAgfVxuXG4gIC8qXG4gIHNldENvbmZpZ1BhcmFtKHBhcmFtTmFtZSwgdmFsdWUpIG9yIHNldENvbmZpZ1BhcmFtKHBsdWdpbk5hbWUsIHBhcmFtTmFtZSwgdmFsdWUpXG5cbiAgdmFsdWUgaXMgb3B0aW9uYWwuIElmIG9taXR0ZWQsIGEgc2VsZWN0aW9uIGRpYWxvZyB3aWxsIGJlIHByZXNlbnRlZCB0byB1c2VyLlxuXG4gIHJldHVybnMgYSBQcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gcGFyYW1ldGVyIHZhbHVlLlxuXG4gIFByb21pc2UgY2FuIGJlIHJlamVjdGVkIHdpdGggZWl0aGVyIGVycm9yLCBvciAndW5kZWZpbmVkJy4gTGF0dGVyXG4gIGluIGNhc2UgdXNlciBjYW5jZWxzIHBhcmFtIHNlbGVjdGlvbiBkaWFsb2cuXG4gICovXG4gIGFzeW5jIHNldENvbmZpZ1BhcmFtIChvdGhlclBsdWdpbk5hbWU6IHN0cmluZywgbmFtZTogc3RyaW5nLCB2YWx1ZT86IE9iamVjdCkge1xuICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB2YWx1ZSA9IG5hbWVcbiAgICAgIG5hbWUgPSBvdGhlclBsdWdpbk5hbWVcbiAgICAgIG90aGVyUGx1Z2luTmFtZSA9IHRoaXMucGx1Z2luTmFtZVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbmZpZ1BhcmFtTWFuYWdlci5zZXQob3RoZXJQbHVnaW5OYW1lLCBuYW1lLCB2YWx1ZSlcbiAgfVxuXG4gIC8qXG4gIFV0aWxpdHkgZnVuY3Rpb24gdG8gZXh0cmFjdCBldmVudCByYW5nZS90eXBlIGZvciBhIGdpdmVuIGV2ZW50XG5cbiAgZWRpdG9yOiBUZXh0RWRpdG9yLCBlZGl0b3IgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcbiAgZGV0YWlsOiBldmVudCBkZXRhaWwsIGlnbm9yZWQgaWYgZXZlbnRUeXBlIGlzIHNldFxuICBldmVudFR5cGU6IFN0cmluZywgZXZlbnQgdHlwZSwgb25lIG9mICdrZXlib2FyZCcsICdjb250ZXh0JywgJ21vdXNlJ1xuICBwb3M6IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgZXZlbnQgcG9zaXRpb24sIGNhbiBiZSB1bmRlZmluZWRcbiAgY29udHJvbGxlcjogbGVhdmUgdW5kZWZpbmVkLCB0aGlzIGlzIGludGVybmFsIGZpZWxkXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKHtwb3MsIGNyYW5nZSwgZXZlbnRUeXBlfSlcbiAgICBwb3M6IFBvaW50LCBldmVudCBwb3NpdGlvblxuICAgIGNyYW5nZTogUmFuZ2UsIGV2ZW50IHJhbmdlXG4gICAgZXZlbnRUeXBlOiBTdHJpbmcsIGV2ZW50IHR5cGUsIG9uZSBvZiAna2V5Ym9hcmQnLCAnY29udGV4dCcsICdtb3VzZSdcbiAgKi9cbiAgd2l0aEV2ZW50UmFuZ2U8VD4gKHtlZGl0b3IsIGRldGFpbCwgZXZlbnRUeXBlLCBwb3N9OiBJRXZlbnRSYW5nZVBhcmFtcywgY2FsbGJhY2s6IFRFdmVudFJhbmdlQ2FsbGJhY2s8VD4pIHtcbiAgICBsZXQgcHBvczogUG9pbnQgfCB1bmRlZmluZWRcbiAgICBpZiAocG9zKSB7IHBwb3MgPSBQb2ludC5mcm9tT2JqZWN0KHBvcykgfVxuICAgIGlmICghZXZlbnRUeXBlKSB7IGV2ZW50VHlwZSA9IGdldEV2ZW50VHlwZShkZXRhaWwpIH1cbiAgICBjb25zdCBjb250cm9sbGVyID0gdGhpcy5wbHVnaW5NYW5hZ2VyLmNvbnRyb2xsZXIoZWRpdG9yKVxuICAgIGlmICghY29udHJvbGxlcikgeyByZXR1cm4gfVxuICAgIGNvbnN0IHJlcyA9IGNvbnRyb2xsZXIuZ2V0RXZlbnRSYW5nZShldmVudFR5cGUpXG4gICAgaWYgKCFyZXMpIHsgcmV0dXJuIH1cbiAgICByZXR1cm4gY2FsbGJhY2socmVzKVxuICB9XG59XG4iXX0=