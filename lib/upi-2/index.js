"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const utils_1 = require("../utils");
const dummy_element_1 = require("./dummy-element");
function instance(pluginManager, outerDisposables, pluginName) {
    return new UPIInstance(pluginManager, outerDisposables, pluginName);
}
exports.instance = instance;
class UPIInstance {
    constructor(pluginManager, outerDisposables, pluginName) {
        this.pluginManager = pluginManager;
        this.pluginName = pluginName;
        this.messages = [];
        this.disposables = new atom_1.CompositeDisposable();
        outerDisposables.add(this.disposables);
        this.messageProvider = pluginManager.resultsDB.registerProvider(pluginName);
        this.disposables.add(this.messageProvider);
    }
    setMenu(name, menu) {
        let menuDisp;
        this.disposables.add(menuDisp = atom.menu.add([{
                label: utils_1.MAIN_MENU_LABEL,
                submenu: [{ label: name, submenu: menu }]
            }
        ]));
        return menuDisp;
    }
    setStatus(status) {
        return this.pluginManager.outputPanel.backendStatus(this.pluginName, status);
    }
    addMessages(newMessages, types) {
        console.error(newMessages);
        this.messages.push(...newMessages);
        this.messageProvider.setMessages(this.messages);
    }
    setMessages(newMessages, types) {
        this.messages = [...newMessages];
        this.messageProvider.setMessages(this.messages);
    }
    clearMessages(types) {
        this.messages = this.messages.filter(({ severity }) => !types.includes(severity));
        this.messageProvider.setMessages(this.messages);
    }
    setMessageTypes(types) {
        return (() => {
            const result = [];
            for (const type of Object.keys(types)) {
                const opts = types[type];
                result.push(this.pluginManager.outputPanel.createTab(type, opts));
            }
            return result;
        })();
    }
    onShouldShowTooltip(callback) {
        const disp = this.pluginManager.tooltipRegistry.register(this.pluginName, { priority: 100, handler: callback });
        this.disposables.add(disp);
        return disp;
    }
    showTooltip({ editor, pos, eventType, detail, tooltip }) {
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        this.pluginManager.tooltipRegistry.showTooltip(editor, eventType, { pluginName: this.pluginName, tooltip });
    }
    onWillSaveBuffer(callback) {
        const disp = this.pluginManager.onWillSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidSaveBuffer(callback) {
        const disp = this.pluginManager.onDidSaveBuffer(callback);
        this.disposables.add(disp);
        return disp;
    }
    onDidStopChanging(callback) {
        const disp = this.pluginManager.onDidStopChanging(callback);
        this.disposables.add(disp);
        return disp;
    }
    addPanelControl(element, opts) {
        if (typeof element === 'string') {
            return this.pluginManager.outputPanel.addPanelControl({ element, opts });
        }
        else {
            const newOpts = Object.assign({}, opts, { element });
            return this.pluginManager.outputPanel.addPanelControl({ element: dummy_element_1.DummyElement, opts: newOpts });
        }
    }
    addConfigParam(specs) {
        const disp = new atom_1.CompositeDisposable();
        for (const name of Object.keys(specs)) {
            const spec = specs[name];
            disp.add(this.pluginManager.configParamManager.add(this.pluginName, name, spec));
        }
        return disp;
    }
    getConfigParam(otherPluginName, name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!name) {
                name = otherPluginName;
                otherPluginName = this.pluginName;
            }
            return this.pluginManager.configParamManager.get(otherPluginName, name);
        });
    }
    setConfigParam(otherPluginName, name, value) {
        return __awaiter(this, void 0, void 0, function* () {
            if (value === undefined) {
                value = name;
                name = otherPluginName;
                otherPluginName = this.pluginName;
            }
            return this.pluginManager.configParamManager.set(otherPluginName, name, value);
        });
    }
    withEventRange({ editor, detail, eventType, pos }, callback) {
        let ppos;
        if (pos) {
            ppos = atom_1.Point.fromObject(pos);
        }
        if (!eventType) {
            eventType = utils_1.getEventType(detail);
        }
        const controller = this.pluginManager.controller(editor);
        if (!controller) {
            return;
        }
        const res = controller.getEventRange(eventType);
        if (!res) {
            return;
        }
        return callback(res);
    }
}
exports.UPIInstance = UPIInstance;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXBpLTIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUNBLCtCQUFvRTtBQUNwRSxvQ0FBd0Q7QUFVeEQsbURBQTRDO0FBK0I1QyxrQkFBMEIsYUFBNEIsRUFBRSxnQkFBcUMsRUFBRSxVQUFrQjtJQUMvRyxNQUFNLENBQUMsSUFBSSxXQUFXLENBQUMsYUFBYSxFQUFFLGdCQUFnQixFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQ3JFLENBQUM7QUFGRCw0QkFFQztBQUVEO0lBSUUsWUFDVSxhQUE0QixFQUFFLGdCQUFxQyxFQUFVLFVBQWtCO1FBQS9GLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQWlELGVBQVUsR0FBVixVQUFVLENBQVE7UUFKakcsYUFBUSxHQUFrQixFQUFFLENBQUE7UUFDNUIsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFLN0MsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUN0QyxJQUFJLENBQUMsZUFBZSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDM0UsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFBO0lBQzVDLENBQUM7SUFRRCxPQUFPLENBQUUsSUFBWSxFQUFFLElBQWlCO1FBQ3RDLElBQUksUUFBUSxDQUFBO1FBQ1osSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLEtBQUssRUFBRSx1QkFBZTtnQkFDdEIsT0FBTyxFQUFFLENBQUUsRUFBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBRTthQUMxQztTQUNBLENBQUMsQ0FBQyxD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R0FBRyxDQUFDLENBQUMsQ0FBQztZQUFDLElBQUksR0FBRyxZQUFLLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQUMsQ0FBQztRQUN6QyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFBQyxTQUFTLEdBQUcsb0JBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUFDLENBQUM7UUFDcEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDeEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQUMsTUFBTSxDQUFBO1FBQUMsQ0FBQztRQUMzQixNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQy9DLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUFDLENBQUM7UUFDcEIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUN0QixDQUFDO0NBQ0Y7QUE5U0Qsa0NBOFNDIiwic291cmNlc0NvbnRlbnQiOlsiLyogdHNsaW50OmRpc2FibGU6bWVtYmVyLWFjY2VzcyAqL1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUG9pbnQsIFRleHRFZGl0b3IsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IE1BSU5fTUVOVV9MQUJFTCwgZ2V0RXZlbnRUeXBlIH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQge1BsdWdpbk1hbmFnZXJ9IGZyb20gJy4uL3BsdWdpbi1tYW5hZ2VyJ1xuaW1wb3J0IHtJU3RhdHVzLCBJU2V2ZXJpdHlUYWJEZWZpbml0aW9uLCBJQ29udHJvbE9wdHN9IGZyb20gJy4uL291dHB1dC1wYW5lbCdcbmltcG9ydCB7SVJlc3VsdEl0ZW0sIFRTZXZlcml0eX0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7VEV2ZW50UmFuZ2VUeXBlfSBmcm9tICcuLi9lZGl0b3ItY29udHJvbC90b29sdGlwLW1hbmFnZXInXG5pbXBvcnQge1RQb3NpdGlvbn0gZnJvbSAnLi4vcmVzdWx0cy1kYidcbmltcG9ydCB7UHJvdmlkZXIgYXMgTWVzc2FnZVByb3ZpZGVyfSBmcm9tICcuLi9yZXN1bHRzLWRiL3Byb3ZpZGVyJ1xuaW1wb3J0IHtJUGFyYW1TcGVjfSBmcm9tICcuLi9jb25maWctcGFyYW1zJ1xuaW1wb3J0IHtUVGV4dEJ1ZmZlckNhbGxiYWNrfSBmcm9tICcuLi9lZGl0b3ItY29udHJvbCdcbmltcG9ydCB7VFRvb2x0aXBIYW5kbGVyLCBUVG9vbHRpcEZ1bmN0aW9ufSBmcm9tICcuLi90b29sdGlwLXJlZ2lzdHJ5J1xuaW1wb3J0IHtEdW1teUVsZW1lbnR9IGZyb20gJy4vZHVtbXktZWxlbWVudCdcblxuZXhwb3J0IGludGVyZmFjZSBJU2hvd1Rvb2x0aXBQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgcG9zOiBUUG9zaXRpb25cbiAgZXZlbnRUeXBlPzogVEV2ZW50UmFuZ2VUeXBlXG4gIGRldGFpbD86IE9iamVjdFxuICB0b29sdGlwOiBUVG9vbHRpcEZ1bmN0aW9uXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUV2ZW50UmFuZ2VQYXJhbXMge1xuICBlZGl0b3I6IFRleHRFZGl0b3JcbiAgZGV0YWlsPzogT2JqZWN0XG4gIGV2ZW50VHlwZT86IFRFdmVudFJhbmdlVHlwZVxuICBwb3M6IFRQb3NpdGlvblxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElBdG9tTWVudUNvbW1hbmQge1xuICBsYWJlbDogc3RyaW5nXG4gIGNvbW1hbmQ6IHN0cmluZ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElBdG9tU3VibWVudSB7XG4gIGxhYmVsOiBzdHJpbmdcbiAgc3VibWVudTogVEF0b21NZW51W11cbn1cblxuZXhwb3J0IHR5cGUgVEF0b21NZW51ID0gSUF0b21NZW51Q29tbWFuZCB8IElBdG9tU3VibWVudVxuXG5leHBvcnQgdHlwZSBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+ID0gKHBhcnM6IHtwb3M6IFBvaW50LCBjcmFuZ2U6IFJhbmdlLCBldmVudFR5cGU6IFRFdmVudFJhbmdlVHlwZX0pID0+IFRcblxuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbmNlIChwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLCBvdXRlckRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLCBwbHVnaW5OYW1lOiBzdHJpbmcpIHtcbiAgcmV0dXJuIG5ldyBVUElJbnN0YW5jZShwbHVnaW5NYW5hZ2VyLCBvdXRlckRpc3Bvc2FibGVzLCBwbHVnaW5OYW1lKVxufVxuXG5leHBvcnQgY2xhc3MgVVBJSW5zdGFuY2Uge1xuICBwcml2YXRlIG1lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdID0gW11cbiAgcHJpdmF0ZSBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgcHJpdmF0ZSBtZXNzYWdlUHJvdmlkZXI6IE1lc3NhZ2VQcm92aWRlclxuICBjb25zdHJ1Y3RvciAoXG4gICAgcHJpdmF0ZSBwbHVnaW5NYW5hZ2VyOiBQbHVnaW5NYW5hZ2VyLCBvdXRlckRpc3Bvc2FibGVzOiBDb21wb3NpdGVEaXNwb3NhYmxlLCBwcml2YXRlIHBsdWdpbk5hbWU6IHN0cmluZ1xuICApIHtcbiAgICBvdXRlckRpc3Bvc2FibGVzLmFkZCh0aGlzLmRpc3Bvc2FibGVzKVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyID0gcGx1Z2luTWFuYWdlci5yZXN1bHRzREIucmVnaXN0ZXJQcm92aWRlcihwbHVnaW5OYW1lKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKHRoaXMubWVzc2FnZVByb3ZpZGVyKVxuICB9XG4gIC8qXG4gIEFkZHMgbmV3IHN1bWJlbnUgdG8gJ0hhc2tlbGwgSURFJyBtZW51IGl0ZW1cbiAgbmFtZSAtLSBzdWJtZW51IGxhYmVsLCBzaG91bGQgYmUgZGVzY3JpcHRpdmUgb2YgYSBwYWNrYWdlXG4gIG1lbnUgLS0gQXRvbSBtZW51IG9iamVjdFxuXG4gIFJldHVybnMgRGlzcG9zYWJsZS5cbiAgKi9cbiAgc2V0TWVudSAobmFtZTogc3RyaW5nLCBtZW51OiBUQXRvbU1lbnVbXSkge1xuICAgIGxldCBtZW51RGlzcFxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKG1lbnVEaXNwID0gYXRvbS5tZW51LmFkZChbe1xuICAgICAgbGFiZWw6IE1BSU5fTUVOVV9MQUJFTCxcbiAgICAgIHN1Ym1lbnU6IFsge2xhYmVsOiBuYW1lLCBzdWJtZW51OiBtZW51fSBdXG4gICAgfVxuICAgIF0pKVxuICAgIHJldHVybiBtZW51RGlzcFxuICB9XG5cbiAgLypcbiAgU2V0cyBiYWNrZW5kIHN0YXR1c1xuICBzdGF0dXMgLS0gb2JqZWN0XG4gICAgc3RhdHVzOiBvbmUgb2YgJ3Byb2dyZXNzJywgJ3JlYWR5JywgJ2Vycm9yJywgJ3dhcm5pbmcnXG4gICAgcHJvZ3Jlc3M6IGZsb2F0IGJldHdlZW4gMCBhbmQgMSwgb25seSByZWxldmFudCB3aGVuIHN0YXR1cyBpcyAncHJvZ3Jlc3MnXG4gICAgICAgICAgICAgIGlmIDAgb3IgdW5kZWZpbmVkLCBwcm9ncmVzcyBiYXIgaXMgbm90IHNob3duXG4gICovXG4gIHNldFN0YXR1cyAoc3RhdHVzOiBJU3RhdHVzKSB7XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5iYWNrZW5kU3RhdHVzKHRoaXMucGx1Z2luTmFtZSwgc3RhdHVzKVxuICB9XG5cbiAgLypcbiAgQWRkIG1lc3NhZ2VzIHRvIGlkZS1oYXNrZWxsIG91dHB1dFxuICBtZXNzYWdlczogQXJyYXkgb2YgT2JqZWN0XG4gICAgdXJpOiBTdHJpbmcsIEZpbGUgVVJJIG1lc3NhZ2UgcmVsYXRlcyB0b1xuICAgIHBvc2l0aW9uOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIHBvc2l0aW9uIHRvIHdoaWNoIG1lc3NhZ2UgcmVsYXRlc1xuICAgIG1lc3NhZ2U6IFN0cmluZyBvciB7PHRleHQgfCBodG1sPiwgaGlnaGxpZ2h0ZXI/fSwgbWVzc2FnZVxuICAgIHNldmVyaXR5OiBTdHJpbmcsIG9uZSBvZiAnZXJyb3InLCAnd2FybmluZycsICdsaW50JywgJ2J1aWxkJyxcbiAgICAgICAgICAgICAgb3IgdXNlci1kZWZpbmVkLCBzZWUgYHNldE1lc3NhZ2VUeXBlc2BcbiAgdHlwZXM6IEFycmF5IG9mIFN0cmluZywgY29udGFpbmluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAuIElmIHVuZGVmaW5lZCxcbiAgICAgICAgIHdpbGwgYmUgdGFrZW4gZnJvbSBgbWVzc2FnZXNgXG4gICovXG4gIGFkZE1lc3NhZ2VzIChuZXdNZXNzYWdlczogSVJlc3VsdEl0ZW1bXSwgdHlwZXM/OiBUU2V2ZXJpdHlbXSkge1xuICAgIGNvbnNvbGUuZXJyb3IobmV3TWVzc2FnZXMpXG4gICAgdGhpcy5tZXNzYWdlcy5wdXNoKC4uLm5ld01lc3NhZ2VzKVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKHRoaXMubWVzc2FnZXMpXG4gIH1cblxuICAvKlxuICBTZXQgbWVzc2FnZXMgaW4gaWRlLWhhc2tlbGwgb3V0cHV0LiBDbGVhcnMgYWxsIGV4aXN0aW5nIG1lc3NhZ2VzIHdpdGhcbiAgYHNldmVyaXR5YCBpbiBgdHlwZXNgXG4gIG1lc3NhZ2VzOiBBcnJheSBvZiBPYmplY3RcbiAgICB1cmk6IFN0cmluZywgRmlsZSBVUkkgbWVzc2FnZSByZWxhdGVzIHRvXG4gICAgcG9zaXRpb246IFBvaW50LCBvciBQb2ludC1saWtlIE9iamVjdCwgcG9zaXRpb24gdG8gd2hpY2ggbWVzc2FnZSByZWxhdGVzXG4gICAgbWVzc2FnZTogU3RyaW5nLCBtZXNzYWdlXG4gICAgc2V2ZXJpdHk6IFN0cmluZywgb25lIG9mICdlcnJvcicsICd3YXJuaW5nJywgJ2xpbnQnLCAnYnVpbGQnLFxuICAgICAgICAgICAgICBvciB1c2VyLWRlZmluZWQsIHNlZSBgc2V0TWVzc2FnZVR5cGVzYFxuICB0eXBlczogQXJyYXkgb2YgU3RyaW5nLCBjb250YWluaW5nIHBvc3NpYmxlIG1lc3NhZ2UgYHNldmVyaXR5YC4gSWYgdW5kZWZpbmVkLFxuICAgICAgICAgd2lsbCBiZSB0YWtlbiBmcm9tIGBtZXNzYWdlc2BcbiAgKi9cbiAgc2V0TWVzc2FnZXMgKG5ld01lc3NhZ2VzOiBJUmVzdWx0SXRlbVtdLCB0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICB0aGlzLm1lc3NhZ2VzID0gWy4uLm5ld01lc3NhZ2VzXVxuICAgIHRoaXMubWVzc2FnZVByb3ZpZGVyLnNldE1lc3NhZ2VzKHRoaXMubWVzc2FnZXMpXG4gIH1cblxuICAvKlxuICBDbGVhciBhbGwgZXhpc3RpbmcgbWVzc2FnZXMgd2l0aCBgc2V2ZXJpdHlgIGluIGB0eXBlc2BcbiAgVGhpcyBpcyBzaG9ydGhhbmQgZnJvbSBgc2V0TWVzc2FnZXMoW10sdHlwZXMpYFxuICAqL1xuICBjbGVhck1lc3NhZ2VzICh0eXBlczogVFNldmVyaXR5W10pIHtcbiAgICB0aGlzLm1lc3NhZ2VzID0gdGhpcy5tZXNzYWdlcy5maWx0ZXIoKHtzZXZlcml0eX0pID0+ICF0eXBlcy5pbmNsdWRlcyhzZXZlcml0eSkpXG4gICAgdGhpcy5tZXNzYWdlUHJvdmlkZXIuc2V0TWVzc2FnZXModGhpcy5tZXNzYWdlcylcbiAgfVxuXG4gIC8qXG4gIFNldCBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgdGhhdCB5b3VyIHBhY2thZ2Ugd2lsbCB1c2UuXG4gIHR5cGVzOiBPYmplY3Qgd2l0aCBrZXlzIHJlcHJlc2VudGluZyBwb3NzaWJsZSBtZXNzYWdlIGBzZXZlcml0eWAgKGkuZS4gdGFiIG5hbWUpXG4gICAgICAgICBhbmQgdmFsdWVzIGJlaW5nIE9iamVjdHMgd2l0aCBrZXlzXG4gICAgdXJpRmlsdGVyOiBCb29sLCBzaG91bGQgdXJpIGZpbHRlciBhcHBseSB0byB0YWI/XG4gICAgYXV0b1Njcm9sbDogQm9vbCwgc2hvdWxkIHRhYiBhdXRvLXNjcm9sbD9cblxuICBUaGlzIGFsbG93cyB0byBkZWZpbmUgY3VzdG9tIG91dHB1dCBwYW5lbCB0YWJzLlxuICAqL1xuICBzZXRNZXNzYWdlVHlwZXMgKHR5cGVzOiB7IFtzZXZlcml0eTogc3RyaW5nXTogSVNldmVyaXR5VGFiRGVmaW5pdGlvbn0pIHtcbiAgICByZXR1cm4gKCgpID0+IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdXG4gICAgICBmb3IgKGNvbnN0IHR5cGUgb2YgT2JqZWN0LmtleXModHlwZXMpKSB7XG4gICAgICAgIGNvbnN0IG9wdHMgPSB0eXBlc1t0eXBlXVxuICAgICAgICByZXN1bHQucHVzaCh0aGlzLnBsdWdpbk1hbmFnZXIub3V0cHV0UGFuZWwuY3JlYXRlVGFiKHR5cGUsIG9wdHMpKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdFxuICAgIH0pKClcbiAgfVxuXG4gIC8qXG4gIEVkaXRvciBldmVudCBzdWJzY3JpcHRpb24uIEZpcmVzIHdoZW4gbW91c2UgY3Vyc29yIHN0b3BwZWQgb3ZlciBhIHN5bWJvbCBpblxuICBlZGl0b3IuXG5cbiAgY2FsbGJhY2s6IGNhbGxiYWNrKGVkaXRvciwgY3JhbmdlLCB0eXBlKVxuICAgIGVkaXRvcjogVGV4dEVkaXRvciwgZWRpdG9yIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG4gICAgY3JhbmdlOiBSYW5nZSwgY3Vyc29yIHJhbmdlIHRoYXQgZ2VuZXJhdGVkIGV2ZW50LlxuICAgIHR5cGU6IE9uZSBvZiAnbW91c2UnLCAnc2VsZWN0aW9uJyAtLSB0eXBlIG9mIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoaXNcblxuICAgIFJldHVybnMge3JhbmdlLCB0ZXh0fSBvciBQcm9taXNlLlxuICAgICAgcmFuZ2U6IFJhbmdlLCB0b29sdGlwIGhpZ2hsaWdodGluZyByYW5nZVxuICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0LiBTdHJpbmcgb3Ige3RleHQsIGhpZ2hsaWdodGVyfSBvciB7aHRtbH1cbiAgICAgICAgdGV4dDogdG9vbHRpcCB0ZXh0XG4gICAgICAgIGhpZ2hsaWdodGVyOiBncmFtbWFyIHNjb3BlIHRoYXQgd2lsbCBiZSB1c2VkIHRvIGhpZ2hsaWdodCB0b29sdGlwIHRleHRcbiAgICAgICAgaHRtbDogaHRtbCB0byBiZSBkaXNwbGF5ZWQgaW4gdG9vbHRpcFxuXG4gIHJldHVybnMgRGlzcG9zYWJsZVxuICAqL1xuICBvblNob3VsZFNob3dUb29sdGlwIChjYWxsYmFjazogVFRvb2x0aXBIYW5kbGVyKSB7XG4gICAgY29uc3QgZGlzcCA9IHRoaXMucGx1Z2luTWFuYWdlci50b29sdGlwUmVnaXN0cnkucmVnaXN0ZXIoXG4gICAgICB0aGlzLnBsdWdpbk5hbWUsIHtwcmlvcml0eTogMTAwLCBoYW5kbGVyOiBjYWxsYmFja31cbiAgICApXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLypcbiAgU2hvdyB0b29sdGlwIGluIGVkaXRvci5cblxuICBlZGl0b3I6IGVkaXRvciB0aGF0IHdpbGwgc2hvdyB0b29sdGlwXG4gIHBvczogdG9vbHRpcCBwb3NpdGlvblxuICBldmVudFR5cGU6IG9uZSBvZiAnY29udGV4dCcsICdrZXlib2FyZCcgYW5kICdtb3VzZSdcbiAgZGV0YWlsOiBmb3IgYXV0b21hdGljIHNlbGVjdGlvbiBiZXR3ZWVuICdjb250ZXh0JyBhbmQgJ2tleWJvYXJkJy5cbiAgICAgICAgICBJZ25vcmVkIGlmICdldmVudFR5cGUnIGlzIHNldC5cbiAgdG9vbHRpcDogZnVuY3Rpb24oY3JhbmdlKVxuICAgIGNyYW5nZTogUmFuZ2UsIGN1cnJlbnRseSBzZWxlY3RlZCByYW5nZSBpbiBlZGl0b3IgKHBvc3NpYmx5IGVtcHR5KVxuXG4gICAgUmV0dXJucyB7cmFuZ2UsIHRleHR9IG9yIFByb21pc2VcbiAgICAgIHJhbmdlOiBSYW5nZSwgdG9vbHRpcCBoaWdobGlnaHRpbmcgcmFuZ2VcbiAgICAgIHBlcnNpc3RPbkN1cnNvck1vdmU6IEJvb2xlYW4sIG9wdGlvbmFsLCBkZWZhdWx0IGZhbHNlLCBwZXJzaXN0IG9uIGN1cnNvciBtb3ZlIHJlZ2FyZGxlc3Mgb2Ygc2V0dGluZ3NcbiAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dC4gU3RyaW5nIG9yIHt0ZXh0LCBoaWdobGlnaHRlcn0gb3Ige2h0bWx9XG4gICAgICAgIHRleHQ6IHRvb2x0aXAgdGV4dFxuICAgICAgICBoaWdobGlnaHRlcjogZ3JhbW1hciBzY29wZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBoaWdobGlnaHQgdG9vbHRpcCB0ZXh0XG4gICAgICAgIGh0bWw6IGh0bWwgdG8gYmUgZGlzcGxheWVkIGluIHRvb2x0aXBcbiAgKi9cbiAgc2hvd1Rvb2x0aXAgKHtlZGl0b3IsIHBvcywgZXZlbnRUeXBlLCBkZXRhaWwsIHRvb2x0aXB9OiBJU2hvd1Rvb2x0aXBQYXJhbXMpIHtcbiAgICBpZiAoIWV2ZW50VHlwZSkge1xuICAgICAgZXZlbnRUeXBlID0gZ2V0RXZlbnRUeXBlKGRldGFpbClcbiAgICB9XG4gICAgdGhpcy5wbHVnaW5NYW5hZ2VyLnRvb2x0aXBSZWdpc3RyeS5zaG93VG9vbHRpcChcbiAgICAgIGVkaXRvciwgZXZlbnRUeXBlLCB7cGx1Z2luTmFtZTogdGhpcy5wbHVnaW5OYW1lLCB0b29sdGlwfVxuICAgIClcbiAgfVxuXG4gIC8qXG4gIENvbnZlbmllbmNlIGZ1bmN0aW9uLiBXaWxsIGZpcmUgYmVmb3JlIEhhc2tlbGwgYnVmZmVyIGlzIHNhdmVkLlxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayhidWZmZXIpXG4gICAgYnVmZmVyOiBUZXh0QnVmZmVyLCBidWZmZXIgdGhhdCBnZW5lcmF0ZWQgZXZlbnRcblxuICBSZXR1cm5zIERpc3Bvc2FibGVcbiAgKi9cbiAgb25XaWxsU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uV2lsbFNhdmVCdWZmZXIoY2FsbGJhY2spXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoZGlzcClcbiAgICByZXR1cm4gZGlzcFxuICB9XG5cbiAgLypcbiAgQ29udmVuaWVuY2UgZnVuY3Rpb24uIFdpbGwgZmlyZSBhZnRlciBIYXNrZWxsIGJ1ZmZlciBpcyBzYXZlZC5cblxuICBjYWxsYmFjazogY2FsbGJhY2soYnVmZmVyKVxuICAgIGJ1ZmZlcjogVGV4dEJ1ZmZlciwgYnVmZmVyIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG5cbiAgUmV0dXJucyBEaXNwb3NhYmxlXG4gICovXG4gIG9uRGlkU2F2ZUJ1ZmZlciAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uRGlkU2F2ZUJ1ZmZlcihjYWxsYmFjaylcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChkaXNwKVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICBvbkRpZFN0b3BDaGFuZ2luZyAoY2FsbGJhY2s6IFRUZXh0QnVmZmVyQ2FsbGJhY2spIHtcbiAgICBjb25zdCBkaXNwID0gdGhpcy5wbHVnaW5NYW5hZ2VyLm9uRGlkU3RvcENoYW5naW5nKGNhbGxiYWNrKVxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKGRpc3ApXG4gICAgcmV0dXJuIGRpc3BcbiAgfVxuXG4gIC8qXG4gIEFkZCBhIG5ldyBjb250cm9sIHRvIG91cHR1dCBwYW5lbCBoZWFkaW5nLlxuXG4gIGVsZW1lbnQ6IEhUTUxFbGVtZW50IG9mIGNvbnRyb2wsIG9yIFN0cmluZyB3aXRoIHRhZyBuYW1lXG4gIG9wdHM6IHZhcmlvdXMgb3B0aW9uc1xuICAgIGlkOiBTdHJpbmcsIGlkXG4gICAgZXZlbnRzOiBPYmplY3QsIGV2ZW50IGNhbGxiYWNrcywga2V5IGlzIGV2ZW50IG5hbWUsIGUuZy4gXCJjbGlja1wiLFxuICAgICAgICAgICAgdmFsdWUgaXMgY2FsbGJhY2tcbiAgICBjbGFzc2VzOiBBcnJheSBvZiBTdHJpbmcsIGNsYXNzZXNcbiAgICBzdHlsZTogT2JqZWN0LCBjc3Mgc3R5bGUsIGtleXMgYXJlIHN0eWxlIGF0dHJpYnV0ZXMsIHZhbHVlcyBhcmUgdmFsdWVzXG4gICAgYXR0cnM6IE9iamVjdCwgb3RoZXIgYXR0cmlidXRlcywga2V5cyBhcmUgYXR0cmlidXRlIG5hbWVzLCB2YWx1ZXMgYXJlIHZhbHVlc1xuICAgIGJlZm9yZTogU3RyaW5nLCBDU1Mgc2VsZWN0b3Igb2YgZWxlbWVudCwgdGhhdCB0aGlzIG9uZSBzaG91bGQgYmUgaW5zZXJ0ZWRcbiAgICAgICAgICAgIGJlZm9yZSwgZS5nLiAnI3Byb2dyZXNzQmFyJ1xuXG4gIFJldHVybnMgRGlzcG9zYWJsZS5cbiAgKi9cbiAgYWRkUGFuZWxDb250cm9sIChlbGVtZW50OiBzdHJpbmcgfCBIVE1MRWxlbWVudCwgb3B0czogSUNvbnRyb2xPcHRzKSB7XG4gICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5vdXRwdXRQYW5lbC5hZGRQYW5lbENvbnRyb2woe2VsZW1lbnQsIG9wdHN9KVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBuZXdPcHRzOiBJQ29udHJvbE9wdHMgJiB7ZWxlbWVudDogSFRNTEVsZW1lbnR9ID0gey4uLm9wdHMsIGVsZW1lbnR9XG4gICAgICByZXR1cm4gdGhpcy5wbHVnaW5NYW5hZ2VyLm91dHB1dFBhbmVsLmFkZFBhbmVsQ29udHJvbCh7ZWxlbWVudDogRHVtbXlFbGVtZW50LCBvcHRzOiBuZXdPcHRzfSlcbiAgICB9XG4gIH1cblxuICAvKlxuICBhZGRDb25maWdQYXJhbVxuICAgIHBhcmFtX25hbWU6XG4gICAgICBvbkNoYW5nZWQ6IGNhbGxiYWNrIHZvaWQodmFsdWUpXG4gICAgICBpdGVtczogQXJyYXkgb3IgY2FsbGJhY2sgQXJyYXkodm9pZClcbiAgICAgIGl0ZW1UZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgaHRtbCB0ZW1wbGF0ZVxuICAgICAgaXRlbUZpbHRlcktleTogU3RyaW5nLCBpdGVtIGZpbHRlciBrZXlcbiAgICAgIGRlc2NyaXB0aW9uOiBTdHJpbmcgW29wdGlvbmFsXVxuICAgICAgZGlzcGxheU5hbWU6IFN0cmluZyBbb3B0aW9uYWwsIGNhcGl0YWxpemVkIHBhcmFtX25hbWUgZGVmYXVsdF1cbiAgICAgIGRpc3BsYXlUZW1wbGF0ZTogY2FsbGJhY2ssIFN0cmluZyhpdGVtKSwgc3RyaW5nIHRlbXBsYXRlXG4gICAgICBkZWZhdWx0OiBpdGVtLCBkZWZhdWx0IHZhbHVlXG5cbiAgUmV0dXJuc1xuICAgIGRpc3A6IERpc3Bvc2FibGVcbiAgICBjaGFuZ2U6IG9iamVjdCBvZiBjaGFuZ2UgZnVuY3Rpb25zLCBrZXlzIGJlaW5nIHBhcmFtX25hbWVcbiAgKi9cbiAgYWRkQ29uZmlnUGFyYW0gKHNwZWNzOiB7IFtwYXJhbU5hbWU6IHN0cmluZ106IElQYXJhbVNwZWM8T2JqZWN0PiB9KSB7XG4gICAgY29uc3QgZGlzcCA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICBmb3IgKGNvbnN0IG5hbWUgb2YgT2JqZWN0LmtleXMoc3BlY3MpKSB7XG4gICAgICBjb25zdCBzcGVjID0gc3BlY3NbbmFtZV1cbiAgICAgIGRpc3AuYWRkKFxuICAgICAgICB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmFkZCh0aGlzLnBsdWdpbk5hbWUsIG5hbWUsIHNwZWMpXG4gICAgICApXG4gICAgfVxuICAgIHJldHVybiBkaXNwXG4gIH1cblxuICAvKlxuICBnZXRDb25maWdQYXJhbShwYXJhbU5hbWUpIG9yIGdldENvbmZpZ1BhcmFtKHBsdWdpbk5hbWUsIHBhcmFtTmFtZSlcblxuICByZXR1cm5zIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlclxuICB2YWx1ZS5cblxuICBQcm9taXNlIGNhbiBiZSByZWplY3RlZCB3aXRoIGVpdGhlciBlcnJvciwgb3IgJ3VuZGVmaW5lZCcuIExhdHRlclxuICBpbiBjYXNlIHVzZXIgY2FuY2VscyBwYXJhbSBzZWxlY3Rpb24gZGlhbG9nLlxuICAqL1xuICBhc3luYyBnZXRDb25maWdQYXJhbSAob3RoZXJQbHVnaW5OYW1lOiBzdHJpbmcsIG5hbWU6IHN0cmluZykge1xuICAgIGlmICghbmFtZSkge1xuICAgICAgbmFtZSA9IG90aGVyUGx1Z2luTmFtZVxuICAgICAgb3RoZXJQbHVnaW5OYW1lID0gdGhpcy5wbHVnaW5OYW1lXG4gICAgfVxuICAgIHJldHVybiB0aGlzLnBsdWdpbk1hbmFnZXIuY29uZmlnUGFyYW1NYW5hZ2VyLmdldChvdGhlclBsdWdpbk5hbWUsIG5hbWUpXG4gIH1cblxuICAvKlxuICBzZXRDb25maWdQYXJhbShwYXJhbU5hbWUsIHZhbHVlKSBvciBzZXRDb25maWdQYXJhbShwbHVnaW5OYW1lLCBwYXJhbU5hbWUsIHZhbHVlKVxuXG4gIHZhbHVlIGlzIG9wdGlvbmFsLiBJZiBvbWl0dGVkLCBhIHNlbGVjdGlvbiBkaWFsb2cgd2lsbCBiZSBwcmVzZW50ZWQgdG8gdXNlci5cblxuICByZXR1cm5zIGEgUHJvbWlzZSB0aGF0IHJlc29sdmVzIHRvIHBhcmFtZXRlciB2YWx1ZS5cblxuICBQcm9taXNlIGNhbiBiZSByZWplY3RlZCB3aXRoIGVpdGhlciBlcnJvciwgb3IgJ3VuZGVmaW5lZCcuIExhdHRlclxuICBpbiBjYXNlIHVzZXIgY2FuY2VscyBwYXJhbSBzZWxlY3Rpb24gZGlhbG9nLlxuICAqL1xuICBhc3luYyBzZXRDb25maWdQYXJhbSAob3RoZXJQbHVnaW5OYW1lOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgdmFsdWU/OiBPYmplY3QpIHtcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdmFsdWUgPSBuYW1lXG4gICAgICBuYW1lID0gb3RoZXJQbHVnaW5OYW1lXG4gICAgICBvdGhlclBsdWdpbk5hbWUgPSB0aGlzLnBsdWdpbk5hbWVcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucGx1Z2luTWFuYWdlci5jb25maWdQYXJhbU1hbmFnZXIuc2V0KG90aGVyUGx1Z2luTmFtZSwgbmFtZSwgdmFsdWUpXG4gIH1cblxuICAvKlxuICBVdGlsaXR5IGZ1bmN0aW9uIHRvIGV4dHJhY3QgZXZlbnQgcmFuZ2UvdHlwZSBmb3IgYSBnaXZlbiBldmVudFxuXG4gIGVkaXRvcjogVGV4dEVkaXRvciwgZWRpdG9yIHRoYXQgZ2VuZXJhdGVkIGV2ZW50XG4gIGRldGFpbDogZXZlbnQgZGV0YWlsLCBpZ25vcmVkIGlmIGV2ZW50VHlwZSBpcyBzZXRcbiAgZXZlbnRUeXBlOiBTdHJpbmcsIGV2ZW50IHR5cGUsIG9uZSBvZiAna2V5Ym9hcmQnLCAnY29udGV4dCcsICdtb3VzZSdcbiAgcG9zOiBQb2ludCwgb3IgUG9pbnQtbGlrZSBPYmplY3QsIGV2ZW50IHBvc2l0aW9uLCBjYW4gYmUgdW5kZWZpbmVkXG4gIGNvbnRyb2xsZXI6IGxlYXZlIHVuZGVmaW5lZCwgdGhpcyBpcyBpbnRlcm5hbCBmaWVsZFxuXG4gIGNhbGxiYWNrOiBjYWxsYmFjayh7cG9zLCBjcmFuZ2UsIGV2ZW50VHlwZX0pXG4gICAgcG9zOiBQb2ludCwgZXZlbnQgcG9zaXRpb25cbiAgICBjcmFuZ2U6IFJhbmdlLCBldmVudCByYW5nZVxuICAgIGV2ZW50VHlwZTogU3RyaW5nLCBldmVudCB0eXBlLCBvbmUgb2YgJ2tleWJvYXJkJywgJ2NvbnRleHQnLCAnbW91c2UnXG4gICovXG4gIHdpdGhFdmVudFJhbmdlPFQ+ICh7ZWRpdG9yLCBkZXRhaWwsIGV2ZW50VHlwZSwgcG9zfTogSUV2ZW50UmFuZ2VQYXJhbXMsIGNhbGxiYWNrOiBURXZlbnRSYW5nZUNhbGxiYWNrPFQ+KSB7XG4gICAgbGV0IHBwb3M6IFBvaW50IHwgdW5kZWZpbmVkXG4gICAgaWYgKHBvcykgeyBwcG9zID0gUG9pbnQuZnJvbU9iamVjdChwb3MpIH1cbiAgICBpZiAoIWV2ZW50VHlwZSkgeyBldmVudFR5cGUgPSBnZXRFdmVudFR5cGUoZGV0YWlsKSB9XG4gICAgY29uc3QgY29udHJvbGxlciA9IHRoaXMucGx1Z2luTWFuYWdlci5jb250cm9sbGVyKGVkaXRvcilcbiAgICBpZiAoIWNvbnRyb2xsZXIpIHsgcmV0dXJuIH1cbiAgICBjb25zdCByZXMgPSBjb250cm9sbGVyLmdldEV2ZW50UmFuZ2UoZXZlbnRUeXBlKVxuICAgIGlmICghcmVzKSB7IHJldHVybiB9XG4gICAgcmV0dXJuIGNhbGxiYWNrKHJlcylcbiAgfVxufVxuIl19